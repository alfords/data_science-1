


<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>tak.ml.nmf</title>
    
    <link rel="stylesheet" href="../../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/style.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/font-awesome-4.7.0/css/font-awesome.min.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/bootswatch-3.3.6/flatly/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/bootstrap-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/copybutton.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../../_static/bootstrap-3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../../_static/bootstrap-sphinx.js"></script>
    <link rel="top" title="" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../index.html">
          Data Science</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="http://takwatanabe.me"><i class="fa fa-home" aria-hidden="true"></i>&nbsp; takwatanabe.me</a></li>
                <li><a href="https://github.com/wtak23/data_science"><i class="fa fa-github" aria-hidden="true"></i>&nbsp; Github</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../index.html">TOC <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><p class="caption"><span class="caption-text">Research Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../pytak.html"><code class="docutils literal"><span class="pre">pytak</span></code> &#8212; my personal python package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../supervised_nmf.html">Supervised NMF (<code class="docutils literal"><span class="pre">supervised_nmf</span></code>)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../supervised_nmf.html#non-negative-matrix-factorization">Non-negative Matrix Factorization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../supervised_nmf.html#nmf-ls-pnmf-admm">nmf.ls_pnmf_admm</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../supervised_nmf.html#nmf-ls-sgpnmf-admm">nmf.LS_SGPNMF_ADMM</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../supervised_nmf.html#visualization">Visualization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../supervised_nmf.html#imconnmat">imconnmat</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../supervised_nmf.html#data-io">Data IO</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../supervised_nmf.html#data-tob-pnc-load-bct-measures">data.tob_pnc.load_bct_measures</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../supervised_nmf.html#data-tob-pnc-load-diffusion-volume-matfile">data.tob_pnc.load_diffusion_volume_matfile</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../supervised_nmf.html#data-tob-pnc-load-connectome-matfile">data.tob_pnc.load_connectome_matfile</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../sqlite-whirlwind.html">A whirlwind tour to sqlite</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../sqlite-whirlwind.html#beginning">Beginning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../sqlite-whirlwind.html#insert-data">Insert data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../sqlite-whirlwind.html#get-data">Get data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../sqlite-whirlwind.html#row-factory">Row factory</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../sqlite-whirlwind.html#iterdump">iterdump</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../sqlite-whirlwind.html#cursor-object">Cursor object</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../sqlite-whirlwind.html#row-objects">Row objects</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../spark-config.html">Spark Configuration Setup for Jupyter</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../spark-config.html#about">about</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../spark-config.html#self-contained-applications">self-contained applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../spark-config.html#note">Note</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../pnc-mean-analysis.html">Brain Connectivity - PNC Data</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../pnc-mean-analysis.html#load-relevant-packages">Load relevant packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../pnc-mean-analysis.html#load-clinical-scores-dataframe">Load clinical-scores (DataFrame)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../pnc-mean-analysis.html#handle-nan-values">Handle nan values</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../pnc-mean-analysis.html#create-histogram-of-numeric-scores">Create histogram of numeric scores</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../pnc-mean-analysis.html#display-mean-connectome-heatmap">Display mean connectome heatmap</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../pnc-mean-analysis.html#nice-let-s-repeat-using-plotly">Nice, let&#8217;s repeat using plotly</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../pnc-mean-analysis.html#create-plotly-trace-object">Create plotly <code class="docutils literal"><span class="pre">trace</span></code> object</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../pnc-mean-analysis.html#bunch-of-layout-objects">Bunch of layout objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../pnc-mean-analysis.html#nice-but-we-can-do-better-by-defining-a-layout-object">Nice, but we can do better by defining a <code class="docutils literal"><span class="pre">layout</span></code> object</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../pnc-mean-analysis.html#try-again">Try again</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../pnc_study_feature_1104_onesession.html">PNC classification experiment results (old)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../pnc_study_feature_1104_onesession.html#what-is-this">What is this?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../pnc_study_feature_1104_onesession.html#load-data">Load data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../pnc_study_feature_1104_onesession.html#show-classification-result">Show classification result</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../pnc_study_feature_1104_onesession.html#display-median-coefficients">Display median coefficients</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../pnc_study_feature_1104_onesession.html#display-median-connmat">Display median connmat</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../pnc_study_feature_1104_onesession.html#glass-brain">Glass-brain</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../pnc_study_feature_1104_onesession.html#thresholded-median-value-experimental">Thresholded median value (experimental)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../pnc_study_feature_1104_onesession.html#trinarized-median-connmat-after-thresholding">Trinarized median connmat after thresholding</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../pnc_study_feature_1104_onesession.html#glassbrain">Glassbrain</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../rst-test/top-rst.html">Check rst functionality (<code class="docutils literal"><span class="pre">top-rst.rst</span></code>)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../rst-test/cs-rst.directive-test.html">Test runs on RST directives (<code class="docutils literal"><span class="pre">cs-rst.directive-test.rst</span></code>)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../rst-test/cs-rst.directive-test.html#admonitions">Admonitions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rst-test/cs-rst.directive-test.html#images">Images</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../rst-test/cs-rst.directive-test.html#image">Image</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../rst-test/cs-rst.directive-test.html#figure">figure</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../rst-test/cs-rst.directive-test.html#additional-body-elements">Additional body elements</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../rst-test/cs-rst.directive-test.html#id1">contents</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../rst-test/cs-rst.directive-test.html#container">container</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../rst-test/cs-rst.directive-test.html#rubric">rubric</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../rst-test/cs-rst.directive-test.html#topics">topics</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../rst-test/cs-rst.directive-test.html#sidebar">sidebar</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../rst-test/cs-rst.directive-test.html#parsed-literal">parsed-literal</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../rst-test/cs-rst.directive-test.html#epigraph">epigraph</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../rst-test/cs-rst.directive-test.html#highlights">highlights</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../rst-test/cs-rst.directive-test.html#pull-quote">pull-quote</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../rst-test/cs-rst.directive-test.html#compound">compound</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../rst-test/cs-rst.directive-test.html#special-tables">Special tables</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../rst-test/cs-rst.directive-test.html#table">table</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../rst-test/cs-rst.directive-test.html#csv-table">csv-table</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../rst-test/cs-rst.directive-test.html#list-table">list-table</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../rst-test/cs-rst.directive-test.html#special-directives">Special directives</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../rst-test/cs-rst.directive-test.html#raw">raw</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../rst-test/cs-rst.directive-test.html#include">include</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../rst-test/cs-rst.directive-test.html#class">class</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../rst-test/cs-rst.directive-test.html#html-specifics">HTML specifics</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../rst-test/cs-rst.directive-test.html#meta">meta</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../rst-test/cs-rst.directive-test.html#title">title</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../rst-test/cs-rst.directive-test.html#influencing-markup-i-rarely-use">Influencing Markup (i rarely use)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../rst-test/cs-rst.directive-test.html#default-role-set-a-new-default-role">default-role (set a new default role)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../rst-test/cs-rst.directive-test.html#role-create-a-new-role">role (create a new role)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../rst-test/cs-rst.directive-test.html#foot-notes-citations-substitutions">Foot-notes, citations, substitutions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../rst-test/cs-rst.directive-test.html#footnotes">footnotes</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../rst-test/cs-rst.directive-test.html#citations">citations</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../rst-test/cs-rst.directive-test.html#substitutions">substitutions</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../rst-test/cs-rst.math_part1.html">Latex mathematics on sphinx (<code class="docutils literal"><span class="pre">cs-rst.math_part1.rst</span></code>)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../rst-test/cs-rst.math_part1.html#symbols">Symbols</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rst-test/cs-rst.math_part1.html#greek-letters">Greek letters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rst-test/cs-rst.math_part1.html#operators">Operators</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rst-test/cs-rst.math_part1.html#fractions-and-binomials">Fractions and Binomials</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rst-test/cs-rst.math_part1.html#square-roots">Square roots</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rst-test/cs-rst.math_part1.html#sum-and-integrals">Sum and integrals</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../rst-test/cs-rst.math_part1.html#big-commands"><strong>BIG</strong> commands</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../rst-test/cs-rst.math_part1.html#brackets-braces-and-delimiters">Brackets, braces and delimiters</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../rst-test/cs-rst.math_part1.html#automatic-sizing">Automatic sizing</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../rst-test/cs-rst.math_part1.html#manual-sizing">Manual sizing</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../rst-test/cs-rst.math_part1.html#typesetting-intervals">Typesetting intervals</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../rst-test/cs-rst.math_part1.html#matrices-and-array">Matrices and array</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../rst-test/cs-rst.math_part1.html#more-fancy-ones">More fancy ones</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../rst-test/cs-rst.math_part1.html#adding-text-to-equations">Adding text to equations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rst-test/cs-rst.math_part1.html#formatting-mathematics-symbols">Formatting mathematics symbols</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../rst-test/cs-rst.math_part1.html#accents">Accents</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../rst-test/cs-rst.math_part1.html#color-works">Color (works!)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rst-test/cs-rst.math_part1.html#plus-and-minus">Plus and minus</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rst-test/cs-rst.math_part1.html#controlling-horizontal-spacing">Controlling horizontal spacing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rst-test/cs-rst.math_part1.html#dots">Dots</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rst-test/cs-rst.math_part1.html#list-of-mathematical-symbols">List of Mathematical Symbols</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../rst-test/cs-rst.math_part1.html#other-symbols">Other symbols</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../rst-test/cs-rst.math_part1.html#trigonemtrics">Trigonemtrics</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../rst-test/cs_rst.math_part2.html">Advanced Latex Mathematics on Sphinx (<code class="docutils literal"><span class="pre">cs_rst.math_part2.rst</span></code>)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../rst-test/cs_rst.math_part2.html#some-self-notes-i-created">Some self-notes I created</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../rst-test/cs_rst.math_part2.html#bold-for-lower-case-greek">bold for lower-case greek</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../rst-test/cs_rst.math_part2.html#defining-own-function">Defining own function</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../rst-test/cs_rst.math_part2.html#equations">Equations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rst-test/cs_rst.math_part2.html#vertical-alignment">Vertical alignment</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rst-test/cs_rst.math_part2.html#more-aligns">More aligns</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rst-test/cs_rst.math_part2.html#braces-spanning-multiple-lines">Braces spanning multiple lines</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rst-test/cs_rst.math_part2.html#aligning-braces-for-piecewise-functions">Aligning braces for piecewise functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rst-test/cs_rst.math_part2.html#the-cases-environment">The <strong>cases</strong> environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rst-test/cs_rst.math_part2.html#more-exotic-examples">More exotic examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rst-test/cs_rst.math_part2.html#boxed-equations">Boxed equations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rst-test/cs_rst.math_part2.html#custom-operator-ah-argmax">Custom operator (ah, argmax!)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rst-test/cs_rst.math_part2.html#advanced-formatting">Advanced formatting</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../rst-test/cs_rst.math_part2.html#limits">Limits</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../rst-test/cs_rst.math_part2.html#subscripts-and-supterscripts">Subscripts and supterscripts</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../rst-test/cs_rst.math_part2.html#changing-font-size">Changing font size</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../rst-test/cs-rst.ipython.html">Demo runs of ipython sphinx extensions (<code class="docutils literal"><span class="pre">cs-rst.ipython.rst</span></code>)</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Spark Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../pyspark/top-edx.html">EdX - Data Science and Engineering with Spark</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/cs105_lab0.html">cs105_lab0 - Running Your First Notebook</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs105_lab0.html#create-dataframe-and-filter-it">Create DataFrame and filter it</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs105_lab0.html#load-a-text-file">Load a text file</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs105_lab0.html#check-plotting">Check plotting</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/cs105_lab1a.html">cs105_lab1a - Learning Apache Spark</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs105_lab1a.html#spark-context">Spark Context</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs105_lab1a.html#sparkcontext-and-the-driver-program-cluster-structure">SparkContext and the Driver Program (Cluster Structure)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab1a.html#about-the-driver-program">About the Driver Program</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab1a.html#about-hivecontext-the-type-of-sqlcontext-for-db">About HiveContext (the type of sqlContext for DB)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab1a.html#sparkcontext">SparkContext</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs105_lab1a.html#using-dataframes-and-chaining-transformations">Using DataFrames and chaining transformations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab1a.html#dataframe-and-schema">DataFrame and Schema</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab1a.html#ways-to-define-schemas">Ways to define schemas</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab1a.html#distributed-data-and-using-a-collection-to-create-a-dataframe">Distributed Data and using a collection to create a DataFrame</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab1a.html#query-plans-and-the-catalyst-optimizer">Query plans and the <code class="docutils literal"><span class="pre">Catalyst</span> <span class="pre">Optimizer</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/cs105_lab1a_coding.html">cs105_lab1a codes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs105_lab1a_coding.html#exercise-overview">Exercise Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs105_lab1a_coding.html#create-list-of-data">Create list of Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs105_lab1a_coding.html#create-dataframe-from-a-list">Create DataFrame from a list</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs105_lab1a_coding.html#subtract-one-from-each-the-age-row">Subtract one from each the <em>age</em> row</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs105_lab1a_coding.html#apply-transformations-and-examine-query-plan">Apply transformations, and examine query plan</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs105_lab1a_coding.html#use-collect-to-view-results">Use <code class="docutils literal"><span class="pre">collect</span></code> to view results</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs105_lab1a_coding.html#display-helper-function-in-db">display helper function in DB</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs105_lab1a_coding.html#more-actions-count-to-get-total">More actions: <code class="docutils literal"><span class="pre">count</span></code> to get total</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs105_lab1a_coding.html#apply-transformation-filter-and-view-results-with-collect">Apply transformation <code class="docutils literal"><span class="pre">filter</span></code> and view results with <code class="docutils literal"><span class="pre">collect</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs105_lab1a_coding.html#lambda-functions-and-udfs">Lambda functions and UDFs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs105_lab1a_coding.html#additional-dataframe-actions">Additional DataFrame actions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs105_lab1a_coding.html#additional-dataframe-transformations">Additional DataFrame transformations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab1a_coding.html#orderby">orderBy</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab1a_coding.html#a-distinct-and-dropduplicates">A <code class="docutils literal"><span class="pre">distinct</span></code> and <code class="docutils literal"><span class="pre">dropDuplicates</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab1a_coding.html#drop">drop</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab1a_coding.html#groupby">groupBy</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab1a_coding.html#sample">sample</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs105_lab1a_coding.html#caching-dataframes-and-storage-options">Caching DataFrames and Storage Options</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab1a_coding.html#unpersist-and-storage-options">Unpersist and storage options</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs105_lab1a_coding.html#debugging-spark-applications-and-lazy-evaluation">Debugging Spark applications and lazy evaluation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab1a_coding.html#jvm-and-py4j-how-python-is-executed-in-spark">JVM and Py4J - How Python is Executed in Spark</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab1a_coding.html#challenges-with-lazy-evaluation-using-transformations-and-actions">Challenges with lazy evaluation using transformations and actions</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab1a_coding.html#finding-the-bug">Finding the bug</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab1a_coding.html#moving-toward-expert-style">Moving toward expert style</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/cs105_lab1b.html">cs105_lab1b - Building a word count application</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs105_lab1b.html#create-a-base-df-and-perform-operations">Create a base DF and perform operations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab1b.html#create-a-base-df">Create a base DF</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab1b.html#use-df-functions-to-add-an-s">Use DF functions to add an &#8216;s&#8217;</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab1b.html#length-of-each-word">Length of each word</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs105_lab1b.html#counting-with-spark-sql-and-dataframes">Counting with Spark SQL and DataFrames</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab1b.html#using-groupby-and-count">Using groupBy and count</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs105_lab1b.html#finding-unique-words-and-a-mean-value">Finding unique words and a mean value</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab1b.html#unique-words">Unique words</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab1b.html#means-of-groups-using-dataframes">Means of groups using DataFrames</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs105_lab1b.html#apply-word-count-to-a-file">Apply word count to a file</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab1b.html#the-wordcount-function">The wordCount function</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab1b.html#capitalization-and-punctuation">Capitalization and punctuation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab1b.html#load-a-text-file">Load a text file</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab1b.html#words-from-lines">Words from lines</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab1b.html#count-the-words">Count the words</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs105_lab1b.html#random-stuffs-i-played-around-with">Random stuffs I played around with</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/cs105_lab2.html">cs105_lab2 - Web Server Log Analysis with Apache Spark</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs105_lab2.html#part1-overview-web-server-log-analysis-with-apache-spark">Part1: Overview: Web Server Log Analysis with Apache Spark</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab2.html#modules-used-in-this-assignment">Modules used in this assignment</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab2.html#dataset-used">Dataset used</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs105_lab2.html#part2-exploratory-data-analysis">Part2: Exploratory Data Analysis</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab2.html#a-loading-the-log-file">2a) loading the log file</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab2.html#b-parsing-the-log-file">2b) Parsing the log file</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab2.html#c-data-cleaning">2c) Data Cleaning</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab2.html#fix-the-rows-with-null-content-size">Fix the rows with null content_size</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab2.html#parsing-the-timestamp">Parsing the timestamp</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs105_lab2.html#part3-analysis-walk-through-on-the-web-server-log-file">Part3: Analysis Walk-Through on the Web Server Log File</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab2.html#a-example-content-size-statistics">3a) Example: Content Size Statistics</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab2.html#b-example-http-status-analysis">3b) Example: HTTP Status Analysis</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab2.html#c-example-status-graphing">3c) Example: Status Graphing</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab2.html#d-example-frequent-hosts">3d) Example: Frequent Hosts</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab2.html#e-example-visualizing-paths">3e) Example: Visualizing Paths</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab2.html#f-example-top-paths">3f) Example: Top Paths</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs105_lab2.html#part-4-analyzing-web-server-log-file">Part 4: Analyzing Web Server Log File</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab2.html#a-exercise-top-ten-error-paths-hw">4a) Exercise: Top Ten Error Paths (HW)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab2.html#b-exercise-number-of-unique-hosts-hw">4b) Exercise: Number of Unique Hosts (HW)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab2.html#c-exercise-number-of-unique-daily-hosts">4c) Exercise: Number of Unique Daily Hosts</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab2.html#d-exercise-visualizing-the-number-of-unique-daily-hosts">4d) Exercise: Visualizing the Number of Unique Daily Hosts</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab2.html#e-exercise-average-number-of-daily-requests-per-host">4e) Exercise: Average Number of Daily Requests per Host</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs105_lab2.html#f-exercise-visualizing-the-average-daily-requests-per-unique-host">4f) Exercise: Visualizing the Average Daily Requests per Unique Host</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/cs110_lab1.html">cs110 - Power Plant Machine Learning Pipeline Application</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#part1-business-understanding">Part1: Business Understanding</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#background-power-generation">Background &#8212; power generation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#challenge-for-power-grid-operation">Challenge for power grid operation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#the-business-problem">The business problem</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#business-understanding">Business Understanding</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#part2-extract-transform-load-etl-your-data">Part2: Extract-Transform-Load (ETL) Your Data</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#exercise-2a">Exercise 2a</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#exercise-2b">Exercise 2b</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#part-2-alternative-method-to-load-your-data">Part 2: Alternative Method to Load your Data</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#exercise-2c">Exercise 2c</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#exercise-2d">Exercise 2d</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#part-3-explore-your-data">Part 3: Explore Your Data</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#a-register-the-dataframe-to-use-sql-commands">3a - <strong>register</strong> the DataFrame (to use sql commands)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#b-read-data-using-sql-command-databricks-only">3b - read data using <code class="docutils literal"><span class="pre">%sql</span></code> command (DataBricks only)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#c-use-sql-desc-command-to-describe-the-schema">3c - use SQL <code class="docutils literal"><span class="pre">desc</span></code> command to describe the schema</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#dataframe-describe-method">DataFrame <code class="docutils literal"><span class="pre">describe</span></code> method</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#part-4-visualize-your-data">Part 4: Visualize your data</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#exercise-4a">Exercise 4a</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#exercise-4b-hw">Exercise 4b (hw)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#exercise-4c-hw">Exercise 4c (hw)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#exercise-4d-hw">Exercise 4d (hw)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#part-5-data-preparation">Part 5: Data Preparation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#exercise-5-a">Exercise 5(a)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#part-6-data-modeling">Part 6: Data Modeling</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#exercise-6-a-hw">Exercise 6(a) (hw)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#b-build-linear-regression-model">6(b) - build Linear Regression Model</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#c-set-model-parameters-and-fit-linear-regression-model">6(c) - set model parameters, and fit linear regression model</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#d-study-the-fitted-lr-model">6(d) &#8212; study the fitted LR model</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#e-evalute-model-on-the-20-test-set">6(e) evalute model on the 20% test-set</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#f-quantify-performance-using-regressionevaluator">6(f) &#8211; quantify performance using <code class="docutils literal"><span class="pre">RegressionEvaluator</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#g-use-r2-this-time">6(g) use R2 this time</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#h-register-our-test-dataframe-as-sql-table">6(h) Register our test DataFrame as SQL table</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#i-sql-statement-on-the-sql-table-registered-from-our-test-dataframe">6(i) SQL statement on the SQL table registered from our test DataFrame</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#j-plot-histogram-of-rmse">6(j) Plot histogram of RMSE</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#k-plot-pie-chart">6(k) Plot pie chart</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#part-7-tuning-and-evaluation">Part 7: Tuning and Evaluation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#a-run-cross-validation-tuning">7(a) Run Cross Validation Tuning</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#exercise-7-b-evaluate-tuned-lr-model-hw">Exercise 7(b) &#8211; Evaluate tuned LR model (hw)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#exercise-7-c-decisiontreeregressor">Exercise 7(c) DecisionTreeRegressor</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#exercise-7-d">Exercise 7(d)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#exercise-7-e-evaluate-dtr-performance">Exercise 7(e) &#8212; evaluate DTR performance</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#exercise-7-f-random-forest-regressor">Exercise 7(f) (Random Forest Regressor)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#exercise-7-g-cross-validation">Exercise 7(g) (cross validation)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab1.html#exercise-7-h-model-evaluation">Exercise 7(h) (model evaluation)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/cs110_lab2.html">cs110 - Predicting Movie Ratings with Alternating Least Squares</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs110_lab2.html#preliminaries">Preliminaries</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab2.html#the-20-million-movie-sample">The 20-million movie sample</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab2.html#cpu-vs-io-tradeoff">CPU vs IO Tradeoff</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab2.html#load-and-cache">Load and Cache</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs110_lab2.html#basic-recommendations">Basic Recommendations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab2.html#exercise-1a-movies-with-highest-average-ratings">Exercise (1a) Movies with Highest Average Ratings</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab2.html#exercise-1b-movies-with-highest-average-ratings-and-at-least-500-reviews">Exercise (1b) Movies with Highest Average Ratings and at least 500 reviews</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs110_lab2.html#collaborative-filtering">Collaborative Filtering</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab2.html#exercise-2a-creating-a-training-set">Exercise (2a) Creating a Training Set</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab2.html#exercise-2b-alternating-least-squares">Exercise (2b) Alternating Least Squares</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab2.html#why-are-we-doing-our-own-cross-validation">Why are we doing our own cross-validation?</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab2.html#excersie-2c-testing-your-model">Excersie (2c) Testing Your Model</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab2.html#exercise-2d-comparing-your-model">Exercise (2d) Comparing Your Model</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs110_lab2.html#predictions-for-yourself">Predictions for Yourself</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab2.html#exercise-3a-your-movie-ratings">Exercise (3a) Your Movie Ratings</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab2.html#exercise-3b-add-your-movies-to-training-dataset">Exercise (3b) Add Your Movies to Training Dataset</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab2.html#exercise-3c-train-a-model-with-your-ratings">Exercise (3c) Train a Model with Your Ratings</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab2.html#exercise-3d-check-rmse-for-the-new-model-with-your-ratings">Exercise (3d) Check RMSE for the New Model with Your Ratings</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab2.html#exercise-3e-predict-your-ratings">Exercise (3e) Predict Your Ratings</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab2.html#exercise-3f-predict-your-ratings">Exercise (3f) Predict Your Ratings</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/cs110_lab3b.html">cs110 - Text Analysis and Entity Resolution with TF-IDF</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs110_lab3b.html#preliminaries">Preliminaries</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab3b.html#background-on-er">Background on ER</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab3b.html#data-files">Data files</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab3b.html#load-data-files">Load data files</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab3b.html#examine-the-lines-loaded">Examine the lines loaded</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs110_lab3b.html#part1-er-as-text-similarity-bags-of-words">Part1: ER as Text Similarity - Bags of Words</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab3b.html#a-tokenize-a-string">1a) Tokenize a String</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab3b.html#b-removing-stopwords">1b) removing stopwords</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab3b.html#c-tokenizing-the-small-datasets">1c) Tokenizing the small datasets</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab3b.html#d-amazon-record-with-the-most-tokens">1d) Amazon record with the most tokens</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs110_lab3b.html#part2-er-as-text-similarity-weighted-bag-of-words-using-tf-idf">Part2: ER as Text Similarity - Weighted Bag-of-Words using TF-IDF</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab3b.html#a-implement-a-tf-function">2a) Implement a TF function</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab3b.html#b-create-a-corpus">2b) Create a corpus</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab3b.html#c-implement-an-idfs-function">2c) Implement an IDFs function</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab3b.html#d-tokens-with-the-smallest-idf">2d) Tokens with the smallest IDF</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab3b.html#e-idf-histogram">2e) IDF Histogram</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab3b.html#f-implement-a-tf-idf-function">2f) Implement a TF-IDF function</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs110_lab3b.html#part-3-er-as-text-similarity-cosine-similarity">Part 3: ER as Text Similarity &#8212; Cosine Similarity</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab3b.html#a-implement-the-components-of-a-cosinesimilarity-function">3a) Implement the components of a cosineSimilarity function</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab3b.html#b-implement-a-cosinesimilarity-function">3b) Implement a cosineSimilarity function</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab3b.html#c-perform-entity-resolution">3c) Perform Entity Resolution</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab3b.html#d-perform-entity-resolution-with-broadcast-variables">3d) Perform Entity Resolution with Broadcast Variables</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab3b.html#e-perform-a-gold-standard-evaluation">3e) Perform a Gold Standard evaluation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab3b.html#using-the-gold-standard-data-we-can-answer-the-following-questions">Using the &#8220;gold standard&#8221; data we can answer the following questions</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs110_lab3b.html#part-4-scalable-er">Part 4: Scalable ER</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab3b.html#inverted-indices">Inverted Indices</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab3b.html#a-tokenize-the-full-dataset">4a) Tokenize the full dataset</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab3b.html#b-compute-idfs-and-tf-idfs-for-the-full-datasets">4b) Compute IDFs and TF-IDFs for the full datasets</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab3b.html#c-compute-norms-for-the-weights-from-the-full-datasets">4c) Compute Norms for the weights from the full datasets</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab3b.html#d-create-inverted-indices-from-the-full-datasets">4d) Create inverted indices from the full datasets</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab3b.html#e-identify-common-tokens-from-the-full-dataset">4e) Identify common tokens from the full dataset</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab3b.html#f-identify-common-tokens-from-the-full-dataset">4f) Identify common tokens from the full dataset</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs110_lab3b.html#part-5-analysis">Part 5: Analysis</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab3b.html#a-counting-true-positives-false-positives-and-false-negatives">5a) Counting True Positives, False Positives, and False Negatives</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab3b.html#b-precision-recall-and-f-measures">5b Precision, Recall, and F-measures</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs110_lab3b.html#c-line-plots">5c Line Plots</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs110_lab3b.html#discussion-of-results">Discussion of results</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/cs120_lab1a.html">cs120 Lab - Math_review</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs120_lab1a.html#math-review">Math review</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab1a.html#exercise-1a-scalar-multiplication-vectors">Exercise (1a) Scalar multiplication: vectors</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab1a.html#exercise-1b-element-wise-multiplication-vectors">Exercise (1b) Element-wise multiplication: vectors</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab1a.html#exercise-1c-dot-product">Exercise (1c) Dot product</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab1a.html#exercise-1d-matrix-multiplication">Exercise (1d) Matrix multiplication</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs120_lab1a.html#numpy">NumPy</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab1a.html#exercise-2a-scalar-multiplication">Exercise (2a) Scalar multiplication</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab1a.html#exercise-2b-element-wise-multiplication-and-dot-product">Exercise (2b) Element-wise multiplication and dot product</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab1a.html#exercise-2c-matrix-math">Exercise (2c) Matrix math</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs120_lab1a.html#additional-numpy-and-spark-linear-algebra">Additional NumPy and Spark linear algebra</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab1a.html#exercise-3a-slices">Exercise (3a) Slices</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab1a.html#exercise-3b-combining-ndarray-objects">Exercise (3b) Combining ndarray objects</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab1a.html#exercise-3c-pyspark-s-densevector">Exercise (3c) PySpark&#8217;s DenseVector</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs120_lab1a.html#python-lambda-expressions">Python lambda expressions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab1a.html#exercise-4a-lambda-is-an-anonymous-function">Exercise (4a) Lambda is an anonymous function</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab1a.html#exercise-4b-lambda-fewer-steps-than-def">Exercise (4b) lambda fewer steps than def</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab1a.html#exercise-4c-lambda-expression-arguments">Exercise (4c) Lambda expression arguments</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab1a.html#exercise-4d-restrictions-on-lambda-expressions">Exercise (4d) Restrictions on lambda expressions</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab1a.html#exercise-4e-functional-programming">Exercise (4e) Functional programming</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab1a.html#exercise-4f-composability">Exercise (4f) Composability</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/cs120_lab1b.html">cs120 - Word Count Lab in RDD</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs120_lab1b.html#part-1-creating-a-base-rdd-and-pair-rdds">Part 1: Creating a base RDD and pair RDDs</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab1b.html#b-pluralize-and-test">1b) Pluralize and test</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab1b.html#c-apply-makeplural-to-the-base-rdd">1c) Apply makePlural to the base RDD</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab1b.html#d-pass-a-lambda-function-to-map">1d) Pass a lambda function to map</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab1b.html#e-length-of-each-word">1e) Length of each word</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab1b.html#f-pair-rdds">1f) Pair RDDs</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs120_lab1b.html#part-2-counting-with-pair-rdds">Part 2: Counting with pair RDDs</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab1b.html#a-groupbykey-approach">2a) <code class="docutils literal"><span class="pre">groupByKey()</span></code> approach</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab1b.html#b-use-groupbykey-to-obtain-the-counts">2b) Use <code class="docutils literal"><span class="pre">groupByKey()</span></code> to obtain the counts</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab1b.html#c-counting-using-reducebykey">2c) Counting using <code class="docutils literal"><span class="pre">reduceByKey</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab1b.html#d-all-together">2d) All together</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs120_lab1b.html#part-3-finding-unique-words-and-a-mean-value">Part 3: Finding unique words and a mean value</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab1b.html#a-unique-words">3a) Unique words</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab1b.html#b-mean-using-reduce">3b) Mean using <code class="docutils literal"><span class="pre">reduce</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs120_lab1b.html#part-4-apply-word-count-to-a-file">Part 4: Apply word count to a file</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab1b.html#a-wordcount-function">4a) <code class="docutils literal"><span class="pre">wordCount</span></code> function</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab1b.html#b-capitalization-and-punctuation">4b) Capitalization and punctuation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab1b.html#c-load-a-text-file">4c) Load a text file</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab1b.html#d-words-from-lines">4d) Words from lines</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab1b.html#e-remove-empty-elements">4e) Remove empty elements</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab1b.html#f-count-the-words">4f) Count the words</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/cs120_lab2.html">cs120 - Linear Regression with DataFrames</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs120_lab2.html#part-1-read-and-parse-the-initial-dataset">Part 1: Read and parse the initial dataset</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab2.html#a-load-and-check-the-data">1a) Load and check the data</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab2.html#b-using-labeledpoint">1b) Using LabeledPoint</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab2.html#visualization-1-features">Visualization 1: Features</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab2.html#c-find-the-range">1c) Find the range</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab2.html#d-shift-labels">1d) Shift labels</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab2.html#visualization-2-shifting-labels">Visualization 2: Shifting labels</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab2.html#e-training-validation-and-test-sets">1e) Training, validation, and test sets</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs120_lab2.html#part-2-create-and-evaluate-a-baseline-model">Part 2: Create and evaluate a baseline model</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab2.html#a-average-label">2a) Average label</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab2.html#b-root-mean-squared-error">2b) Root mean squared error</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab2.html#c-training-validation-and-test-rmse">2c) Training, validation and test RMSE</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab2.html#visualization-3-predicted-vs-actual">Visualization 3: Predicted vs. actual</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs120_lab2.html#part-3-train-via-gradient-descent-and-evaluate-a-linear-regression-model">Part 3: Train (via gradient descent) and evaluate a linear regression model</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab2.html#a-gradient-summand">3a) Gradient summand</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab2.html#b-use-weights-to-make-predictions">3b) Use weights to make predictions</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab2.html#c-gradient-descent">3c) Gradient descent</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab2.html#d-train-the-model">3d) Train the model</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab2.html#visualization-4-training-error">Visualization 4: Training error</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs120_lab2.html#part-4-train-using-sparkml-and-perform-grid-search">Part 4: Train using SparkML and perform grid search</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab2.html#a-linearregression">4a) LinearRegression</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab2.html#b-transform">4b) Transform</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab2.html#c-evaluate-rmse">4c) Evaluate RMSE</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab2.html#d-grid-search">4d) Grid search</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab2.html#visualization-5-best-model-s-predictions">Visualization 5: Best model&#8217;s predictions</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab2.html#visualization-6-hyperparameter-heat-map">Visualization 6: Hyperparameter heat map</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs120_lab2.html#part-5-add-interactions-between-features">Part 5: Add interactions between features</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab2.html#a-add-2-way-interactions">5a) Add 2-way interactions</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab2.html#b-build-interaction-model">5b) Build interaction model</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab2.html#c-evaluate-interaction-model-on-test-data">5c) Evaluate interaction model on test data</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab2.html#d-use-a-pipeline-to-create-the-interaction-model">5d) Use a pipeline to create the interaction model</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/cs120_lab3.html">cs120_lab3_ctr_df</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/cs120_lab4.html">cs120 - PCA on Neuroscience Data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs120_lab4.html#work-through-the-steps-of-pca-on-a-sample-dataset">Work through the steps of PCA on a sample dataset</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab4.html#visualization-1-two-dimensional-gaussians">Visualization 1: Two-dimensional Gaussians</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab4.html#a-interpreting-pca">1a) Interpreting PCA</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab4.html#b-sample-covariance-matrix">1b) Sample covariance matrix</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab4.html#c-covariance-function">1c) Covariance Function</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab4.html#d-eigendecomposition">1d) Eigendecomposition</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab4.html#e-pca-scores">1e) PCA scores</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs120_lab4.html#write-a-pca-function-and-evaluate-pca-on-sample-datasets">Write a PCA function and evaluate PCA on sample datasets</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab4.html#a-pca-function">2a) PCA function</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab4.html#b-pca-on-data-random">2b) PCA on data_random</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab4.html#visualization-2-pca-projection">Visualization 2: PCA projection</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab4.html#visualization-3-three-dimensional-data">Visualization 3: Three-dimensional data</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab4.html#c-3d-to-2d">2c) 3D to 2D</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab4.html#visualization-4-2d-representation-of-3d-data">Visualization 4: 2D representation of 3D data</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab4.html#d-variance-explained">2d) Variance explained</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs120_lab4.html#parse-inspect-and-preprocess-neuroscience-data-then-perform-pca">Parse, inspect, and preprocess neuroscience data then perform PCA</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab4.html#a-load-neuroscience-data">3a) Load neuroscience data</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab4.html#b-parse-the-data">3b) Parse the data</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab4.html#c-min-and-max-fluorescence">3c) Min and max fluorescence</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab4.html#visualization-5-pixel-intensity">Visualization 5: Pixel intensity</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab4.html#d-fractional-signal-change">3d) Fractional signal change</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab4.html#visualization-6-normalized-data">Visualization 6: Normalized data</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab4.html#e-pca-on-the-scaled-data">3e) PCA on the scaled data</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab4.html#visualization-7-top-two-components-as-images">Visualization 7: Top two components as images</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab4.html#visualization-8-top-two-components-as-one-image">Visualization 8: Top two components as one image</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/cs120_lab4.html#feature-based-aggregation-and-pca">Feature-based aggregation and PCA</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab4.html#a-aggregation-using-arrays">(4a) Aggregation using arrays</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab4.html#b-recreate-with-np-tile-and-np-eye">(4b) Recreate with np.tile and np.eye</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab4.html#c-recreate-with-np-kron">(4c) Recreate with np.kron</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab4.html#d-aggregate-by-time">(4d) Aggregate by time</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab4.html#e-obtain-a-compact-representation">(4e) Obtain a compact representation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab4.html#visualization-9-top-two-components-by-time">Visualization 9: Top two components by time</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab4.html#f-aggregate-by-direction">(4f) Aggregate by direction</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab4.html#g-compact-representation-of-direction-data">(4g) Compact representation of direction data</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pyspark/cs120_lab4.html#visualization-10-top-two-components-by-direction">Visualization 10: Top two components by direction</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../pyspark/pyspark-aws.html">PySpark on AWS (<code class="docutils literal"><span class="pre">pyspark-aws</span></code>)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/pyspark-aws.html#setting-up-aws-and-pyspark">Setting up AWS and PySpark</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/pyspark-aws.html#create-iam-user-key">Create IAM user key</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/pyspark-aws.html#create-admin-group-and-user">Create admin group and user</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/pyspark-aws.html#setup-an-s3-bucket">Setup an S3 Bucket</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/pyspark-aws.html#create-wordcount-script-to-submit">Create wordcount script to submit</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/pyspark-aws.html#create-emr-cluster">Create EMR cluster</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/pyspark-aws.html#run-spark-application-on-emr">Run Spark application on EMR</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/pyspark-aws.html#setup-pyspark-in-ipython-profile">Setup pyspark in ipython profile</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/pyspark-aws.html#finally-worked">Finally worked!</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/pyspark-aws.html#wrong-java-version">Wrong java version?</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/pyspark-aws.html#pyspark-options-giving-errors">pyspark options giving errors...</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/pyspark-aws.html#update-scala">Update scala?</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/pyspark-aws.html#rough-drafts">rough drafts</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/pyspark-aws.html#failed-windows-try">Failed Windows Try</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/pyspark-aws.html#windows">windows?</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/pyspark-aws.html#retry-above-is-a-disaster">Retry, above is a disaster</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../pyspark/pyspark-overflow.html"><code class="docutils literal"><span class="pre">pyspark-overflow.rst</span></code></a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/pyspark-overflow.html#how-to-get-a-value-from-the-row-object-in-spark-dataframe">How to get a value from the Row object in Spark Dataframe?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/pyspark-overflow.html#how-to-add-a-constant-column-in-a-spark-dataframe">How to add a constant column in a Spark DataFrame?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/pyspark-overflow.html#add-an-empty-column-to-spark-dataframe">Add an empty column to Spark DataFrame</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/pyspark-overflow.html#count-number-of-non-nan-entries-in-each-column-of-spark-dataframe">Count number of non-NaN entries in each column of Spark dataframe</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/pyspark-overflow.html#use-simple-aggregation">Use simple aggregation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/pyspark-overflow.html#use-sql-null-semantics">Use SQL <code class="docutils literal"><span class="pre">NULL</span></code> semantics</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/pyspark-overflow.html#in-fractions">In fractions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/pyspark-overflow.html#updating-a-dataframe-column-in-spark">Updating a dataframe column in spark</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/pyspark-overflow.html#how-do-i-add-a-new-column-to-spark-data-frame-pyspark">How do I add a new column to spark data frame (Pyspark)?</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/pyspark-overflow.html#use-literals-lit">Use literals <code class="docutils literal"><span class="pre">lit</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/pyspark-overflow.html#transforming-an-existing-column">Transforming an existing column</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/pyspark-overflow.html#using-join">Using <code class="docutils literal"><span class="pre">join</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/pyspark-overflow.html#using-function-udf">Using function/UDF</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/pyspark-overflow.html#how-to-change-dataframe-column-names-in-pyspark">How to change dataframe column names in pyspark?</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/pyspark-overflow.html#option-1-using-selectexpr">Option 1. Using selectExpr.</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/pyspark-overflow.html#option-2-using-withcolumnrenamed">Option 2. Using <code class="docutils literal"><span class="pre">withColumnRenamed</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/pyspark-overflow.html#using-alias">Using alias</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/pyspark-overflow.html#using-sqlcontext-sql">Using <code class="docutils literal"><span class="pre">sqlContext.sql</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/pyspark-overflow.html#pyspark-dataframes-way-to-enumerate-without-converting-to-pandas">PySpark DataFrames - way to enumerate without converting to Pandas?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/pyspark-overflow.html#dividing-two-columns-from-a-different-df">Dividing two columns from a different DF</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/pyspark-overflow.html#ones-i-just-bookmarked-for-future-reference">Ones I just bookmarked for future reference</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/pyspark-overflow.html#reshaping-pivoting-data-in-spark-rdd-and-or-spark-dataframes">Reshaping/Pivoting data in Spark RDD and/or Spark DataFrames</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../pyspark/pyspark-snippet.html"><code class="docutils literal"><span class="pre">pyspark-snippet.rst</span></code></a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/pyspark-snippet.html#data-from-application-examples-on-db-workspace">Data from <em>Application Examples</em> on DB Workspace</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/pyspark-snippet.html#list-out-datasets-important">List out datasets (Important)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/pyspark-snippet.html#create-sample-json-file">Create sample JSON file</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/pyspark-snippet.html#tables">Tables</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/pyspark-snippet.html#random-data-io">Random data-io</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/pyspark-snippet.html#diamonds">Diamonds</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/pyspark-snippet.html#february-2015-english-wikipedia-clickstream-data">February 2015 English Wikipedia Clickstream data</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/pyspark-snippet.html#dbf">DBF</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/pyspark-snippet.html#modules">Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/pyspark-snippet.html#spark-notebook-helpers-library-for-databricks">spark_notebook_helpers library for Databricks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/pyspark-snippet.html#create-toy-dataset">Create toy dataset</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/pyspark-snippet.html#print-rdd-per-item">Print RDD per item</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/pyspark-snippet.html#databrick-helper-function-displaying-all-dfs-in-the-notebook">Databrick helper function displaying all DFs in the notebook</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/pyspark-snippet.html#get-shape-of-df-gotta-be-a-better-way">Get shape of DF (gotta be a better way)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/pyspark-snippet.html#random-snippets">Random snippets</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/pyspark-snippet.html#print-dataframes-in-my-workspace-super-ad-hoc">print dataframes in my workspace (super-ad-hoc)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/pyspark-snippet.html#rename-column">Rename column</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/pyspark-snippet.html#dbutils">dbutils</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/pyspark-snippet.html#random-from-spark-essentials-spark-summit-2016">Random from Spark Essentials (Spark Summit 2016)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/pyspark-snippet.html#spark-for-data-scientists">Spark for Data Scientists</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/pyspark-snippet.html#tax-data">Tax Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/pyspark-snippet.html#farmer-s-market-data">Farmer&#8217;s market data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/pyspark-snippet.html#run-some-sql-create-tables">Run some sql, create tables</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/pyspark-snippet.html#cache-table-in-sql-or-sqlcontext">cache table in SQL or sqlContext</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../pyspark/pyspark-practice.html"><code class="docutils literal"><span class="pre">pyspark-practice.rst</span></code></a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/pyspark-practice.html#basics-dfs">Basics DFs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/pyspark-practice.html#udfs">UDFs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/pyspark-practice.html#sorting">Sorting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/pyspark-practice.html#create-df-from-list-of-tuples">Create DF from list of tuples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/pyspark-practice.html#groupby">groupby</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/pyspark-practice.html#practice-with-faker-data">Practice with faker data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../pyspark/pyspark-practice.html#little-refrehser-on-generators">Little refrehser on generators</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/pyspark-practice.html#register-table-to-use-sql">Register table to use SQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../pyspark/pyspark-practice.html#more">More</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">R Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../R/ds-R.html">R notes (<code class="docutils literal"><span class="pre">ds-R.rst</span></code>)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../R/control_var2.html">1 Controlling Confounds (with xtable)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../R/control_var2.html#set-variables">1.1 set variables</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/control_var2.html#regression">1.2 regression</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../R/control_var2.html#lm1-without-controlling-for-weight-weight">1.2.1 lm1: without controlling for weight(weight)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../R/control_var2.html#lm2-here-we-control-for-weight">1.2.2 lm2: here we control for weight</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../R/control_var2.html#in-case-you-want-to-add-the-fitted-lines-to-the-plot">1.2.3 In case you want to add the fitted lines to the plot</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../R/sva_demo_jtleek2.html">2 R code from Jeff Leek&#8217;s page</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../R/sva_demo_jtleek2.html#dependencies">2.1 Dependencies</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/sva_demo_jtleek2.html#download-the-data">2.2 Download the data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/sva_demo_jtleek2.html#set-up-the-data">2.3 Set up the data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/sva_demo_jtleek2.html#adjusting-for-batch-effects-with-a-linear-model">2.4 Adjusting for batch effects with a linear model</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/sva_demo_jtleek2.html#adjusting-for-batch-effects-with-combat">2.5 Adjusting for batch effects with Combat</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/sva_demo_jtleek2.html#comparing-combat-and-linear-adjustment">2.6 Comparing Combat and linear adjustment</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/sva_demo_jtleek2.html#adjusting-for-batch-effects-with-sva">2.7 Adjusting for batch effects with sva</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/sva_demo_jtleek2.html#principal-components-for-population-structure">2.8 Principal components for population structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/sva_demo_jtleek2.html#notes-and-further-resources">2.9 Notes and further resources</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../R/t_1104b_combat_pca.html">3 Site-correction with ComBat - PCA analysis</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../R/t_1104b_combat_pca.html#load-data">3.1 Load data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/t_1104b_combat_pca.html#scale-normalize-data">3.2 Scale normalize data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/t_1104b_combat_pca.html#study-pca-of-scale-normalized-data">3.3 Study pca of scale normalized data</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../R/t_1104b_combat_pca.html#scattermatrix-plot">3.3.1 scattermatrix plot</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../R/t_1104b_combat_pca.html#scatter-matrix-using-lattice-splom">3.3.2 Scatter-matrix using <code class="docutils literal"><span class="pre">lattice::splom</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/t_1104b_combat_pca.html#correct-site-effect-via-running-combat-on-normalized-data">3.4 Correct site-effect via running ComBat on normalized data</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../R/t_1104b_combat_pca.html#repeat-pca-plot-after-site-correction">3.4.1 Repeat pca plot after site-correction</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/t_1104b_combat_pca.html#save-combat-corrected-data-matrix">3.5 Save ComBat corrected data-matrix</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../R/dave-langer/TitanicDataAnalysis_Video7.html">4 Introduction to Data Science with R</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../R/dave-langer/TitanicDataAnalysis_Video7.html#video1-data-analysis-part-1">4.1 Video1 - Data Analysis Part 1</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/dave-langer/TitanicDataAnalysis_Video7.html#video2-data-analysis-part-2">4.2 Video2 - Data Analysis Part 2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/dave-langer/TitanicDataAnalysis_Video7.html#video3-data-analysis-part-3">4.3 Video3 - Data Analysis Part 3</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/dave-langer/TitanicDataAnalysis_Video7.html#video4-exploratory-modeling-random-forests">4.4 Video4 - Exploratory Modeling (Random Forests)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../R/dave-langer/TitanicDataAnalysis_Video7.html#train-a-random-forest-with-the-default-parameters-using-pclass-title">4.4.1 Train a Random Forest with the default parameters using pclass &amp; title</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../R/dave-langer/TitanicDataAnalysis_Video7.html#train-a-random-forest-using-pclass-title-sibsp">4.4.2 Train a Random Forest using pclass, title, &amp; sibsp</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../R/dave-langer/TitanicDataAnalysis_Video7.html#train-a-random-forest-using-pclass-title-parch">4.4.3 Train a Random Forest using pclass, title, &amp; parch</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../R/dave-langer/TitanicDataAnalysis_Video7.html#train-a-random-forest-using-pclass-title-sibsp-parch">4.4.4 Train a Random Forest using pclass, title, sibsp, parch</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../R/dave-langer/TitanicDataAnalysis_Video7.html#train-a-random-forest-using-pclass-title-family-size">4.4.5 Train a Random Forest using pclass, title, &amp; family.size</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../R/dave-langer/TitanicDataAnalysis_Video7.html#train-a-random-forest-using-pclass-title-sibsp-family-size">4.4.6 Train a Random Forest using pclass, title, sibsp, &amp; family.size</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../R/dave-langer/TitanicDataAnalysis_Video7.html#train-a-random-forest-using-pclass-title-parch-family-size">4.4.7 Train a Random Forest using pclass, title, parch, &amp; family.size</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/dave-langer/TitanicDataAnalysis_Video7.html#video5-cross-validation">4.5 Video5 - Cross Validation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/dave-langer/TitanicDataAnalysis_Video7.html#video6-exploratory-modeling-2">4.6 Video6 - Exploratory Modeling 2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/dave-langer/TitanicDataAnalysis_Video7.html#video7-submitting-scoring-and-some-analysis">4.7 Video7 Submitting, scoring, and some analysis</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../R-ISL/R-ISL.html">R - Labs from ISL (<code class="docutils literal"><span class="pre">R-ISL</span></code>)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../R-ISL/ch2.html">Ch2 Introduction to R</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../R-ISL/ch2.html#basic-commands">Basic Commands</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R-ISL/ch2.html#graphics">Graphics</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R-ISL/ch2.html#indexing-data">Indexing Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R-ISL/ch2.html#loading-data">Loading Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R-ISL/ch2.html#additional-graphical-and-numerical-summaries">Additional Graphical and Numerical Summaries</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../R-ISL/ch3.html">Ch3 Linear Regression</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../R-ISL/ch3.html#simple-linear-regression">Simple Linear Regression</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R-ISL/ch3.html#multiple-linear-regression">Multiple Linear Regression</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../R-ISL/ch3.html#interaction-terms">Interaction Terms</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../R-ISL/ch3.html#qualitative-predictors">Qualitative Predictors</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R-ISL/ch3.html#writing-functions">Writing Functions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../R-ISL/ch4.html">Ch4 Logistic Regression, LDA, QDA, and KNN</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../R-ISL/ch4.html#the-stock-market-data">The Stock Market Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R-ISL/ch4.html#logistic-regression">Logistic Regression</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R-ISL/ch4.html#linear-discriminant-analysis">Linear Discriminant Analysis</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R-ISL/ch4.html#quadratic-discriminant-analysis">Quadratic Discriminant Analysis</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R-ISL/ch4.html#k-nearest-neighbors">K-Nearest Neighbors</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R-ISL/ch4.html#an-application-to-caravan-insurance-data">An Application to Caravan Insurance Data</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../R-ISL/ch5.html">Ch5 Cross-Validation and the Bootstrap</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../R-ISL/ch5.html#the-validation-set-approach">The Validation Set Approach</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R-ISL/ch5.html#leave-one-out-cross-validation">Leave-One-Out Cross-Validation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R-ISL/ch5.html#k-fold-cross-validation">k-Fold Cross-Validation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R-ISL/ch5.html#the-bootstrap">The Bootstrap</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R-ISL/ch5.html#estimating-the-accuracy-of-a-linear-regression-model">Estimating the Accuracy of a Linear Regression Model</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../R-ISL/ch6.html">Ch6 Linear Model Selection and Regularization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../R-ISL/ch6.html#lab-1-subset-selection-methods">Lab 1: Subset Selection Methods</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../R-ISL/ch6.html#best-subset-selection">Best Subset Selection</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../R-ISL/ch6.html#forward-and-backward-stepwise-selection">Forward and Backward Stepwise Selection</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../R-ISL/ch6.html#choosing-among-models">Choosing Among Models</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../R-ISL/ch6.html#lab-2-ridge-regression-and-the-lasso">Lab 2: Ridge Regression and the Lasso</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../R-ISL/ch6.html#ridge-regression">Ridge Regression</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../R-ISL/ch6.html#the-lasso">The Lasso</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../R-ISL/ch6.html#lab-3-pcr-and-pls-regression">Lab 3: PCR and PLS Regression</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../R-ISL/ch6.html#principal-components-regression">Principal Components Regression</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../R-ISL/ch6.html#partial-least-squares">Partial Least Squares</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../R-ISL/ch7.html">Ch7 Non-linear Modeling</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../R-ISL/ch7.html#polynomial-regression-and-step-functions">Polynomial Regression and Step Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R-ISL/ch7.html#splines">Splines</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R-ISL/ch7.html#gams">GAMs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../R-ISL/ch8.html">Ch8 Tree-Based Methods</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../R-ISL/ch8.html#fitting-classification-trees">Fitting Classification Trees</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R-ISL/ch8.html#bagging-and-random-forests">Bagging and Random Forests</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R-ISL/ch8.html#boosting">Boosting</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../R-ISL/ch9.html">Ch9 Support Vector Machines</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../R-ISL/ch9.html#support-vector-classifier">Support Vector Classifier</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R-ISL/ch9.html#support-vector-machine">Support Vector Machine</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R-ISL/ch9.html#roc-curves">ROC Curves</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R-ISL/ch9.html#svm-with-multiple-classes">SVM with Multiple Classes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R-ISL/ch9.html#application-to-gene-expression-data">Application to Gene Expression Data</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../R-ISL/ch10.html">Ch10 Unsupervised Learning</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../R-ISL/ch10.html#lab-1-principal-components-analysis">Lab 1: Principal Components Analysis</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R-ISL/ch10.html#lab-2-clustering">Lab 2: Clustering</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../R-ISL/ch10.html#k-means-clustering">K-Means Clustering</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../R-ISL/ch10.html#hierarchical-clustering">Hierarchical Clustering</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../R-ISL/ch10.html#lab-3-nci60-data-example">Lab 3: NCI60 Data Example</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../R-ISL/ch10.html#the-nci60-data">The NCI60 data</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../R-ISL/ch10.html#pca-on-the-nci60-data">PCA on the NCI60 Data</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../R-ISL/ch10.html#clustering-the-observations-of-the-nci60-data">Clustering the Observations of the NCI60 Data</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../R/ggplot/top-ggplot.html">ggplot-examples (<code class="docutils literal"><span class="pre">top-ggplot.rst</span></code>)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../R/ggplot/qplot.html">Ch2. Getting startd with qplot</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../R/ggplot/qplot.html#the-diamonds-dataset">The Diamonds dataset</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/ggplot/qplot.html#basic-use">2.3 Basic use</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/ggplot/qplot.html#color-size-shape-and-other-aesthetic-attributes">2.4 Color, size, shape, and other aesthetic attributes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/ggplot/qplot.html#plot-geoms">2.5 Plot geoms</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../R/ggplot/qplot.html#add-a-smoother-to-plot">2.5.1 Add a smoother to plot</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../R/ggplot/qplot.html#boxplots-and-jittered-points">2.5.2 Boxplots and jittered points</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../R/ggplot/qplot.html#histogram-and-density-plots">2.5.3 Histogram and density plots</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../R/ggplot/qplot.html#bar-charts">2.5.4 Bar charts</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../R/ggplot/qplot.html#time-series-with-line-and-path-plots">2.5.5 Time series with line and path plots</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/ggplot/qplot.html#faceting">2.6 Faceting</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../R/ggplot/mastery.html">Ch3. Mastering the Grammar</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../R/ggplot/mastery.html#fuel-economy-date">3.2 Fuel economy date</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/ggplot/mastery.html#building-a-scatterplot">3.3 Building a scatterplot</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../R/ggplot/mastery.html#mapping-aesthetics-to-data">Mapping aesthetics to data</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/ggplot/mastery.html#a-more-complex-plot">3.4 A more complex plot</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/ggplot/mastery.html#data-structures">3.6 Data structures</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../R/ggplot/ch4_layers.html">Ch4. Build a plot layer by layer</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../R/ggplot/ch4_layers.html#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/ggplot/ch4_layers.html#building-a-plot">Building a plot</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/ggplot/ch4_layers.html#data">Data</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../R/ggplot/ch4_layers.html#exercises">Exercises</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/ggplot/ch4_layers.html#aesthetic-mappings">Aesthetic mappings</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../R/ggplot/ch4_layers.html#specifying-the-aesthetics-in-the-plot-vs-in-the-layers">Specifying the aesthetics in the plot vs. in the layers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../R/ggplot/ch4_layers.html#setting-vs-mapping">Setting vs. mapping</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../R/ggplot/ch4_layers.html#id19">Exercises</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/ggplot/ch4_layers.html#geoms">Geoms</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../R/ggplot/ch4_layers.html#id26">Exercises</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/ggplot/ch4_layers.html#stats">Stats</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../R/ggplot/ch4_layers.html#generated-variables">Generated variables</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../R/ggplot/ch4_layers.html#id33">Exercises</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/ggplot/ch4_layers.html#position-adjustments">Position adjustments</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../R/ggplot/ch4_layers.html#id54">Exercises</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../R/ggplot-book/ggplot-book.html">ggplot-book (<code class="docutils literal"><span class="pre">ggplot-book.rst</span></code>)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../R/ggplot-book/ch1-introduction.html">Ch1 Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../R/ggplot-book/ch2-getting-started.html">Ch2 Getting started with ggplot2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../R/ggplot-book/ch3-toolbox.html">Ch3 Toolbox</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../R/ggplot-book/ch4-mastery.html">Ch4 Mastering the grammar</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../R/ggplot-book/ch5-layers.html">Ch5 Build a plot layer by layer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../R/ggplot-book/ch6-scales.html">Ch6 Scales, axes, and legends</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../R/ggplot-book/ch7-position.html">Ch7 Positioning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../R/ggplot-book/ch8-themes.html">Ch8 Themes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../R/ggplot-book/ch9-tidy-data.html">Ch9 Data analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../R/ggplot-book/ch10-data-manip.html">Ch10 Data transformation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../R/ggplot-book/ch11-modelling.html">Ch11 Modelling for visualisation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../R/ggplot-book/ch12-programming.html">Ch12 Programming with ggplot2</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../R/lattice-R-book/lattice-R.html">lattice plot examples (<code class="docutils literal"><span class="pre">lattice-R.rst</span></code>)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../R/lattice-R-book/ch1.html">Ch1 - Introduction</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch1.html#figure-1-1-conditional-histogram">Figure 1.1 (conditional histogram)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch1.html#figure-1-2-conditional-density-plot">Figure 1.2 (conditional density plot)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch1.html#figure-1-3-grouped-kde-plot">Figure 1.3 (grouped kde plot)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch1.html#figure-1-4-conditional-histogram-and-kde-grouped-in-a-single-figure">Figure 1.4 (conditional histogram and kde grouped in a single figure)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../R/lattice-R-book/ch2.html">Ch2 - A Technical Overview</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch2.html#dimension-and-physical-layout">Dimension and Physical Layout</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../R/lattice-R-book/ch2.html#figure-2-1-a-trelis-display-of-the-data-object">Figure 2.1 (A Trelis display of the <strong>Data</strong> Object)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../R/lattice-R-book/ch2.html#figure-2-2-subset-display-of-the-trellis-object">Figure 2.2 (subset display of the Trellis object)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../R/lattice-R-book/ch2.html#figure-2-3-aspect-ratio-control">Figure 2.3 (aspect ratio control)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../R/lattice-R-book/ch2.html#figure-2-4">Figure 2.4</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../R/lattice-R-book/ch2.html#figure-2-5-fig-2-5-with-spacing-between-column-blocks">Figure 2.5 (fig 2.5 with spacing between column blocks)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch2.html#grouped-displays">Grouped displays</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../R/lattice-R-book/ch2.html#figure-2-6">Figure 2.6</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch2.html#annotation-captions-labels-and-legends">Annotation: Captions, labels, and legends</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../R/lattice-R-book/ch2.html#figure-2-7">Figure 2.7</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch2.html#scale-and-axes">Scale and Axes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../R/lattice-R-book/ch2.html#figure-2-8">Figure 2.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../R/lattice-R-book/ch2.html#figure-2-9">Figure 2.9</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch2.html#the-panel-function">The Panel function</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../R/lattice-R-book/ch2.html#figure-2-10">Figure 2.10</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../R/lattice-R-book/ch2.html#figure-2-11">Figure 2.11</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../R/lattice-R-book/ch3.html">Ch3 - Displaying Univariate Distributions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch3.html#datasets-used-in-this-chapter">Datasets used in this Chapter</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../R/lattice-R-book/ch3.html#faithful">faithful</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../R/lattice-R-book/ch3.html#gvhd10">gvhd10</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../R/lattice-R-book/ch3.html#chem97">Chem97</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../R/lattice-R-book/ch3.html#quakes">quakes</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../R/lattice-R-book/ch3.html#barley">barley</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch3.html#density-plot">Density plot</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../R/lattice-R-book/ch3.html#figure-3-1">Figure 3.1</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../R/lattice-R-book/ch3.html#figure-3-2">Figure 3.2</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../R/lattice-R-book/ch3.html#figure-3-3">Figure 3.3</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch3.html#histograms">Histograms</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../R/lattice-R-book/ch3.html#figure-3-4">Figure 3.4</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch3.html#normal-qq-plots">Normal QQ Plots</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../R/lattice-R-book/ch3.html#figure-3-5">Figure 3.5</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../R/lattice-R-book/ch3.html#figure-3-6">Figure 3.6</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../R/lattice-R-book/ch3.html#figure-3-7">Figure 3.7</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch3.html#the-empirical-cdf">The empirical CDF</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../R/lattice-R-book/ch3.html#figure-3-8">Figure 3.8</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch3.html#two-sample-qq-plots">Two-sample QQ-plots</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../R/lattice-R-book/ch3.html#figure-3-9">Figure 3.9</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../R/lattice-R-book/ch3.html#figure-3-10">Figure 3.10</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch3.html#box-and-whisker-plots">Box-and-whisker plots</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../R/lattice-R-book/ch3.html#figure-3-11">Figure 3.11</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../R/lattice-R-book/ch3.html#figure-3-12">Figure 3.12</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../R/lattice-R-book/ch3.html#figure-3-13">Figure 3.13</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../R/lattice-R-book/ch3.html#figure-3-14">Figure 3.14</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch3.html#strip-plot">Strip plot</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../R/lattice-R-book/ch3.html#figure-3-15">Figure 3.15</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../R/lattice-R-book/ch3.html#figure-3-16">Figure 3.16</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../R/lattice-R-book/ch3.html#figure-3-17">Figure 3.17</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../R/lattice-R-book/ch4.html">Ch4 - Displaying Multiway Tables</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch4.html#figure-4-1">Figure 4.1</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch4.html#figure-4-2">Figure 4.2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch4.html#figure-4-3">Figure 4.3</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch4.html#figure-4-4">Figure 4.4</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch4.html#figure-4-5">Figure 4.5</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch4.html#figure-4-6">Figure 4.6</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch4.html#figure-4-7">Figure 4.7</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch4.html#figure-4-8">Figure 4.8</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch4.html#figure-4-9">Figure 4.9</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../R/lattice-R-book/ch5.html">Ch5 - Scatter Plots and Extensions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch5.html#figure-5-1">Figure 5.1</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch5.html#figure-5-2">Figure 5.2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch5.html#figure-5-3">Figure 5.3</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch5.html#figure-5-4">Figure 5.4</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch5.html#figure-5-5">Figure 5.5</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch5.html#figure-5-6">Figure 5.6</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch5.html#figure-5-7">Figure 5.7</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch5.html#figure-5-8">Figure 5.8</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch5.html#figure-5-9">Figure 5.9</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch5.html#figure-5-10">Figure 5.10</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch5.html#figure-5-11">Figure 5.11</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch5.html#figure-5-12">Figure 5.12</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch5.html#figure-5-13">Figure 5.13</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch5.html#figure-5-14">Figure 5.14</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch5.html#figure-5-15">Figure 5.15</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch5.html#figure-5-16">Figure 5.16</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch5.html#figure-5-17">Figure 5.17</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch5.html#figure-5-18">Figure 5.18</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch5.html#figure-5-19">Figure 5.19</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../R/lattice-R-book/ch6.html">Ch6 - Trivariate Displays</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch6.html#figure-6-1">Figure 6.1</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch6.html#figure-6-2">Figure 6.2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch6.html#figure-6-3">Figure 6.3</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch6.html#figure-6-4">Figure 6.4</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch6.html#figure-6-5">Figure 6.5</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch6.html#figure-6-6">Figure 6.6</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch6.html#figure-6-7">Figure 6.7</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch6.html#figure-6-8">Figure 6.8</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch6.html#figure-6-9">Figure 6.9</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch6.html#figure-6-10">Figure 6.10</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch6.html#figure-6-11">Figure 6.11</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch6.html#figure-6-12">Figure 6.12</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch6.html#figure-6-13">Figure 6.13</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch6.html#figure-6-14">Figure 6.14</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch6.html#figure-6-15">Figure 6.15</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch6.html#figure-6-16">Figure 6.16</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch6.html#figure-6-17">Figure 6.17</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch6.html#figure-6-18">Figure 6.18</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch6.html#figure-6-19">Figure 6.19</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../R/lattice-R-book/ch7.html">Ch7 - Graphical Parameters and Other Settings</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch7.html#figure-7-1">Figure 7.1</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch7.html#figure-7-2">Figure 7.2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch7.html#figure-7-2-alternative">Figure 7.2 (alternative)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch7.html#figure-7-3">Figure 7.3</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch7.html#figure-7-4">Figure 7.4</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../R/lattice-R-book/ch8.html">Ch8 - Plot Coordinates and Axis Annotation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch8.html#figure-8-1">Figure 8.1</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch8.html#figure-8-2">Figure 8.2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch8.html#figure-8-3">Figure 8.3</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch8.html#figure-8-4">Figure 8.4</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch8.html#figure-8-5">Figure 8.5</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch8.html#figure-8-6">Figure 8.6</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../R/lattice-R-book/ch9.html">Ch9 - Labels and Legends</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch9.html#figure-9-1">Figure 9.1</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch9.html#figure-9-1-alternative-using-auto-key">Figure 9.1 (alternative, using auto.key)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch9.html#figure-9-1-yet-another-alternative-using-drop-true">Figure 9.1 (yet another alternative, using drop=TRUE)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch9.html#figure-9-2">Figure 9.2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch9.html#figure-9-3">Figure 9.3</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../R/lattice-R-book/ch10.html">Ch10 - Data Manipulation and Related Topics</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch10.html#figure-10-1">Figure 10.1</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch10.html#figure-10-2">Figure 10.2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch10.html#figure-10-3">Figure 10.3</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch10.html#figure-10-4">Figure 10.4</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch10.html#figure-10-5">Figure 10.5</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch10.html#figure-10-6">Figure 10.6</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch10.html#figure-10-7">Figure 10.7</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch10.html#figure-10-8">Figure 10.8</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch10.html#figure-10-9">Figure 10.9</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch10.html#figure-10-10">Figure 10.10</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch10.html#figure-10-11">Figure 10.11</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch10.html#figure-10-12">Figure 10.12</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch10.html#figure-10-13">Figure 10.13</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch10.html#figure-10-14">Figure 10.14</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch10.html#figure-10-15">Figure 10.15</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch10.html#figure-10-16">Figure 10.16</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch10.html#figure-10-17">Figure 10.17</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch10.html#figure-10-18">Figure 10.18</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch10.html#figure-10-19">Figure 10.19</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch10.html#figure-10-20">Figure 10.20</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch10.html#figure-10-21">Figure 10.21</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch10.html#figure-10-22">Figure 10.22</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch10.html#figure-10-23">Figure 10.23</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch10.html#figure-10-24">Figure 10.24</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch10.html#figure-10-25">Figure 10.25</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../R/lattice-R-book/ch11.html">Ch11 - Manipulating the <em>trellis</em> object</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch11.html#figure-11-1">Figure 11.1</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch11.html#figure-11-2">Figure 11.2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch11.html#figure-11-3">Figure 11.3</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch11.html#figure-11-4">Figure 11.4</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch11.html#figure-11-5">Figure 11.5</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch11.html#figure-11-6">Figure 11.6</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../R/lattice-R-book/ch12.html">Ch12 - Interacting with Trellis Displays</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch12.html#figure-12-1">Figure 12.1</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch12.html#figure-12-2">Figure 12.2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch12.html#figure-12-3">Figure 12.3</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch12.html#figure-12-4">Figure 12.4</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch12.html#figure-12-5">Figure 12.5</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch12.html#figure-12-6">Figure 12.6</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../R/lattice-R-book/ch13.html">Ch13 - Advanced Panel Functions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch13.html#figure-13-1">Figure 13.1</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch13.html#figure-13-2">Figure 13.2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch13.html#figure-13-3">Figure 13.3</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch13.html#figure-13-4">Figure 13.4</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch13.html#figure-13-5">Figure 13.5</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch13.html#figure-13-6">Figure 13.6</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch13.html#figure-13-7">Figure 13.7</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch13.html#figure-13-8">Figure 13.8</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch13.html#figure-13-9">Figure 13.9</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch13.html#figure-13-10">Figure 13.10</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../R/lattice-R-book/ch14.html">Ch14 - New Trellis Displays</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch14.html#figure-14-1">Figure 14.1</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch14.html#figure-14-2">Figure 14.2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch14.html#figure-14-3">Figure 14.3</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch14.html#figure-14-4">Figure 14.4</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../R/lattice-R-book/ch14.html#figure-14-5">Figure 14.5</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Plotly demos</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../plotly_demos/top-plotly.html">Plotly demos</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_demos/choose_my_geolocator.html">Choose my Geolocator</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/choose_my_geolocator.html#try-to-pinpoint-huntsman-hall">Try to pinpoint Huntsman Hall</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/choose_my_geolocator.html#hmmm-that-s-pretty-off">Hmmm...that&#8217;s pretty off...</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/choose_my_geolocator.html#url-request-using-freegeopi">URL Request using freegeopi</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/choose_my_geolocator.html#that-s-also-quite-off">That&#8217;s also quite off....</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/choose_my_geolocator.html#try-geolocation-python">Try geolocation-python</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/choose_my_geolocator.html#success">Success!</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_demos/google_big_query.html">Google Big Query Demo</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/google_big_query.html#top-10-hacker-news-submissions-by-score">Top 10 Hacker News Submissions (by score)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/google_big_query.html#from-which-top-level-domain-tld-most-of-the-stories-come">From which Top-level domain (TLD) most of the stories come?</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/google_big_query.html#public-response-to-the-who-is-hiring-posts">Public response to the &#8220;Who Is Hiring?&#8221; posts</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/google_big_query.html#submission-traffic-volume-in-a-week">Submission Traffic Volume in a Week</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/google_big_query.html#programming-language-trend-on-hackernews">Programming Language Trend on HackerNews</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_demos/mysql_plotly.html">MySQL with Plotly</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/mysql_plotly.html#first-download-the-world-database">First download the world database</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/mysql_plotly.html#install-database-in-mysql">Install database in mysql</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/mysql_plotly.html#for-this-demo-create-user-with-all-privileges-to-this-world-database">For this demo, create user with all privileges to this <code class="docutils literal"><span class="pre">world</span></code> database</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/mysql_plotly.html#alright-we-are-in-business-let-s-analyze-this-database">Alright, we are in business. Let&#8217;s analyze this database!</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/mysql_plotly.html#create-pandas-dataframe">create pandas DataFrame</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/mysql_plotly.html#a-bit-of-data-cleansing">A bit of data cleansing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/mysql_plotly.html#plot-interactive-scatterplots">Plot interactive scatterplots!</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/mysql_plotly.html#prettify-the-above">prettify the above :)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_demos/plotly_sqlite.html">Plotly and SQLite</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/plotly_sqlite.html#create-database-file-on-disk-by-reading-in-subset-of-data">Create database file on disk by reading in subset of data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/plotly_sqlite.html#alright-let-s-preview-the-table">Alright, let&#8217;s preview the table</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/plotly_sqlite.html#k-let-s-do-some-plotly">K, let&#8217;s do some plotly</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/plotly_sqlite.html#housing-and-development-dept-receives-the-most-complaints">Housing and Development Dept receives the most complaints</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/plotly_sqlite.html#heat-hot-water-is-the-most-common-complaint">Heat / Hot Water is the most common complaint</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/plotly_sqlite.html#what-s-the-most-complain-in-each-city">What&#8217;s the most complain in each city?</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/plotly_sqlite.html#conclusion">Conclusion</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/plotly_sqlite.html#part2-slite3-timeseries-with-pandas">Part2: Slite3 timeseries with pandas</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/plotly_sqlite.html#filter-noise-complaints-by-hour">Filter noise complaints by hour</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/plotly_sqlite.html#segregate-complaints-by-hour">Segregate complaints by hour</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/plotly_sqlite.html#aggregate-time-series">Aggregate time series</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_demos/steph_curry_demo.html">Steph Curry Demo</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/steph_curry_demo.html#data-transformation-for-querying">Data Transformation for querying</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/steph_curry_demo.html#shot-locations">Shot locations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/steph_curry_demo.html#create-the-court">Create the court</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/steph_curry_demo.html#outer-lines">Outer Lines</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/steph_curry_demo.html#basketball-hoop">2. basketball hoop</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/steph_curry_demo.html#basket-backboard">Basket Backboard</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/steph_curry_demo.html#outer-box-of-three-second-area">Outer box of three-second area</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/steph_curry_demo.html#inner-box-of-three-second-area">Inner box of three-second area</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/steph_curry_demo.html#three-point-line-left">Three-point line (left)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/steph_curry_demo.html#three-point-line-right">Three-point line (right)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/steph_curry_demo.html#three-point-arc">Three-point arc</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/steph_curry_demo.html#center-circle">Center circle</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/steph_curry_demo.html#restraining-circe">Restraining circe</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/steph_curry_demo.html#free-throw-circle">Free-throw circle</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/steph_curry_demo.html#restricted-area">Restricted area</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/steph_curry_demo.html#chart-the-shots">Chart the shots</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/steph_curry_demo.html#good-stuff-let-s-save-in-plotly">Good stuff! let&#8217;s save in plotly</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_demos/spark-plotly.html">Spark demo with Plotly</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/spark-plotly.html#check-pyspark-is-loaded-correctly">Check pyspark is loaded correctly</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/spark-plotly.html#download-bike-data">Download bike data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/spark-plotly.html#register-dataframe-as-table-to-use-sql-commands">Register dataframe as table to use SQL commands!</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/spark-plotly.html#now-let-s-visualize">Now let&#8217;s visualize!</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos/spark-plotly.html#pyspark-dataframe-to-pandas-dataframe">PySpark Dataframe to Pandas Dataframe</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../plotly_pandas/top-plotly-pandas.html">Plotly &#8211; pandas</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - Pandas Like Visualization.html">Cufflinks - Pandas Like Visualization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - Pandas Like Visualization.html#themes">Themes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - Pandas Like Visualization.html#basic-line-plots-time-series">Basic line plots (time series)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - Pandas Like Visualization.html#bar-plots">Bar Plots</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - Pandas Like Visualization.html#multiple-bars">Multiple bars</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - Pandas Like Visualization.html#stacked-bars">Stacked bars</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - Pandas Like Visualization.html#horizontal-bars-kind-barh">Horizontal bars (kind=&#8217;barh&#8217;)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - Pandas Like Visualization.html#histograms">Histograms</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - Pandas Like Visualization.html#normalized-over-probability">Normalized over probability</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - Pandas Like Visualization.html#subplots">Subplots</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - Pandas Like Visualization.html#boxplots">Boxplots</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - Pandas Like Visualization.html#grouping-values">Grouping values</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - Pandas Like Visualization.html#area-plots">Area Plots</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - Pandas Like Visualization.html#scatter-plots">Scatter plots</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - Pandas Like Visualization.html#assign-color-via-dict-or-list">Assign color via dict or list</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - Pandas Like Visualization.html#use-size-to-set-bubble-size">Use size to set bubble size</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - Pandas Like Visualization.html#scattermatrix">Scattermatrix</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - Pandas Like Visualization.html#id3">Subplots</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - Pandas Like Visualization.html#irregular-shaped-subplots">irregular shaped subplots</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - Pandas Like Visualization.html#shapes">Shapes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - Pandas Like Visualization.html#other-shapes">Other shapes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - chart gallery.html">Cufflinks - chart gallery</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - chart gallery.html#line-chart">Line Chart</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - chart gallery.html#basic">Basic</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - chart gallery.html#filled-line-plot">Filled line plot</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - chart gallery.html#with-best-fit-line">With best fit line</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - chart gallery.html#scatter-chart">Scatter Chart</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - chart gallery.html#spread-chart">Spread Chart</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - chart gallery.html#bar-chart">Bar Chart</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - chart gallery.html#default">Default</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - chart gallery.html#stacked-bars">Stacked bars</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - chart gallery.html#box-plot">Box Plot</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - chart gallery.html#historgram">Historgram</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - chart gallery.html#heatmap-plot">Heatmap Plot</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - chart gallery.html#bubble-chart">Bubble Chart</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - chart gallery.html#scatter-3d">Scatter 3D</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - chart gallery.html#bubble-3d">Bubble 3D</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - chart gallery.html#surface">Surface</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - color management.html">Cufflinks - color management</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - color management.html#cufflinks-colors">Cufflinks Colors</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - color management.html#color-conversions">Color Conversions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - color management.html#normalization">Normalization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - color management.html#color-ranges">Color Ranges</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - color management.html#color-tables">Color Tables</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - color management.html#color-generators">Color Generators</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - tutorial from plotly (best).html">Cufflinks - tutorial from plotly (best)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - tutorial from plotly (best).html#intro">Intro</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - tutorial from plotly (best).html#python-version">Python version</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - tutorial from plotly (best).html#cufflinks-version">Cufflinks version</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - tutorial from plotly (best).html#scatter-matrix">scatter_matrix</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - tutorial from plotly (best).html#offline-mode">Offline mode</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - tutorial from plotly (best).html#change-default-config">Change default config</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - tutorial from plotly (best).html#chart-types">Chart Types</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - tutorial from plotly (best).html#line-charts">Line charts</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - tutorial from plotly (best).html#bar-charts">Bar charts</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - tutorial from plotly (best).html#plot-series-directly">Plot series directly</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - tutorial from plotly (best).html#plot-a-dataframe-row-as-a-bar">Plot a dataframe row as a bar</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - tutorial from plotly (best).html#grouped-bar-chart">Grouped bar chart</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - tutorial from plotly (best).html#stacked">Stacked</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - tutorial from plotly (best).html#horizontal">Horizontal</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - tutorial from plotly (best).html#themes">Themes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - tutorial from plotly (best).html#histograms">Histograms</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - tutorial from plotly (best).html#customizing-histogram-style">Customizing histogram style</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - tutorial from plotly (best).html#subplots">Subplots</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - tutorial from plotly (best).html#box-plots">Box plots</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - tutorial from plotly (best).html#area-charts">Area charts</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - tutorial from plotly (best).html#stacked-area-chart">Stacked area chart</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - tutorial from plotly (best).html#non-stacked-area-charts">Non-stacked area charts</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - tutorial from plotly (best).html#scatter-plot">Scatter plot</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - tutorial from plotly (best).html#demo1">Demo1</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - tutorial from plotly (best).html#multiple-scatter-plot-use-python">++Multiple scatter plot? Use python</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - tutorial from plotly (best).html#grouping-use-python">+++Grouping? Use python</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - tutorial from plotly (best).html#bubble-charts">BUBBLE CHARTS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - tutorial from plotly (best).html#id1">Subplots</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - tutorial from plotly (best).html#id2">Scatter matrix</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - tutorial from plotly (best).html#heatmaps">Heatmaps</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - tutorial from plotly (best).html#lines-and-shaded-areas">LINES AND SHADED AREAS</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - tutorial from plotly (best).html#hline-vline">hline, vline</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - tutorial from plotly (best).html#hspan-vspan-for-shaded-region">hspan, vspan for shaded region</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - tutorial from plotly (best).html#extra-param-as-dict">Extra param as dict</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - tutorial from plotly (best).html#customizing-figures">+++Customizing Figures</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks - tutorial from plotly (best).html#crux">+++Crux</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_pandas/Cufflinks_Basic_Tutorial.html">Cufflinks_Basic_Tutorial</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks_Basic_Tutorial.html#customizing-themes">Customizing Themes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks_Basic_Tutorial.html#bestfit-lines">Bestfit Lines</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks_Basic_Tutorial.html#customizing-colors">Customizing Colors</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks_Basic_Tutorial.html#filled-traces">Filled Traces</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks_Basic_Tutorial.html#bar-charts">Bar Charts</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks_Basic_Tutorial.html#spread-and-ratio-charts">Spread and Ratio charts</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks_Basic_Tutorial.html#annotations">Annotations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks_Basic_Tutorial.html#output-as-image">Output as Image</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks_Basic_Tutorial.html#advanced-use">++Advanced Use</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_pandas/Cufflinks_Basic_Tutorial.html#get-figure-object">Get figure object</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks_Basic_Tutorial.html#get-data-object">Get Data object</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/Cufflinks_Basic_Tutorial.html#get-layout-object">Get Layout object</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_pandas/color-lover.html">color-lover</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/color-lover.html#using-colorlover-to-easily-access-colorscale">Using Colorlover to easily access colorscale</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/color-lover.html#binding-plotly-to-pandas-dataframes-cufflinks">Binding Plotly to Pandas Dataframes ( Cufflinks )</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/color-lover.html#plotting-the-data-using-plotly">Plotting the data using Plotly</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/color-lover.html#adding-colorscales-using-colorlover">Adding Colorscales using Colorlover</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_pandas/pandas-boxplots.html">pandas-boxplots</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/pandas-boxplots.html#pandas-boxplot-with-cufflinks">Pandas boxplot with cufflinks</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_pandas/plotly-configs.html">plotly-configs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_pandas/plotly-pandas-basic-charts.html">plotly-pandas-basic-charts</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/plotly-pandas-basic-charts.html#pandas-subplots">Pandas subplots</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/plotly-pandas-basic-charts.html#overlaying-trace-should-be-done-in-python">Overlaying trace should be done in python</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/plotly-pandas-basic-charts.html#sync-hover-text">Sync hover text</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/plotly-pandas-basic-charts.html#bubble-charts-pandas">Bubble charts pandas</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/plotly-pandas-basic-charts.html#multiple-axes">Multiple axes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/plotly-pandas-basic-charts.html#use-secondary-y">Use secondary_y</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/plotly-pandas-basic-charts.html#secondary-y-axis-with-multiple-chart-types">SECONDARY Y AXIS WITH MULTIPLE CHART TYPES</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/plotly-pandas-basic-charts.html#line-charts">Line-charts</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/plotly-pandas-basic-charts.html#cufflinks-demo">Cufflinks demo</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/plotly-pandas-basic-charts.html#set-line-color-and-style-in-cufflinks">+++Set Line Color and Style in Cufflinks</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/plotly-pandas-basic-charts.html#updating-cufflinks-plots">Updating cufflinks plots</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/plotly-pandas-basic-charts.html#time-series">Time series</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/plotly-pandas-basic-charts.html#demo1">Demo1</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/plotly-pandas-basic-charts.html#subplots">Subplots</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_pandas/plotly-pandas-statistical-charts.html">plotly-pandas-statistical-charts</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/plotly-pandas-statistical-charts.html#d-density-plots">2d density plots</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/plotly-pandas-statistical-charts.html#d-histogram">2D Histogram</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/plotly-pandas-statistical-charts.html#histograms">Histograms</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_pandas/plotly-pandas-statistical-charts.html#basic-histogram-in-pandas">Basic Histogram in Pandas</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/plotly-pandas-statistical-charts.html#multiple-histograms-in-pandas-cufflinks">Multiple histograms in Pandas (cufflinks)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/plotly-pandas-statistical-charts.html#histograms-binning-and-normalization-in-pandas">Histograms binning and normalization in Pandas</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/plotly-pandas-statistical-charts.html#histograms-subplots-in-pandas">Histograms subplots in Pandas</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/plotly-pandas-statistical-charts.html#box-plots">Box-plots</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/plotly-pandas-statistical-charts.html#basic-box-plot">Basic Box Plot</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/plotly-pandas-statistical-charts.html#use-cufflinks">Use cufflinks</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/plotly-pandas-statistical-charts.html#error-bars">Error bars</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_pandas/plotly-pandas-statistical-charts.html#discrete-fixed-error-bars">Discrete, fixed error bars</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/plotly-pandas-statistical-charts.html#discrete-variable-error-bars">Discrete, variable error bars</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/plotly-pandas-statistical-charts.html#asymmetric-error-bars-with-a-constant-offset">Asymmetric Error Bars with a Constant Offset</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_pandas/plotly-pandas-statistical-charts.html#bar-chart-with-error-bars">Bar Chart with Error Bars</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../plotly_FF/top-plotly-FF.html">Plotly FigureFactory</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_FF/FigureFactory-favorites.html">Figure Factory &#8211; my favorites!</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_FF/FigureFactory-favorites.html#create-2d-density">create_2D_density</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactory-favorites.html#simple-2d-density">Simple 2d Density</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactory-favorites.html#add-colorscale">add colorscale</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_FF/FigureFactory-favorites.html#create-dendrogram">create_dendrogram</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactory-favorites.html#simple-bottom-oriented-dendrogram">Simple bottom oriented dendrogram</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactory-favorites.html#dendrogram-to-put-on-the-left-of-the-heatmap">Dendrogram to put on the left of the heatmap</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactory-favorites.html#dendrogram-with-pandas">Dendrogram with Pandas</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactory-favorites.html#with-heatmap">With heatmap</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_FF/FigureFactory-favorites.html#create-distplot">create_distplot</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactory-favorites.html#simple-distplot">simple distplot</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactory-favorites.html#two-data-sets-and-added-rug-text">Two data sets and added rug text</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactory-favorites.html#normal-distribution-plot-with-no-rug">normal distribution plot with no rug</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactory-favorites.html#distplot-with-pandas">Distplot with pandas</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_FF/FigureFactory-favorites.html#create-scatterplotmatrix">create_scatterplotmatrix</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactory-favorites.html#diagonal-boxplots">Diagonal boxplots</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactory-favorites.html#use-a-theme-to-style-the-subplots">Use a Theme to Style the Subplots</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactory-favorites.html#example-4-with-interval-factoring">Example 4 with Interval Factoring</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactory-favorites.html#using-the-colormap-as-a-dictionary">Using the colormap as a Dictionary</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_FF/FigureFactory-favorites.html#create-table">create_table</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactory-favorites.html#simple-plotly-table">Simple Plotly Table</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactory-favorites.html#table-with-custom-coloring">Table with Custom Coloring</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactory-favorites.html#using-pandas">Using pandas</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_FF/FigureFactory-favorites.html#create-violin">create_violin</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactory-favorites.html#multiple-violin-plots-with-qualitative-coloring">Multiple Violin Plots with Qualitative Coloring</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactory-favorites.html#violin-plots-with-colorscale">Violin Plots with Colorscale</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_FF/FigureFactories (a-o).html">Figure Factory Demos (a-o)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_FF/FigureFactories (a-o).html#create-2d-density">create_2D_density</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactories (a-o).html#simple-2d-density-plot">Simple 2D Density plot</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactories (a-o).html#using-parameters">Using Parameters</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_FF/FigureFactories (a-o).html#create-annotated-heatmap">create_annotated_heatmap</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_FF/FigureFactories (a-o).html#create-candlestick">create_candlestick</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactories (a-o).html#simple-candlestick-chart-from-a-pandas-dataframe">Simple candlestick chart from a Pandas DataFrame</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactories (a-o).html#add-text-and-annotations-to-the-candlestick-chart">Add text and annotations to the candlestick chart</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactories (a-o).html#customize-the-candlestick-colors">Customize the candlestick colors</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactories (a-o).html#candlestick-chart-with-datetime-objects">Candlestick chart with datetime objects</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_FF/FigureFactories (a-o).html#create-dendrogram">create_dendrogram</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactories (a-o).html#simple-bottom-oriented-dendrogram">Simple bottom oriented dendrogram</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactories (a-o).html#dendrogram-to-put-on-the-left-of-the-heatmap">Dendrogram to put on the left of the heatmap</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactories (a-o).html#dendrogram-with-pandas">Dendrogram with Pandas</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_FF/FigureFactories (a-o).html#create-distplot">create_distplot</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactories (a-o).html#simple-distplot-of-1-dataset">Simple distplot of 1 dataset</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactories (a-o).html#two-data-sets-and-added-rug-text">Two data sets and added rug text</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactories (a-o).html#plot-with-normal-curve-and-hide-rug-plot">Plot with normal curve and hide rug plot</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactories (a-o).html#distplot-with-pandas">Distplot with pandas</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_FF/FigureFactories (a-o).html#create-gantt">create_gantt</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactories (a-o).html#simple-gantt-chart">Simple Gantt Chart</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactories (a-o).html#index-by-column-with-numerical-entries">Index by Column with Numerical Entries</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactories (a-o).html#index-by-column-with-string-entries">Index by Column with String Entries</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactories (a-o).html#use-a-dictionary-for-colors">Use a dictionary for colors</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactories (a-o).html#use-a-pandas-dataframe">Use a pandas dataframe</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_FF/FigureFactories (a-o).html#create-ohlc">create_ohlc</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactories (a-o).html#simple-ohlc-chart-from-a-pandas-dataframe">Simple OHLC chart from a Pandas DataFrame</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactories (a-o).html#add-text-and-annotations-to-the-ohlc-chart">Add text and annotations to the OHLC chart</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactories (a-o).html#customize-the-ohlc-colors">Customize the OHLC colors</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactories (a-o).html#ohlc-chart-with-datetime-objects">OHLC chart with datetime objects</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_FF/FigureFactory (q-z).html">Figure Factory Demos (q-z)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_FF/FigureFactory (q-z).html#create-quiver">create_quiver</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactory (q-z).html#trivial-quiver">Trivial Quiver</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactory (q-z).html#quiver-plot-using-meshgrid">Quiver plot using meshgrid</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactory (q-z).html#styling-the-quiver-plot">Styling the quiver plot</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_FF/FigureFactory (q-z).html#create-scatterplotmatrix">create_scatterplotmatrix</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactory (q-z).html#vanilla-scatterplot-matrix">Vanilla Scatterplot Matrix</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactory (q-z).html#indexing-a-column">Indexing a Column</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactory (q-z).html#styling-the-diagonal-subplots">Styling the Diagonal Subplots</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactory (q-z).html#use-a-theme-to-style-the-subplots">Use a Theme to Style the Subplots</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactory (q-z).html#example-4-with-interval-factoring">Example 4 with Interval Factoring</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactory (q-z).html#using-the-colormap-as-a-dictionary">Using the colormap as a Dictionary</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_FF/FigureFactory (q-z).html#create-streamline">create_streamline</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactory (q-z).html#from-aeropython">from AeroPython</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_FF/FigureFactory (q-z).html#create-table">create_table</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactory (q-z).html#simple-plotly-table">Simple Plotly Table</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactory (q-z).html#table-with-custom-coloring">Table with Custom Coloring</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactory (q-z).html#simple-plotly-table-with-pandas">Simple Plotly Table with Pandas</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_FF/FigureFactory (q-z).html#create-trisurf">create_trisurf</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactory (q-z).html#torus">Torus</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactory (q-z).html#mobius-band">Mobius Band</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactory (q-z).html#using-a-custom-colormap-function-with-light-cone">Using a Custom Colormap Function with Light Cone</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactory (q-z).html#enter-color-func-as-a-list-of-colors">Enter color_func as a list of colors</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_FF/FigureFactory (q-z).html#create-violin">create_violin</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactory (q-z).html#single-violin-plot">Single Violin Plot</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactory (q-z).html#multiple-violin-plots-with-qualitative-coloring">Multiple Violin Plots with Qualitative Coloring</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_FF/FigureFactory (q-z).html#violin-plots-with-colorscale">Violin Plots with Colorscale</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../plotly_layout/top-plotly-layout.html">Plotly layout options</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-axes.html">plotly-layout-options-axes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-axes.html#toggling-axes-lines-ticks-labels-and-autorange">Toggling Axes Lines, Ticks, Labels, and Autorange</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-axes.html#tick-placement-color-and-style">Tick Placement, Color, and Style</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-axes.html#set-and-style-axes-title-labels-and-ticks">Set and Style Axes Title Labels and Ticks</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-axes.html#styling-and-coloring-axes-and-the-zero-line">Styling and Coloring Axes and the Zero-Line</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-axes.html#setting-the-range-of-axes-manually">Setting the Range of Axes Manually</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-axes.html#logarithmic-axes">Logarithmic Axes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-axes.html#reversed-axes">Reversed Axes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-axes.html#reversed-axes-with-range-min-max-specified">Reversed Axes with Range ( Min/Max ) Specified</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-axes.html#nonnegative-tozero-and-normal-rangemode">nonnegative, tozero, and normal Rangemode</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-axes.html#enumerated-ticks-with-tickvals-and-ticktext">Enumerated Ticks with Tickvals and Ticktext</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-axes3d.html">plotly-layout-options-axes3d</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-axes3d.html#range-of-axes">Range of Axes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-axes3d.html#set-axes-title">Set Axes Title</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-axes3d.html#ticks-formatting">Ticks Formatting</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-axes3d.html#background-color-and-grid-color">Background color and grid color</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-legend.html">plotly-layout-options-legend</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-legend.html#basic-legend">Basic legend</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-legend.html#positioning-the-legend">Positioning the Legend</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-legend.html#grouped-legends">Grouped legends</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-legend.html#styling-and-coloring-the-legend">Styling and Coloring the Legend</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-legend.html#selectively-hide-legend-entries">Selectively hide legend entries</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-legend.html#hiding-legend-entries-in-grouped-legends">Hiding Legend Entries In Grouped Legends</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-legend.html#horizontal-legends">Horizontal legends</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-subplots.html">plotly-layout-options-subplots</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-subplots.html#simple-subplots">Simple subplots</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-subplots.html#multiple-subplots-with-titles">Multiple Subplots With Titles</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-subplots.html#customizing-subplot-axes">Customizing Subplot Axes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-subplots.html#subplots-with-shared-y-axes">Subplots with Shared Y-Axes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-subplots.html#stacked-subplots">Stacked Subplots</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-subplots.html#custom-sized-subplot-with-subplot-titles">+++Custom Sized Subplot with Subplot Titles</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-subplots.html#subplots-with-shared-x-axes">Subplots with Shared X-Axes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-subplots.html#subplots-with-shared-axes">Subplots with shared Axes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-subplots.html#multiple-custom-sized-subplots">Multiple Custom Sized Subplots</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-subplots.html#subplot-with-custom-sizes">++Subplot with custom sizes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-text-and-annotations.html">plotly-layout-options-text-and-annotations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-text-and-annotations.html#adding-text-to-data-in-line-and-scatter-plots">Adding Text to Data in Line and Scatter Plots</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-text-and-annotations.html#adding-hover-text-to-data-in-line-and-scatter-plots">Adding Hover Text to Data in Line and Scatter Plots</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-text-and-annotations.html#simple-annotation">Simple Annotation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-text-and-annotations.html#multiple-annotations">Multiple Annotations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-text-and-annotations.html#custom-text-color-and-styling">Custom Text Color and Styling</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-text-and-annotations.html#disabling-hover-text">Disabling Hover Text</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-text-and-annotations.html#styling-and-coloring-annotations">Styling and Coloring Annotations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-text-and-annotations.html#text-font-as-an-array-styling-each-text-element">Text Font as an Array - Styling Each Text Element</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options-text-and-annotations.html#adding-annotations-with-xref-and-yref-as-paper">Adding Annotations with xref and yref as Paper</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options.html">plotly-layout-options</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options.html#adding-logos">Adding logos</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options.html#add-background-image">Add background image</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options.html#latex">Latex</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options.html#text-and-font-styling-global-font-properties">Text and Font Styling (global font properties)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options.html#setting-graph-size">Setting graph size</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options.html#setting-the-title-legend-entries-and-axis-titles">Setting the Title, Legend Entries, and Axis Titles</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options.html#multiple-axes">Multiple Axes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options.html#two-y-axes">Two y-axes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options.html#multiple-y-axes">Multiple y-axes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_layout/plotly-layout-options.html#inset-plots">Inset Plots</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../plotly_demos_api/top-plotly-api.html">Plotly &#8211; API demos</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos-camera-and-lighting.html">3d-plot-demos-camera-and-lighting</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos-camera-and-lighting.html#d-camera-controls">3d camera controls</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos-camera-and-lighting.html#default-parameters-eye-x-1-25-y-1-25-z-1-25">Default parameters: eye=(x=1.25, y=1.25, z=1.25)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos-camera-and-lighting.html#lower-the-view-point-eye-x-2-y-2-z-0-1">Lower the View Point: eye=(x=2, y=2, z=0.1)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos-camera-and-lighting.html#x-z-plane-eye-x-0-1-y-2-5-z-0-1">X-Z plane: eye=(x=0.1, y=2.5, z=0.1)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos-camera-and-lighting.html#y-z-plane-eye-x-2-5-y-0-1-z-0-1">Y-Z plane: eye=(x=2.5, y=0.1, z=0.1)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos-camera-and-lighting.html#view-from-above-eye-x-0-1-y-0-1-z-2-5">View from Above - eye=(x=0.1, y=0.1, z=2.5)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos-camera-and-lighting.html#zooming-in-eye-x-0-1-y-0-1-z-1">Zooming In: eye=(x=0.1, y=0.1, z=1)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos-camera-and-lighting.html#d-surface-lighting">3d surface lighting</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos-camera-and-lighting.html#ambient">Ambient</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos-camera-and-lighting.html#roughness">Roughness</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos-camera-and-lighting.html#diffuse">Diffuse</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos-camera-and-lighting.html#fresnel">Fresnel</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos-camera-and-lighting.html#specular">Specular</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos-camera-and-lighting.html#combined-effects">Combined effects</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos.html">3d-plot-demos</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos.html#d-surface-subplots">3D Surface Subplots</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos.html#d-surface-coloring-subplots-too">3D Surface Coloring (subplots too!)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos.html#d-point-clustering">3d point clustering</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos.html#d-network-graph">3d network graph</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos.html#assign-node-posibion">Assign node posibion</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos.html#set-data-for-the-plotly-plot-of-the-graph">Set data for the Plotly plot of the graph:</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos.html#define-trace-objects">Define trace objects</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos.html#define-layout-object">Define layout object</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos.html#plot">Plot!</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos.html#d-filled-line-plots">3d filled line plots</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos.html#d-scatter-plots">3d scatter plots</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos.html#d-scatter-plot-with-colorscaling">3D Scatter Plot with Colorscaling</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos.html#projection-of-3d-surface">Projection of 3D surface</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos.html#set-trace">Set trace</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos.html#set-layout">set layout</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos.html#discretization-of-each-plane">Discretization of each Plane</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos.html#define-color-for-each-xyz-plane">Define color for each xyz plane</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos.html#finally-plot">finally, plot</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos.html#d-mesh">3d mesh</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos.html#simple-3d-mesh-example">Simple 3D Mesh example</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos.html#d-mesh-example-with-alphahull">3D Mesh example with Alphahull</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos.html#mesh-tetrahedron">Mesh Tetrahedron</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos.html#mesh-cube">Mesh Cube</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos.html#d-wireframe-plot">3d-wireframe plot</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos.html#d-surface-plots">3d-surface plots</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos.html#topographical-3d-surface-plot">Topographical 3D Surface Plot</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos.html#multiple-3d-surface-plots">Multiple 3D Surface Plots</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos.html#d-parametric-plots">3d Parametric plots</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos.html#basic-parametric-plot">Basic parametric plot</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos.html#parameteric-plot-with-colorscale">Parameteric Plot with Colorscale</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/3d-plot-demos.html#ribbon-plots">Ribbon plots</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_demos_api/annotated-heatmap.html">annotated-heatmap</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/annotated-heatmap.html#simple-annotated-heatmp">Simple annotated heatmp</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/annotated-heatmap.html#defined-colorscale">Defined Colorscale</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/annotated-heatmap.html#custom-colorscale">Custom Colorscale</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/annotated-heatmap.html#custom-text-and-x-y-labels">Custom Text and X &amp; Y Labels</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/annotated-heatmap.html#annotated-heatmap-with-numpy">Annotated Heatmap with numpy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/annotated-heatmap.html#custom-hovertext">Custom Hovertext</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_demos_api/bar-charts.html">bar-charts</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/bar-charts.html#basic-bar-charts">Basic bar charts</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/bar-charts.html#grouped-bar-charts">Grouped bar charts</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_demos_api/bar-charts.html#set-barmode-group-in-layout">Set barmode=group in layout</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/bar-charts.html#stacked-bar-chart">Stacked Bar Chart</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_demos_api/bar-charts.html#set-barmode-stack-in-layout">Set <code class="docutils literal"><span class="pre">barmode=stack</span></code> in layout</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/bar-charts.html#styled-bar-chart-with-direct-labels">Styled Bar Chart with Direct Labels</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/bar-charts.html#rotated-bar-chart-labels">Rotated Bar Chart Labels</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_demos_api/bar-charts.html#xaxis-dict-tickangle-45">xaxis=dict(tickangle=-45)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/bar-charts.html#customizing-individual-bar-colors">Customizing Individual Bar Colors</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/bar-charts.html#bar-chart-with-hover-text">Bar chart with hover text</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/bar-charts.html#waterfall-bar-chart">Waterfall Bar Chart</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/bar-charts.html#bar-chart-with-relative-barmode">Bar Chart with Relative Barmode</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_demos_api/bubble-charts.html">bubble-charts</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/bubble-charts.html#note">note</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/bubble-charts.html#simple-bubblecharts">Simple bubblecharts</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/bubble-charts.html#setting-marker-size-and-color">Setting Marker Size and Color</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/bubble-charts.html#hover-text-with-bubble-charts">Hover Text with Bubble Charts</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/bubble-charts.html#scaling-the-size-of-bubble-charts">Scaling the Size of Bubble Charts</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/bubble-charts.html#bubble-charts-with-colorscale">Bubble Charts with Colorscale</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/bubble-charts.html#categorical-bubble-charts">Categorical Bubble Charts</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_demos_api/chord-diagram.html">chord-diagram</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/chord-diagram.html#chord-diagram-example-from-plotly">Chord Diagram example from Plotly</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/chord-diagram.html#define-nodes">Define nodes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/chord-diagram.html#define-edges">Define edges</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/chord-diagram.html#node-position">Node position</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/chord-diagram.html#exotic-bezier-curve-stuffs">Exotic Bezier curve stuffs...</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/chord-diagram.html#set-data-and-layout-for-plotly">Set data and layout for Plotly</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/chord-diagram.html#more-bezier-curve-stuffs">more Bezier curve stuffs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/chord-diagram.html#finally-plot">Finally, plot!</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_demos_api/dendrograms.html">dendrograms</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/dendrograms.html#basic-dendrogram">Basic Dendrogram</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_demos_api/dendrograms.html#set-orientation-and-add-labels">Set orientation and add labels</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/dendrograms.html#plot-a-dendrogram-with-a-heatmap">Plot a Dendrogram with a Heatmap</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_demos_api/dendrograms.html#get-data">get data</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_demos_api/dendrograms.html#initialize-figure-by-creating-upper-dendrogram">Initialize figure by creating upper dendrogram</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_demos_api/dendrograms.html#create-heatmap">Create heatmap</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_demos_api/dendrograms.html#edit-layout">Edit layout</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../plotly_demos_api/dendrograms.html#plot">Plot!</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_demos_api/dropdowns (daiji).html">dropdowns (daiji)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/dropdowns (daiji).html#simple-dropdown-menu">Simple Dropdown Menu</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/dropdowns (daiji).html#add-multiple-dropdown-menus">Add Multiple Dropdown Menus</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_demos_api/filled-area-plots.html">filled-area-plots</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/filled-area-plots.html#basic-overlaid-area-chart">Basic Overlaid Area Chart</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/filled-area-plots.html#overlaid-area-chart-without-boundary-lines">Overlaid Area Chart Without Boundary Lines</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/filled-area-plots.html#interior-filling-for-area-chart">Interior Filling for Area Chart</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/filled-area-plots.html#stacked-area-chart-with-cumulative-values">Stacked Area Chart with Cumulative Values</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/filled-area-plots.html#stacked-area-chart-with-original-values">Stacked Area Chart with Original Values</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_demos_api/heatmap-and-contour-colorscales.html">heatmap-and-contour-colorscales</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/heatmap-and-contour-colorscales.html#custom-discretized-heatmap-colorscale">Custom Discretized Heatmap Colorscale</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/heatmap-and-contour-colorscales.html#colorscale-for-scatter-plots">Colorscale for Scatter Plots</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/heatmap-and-contour-colorscales.html#colorscale-for-contour-plot">Colorscale for Contour Plot</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/heatmap-and-contour-colorscales.html#custom-heatmap-colorscale">Custom Heatmap Colorscale</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/heatmap-and-contour-colorscales.html#custom-contour-plot-colorscale">Custom Contour Plot Colorscale</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_demos_api/heatmaps.html">heatmaps</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/heatmaps.html#basic-heatmaps">Basic heatmaps</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/heatmaps.html#heatmap-with-categorical-axis-labels">Heatmap with Categorical Axis Labels</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/heatmaps.html#annotated-heatmap">Annotated Heatmap</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/heatmaps.html#heatmap-with-unequal-block-sizes">Heatmap with Unequal Block Sizes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/heatmaps.html#heatmap-with-datetime-axis">Heatmap with Datetime Axis</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_demos_api/horizontal-bar-charts.html">horizontal-bar-charts</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/horizontal-bar-charts.html#basic-horizontal-bar-charts">Basic horizontal bar charts</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/horizontal-bar-charts.html#colored-horizontal-bar-chart">Colored Horizontal Bar Chart</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/horizontal-bar-charts.html#color-palette-for-bar-chart">Color Palette for Bar Chart</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/horizontal-bar-charts.html#define-traces">Define traces</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/horizontal-bar-charts.html#define-layout">Define layout</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/horizontal-bar-charts.html#bar-chart-with-line-plot">Bar Chart with Line Plot</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_demos_api/igraph-networkx-comparison.html">igraph-networkx-comparison</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/igraph-networkx-comparison.html#download-data-from-uci">Download data from UCI</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/igraph-networkx-comparison.html#igraph">igraph</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/igraph-networkx-comparison.html#networkx">Networkx</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/igraph-networkx-comparison.html#repeat-with-different-pos">Repeat with different pos</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_demos_api/ipython-notebooks-demo.html">ipython-notebooks-demo</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/ipython-notebooks-demo.html#scatter-plots">Scatter plots</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/ipython-notebooks-demo.html#box-plots">Box plots</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/ipython-notebooks-demo.html#heatmap">Heatmap</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/ipython-notebooks-demo.html#sized-bubble-plots">Sized bubble plots</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/ipython-notebooks-demo.html#time-series">Time series</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/ipython-notebooks-demo.html#heatmap-again">heatmap again</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/ipython-notebooks-demo.html#airflight-map">Airflight map</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/ipython-notebooks-demo.html#use-of-py-get-figure">Use of py.get_figure</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_demos_api/line-charts.html">line-charts</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/line-charts.html#simple-line-charts">Simple line charts</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/line-charts.html#line-plot-models">Line plot models</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/line-charts.html#style-line-plots">Style Line plots</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/line-charts.html#connect-data-gaps">Connect Data Gaps</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/line-charts.html#interpolation-with-line-plots">Interpolation with Line Plots</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/line-charts.html#label-lines-with-annotations">Label Lines with Annotations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/line-charts.html#the-traces">The traces</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/line-charts.html#annotation-content">Annotation content</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/line-charts.html#filled-lines-shaded-lines">Filled lines (shaded lines)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/line-charts.html#this-created-the-shading-part">This created the shading part</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_demos_api/networkx-demo.html">networkx-demo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_demos_api/pie-charts.html">pie-charts</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/pie-charts.html#basic-pie-chart">Basic pie chart</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/pie-charts.html#pie-chart-using-pie-object">Pie Chart using Pie object</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/pie-charts.html#donut-chart">Donut Chart</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/pie-charts.html#pie-chart-subplots">Pie Chart Subplots</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_demos_api/range-slider.html">range-slider</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_demos_api/scatter-plots.html">scatter-plots</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/scatter-plots.html#simple-scatter-plot">Simple scatter plot</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/scatter-plots.html#line-and-scatter-plots">Line and Scatter Plots</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/scatter-plots.html#style-scatter-plots">Style Scatter Plots</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_demos_api/tables.html">tables</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/tables.html#simple-table">Simple table</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/tables.html#add-links">Add Links</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/tables.html#use-latex">Use LaTeX</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/tables.html#use-a-panda-s-dataframe">Use a Panda&#8217;s Dataframe</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/tables.html#include-and-index-column">Include and Index Column</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/tables.html#custom-table-colors">Custom Table Colors</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/tables.html#custom-font-colors">Custom Font Colors</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/tables.html#change-font-size">Change Font Size</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/tables.html#tables-with-graphs">Tables with Graphs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/tables.html#horizontal-subplots">Horizontal subplots</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_demos_api/tables.html#vertical-subplots">Vertical subplots</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../plotly_maps/top-plotly-maps.html">Plotly &#8211; map demos</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_maps/Choropleth Maps.html">Choropleth Maps</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_maps/Choropleth Maps.html#united-states-choropleth-map">United States Choropleth Map</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_maps/Choropleth Maps.html#define-data-object">Define data object</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_maps/Choropleth Maps.html#define-layout-object">Define layout object</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_maps/Choropleth Maps.html#world-choropleth-map">World choropleth map</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_maps/Choropleth Maps.html#define-data">Define data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_maps/Choropleth Maps.html#define-layout">Define layout</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_maps/Choropleth Maps.html#choropleth-inset-map">Choropleth Inset Map</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../plotly_maps/plotly-mapbox.html">plotly-mapbox</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_maps/plotly-mapbox.html#basic-example">Basic Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_maps/plotly-mapbox.html#define-trace-scattermapbox-object">Define trace (Scattermapbox object)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_maps/plotly-mapbox.html#define-layout">Define layout</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_maps/plotly-mapbox.html#plot">Plot!</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_maps/plotly-mapbox.html#multiple-markers">Multiple Markers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_maps/plotly-mapbox.html#county-level">County-level</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_maps/plotly-mapbox.html#color-the-counties">Color the Counties</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_maps/plotly-mapbox.html#create-json-files">Create JSON Files</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_maps/plotly-mapbox.html#define-data-easy-part">Define data (easy part)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../plotly_maps/plotly-mapbox.html#define-layout-hard-part">Define layout (hard part)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <h1>Source code for tak.ml.nmf</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">===============================================================================</span>
<span class="sd">Code forked from ~/python/analysis/nmf/nmf_module.py (05/09/2016)</span>

<span class="sd">Here, I can import this module from anywhere</span>
<span class="sd">===============================================================================</span>
<span class="sd">Created on 9, May 2016</span>

<span class="sd">Note: big update on 02/11/2016 - replaced all np.argsort with tw.argsort so</span>
<span class="sd">that &quot;ties&quot;-indices are ordered by their occurence.  This helps me do</span>
<span class="sd">consistency check with my various knn-type methods.</span>

<span class="sd">Note: big update on 02/13/2016 - all NMF methods now default initializes via</span>
<span class="sd">&#39;nndsvd&#39;, and rho=1e3, tol=5e-5.</span>

<span class="sd">Update 02/14/2016 - all NMF methods max_iter now set to 5000</span>
<span class="sd">Update 02/14/2016 - changed tol=1e-4 for all nmf methods</span>

<span class="sd">@author: takanori</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy</span> <span class="kn">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">dot</span><span class="p">,</span> <span class="n">trace</span>

<span class="kn">from</span> <span class="nn">sklearn.utils.validation</span> <span class="kn">import</span> <span class="n">check_is_fitted</span><span class="c1">#, check_random_state</span>
<span class="kn">from</span> <span class="nn">sklearn.base</span> <span class="kn">import</span> <span class="n">BaseEstimator</span><span class="p">,</span><span class="n">TransformerMixin</span><span class="p">,</span><span class="n">ClassifierMixin</span>

<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">tak</span> <span class="kn">as</span> <span class="nn">tw</span>
<span class="kn">from</span> <span class="nn">scipy.linalg</span> <span class="kn">import</span> <span class="n">norm</span><span class="p">,</span><span class="n">solve</span><span class="p">,</span><span class="n">svd</span>

<span class="kn">from</span> <span class="nn">tak.core</span> <span class="kn">import</span> <span class="n">print_time</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">Ridge</span>
<span class="c1">#%%==== Main functions ====</span>
<span class="k">def</span> <span class="nf">pnmf</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">r</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">l2_pen</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">W</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">return_cost</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot; Projective NMF</span>

<span class="sd">    Projective NMF model of 2010 N. Yang</span>

<span class="sd">    Model: :math:`X \approx W(W^T X)`</span>

<span class="sd">    .. math::</span>

<span class="sd">        \min_{W\geq 0} \frac{1}{2}\|X-WH\|^2_F \text{  such that  } H=W^T X</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : ndarray of shape (n_features, n_samples)=(p,n)</span>
<span class="sd">        Data matrix with columns as data points</span>
<span class="sd">    r : int</span>
<span class="sd">        Dimension of the embedding space (n_components)</span>
<span class="sd">    max_iter : int</span>
<span class="sd">        max number of iterations</span>
<span class="sd">    tol : float</span>
<span class="sd">        convergence tolerance</span>
<span class="sd">    l2_pen : float (Default = None)</span>
<span class="sd">        L2 regularization on basis W</span>
<span class="sd">    W : ndarray of shape (n_features, n_components)=(p,r)</span>
<span class="sd">        Initial basis-matrix estimate</span>
<span class="sd">    return_cost : bool (Default = False)</span>
<span class="sd">        Return per-iteration cost and diffW (increases computation)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    W : array of shape (n_features,n_components) = (p,r)</span>
<span class="sd">        Non-negative Basis matrix</span>

<span class="sd">    Usage</span>
<span class="sd">    -----</span>
<span class="sd">    &gt;&gt;&gt; # usually X = (n,p) matrix... but pnmf assumes X=(p,n), so apply transpose</span>
<span class="sd">    &gt;&gt;&gt; W = pnmf(X.T,r=10)</span>
<span class="sd">    &gt;&gt;&gt; W, cost_, diffW_ = pnmf(X.T,r=10,return_cost=True)</span>

<span class="sd">    History</span>
<span class="sd">    -------</span>
<span class="sd">    Update 02/14/2016 - modified &quot;cost&quot; from frobenius to **squared**-</span>
<span class="sd">    frobenius norm (for consistency with my other admm scripts)</span>
<span class="sd">    </span>
<span class="sd">    - update 07/11/2016 -- added keyboard interrupt exception</span>
<span class="sd">    - update 10/04/2016 -- added nnd-svd option for W</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">W</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">W</span> <span class="o">==</span> <span class="s1">&#39;nndsvd&#39;</span><span class="p">:</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">nnd_svd</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_cost</span><span class="p">:</span>
        <span class="n">diffW_list</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">cost_list</span><span class="o">=</span><span class="p">[]</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iter</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">W_old</span> <span class="o">=</span> <span class="n">W</span>
    
            <span class="n">XtW</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="p">)</span>
            <span class="n">WtW</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="p">)</span>
    
            <span class="c1"># numerator term</span>
            <span class="n">num</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">XtW</span><span class="p">)</span>
            <span class="n">den</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">XtW</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">XtW</span><span class="p">))</span> <span class="o">+</span> <span class="n">X</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">XtW</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">WtW</span><span class="p">))</span> <span class="o">+</span> <span class="mf">1e-10</span>
    <span class="c1">#        den = W.dot(XtW.T.dot(XtW)) + 1e-10</span>
            <span class="k">if</span> <span class="n">l2_pen</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c1"># extra term arising from Frobenius norm regularizer</span>
                <span class="n">den</span> <span class="o">=</span> <span class="n">den</span> <span class="o">+</span> <span class="n">l2_pen</span> <span class="o">*</span> <span class="n">W</span>
    
            <span class="n">W</span> <span class="o">=</span> <span class="n">W</span><span class="o">*</span> <span class="p">(</span><span class="n">num</span> <span class="o">/</span> <span class="n">den</span><span class="p">)</span>
            <span class="n">W</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># divide by largest singular value</span>
    
            <span class="n">diffW</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W_old</span> <span class="o">-</span> <span class="n">W</span><span class="p">,</span> <span class="s1">&#39;fro&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">norm</span><span class="p">(</span><span class="n">W_old</span><span class="p">,</span> <span class="s1">&#39;fro&#39;</span><span class="p">)</span>
    
            <span class="k">if</span> <span class="p">(</span><span class="n">diffW</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">iter</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">):</span> <span class="c1"># allow at least 100 iter for &quot;burn-in&quot;</span>
                <span class="k">break</span>
    
            <span class="k">if</span> <span class="n">return_cost</span><span class="p">:</span>
                <span class="sd">&quot;&quot;&quot;keep track of relevant per-iteration values&quot;&quot;&quot;</span>
                <span class="n">diffW_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">diffW</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">l2_pen</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">cost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">X</span> <span class="o">-</span> <span class="n">W</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">)),</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">X</span> <span class="o">-</span> <span class="n">W</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">)),</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                                     <span class="mf">0.5</span><span class="o">*</span><span class="n">l2_pen</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    
            <span class="k">if</span> <span class="nb">iter</span> <span class="o">%</span> <span class="mi">500</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">obj_val</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">X</span> <span class="o">-</span> <span class="n">W</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">)),</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
                <span class="k">if</span> <span class="n">l2_pen</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="c1"># add frobenius norm L2 penalty to objective</span>
                    <span class="n">obj_val</span> <span class="o">=</span> <span class="n">obj_val</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">l2_pen</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
                <span class="k">print</span> <span class="s2">&quot;iter = {:4}, diff = {:3.2e}, cost = {:6.5e} ({:3.1f} sec)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">iter</span><span class="p">,</span><span class="n">diffW</span><span class="p">,</span> <span class="n">obj_val</span><span class="p">,</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="c1">#print iter, diffW</span>
    <span class="k">if</span> <span class="n">return_cost</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">W</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cost_list</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">diffW_list</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">W</span>


<span class="k">def</span> <span class="nf">gpnmf</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">r</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">lam</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">l2_pen</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">W</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">return_cost</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Graph-regularized Projective NMF</span>

<span class="sd">    Projective NMF model of 2010 N. Yang</span>

<span class="sd">    Model: :math:`X \\approx W(W^T X)`</span>

<span class="sd">    .. math::</span>

<span class="sd">        \\min_{W\\geq 0} \\frac{1}{2}\\|X-WH\|^2_F \\text{  such that  } H=W^T X</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : ndarray of shape (n_features, n_samples)=(p,n)</span>
<span class="sd">        Data matrix with columns as data points</span>
<span class="sd">    r : int</span>
<span class="sd">        Dimension of the embedding space (n_components)</span>
<span class="sd">    A : ndarray of shape [n_samples,n_samples]</span>
<span class="sd">        Similarity/adjacency matrix</span>
<span class="sd">    lam : float</span>
<span class="sd">        regularization parameter on graph penalty</span>
<span class="sd">    max_iter : int</span>
<span class="sd">        max number of iterations</span>
<span class="sd">    tol : float</span>
<span class="sd">        convergence tolerance</span>
<span class="sd">    l2_pen : float (Default = None)</span>
<span class="sd">        L2 regularization on basis W</span>
<span class="sd">    W : ndarray of shape (n_features, n_components)=(p,r)</span>
<span class="sd">        Initial basis-matrix estimate</span>
<span class="sd">    return_cost : bool (Default = False)</span>
<span class="sd">        Return per-iteration cost and diffW (increases computation)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    W : array of shape (n_features,n_components) = (p,r)</span>
<span class="sd">        Non-negative Basis matrix</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># degree matrix</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">W</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_cost</span><span class="p">:</span>
        <span class="n">diffW_list</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">cost_list</span><span class="o">=</span><span class="p">[]</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">XA</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">XD</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
    <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iter</span><span class="p">):</span>
        <span class="n">W_old</span> <span class="o">=</span> <span class="n">W</span>

        <span class="n">XtW</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="p">)</span>
        <span class="n">WtW</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="p">)</span>

        <span class="c1"># numerator term</span>
        <span class="n">num</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">X</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">XtW</span><span class="p">)</span> <span class="o">+</span> <span class="n">lam</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">XA</span><span class="p">,</span><span class="n">XtW</span><span class="p">)</span>
        <span class="n">den</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">XtW</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">XtW</span><span class="p">))</span> <span class="o">+</span> <span class="n">X</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">XtW</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">WtW</span><span class="p">))</span> <span class="o">+</span> <span class="n">lam</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">XD</span><span class="p">,</span><span class="n">XtW</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-10</span>

<span class="c1">#        den = W.dot(XtW.T.dot(XtW)) + 1e-10</span>
        <span class="k">if</span> <span class="n">l2_pen</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># extra term arising from Frobenius norm regularizer</span>
            <span class="n">den</span> <span class="o">=</span> <span class="n">den</span> <span class="o">+</span> <span class="n">l2_pen</span> <span class="o">*</span> <span class="n">W</span>

        <span class="n">W</span> <span class="o">=</span> <span class="n">W</span><span class="o">*</span> <span class="p">(</span><span class="n">num</span> <span class="o">/</span> <span class="n">den</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># divide by largest singular value</span>

        <span class="n">diffW</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W_old</span> <span class="o">-</span> <span class="n">W</span><span class="p">,</span> <span class="s1">&#39;fro&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">norm</span><span class="p">(</span><span class="n">W_old</span><span class="p">,</span> <span class="s1">&#39;fro&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">diffW</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">iter</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">):</span> <span class="c1"># allow at least 100 iter for &quot;burn-in&quot;</span>
            <span class="k">break</span>

        <span class="k">if</span> <span class="n">return_cost</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;keep track of relevant per-iteration values&quot;&quot;&quot;</span>
            <span class="n">diffW_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">diffW</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">l2_pen</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">cost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">X</span> <span class="o">-</span> <span class="n">W</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">)),</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">X</span> <span class="o">-</span> <span class="n">W</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">)),</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span>
                                 <span class="mf">0.5</span><span class="o">*</span><span class="n">l2_pen</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">iter</span> <span class="o">%</span> <span class="mi">500</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">obj_val</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">X</span> <span class="o">-</span> <span class="n">W</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">)),</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
            <span class="k">if</span> <span class="n">l2_pen</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c1"># add frobenius norm L2 penalty to objective</span>
                <span class="n">obj_val</span> <span class="o">=</span> <span class="n">obj_val</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">l2_pen</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
            <span class="k">print</span> <span class="s2">&quot;iter = {:4}, diff = {:3.2e}, cost = {:6.5e} ({:3.1f} sec)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">iter</span><span class="p">,</span><span class="n">diffW</span><span class="p">,</span> <span class="n">obj_val</span><span class="p">,</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>
    <span class="c1">#print iter, diffW</span>
    <span class="k">if</span> <span class="n">return_cost</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">W</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cost_list</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">diffW_list</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">W</span>


<span class="k">def</span> <span class="nf">nmf_admm</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">r</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">rho</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">disp_freq</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; NMF solved via ADMM, as proposed in 2010 Y. Zhang from Rice</span>

<span class="sd">    [1] 2010 Yin Zhang, &quot;An Alternating direction algorithm for NMF&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># main primal variables</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">r</span><span class="p">)</span> <span class="c1"># X in Y. Zhang</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="c1"># Y in Y. Zhang</span>

    <span class="c1"># auxiliary variables introduced via variable splitting</span>
    <span class="n">Wtil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="c1"># U in Y. Zhang</span>
    <span class="n">Htil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="c1"># V in Y. Zhang</span>

    <span class="c1"># dual variables</span>
    <span class="n">Lam_W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="c1"># Lambda in Y. Zhang</span>
    <span class="n">Lam_H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="c1"># Pie    in Y. Zhang</span>

    <span class="n">eye_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="c1"># keep track of frobenius norm loss</span>
    <span class="n">cost_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">)</span> <span class="o">-</span> <span class="n">X</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">cost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>

    <span class="c1"># keep track of relative prima residual</span>
    <span class="n">res_W</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_H</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># also keep track of diffW</span>
    <span class="n">diffW</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">start</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="c1">#--- begin admm iterations ---#</span>
    <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iter</span><span class="p">):</span>
        <span class="n">W_old</span> <span class="o">=</span> <span class="n">W</span>

        <span class="c1">#--- primal updates (W,H,Wtil,Htil) ---#</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span> <span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">eye_r</span><span class="p">,</span>
                   <span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">Wtil</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">Lam_W</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span> <span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">W</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">eye_r</span><span class="p">,</span>
                   <span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">X</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">Htil</span> <span class="o">-</span> <span class="n">Lam_H</span><span class="p">)</span>

        <span class="n">Wtil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">W</span><span class="o">+</span><span class="n">Lam_W</span><span class="o">/</span><span class="n">rho</span><span class="p">)</span>
        <span class="n">Htil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">H</span><span class="o">+</span><span class="n">Lam_H</span><span class="o">/</span><span class="n">rho</span><span class="p">)</span>

        <span class="c1">#--- dual updates (Lam_W, Lam_H) ---</span>
        <span class="n">Lam_W</span> <span class="o">+=</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">W</span><span class="o">-</span><span class="n">Wtil</span><span class="p">)</span>
        <span class="n">Lam_H</span> <span class="o">+=</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">H</span><span class="o">-</span><span class="n">Htil</span><span class="p">)</span>

        <span class="c1">#--- compute main objective/cost ---#</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">X</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="n">H</span><span class="p">),</span> <span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">cost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>

        <span class="c1">#--- compute relative primal residual ---#</span>
        <span class="n">res_W</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="o">-</span><span class="n">Wtil</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="n">res_H</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="o">-</span><span class="n">Htil</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="n">diffW</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="o">-</span><span class="n">W_old</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">W_old</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">iter</span> <span class="o">%</span> <span class="n">disp_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="c1">#            print &quot;iter = {:4}, cost = {:3.3f} ({:3.1f} sec)&quot;.format(</span>
<span class="c1">#                iter,  cost_list[iter+1],time.time()-start)</span>
            <span class="n">str_</span> <span class="o">=</span> <span class="s2">&quot;iter={:4} cost={:3.3f} &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">iter</span><span class="p">,</span><span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span>\
                   <span class="s2">&quot;res_W={:3.2e} res_H={:3.2e} diffW={:3.2e} ({:3.1f} sec)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                   <span class="n">res_W</span><span class="p">[</span><span class="nb">iter</span><span class="p">],</span><span class="n">res_H</span><span class="p">[</span><span class="nb">iter</span><span class="p">],</span><span class="n">diffW</span><span class="p">[</span><span class="nb">iter</span><span class="p">],</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>
            <span class="k">print</span> <span class="n">str_</span>

    <span class="c1"># convert residual in pandas dataframe</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">res_W</span><span class="p">,</span><span class="n">res_H</span><span class="p">,</span><span class="n">diffW</span><span class="p">],</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;res_W&#39;</span><span class="p">,</span><span class="s1">&#39;res_H&#39;</span><span class="p">,</span><span class="s1">&#39;diffW&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="k">return</span> <span class="n">W</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">Wtil</span><span class="p">,</span><span class="n">Htil</span><span class="p">,</span><span class="n">cost</span><span class="p">,</span><span class="n">res</span>


<span class="k">def</span> <span class="nf">pnmf_admm</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">r</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">rho</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span><span class="n">W_init</span><span class="o">=</span><span class="s1">&#39;nndsvd&#39;</span><span class="p">,</span><span class="n">disp_freq</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
              <span class="n">silence</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Projective NMF using ADMM.</span>

<span class="sd">    &gt;&gt;&gt; W,P,H,Wtil,Ptil,cost_list,res = pnmf_admm(X,r,rho=1e2)</span>

<span class="sd">    The projective NMF here adopts the following parametrization:</span>

<span class="sd">    .. math ::</span>

<span class="sd">        \\min_{W,P} \\frac{1}{2}\|X - W(PX)\|^2_F</span>
<span class="sd">            \;\; \\text{s.t.}\;\;  W\ge 0, P \ge 0</span>

<span class="sd">    This is converted into the following equivalent constrained problem:</span>

<span class="sd">    .. math ::</span>

<span class="sd">        \\min_{W,P,H} \\frac{1}{2}\|X - WH\|^2_F</span>
<span class="sd">            + I_+(\\tilde{W}) + I_+(\\tilde{P})</span>
<span class="sd">            \\\\ \\quad \\text{s.t.}\;\;  W\ge 0, P \ge 0, H=PX,</span>
<span class="sd">                         W=\\tilde{W}, P=\\tilde{P}</span>

<span class="sd">        W,\\tilde{W} \in \mathbb{R}_+^{p\\times r}\\quad</span>
<span class="sd">        P,\\tilde{P} \in \mathbb{R}_+^{r\\times p}\\quad</span>
<span class="sd">        H \in \mathbb{R}_+^{r\\times n}\\quad</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : ndarray of shape (n_features, n_samples)=(p,n)</span>
<span class="sd">        Data matrix with columns as data points</span>
<span class="sd">    r : int</span>
<span class="sd">        Dimension of the embedding space (n_components)</span>
<span class="sd">    rho : float</span>
<span class="sd">        Augmented Lagrangian parameter</span>
<span class="sd">    max_iter : int</span>
<span class="sd">        max number of iterations</span>
<span class="sd">    tol : float</span>
<span class="sd">        convergence tolerance (on relative change in objective value and</span>
<span class="sd">        all primal residuals)</span>
<span class="sd">    W_init : None, rng, or &#39;nndsvd&#39; (default)</span>
<span class="sd">        Way to initialize W (and H).  If ``None`` or ``RandomState object``</span>
<span class="sd">        is supplied, both W and H will be initialized via non-negative</span>
<span class="sd">        random number.  If ``&#39;nndsvd&#39;``, will use deterministic initialization</span>
<span class="sd">        NNDSVD &quot;Non-Negative Double Singular Value Decomposition&quot;, proposed by</span>
<span class="sd">        Boutsidis2008.</span>
<span class="sd">    disp_freq : int</span>
<span class="sd">        Frequency of update display (in iterations)</span>
<span class="sd">    silence : bool</span>
<span class="sd">        If True, don&#39;t print-out convergence detail at the end.</span>

<span class="sd">    Update history</span>
<span class="sd">    --------------</span>
<span class="sd">    **02/01/2016** - updates based on ``t_0127d2_revisit_pnmf_admm.py``</span>

<span class="sd">    - change initialization scheme and order of primal admm updates</span>

<span class="sd">    **02/02/2016**</span>

<span class="sd">    - added ``silence`` option</span>
<span class="sd">    - changed input ``W`` to ``W_init``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
    <span class="c1">#%%=== initialize variables =====</span>
    <span class="c1"># define main primal variable W (basis matrix)</span>
    <span class="k">if</span> <span class="n">W_init</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">W_init</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">):</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">W_init</span>

        <span class="n">W</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">W_init</span> <span class="o">==</span> <span class="s1">&#39;nndsvd&#39;</span><span class="p">:</span>
<span class="c1">#        W = nnd_svd(X,r)</span>
        <span class="n">W</span><span class="p">,</span><span class="n">H</span> <span class="o">=</span> <span class="n">nnd_svd</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">get_H</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid input for &quot;W_init&quot;&#39;</span><span class="p">)</span>

    <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">p</span><span class="p">))</span>
<span class="c1">#    P = np.random.rand(r,p)</span>

    <span class="c1"># aux. variables</span>
    <span class="n">Wtil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Ptil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="c1"># dual variables</span>
    <span class="n">Lam_W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>


    <span class="c1">#%%=== create empty lists for tracking updates ===</span>
    <span class="c1"># keep track of frobenius norm loss</span>
    <span class="n">cost_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">Wtil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ptil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">))</span> <span class="o">-</span> <span class="n">X</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
<span class="c1">#    cost = norm( X - dot(W,P.dot(X)), &#39;fro&#39;)**2/2</span>
    <span class="n">cost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>

    <span class="c1"># relative change in cost</span>
    <span class="n">diffcost</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># keep track of relative primal residual</span>
    <span class="n">res_W</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_P</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_H</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># also keep track of diffW</span>
<span class="c1">#    diffW = []</span>
    <span class="c1">#%%=== run admm iterations ===</span>
    <span class="n">eye_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="c1"># precompute term needed for inversion lemma</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">X</span><span class="p">),</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="n">start</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iter</span><span class="p">):</span>
        <span class="c1">#W_old = W #&lt;- to keep track of diffW</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1">#================ primal updates (P, W, H, Ptil, Wtil) ===============#</span>
            <span class="c1"># update for P involves inversion lemma...</span>
            <span class="n">_R</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Lam_H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">/</span><span class="n">rho</span> <span class="o">-</span> <span class="n">Lam_P</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">rho</span> <span class="o">+</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">Ptil</span><span class="o">.</span><span class="n">T</span>
            <span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="n">_R</span> <span class="o">-</span> <span class="n">X</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">dot</span><span class="p">(</span><span class="n">K</span><span class="p">,</span><span class="n">_R</span><span class="p">)</span> <span class="p">))</span><span class="o">.</span><span class="n">T</span>
            <span class="n">Ptil</span> <span class="o">=</span> <span class="p">(</span><span class="n">P</span><span class="o">+</span><span class="n">Lam_P</span><span class="o">/</span><span class="n">rho</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
            <span class="c1"># (W,H) updates</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">W</span><span class="p">)</span><span class="o">+</span><span class="n">rho</span><span class="o">*</span><span class="n">eye_r</span><span class="p">,</span> <span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">X</span><span class="p">)</span> <span class="o">-</span> <span class="n">Lam_H</span><span class="p">)</span>
            <span class="n">W</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">+</span><span class="n">rho</span><span class="o">*</span><span class="n">eye_r</span><span class="p">,</span> <span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">Wtil</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">Lam_W</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="n">Wtil</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span><span class="o">+</span><span class="n">Lam_W</span><span class="o">/</span><span class="n">rho</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
            <span class="c1">#====================== dual updates =================================#</span>
            <span class="n">Lam_W</span> <span class="o">=</span> <span class="n">Lam_W</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">W</span> <span class="o">-</span> <span class="n">Wtil</span><span class="p">)</span>
            <span class="n">Lam_P</span> <span class="o">=</span> <span class="n">Lam_P</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">P</span> <span class="o">-</span> <span class="n">Ptil</span><span class="p">)</span>
            <span class="n">Lam_H</span> <span class="o">=</span> <span class="n">Lam_H</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">H</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">X</span><span class="p">))</span>
    
            <span class="c1">#============ comptute objective values ==============================#</span>
            <span class="c1"># main loss function</span>
            <span class="n">cost</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">Wtil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ptil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">))</span> <span class="o">-</span> <span class="n">X</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
    <span class="c1">#        cost = norm( X - dot(W,P.dot(X)), &#39;fro&#39;)**2/2</span>
            <span class="n">cost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>
    
            <span class="c1"># relative change in cost</span>
            <span class="n">diffcost</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span><span class="o">/</span><span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
    
            <span class="c1"># relative primal residuals</span>
            <span class="n">res_W</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="o">-</span><span class="n">Wtil</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
            <span class="n">res_P</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">P</span><span class="o">-</span><span class="n">Ptil</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
            <span class="n">res_H</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="o">-</span><span class="n">P</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">),</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
    
            <span class="c1"># relative change in basis matrix</span>
    <span class="c1">#        diffW.append( norm(W-W_old,&#39;fro&#39;)/ norm(W_old, &#39;fro&#39;) )</span>
    
            <span class="c1">#=== termination check ====#</span>
            <span class="n">check_exit</span>  <span class="o">=</span> <span class="p">(</span><span class="n">diffcost</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">)</span>
            <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_W</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
            <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_P</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
            <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_H</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">check_exit</span> <span class="ow">and</span> <span class="nb">iter</span> <span class="o">&gt;</span> <span class="mi">300</span><span class="p">:</span> <span class="c1"># allow 300 iterations of &quot;burn-in&quot;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">silence</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s2">&quot;Termination condition met.  Exit at iter =&quot;</span><span class="p">,</span><span class="nb">iter</span><span class="p">,</span>
                <span class="k">break</span>
            <span class="c1">#=============== print current progress ==============================#</span>
    <span class="c1">#        if iter % disp_freq == 0:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">iter</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">iter</span> <span class="o">%</span> <span class="n">disp_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
    <span class="c1">#            str_ = &quot;iter={:4} cost={:3.3f}&quot;.format(iter,cost_list[iter+1])</span>
                <span class="n">str_</span> <span class="o">=</span> <span class="s2">&quot;iter={:4} cost={:6.5e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">iter</span><span class="p">,</span><span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; diffcost={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">diffcost</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
                <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; res_W={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_W</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
                <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; res_P={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_P</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
                <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; res_H={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_H</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
    <span class="c1">#            str_ += &quot; diffW={:3.2e}&quot;.format(diffW[iter])</span>
                <span class="k">print</span> <span class="n">str_</span> <span class="o">+</span> <span class="s2">&quot; ({:3.1f} sec)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="c1">#%%---- end of admm for loop ---------------------------------------------#</span>
    <span class="n">cost_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cost_list</span><span class="p">)</span>

    <span class="c1"># convert residual in pandas dataframe</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">res_W</span><span class="p">,</span><span class="n">res_P</span><span class="p">,</span><span class="n">res_H</span><span class="p">,</span><span class="n">diffcost</span><span class="p">],</span>
                       <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;res_W&#39;</span><span class="p">,</span><span class="s1">&#39;res_P&#39;</span><span class="p">,</span><span class="s1">&#39;res_H&#39;</span><span class="p">,</span><span class="s1">&#39;diffcost&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">silence</span><span class="p">:</span> <span class="n">print_time</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">W</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">Wtil</span><span class="p">,</span><span class="n">Ptil</span><span class="p">,</span><span class="n">cost_list</span><span class="p">,</span><span class="n">res</span>


<span class="k">def</span> <span class="nf">projection_spectral</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="n">projection_type</span><span class="o">=</span><span class="s1">&#39;stiefel&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Projection onto Stiefel manifold or its convex relaxation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    W : ndarray of shape [p,r], p &gt;= r</span>
<span class="sd">        Input matrix</span>
<span class="sd">    projection_type : string</span>
<span class="sd">        &#39;stiefel&#39; (default) or &#39;convex&#39;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    The projection of input ``W`` onto the Stiefel manifold or its convex</span>
<span class="sd">    relaxation.</span>

<span class="sd">    History</span>
<span class="sd">    -------</span>
<span class="sd">    Created 02/02/2016</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">U</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">V</span> <span class="o">=</span> <span class="n">svd</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">projection_type</span> <span class="o">==</span> <span class="s1">&#39;stiefel&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">U</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">projection_type</span> <span class="o">==</span> <span class="s1">&#39;convex&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">U</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">S</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Projection must be &#39;stiefel&#39; or &#39;convex&#39;&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">spnmf_admm</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">r</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">constraint</span><span class="o">=</span><span class="s1">&#39;stiefel&#39;</span><span class="p">,</span><span class="n">rho</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
               <span class="n">W_init</span><span class="o">=</span><span class="s1">&#39;nndsvd&#39;</span><span class="p">,</span><span class="n">disp_freq</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">silence</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Spectral Projective NMF using ADMM.</span>

<span class="sd">    Projective NMF with either the orthogonal **Stiefel Manifold contraint**</span>
<span class="sd">    or the convex relaxation **</span>

<span class="sd">    Usage</span>
<span class="sd">    -----</span>
<span class="sd">    &gt;&gt;&gt; W,P,H,W1,Ptil,cost_list,res = spnmf_admm(X, r=10, rho=1e2,</span>
<span class="sd">    &gt;&gt;&gt; ... constraint=&#39;stiefel&#39;,max_iter=5000,tol=1e-4,W=&#39;nndsvd&#39;)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : ndarray of shape (n_features, n_samples)=(p,n)</span>
<span class="sd">        Data matrix with columns as data points</span>
<span class="sd">    r : int</span>
<span class="sd">        Dimension of the embedding space (n_components)</span>
<span class="sd">    constraint : ``&#39;stiefel&#39;`` or ``&#39;convex&#39;``</span>
<span class="sd">        The type of spectral constraint (default: ``&#39;stiefel&#39;``).  This</span>
<span class="sd">        determines the type of spectral projection applied.</span>
<span class="sd">    rho : float</span>
<span class="sd">        Augmented Lagrangian parameter</span>
<span class="sd">    max_iter : int</span>
<span class="sd">        max number of iterations</span>
<span class="sd">    tol : float</span>
<span class="sd">        convergence tolerance (on relative change in objective value and</span>
<span class="sd">        all primal residuals)</span>
<span class="sd">    W_init : None,  rng, or &#39;nndsvd&#39; (default)</span>
<span class="sd">        Way to initialize W (and H).  If ``None`` or ``RandomState object``</span>
<span class="sd">        is supplied, both W and H will be initialized via non-negative</span>
<span class="sd">        random number.  If ``&#39;nndsvd&#39;``, will use deterministic initialization</span>
<span class="sd">        NNDSVD &quot;Non-Negative Double Singular Value Decomposition&quot;, proposed by</span>
<span class="sd">        Boutsidis2008.</span>
<span class="sd">    disp_freq : int</span>
<span class="sd">        Frequency of update display (in iterations)</span>
<span class="sd">    silence : bool</span>
<span class="sd">        If True, don&#39;t print-out convergence detail at the end.</span>

<span class="sd">    History</span>
<span class="sd">    --------------</span>
<span class="sd">    **02/01/2016**</span>

<span class="sd">    - updates based on ``t_0127d2_revisit_pnmf_admm.py``</span>
<span class="sd">    - change initialization scheme and order of primal admm updates</span>

<span class="sd">    **02/02/2016**</span>

<span class="sd">    - Function moved to my nmf_module.  cleaned up codes and docstring.</span>

<span class="sd">    **02/03/2016**</span>

<span class="sd">    - removed ``W2`` from output for consistency with other PNMFtype methods.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
    <span class="c1">#%%=== initialize variables =====</span>
    <span class="k">if</span> <span class="n">W_init</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">W_init</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">):</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">W_init</span>

        <span class="n">W</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">W_init</span> <span class="o">==</span> <span class="s1">&#39;nndsvd&#39;</span><span class="p">:</span>
<span class="c1">#        W = nnd_svd(X,r)</span>
        <span class="n">W</span><span class="p">,</span><span class="n">H</span> <span class="o">=</span> <span class="n">nnd_svd</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">get_H</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid input for &quot;W_init&quot;&#39;</span><span class="p">)</span>

    <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">p</span><span class="p">))</span>
<span class="c1">#    P = np.random.rand(r,p)</span>

    <span class="c1"># aux. variables</span>
    <span class="n">W1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">W2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Ptil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="c1"># dual variables</span>
    <span class="n">Lam_W1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_W2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>


    <span class="c1">#%%=== create empty lists for tracking updates ===</span>
    <span class="c1"># keep track of frobenius norm loss</span>
    <span class="n">cost_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W1</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ptil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">))</span> <span class="o">-</span> <span class="n">X</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
<span class="c1">#    cost = norm( X - dot(W,P.dot(X)), &#39;fro&#39;)**2/2</span>
    <span class="n">cost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>

    <span class="c1"># relative change in cost</span>
    <span class="n">diffcost</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># keep track of relative primal residual</span>
    <span class="n">res_W1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_W2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_P</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_H</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># also keep track of diffW</span>
<span class="c1">#    diffW = []</span>
    <span class="c1">#%%=== run admm iterations ===</span>
    <span class="n">eye_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="c1"># precompute term needed for inversion lemma</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">X</span><span class="p">),</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="n">start</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iter</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1">#================ primal updates (P, W, H, Ptil, Wtil) ===============#</span>
            <span class="c1"># update for P involves inversion lemma...</span>
            <span class="n">_R</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Lam_H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">/</span><span class="n">rho</span> <span class="o">-</span> <span class="n">Lam_P</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">rho</span> <span class="o">+</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">Ptil</span><span class="o">.</span><span class="n">T</span>
            <span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="n">_R</span> <span class="o">-</span> <span class="n">X</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">dot</span><span class="p">(</span><span class="n">K</span><span class="p">,</span><span class="n">_R</span><span class="p">)</span> <span class="p">))</span><span class="o">.</span><span class="n">T</span>
            <span class="n">Ptil</span> <span class="o">=</span> <span class="p">(</span><span class="n">P</span><span class="o">+</span><span class="n">Lam_P</span><span class="o">/</span><span class="n">rho</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
            <span class="c1"># (W,H) updates</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">W</span><span class="p">)</span><span class="o">+</span><span class="n">rho</span><span class="o">*</span><span class="n">eye_r</span><span class="p">,</span> <span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">X</span><span class="p">)</span> <span class="o">-</span> <span class="n">Lam_H</span><span class="p">)</span>
            <span class="n">W</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="n">eye_r</span><span class="p">,</span>
                      <span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">W1</span><span class="o">+</span><span class="n">W2</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">Lam_W1</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">Lam_W2</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    
            <span class="c1"># projections</span>
            <span class="n">W1</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span><span class="o">+</span><span class="n">Lam_W1</span><span class="o">/</span><span class="n">rho</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">W2</span> <span class="o">=</span> <span class="n">projection_spectral</span><span class="p">(</span><span class="n">W</span><span class="o">+</span><span class="n">Lam_W2</span><span class="o">/</span><span class="n">rho</span><span class="p">,</span><span class="n">projection_type</span><span class="o">=</span><span class="n">constraint</span><span class="p">)</span>
    
            <span class="c1">#====================== dual updates =================================#</span>
            <span class="n">Lam_W1</span> <span class="o">=</span> <span class="n">Lam_W1</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">W</span> <span class="o">-</span> <span class="n">W1</span><span class="p">)</span>
            <span class="n">Lam_W2</span> <span class="o">=</span> <span class="n">Lam_W2</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">W</span> <span class="o">-</span> <span class="n">W2</span><span class="p">)</span>
            <span class="n">Lam_P</span> <span class="o">=</span> <span class="n">Lam_P</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">P</span> <span class="o">-</span> <span class="n">Ptil</span><span class="p">)</span>
            <span class="n">Lam_H</span> <span class="o">=</span> <span class="n">Lam_H</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">H</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">X</span><span class="p">))</span>
    
            <span class="c1">#============ comptute objective values ==============================#</span>
            <span class="c1"># main loss function</span>
            <span class="n">cost</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W1</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ptil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">))</span> <span class="o">-</span> <span class="n">X</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
    <span class="c1">#        cost = norm( X - dot(W,P.dot(X)), &#39;fro&#39;)**2/2</span>
            <span class="n">cost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>
    
            <span class="c1"># relative change in cost</span>
            <span class="n">diffcost</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span><span class="o">/</span><span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
    
            <span class="c1"># relative primal residuals</span>
            <span class="n">res_W1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="o">-</span><span class="n">W1</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
            <span class="n">res_W2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="o">-</span><span class="n">W2</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
            <span class="n">res_P</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">P</span><span class="o">-</span><span class="n">Ptil</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
            <span class="n">res_H</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="o">-</span><span class="n">P</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">),</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
    
            <span class="c1"># relative change in basis matrix</span>
    <span class="c1">#        diffW.append( norm(W-W_old,&#39;fro&#39;)/ norm(W_old, &#39;fro&#39;) )</span>
    
            <span class="c1">#=== termination check =============#</span>
            <span class="n">check_exit</span> <span class="o">=</span>  <span class="p">(</span><span class="n">diffcost</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">)</span>
            <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span>  <span class="n">res_W1</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">)</span>
            <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span>  <span class="n">res_W2</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">)</span>
            <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span>   <span class="n">res_P</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">)</span>
            <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span>   <span class="n">res_H</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">check_exit</span> <span class="ow">and</span> <span class="nb">iter</span> <span class="o">&gt;</span> <span class="mi">300</span><span class="p">:</span> <span class="c1"># allow 300 iterations of &quot;burn-in&quot;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">silence</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s2">&quot;Termination condition met.  Exit at iter =&quot;</span><span class="p">,</span><span class="nb">iter</span><span class="p">,</span>
                <span class="k">break</span>
            <span class="c1">#=============== print current progress ==============================#</span>
    <span class="c1">#        if iter % disp_freq == 0:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">iter</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">iter</span> <span class="o">%</span> <span class="n">disp_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">str_</span> <span class="o">=</span> <span class="s2">&quot;iter={:4} cost={:6.5e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">iter</span><span class="p">,</span><span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; diffcost={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">diffcost</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
                <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; W1={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_W1</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
                <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; W2={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_W2</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
                <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; P={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_P</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
                <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; H={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_H</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
    <span class="c1">#            str_ += &quot; diffW={:3.2e}&quot;.format(diffW[iter])</span>
                <span class="k">print</span> <span class="n">str_</span> <span class="o">+</span> <span class="s2">&quot; ({:3.1f} sec)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="c1">#%%---- end of admm for loop ---------------------------------------------#</span>
    <span class="n">cost_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cost_list</span><span class="p">)</span>

    <span class="c1"># convert residual in pandas dataframe</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">res_W1</span><span class="p">,</span><span class="n">res_W2</span><span class="p">,</span><span class="n">res_P</span><span class="p">,</span><span class="n">res_H</span><span class="p">,</span><span class="n">diffcost</span><span class="p">],</span>
                       <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;res_W1&#39;</span><span class="p">,</span><span class="s1">&#39;res_W2&#39;</span><span class="p">,</span><span class="s1">&#39;res_P&#39;</span><span class="p">,</span><span class="s1">&#39;res_H&#39;</span><span class="p">,</span><span class="s1">&#39;diffcost&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">silence</span><span class="p">:</span> <span class="n">print_time</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">W</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">W1</span><span class="p">,</span><span class="n">Ptil</span><span class="p">,</span><span class="n">cost_list</span><span class="p">,</span><span class="n">res</span>


<span class="k">def</span> <span class="nf">ls_pnmf_admm</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">r</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">gam</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">,</span><span class="n">rho</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span><span class="n">gam2</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">W_init</span><span class="o">=</span><span class="s1">&#39;nndsvd&#39;</span><span class="p">,</span><span class="n">disp_freq</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">silence</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">add_intercept</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Projective NMF using ADMM.</span>

<span class="sd">    &gt;&gt;&gt; W,P,H,w,Wtil,Ptil,cost,res = ls_pnmf_admm(X,r,rho=1e2)</span>

<span class="sd">    The projective NMF here adopts the following parametrization:</span>

<span class="sd">    .. math ::</span>

<span class="sd">        \\min_{W,P} \\frac{1}{2}\|X - W(PX)\|^2_F</span>
<span class="sd">            \;\; \\text{s.t.}\;\;  W\ge 0, P \ge 0</span>

<span class="sd">    This is converted into the following equivalent constrained problem:</span>

<span class="sd">    .. math ::</span>

<span class="sd">        \\min_{W,P,H} \\frac{1}{2}\|X - WH\|^2_F</span>
<span class="sd">            + I_+(\\tilde{W}) + I_+(\\tilde{P})</span>
<span class="sd">            \\\\ \\quad \\text{s.t.}\;\;  W\ge 0, P \ge 0, H=PX,</span>
<span class="sd">                         W=\\tilde{W}, P=\\tilde{P}</span>

<span class="sd">        W,\\tilde{W} \in \mathbb{R}_+^{p\\times r}\\quad</span>
<span class="sd">        P,\\tilde{P} \in \mathbb{R}_+^{r\\times p}\\quad</span>
<span class="sd">        H \in \mathbb{R}_+^{r\\times n}\\quad</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : ndarray of shape (n_features, n_samples)=(p,n)</span>
<span class="sd">        Data matrix with columns as data points</span>
<span class="sd">    y : array-like of shape [n_samples,]</span>
<span class="sd">        Label vector</span>
<span class="sd">    r : int</span>
<span class="sd">        Dimension of the embedding space (n_components)</span>
<span class="sd">    rho : float</span>
<span class="sd">        Augmented Lagrangian parameter</span>
<span class="sd">    max_iter : int</span>
<span class="sd">        max number of iterations</span>
<span class="sd">    tol : float</span>
<span class="sd">        convergence tolerance (on relative change in objective value and</span>
<span class="sd">        all primal residuals)</span>
<span class="sd">    W_init : None, rng, or &#39;nndsvd&#39;</span>
<span class="sd">        Way to initialize W (and H).  If ``None`` or ``RandomState object``</span>
<span class="sd">        is supplied, both W and H will be initialized via non-negative</span>
<span class="sd">        random number.  If ``&#39;nndsvd&#39;``, will use deterministic initialization</span>
<span class="sd">        NNDSVD &quot;Non-Negative Double Singular Value Decomposition&quot;, proposed by</span>
<span class="sd">        Boutsidis2008.</span>
<span class="sd">    disp_freq : int</span>
<span class="sd">        Frequency of update display (in iterations)</span>
<span class="sd">    silence : bool</span>
<span class="sd">        If True, don&#39;t print-out convergence detail at the end.</span>
<span class="sd">    add_intercept : bool (default=False)</span>
<span class="sd">        Add intercept term to classifier (added 02/17/2016)</span>

<span class="sd">    Update history</span>
<span class="sd">    --------------</span>
<span class="sd">    **02/01/2016** - updates based on ``t_0127d2_revisit_pnmf_admm.py``</span>

<span class="sd">    - change initialization scheme and order of primal admm updates</span>

<span class="sd">    **02/02/2016**</span>

<span class="sd">    - added ``silence`` option</span>
<span class="sd">    - changed input ``W`` to ``W_init``</span>

<span class="sd">    **02/17/2016** - added ``add_intercept`` option</span>
<span class="sd">    </span>
<span class="sd">    07/11/2016 -- added keyboard interrupt</span>
<span class="sd">    </span>
<span class="sd">    07/13/2016 -- added &#39;gam2&#39; for regularization (only affects the H update)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">gam</span> <span class="o">*=</span> <span class="mf">1.</span><span class="c1"># &lt;- ensure float</span>
    <span class="n">gam2</span> <span class="o">*=</span> <span class="mf">1.</span><span class="c1"># &lt;- ensure float</span>
    <span class="c1">#%%=== initialize variables =====</span>
    <span class="c1"># define main primal variable W (basis matrix)</span>
    <span class="k">if</span> <span class="n">W_init</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">W_init</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">):</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">W_init</span>

        <span class="n">W</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">W_init</span> <span class="o">==</span> <span class="s1">&#39;nndsvd&#39;</span><span class="p">:</span>
<span class="c1">#        W = nnd_svd(X,r)</span>
        <span class="n">W</span><span class="p">,</span><span class="n">H</span> <span class="o">=</span> <span class="n">nnd_svd</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">get_H</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid input for &quot;W_init&quot;&#39;</span><span class="p">)</span>

    <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">p</span><span class="p">))</span>
<span class="c1">#    P = np.random.rand(r,p)</span>

    <span class="k">if</span> <span class="n">add_intercept</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># &lt;- classification vector</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="c1"># &lt;- classification vector</span>

    <span class="c1"># aux. variables</span>
    <span class="n">Wtil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Ptil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="c1"># dual variables</span>
    <span class="n">Lam_W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>


    <span class="c1">#%%=== create empty lists for tracking updates ===</span>
    <span class="c1"># keep track of frobenius norm loss</span>
    <span class="n">cost_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cost_nmf_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cost_ls_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">PX</span> <span class="o">=</span> <span class="n">Ptil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">cost_nmf</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">Wtil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">PX</span><span class="p">)</span> <span class="o">-</span> <span class="n">X</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">if</span> <span class="n">add_intercept</span><span class="p">:</span>
        <span class="c1"># used for the least-squares term</span>
        <span class="n">one_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">PX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">PX</span><span class="p">,</span><span class="n">one_n</span><span class="p">))</span>
        
        <span class="c1"># used in regularized ridge regression for w update</span>
        <span class="n">eye_r0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">eye_r0</span><span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># to avoid penalizing intercept term</span>
        
    <span class="n">cost_ls</span>  <span class="o">=</span> <span class="n">gam</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">PX</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">))</span> <span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="n">cost_nmf</span> <span class="o">+</span> <span class="n">cost_ls</span>

    <span class="n">cost_nmf_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_nmf</span><span class="p">)</span>
    <span class="n">cost_ls_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_ls</span><span class="p">)</span>
    <span class="n">cost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>

    <span class="c1"># relative change in cost</span>
    <span class="n">diffcost</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># keep track of relative primal residual</span>
    <span class="n">res_W</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_P</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_H</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># also keep track of diffW</span>
<span class="c1">#    diffW = []</span>
    <span class="c1">#%%=== run admm iterations ===</span>
    <span class="n">eye_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    
    <span class="c1"># precompute term needed for inversion lemma</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">X</span><span class="p">),</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="n">start</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iter</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
    <span class="c1">#        W_old = W #&lt;- to keep track of diffW</span>
    
            <span class="c1">#================ primal updates (P, W, H, Ptil, Wtil) ===============#</span>
            <span class="c1"># update for P involves inversion lemma...</span>
            <span class="n">_R</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Lam_H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">/</span><span class="n">rho</span> <span class="o">-</span> <span class="n">Lam_P</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">rho</span> <span class="o">+</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">Ptil</span><span class="o">.</span><span class="n">T</span>
            <span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="n">_R</span> <span class="o">-</span> <span class="n">X</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">dot</span><span class="p">(</span><span class="n">K</span><span class="p">,</span><span class="n">_R</span><span class="p">)</span> <span class="p">))</span><span class="o">.</span><span class="n">T</span>
            <span class="n">Ptil</span> <span class="o">=</span> <span class="p">(</span><span class="n">P</span><span class="o">+</span><span class="n">Lam_P</span><span class="o">/</span><span class="n">rho</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
            <span class="c1"># (W,H) updates</span>
            <span class="k">if</span> <span class="n">add_intercept</span><span class="p">:</span>
                <span class="n">ytil</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">one_n</span><span class="o">*</span><span class="n">w</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">H</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">W</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">eye_r</span> <span class="o">+</span> <span class="n">gam</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">w</span><span class="p">[:</span><span class="n">r</span><span class="p">],</span><span class="n">w</span><span class="p">[:</span><span class="n">r</span><span class="p">]),</span>
                      <span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">X</span><span class="p">)</span> <span class="o">-</span> <span class="n">Lam_H</span> <span class="o">+</span> <span class="n">gam</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">w</span><span class="p">[:</span><span class="n">r</span><span class="p">],</span><span class="n">ytil</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">H</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">W</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">eye_r</span> <span class="o">+</span> <span class="n">gam</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">w</span><span class="p">),</span>
                      <span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">X</span><span class="p">)</span> <span class="o">-</span> <span class="n">Lam_H</span> <span class="o">+</span> <span class="n">gam</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">y</span><span class="p">))</span>
                      
            <span class="k">if</span> <span class="n">add_intercept</span><span class="p">:</span>
                <span class="c1"># H with intercept</span>
                <span class="n">H_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">H</span><span class="p">,</span><span class="n">one_n</span><span class="p">))</span>
                <span class="c1"># for now, ignore gam2 regularizer...i never use them</span>
                <span class="c1">#w = solve( H_.dot(H_.T) , H_.dot(y))</span>
                <span class="c1"># regularized case</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span> <span class="n">H_</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">H_</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">gam2</span><span class="o">/</span><span class="n">gam</span><span class="p">)</span><span class="o">*</span><span class="n">eye_r0</span><span class="p">,</span> <span class="n">H_</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span> <span class="n">H</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">gam2</span><span class="o">/</span><span class="n">gam</span><span class="p">)</span><span class="o">*</span><span class="n">eye_r</span> <span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
    
            <span class="n">W</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">+</span><span class="n">rho</span><span class="o">*</span><span class="n">eye_r</span><span class="p">,</span> <span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">Wtil</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">Lam_W</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="n">Wtil</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span><span class="o">+</span><span class="n">Lam_W</span><span class="o">/</span><span class="n">rho</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
            <span class="c1">#====================== dual updates =================================#</span>
            <span class="n">Lam_W</span> <span class="o">=</span> <span class="n">Lam_W</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">W</span> <span class="o">-</span> <span class="n">Wtil</span><span class="p">)</span>
            <span class="n">Lam_P</span> <span class="o">=</span> <span class="n">Lam_P</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">P</span> <span class="o">-</span> <span class="n">Ptil</span><span class="p">)</span>
            <span class="n">Lam_H</span> <span class="o">=</span> <span class="n">Lam_H</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">H</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">X</span><span class="p">))</span>
    
            <span class="c1">#============ comptute objective values ==============================#</span>
            <span class="c1"># main loss function</span>
            <span class="n">PX</span> <span class="o">=</span> <span class="n">Ptil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">cost_nmf</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">Wtil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">PX</span><span class="p">)</span> <span class="o">-</span> <span class="n">X</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
            <span class="k">if</span> <span class="n">add_intercept</span><span class="p">:</span> <span class="c1"># for computing LS loss term</span>
                <span class="n">PX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">PX</span><span class="p">,</span><span class="n">one_n</span><span class="p">))</span>
            <span class="n">cost_ls</span>  <span class="o">=</span> <span class="n">gam</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">PX</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">))</span> <span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">cost</span> <span class="o">=</span> <span class="n">cost_nmf</span> <span class="o">+</span> <span class="n">cost_ls</span>
    
            <span class="n">cost_nmf_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_nmf</span><span class="p">)</span>
            <span class="n">cost_ls_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_ls</span><span class="p">)</span>
            <span class="n">cost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>
    
            <span class="c1"># relative change in cost</span>
            <span class="n">diffcost</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span><span class="o">/</span><span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
    
            <span class="c1"># relative primal residuals</span>
            <span class="n">res_W</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="o">-</span><span class="n">Wtil</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
            <span class="n">res_P</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">P</span><span class="o">-</span><span class="n">Ptil</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
            <span class="n">res_H</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="o">-</span><span class="n">P</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">),</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
    
            <span class="c1"># relative change in basis matrix</span>
    <span class="c1">#        diffW.append( norm(W-W_old,&#39;fro&#39;)/ norm(W_old, &#39;fro&#39;) )</span>
    
            <span class="c1">#=== termination check ====#</span>
            <span class="n">check_exit</span>  <span class="o">=</span> <span class="p">(</span><span class="n">diffcost</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">)</span>
            <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_W</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
            <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_P</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
            <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_H</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">check_exit</span> <span class="ow">and</span> <span class="nb">iter</span> <span class="o">&gt;</span> <span class="mi">300</span><span class="p">:</span> <span class="c1"># allow 300 iterations of &quot;burn-in&quot;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">silence</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s2">&quot;    Termination condition met.  Exit at iter =&quot;</span><span class="p">,</span><span class="nb">iter</span><span class="p">,</span>
                <span class="k">break</span>
            <span class="c1">#=============== print current progress ==============================#</span>
    <span class="c1">#        if iter % disp_freq == 0:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">iter</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">iter</span> <span class="o">%</span> <span class="n">disp_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
    <span class="c1">#            str_ = &quot;iter={:4} cost={:3.3f}&quot;.format(iter,cost_list[iter+1])</span>
                <span class="n">str_</span> <span class="o">=</span> <span class="s2">&quot;iter={:4} cost={:6.5e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">iter</span><span class="p">,</span><span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; nmf={:.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cost_nmf_list</span><span class="p">[</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; ls={:.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cost_ls_list</span><span class="p">[</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; diffcost={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">diffcost</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
                <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; res_W={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_W</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
                <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; res_P={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_P</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
                <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; res_H={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_H</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
    <span class="c1">#            str_ += &quot; diffW={:3.2e}&quot;.format(diffW[iter])</span>
                <span class="k">print</span> <span class="n">str_</span> <span class="o">+</span> <span class="s2">&quot; ({:3.1f} sec)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="c1">#%%---- end of admm for loop ---------------------------------------------#</span>
<span class="c1">#    cost_list = np.array(cost_list)</span>

    <span class="c1"># convert residual in pandas dataframe</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">cost_list</span><span class="p">,</span> <span class="n">cost_nmf_list</span><span class="p">,</span> <span class="n">cost_ls_list</span><span class="p">],</span>
                        <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">,</span><span class="s1">&#39;nmf&#39;</span><span class="p">,</span><span class="s1">&#39;ls&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">res_W</span><span class="p">,</span><span class="n">res_P</span><span class="p">,</span><span class="n">res_H</span><span class="p">,</span><span class="n">diffcost</span><span class="p">],</span>
                       <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;res_W&#39;</span><span class="p">,</span><span class="s1">&#39;res_P&#39;</span><span class="p">,</span><span class="s1">&#39;res_H&#39;</span><span class="p">,</span><span class="s1">&#39;diffcost&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">silence</span><span class="p">:</span> <span class="n">print_time</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">W</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">Wtil</span><span class="p">,</span><span class="n">Ptil</span><span class="p">,</span><span class="n">cost</span><span class="p">,</span><span class="n">res</span>

<span class="k">def</span> <span class="nf">ls_pnmf_admm_bal</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">r</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">gam</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">,</span><span class="n">rho</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
                 <span class="n">W_init</span><span class="o">=</span><span class="s1">&#39;nndsvd&#39;</span><span class="p">,</span><span class="n">disp_freq</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">silence</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">add_intercept</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Same as ``ls_pnmf_admm``, but with class-weighted loss</span>

<span class="sd">    &gt;&gt;&gt; W,P,H,Wtil,Ptil,cost_list,res = ls_pnmf_admm_bal(X,r,rho=1e2)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : ndarray of shape (n_features, n_samples)=(p,n)</span>
<span class="sd">        Data matrix with columns as data points</span>
<span class="sd">    y : array-like of shape [n_samples,]</span>
<span class="sd">        Label vector</span>
<span class="sd">    r : int</span>
<span class="sd">        Dimension of the embedding space (n_components)</span>
<span class="sd">    rho : float</span>
<span class="sd">        Augmented Lagrangian parameter</span>
<span class="sd">    max_iter : int</span>
<span class="sd">        max number of iterations</span>
<span class="sd">    tol : float</span>
<span class="sd">        convergence tolerance (on relative change in objective value and</span>
<span class="sd">        all primal residuals)</span>
<span class="sd">    W_init : None, rng, or &#39;nndsvd&#39;</span>
<span class="sd">        Way to initialize W (and H).  If ``None`` or ``RandomState object``</span>
<span class="sd">        is supplied, both W and H will be initialized via non-negative</span>
<span class="sd">        random number.  If ``&#39;nndsvd&#39;``, will use deterministic initialization</span>
<span class="sd">        NNDSVD &quot;Non-Negative Double Singular Value Decomposition&quot;, proposed by</span>
<span class="sd">        Boutsidis2008.</span>
<span class="sd">    disp_freq : int</span>
<span class="sd">        Frequency of update display (in iterations)</span>
<span class="sd">    silence : bool</span>
<span class="sd">        If True, don&#39;t print-out convergence detail at the end.</span>
<span class="sd">    add_intercept : bool (default=False)</span>
<span class="sd">        Add intercept term to classifier (added 02/17/2016)</span>

<span class="sd">    Update history</span>
<span class="sd">    --------------</span>
<span class="sd">    **02/17/2016** - created</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">rho</span> <span class="o">*=</span> <span class="mf">1.</span>
    <span class="n">gam</span> <span class="o">*=</span> <span class="mf">1.</span><span class="c1"># &lt;- ensure float</span>
    <span class="c1">#%% get class balance info</span>
    <span class="n">weight_pos</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="o">==-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">n</span>
    <span class="n">weight_neg</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">weight_pos</span>
    <span class="n">weight_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">weight_vec</span><span class="p">[</span><span class="n">y</span><span class="o">==+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight_pos</span>
    <span class="n">weight_vec</span><span class="p">[</span><span class="n">y</span><span class="o">==-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight_neg</span>
    <span class="n">J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span> <span class="n">weight_vec</span> <span class="p">)</span>
    <span class="c1">#%%=== initialize variables =====</span>
    <span class="c1"># define main primal variable W (basis matrix)</span>
    <span class="k">if</span> <span class="n">W_init</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">W_init</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">):</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">W_init</span>

        <span class="n">W</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">W_init</span> <span class="o">==</span> <span class="s1">&#39;nndsvd&#39;</span><span class="p">:</span>
<span class="c1">#        W = nnd_svd(X,r)</span>
        <span class="n">W</span><span class="p">,</span><span class="n">H</span> <span class="o">=</span> <span class="n">nnd_svd</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">get_H</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid input for &quot;W_init&quot;&#39;</span><span class="p">)</span>

    <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">p</span><span class="p">))</span>
<span class="c1">#    P = np.random.rand(r,p)</span>

    <span class="k">if</span> <span class="n">add_intercept</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># &lt;- classification vector</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="c1"># &lt;- classification vector</span>

    <span class="c1"># aux. variables</span>
    <span class="n">Wtil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Ptil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="c1"># dual variables</span>
    <span class="n">Lam_W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>


    <span class="c1">#%%=== create empty lists for tracking updates ===</span>
    <span class="c1"># keep track of frobenius norm loss</span>
    <span class="n">cost_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cost_nmf_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cost_ls_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">PX</span> <span class="o">=</span> <span class="n">Ptil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">cost_nmf</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">Wtil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">PX</span><span class="p">)</span> <span class="o">-</span> <span class="n">X</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">if</span> <span class="n">add_intercept</span><span class="p">:</span>
        <span class="c1"># used for the least-squares term</span>
        <span class="n">one_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">PX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">PX</span><span class="p">,</span><span class="n">one_n</span><span class="p">))</span>
    <span class="c1"># compute weighted error</span>
    <span class="n">_err</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">PX</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
    <span class="n">_err</span> <span class="o">=</span> <span class="n">_err</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">J</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">_err</span><span class="p">))</span>
    <span class="n">cost_ls</span>  <span class="o">=</span> <span class="n">gam</span><span class="o">*</span><span class="n">_err</span><span class="o">/</span><span class="mi">2</span>
    <span class="c1">#cost_ls  = gam*norm(y - PX.T.dot(w)) **2/2</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="n">cost_nmf</span> <span class="o">+</span> <span class="n">cost_ls</span>

    <span class="n">cost_nmf_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_nmf</span><span class="p">)</span>
    <span class="n">cost_ls_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_ls</span><span class="p">)</span>
    <span class="n">cost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>

    <span class="c1"># relative change in cost</span>
    <span class="n">diffcost</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># keep track of relative primal residual</span>
    <span class="n">res_W</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_P</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_H</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># also keep track of diffW</span>
<span class="c1">#    diffW = []</span>
    <span class="c1">#%%=== run admm iterations ===</span>
    <span class="n">eye_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="c1"># precompute term needed for inversion lemma</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">X</span><span class="p">),</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="n">start</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iter</span><span class="p">):</span>
<span class="c1">#        W_old = W #&lt;- to keep track of diffW</span>

        <span class="c1">#================ primal updates (P, W, H, Ptil, Wtil) ===============#</span>
        <span class="c1"># update for P involves inversion lemma...</span>
        <span class="n">_R</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Lam_H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">/</span><span class="n">rho</span> <span class="o">-</span> <span class="n">Lam_P</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">rho</span> <span class="o">+</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">Ptil</span><span class="o">.</span><span class="n">T</span>
        <span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="n">_R</span> <span class="o">-</span> <span class="n">X</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">dot</span><span class="p">(</span><span class="n">K</span><span class="p">,</span><span class="n">_R</span><span class="p">)</span> <span class="p">))</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Ptil</span> <span class="o">=</span> <span class="p">(</span><span class="n">P</span><span class="o">+</span><span class="n">Lam_P</span><span class="o">/</span><span class="n">rho</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># (W,H) updates</span>
        <span class="n">WtW</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">W</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">eye_r</span>
        <span class="k">if</span> <span class="n">add_intercept</span><span class="p">:</span>
            <span class="n">ytil</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">one_n</span><span class="o">*</span><span class="n">w</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">_S</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">X</span><span class="p">)</span> <span class="o">-</span> <span class="n">Lam_H</span> <span class="o">+</span> <span class="n">gam</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">w</span><span class="p">[:</span><span class="n">r</span><span class="p">],</span><span class="n">ytil</span><span class="p">)</span>
            <span class="n">wtw</span> <span class="o">=</span> <span class="n">gam</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">w</span><span class="p">[:</span><span class="n">r</span><span class="p">],</span><span class="n">w</span><span class="p">[:</span><span class="n">r</span><span class="p">])</span>
            <span class="c1">#H = solve(dot(W.T,W) + rho*eye_r + gam*np.outer(w[:r],w[:r]),_S)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_S</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">X</span><span class="p">)</span> <span class="o">-</span> <span class="n">Lam_H</span> <span class="o">+</span> <span class="n">gam</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
            <span class="n">wtw</span> <span class="o">=</span> <span class="n">gam</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">w</span><span class="p">)</span>
            <span class="c1">#H = solve(dot(W.T,W) + rho*eye_r + gam*np.outer(w,w),_S)</span>

        <span class="n">H</span><span class="p">[:,</span><span class="n">y</span><span class="o">==+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">WtW</span> <span class="o">+</span> <span class="n">weight_pos</span><span class="o">*</span><span class="n">wtw</span><span class="p">,</span> <span class="n">_S</span><span class="p">[:,</span><span class="n">y</span><span class="o">==+</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">H</span><span class="p">[:,</span><span class="n">y</span><span class="o">==-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">WtW</span> <span class="o">+</span> <span class="n">weight_neg</span><span class="o">*</span><span class="n">wtw</span><span class="p">,</span> <span class="n">_S</span><span class="p">[:,</span><span class="n">y</span><span class="o">==-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">add_intercept</span><span class="p">:</span>
            <span class="c1"># H with intercept</span>
            <span class="n">H_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">H</span><span class="p">,</span><span class="n">one_n</span><span class="p">))</span>
            <span class="c1"># for now, ignore gam2 regularizer...i never use them</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span> <span class="n">H_</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">J</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">H_</span><span class="o">.</span><span class="n">T</span><span class="p">)),</span> <span class="n">H_</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">J</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span> <span class="n">H</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">J</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">))</span> <span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">J</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">)))</span>

        <span class="n">W</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">+</span><span class="n">rho</span><span class="o">*</span><span class="n">eye_r</span><span class="p">,</span> <span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">Wtil</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">Lam_W</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Wtil</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span><span class="o">+</span><span class="n">Lam_W</span><span class="o">/</span><span class="n">rho</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1">#====================== dual updates =================================#</span>
        <span class="n">Lam_W</span> <span class="o">=</span> <span class="n">Lam_W</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">W</span> <span class="o">-</span> <span class="n">Wtil</span><span class="p">)</span>
        <span class="n">Lam_P</span> <span class="o">=</span> <span class="n">Lam_P</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">P</span> <span class="o">-</span> <span class="n">Ptil</span><span class="p">)</span>
        <span class="n">Lam_H</span> <span class="o">=</span> <span class="n">Lam_H</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">H</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">X</span><span class="p">))</span>

        <span class="c1">#============ comptute objective values ==============================#</span>
        <span class="c1"># main loss function</span>
        <span class="n">PX</span> <span class="o">=</span> <span class="n">Ptil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">cost_nmf</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">Wtil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">PX</span><span class="p">)</span> <span class="o">-</span> <span class="n">X</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
        <span class="k">if</span> <span class="n">add_intercept</span><span class="p">:</span> <span class="c1"># for computing LS loss term</span>
            <span class="n">PX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">PX</span><span class="p">,</span><span class="n">one_n</span><span class="p">))</span>
        <span class="c1"># compute weighted error</span>
        <span class="n">_err</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">PX</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
        <span class="n">_err</span> <span class="o">=</span> <span class="n">_err</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">J</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">_err</span><span class="p">))</span>
        <span class="n">cost_ls</span>  <span class="o">=</span> <span class="n">gam</span><span class="o">*</span><span class="n">_err</span><span class="o">/</span><span class="mi">2</span>
        <span class="c1">#cost_ls  = gam*norm(y - PX.T.dot(w)) **2/2</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="n">cost_nmf</span> <span class="o">+</span> <span class="n">cost_ls</span>

        <span class="n">cost_nmf_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_nmf</span><span class="p">)</span>
        <span class="n">cost_ls_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_ls</span><span class="p">)</span>
        <span class="n">cost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>

        <span class="c1"># relative change in cost</span>
        <span class="n">diffcost</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span><span class="o">/</span><span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>

        <span class="c1"># relative primal residuals</span>
        <span class="n">res_W</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="o">-</span><span class="n">Wtil</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="n">res_P</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">P</span><span class="o">-</span><span class="n">Ptil</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="n">res_H</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="o">-</span><span class="n">P</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">),</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>

        <span class="c1"># relative change in basis matrix</span>
<span class="c1">#        diffW.append( norm(W-W_old,&#39;fro&#39;)/ norm(W_old, &#39;fro&#39;) )</span>

        <span class="c1">#=== termination check ====#</span>
        <span class="n">check_exit</span>  <span class="o">=</span> <span class="p">(</span><span class="n">diffcost</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_W</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_P</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_H</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">check_exit</span> <span class="ow">and</span> <span class="nb">iter</span> <span class="o">&gt;</span> <span class="mi">300</span><span class="p">:</span> <span class="c1"># allow 300 iterations of &quot;burn-in&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silence</span><span class="p">:</span>
                <span class="k">print</span> <span class="s2">&quot;    Termination condition met.  Exit at iter =&quot;</span><span class="p">,</span><span class="nb">iter</span><span class="p">,</span>
            <span class="k">break</span>
        <span class="c1">#=============== print current progress ==============================#</span>
<span class="c1">#        if iter % disp_freq == 0:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">iter</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">iter</span> <span class="o">%</span> <span class="n">disp_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="c1">#            str_ = &quot;iter={:4} cost={:3.3f}&quot;.format(iter,cost_list[iter+1])</span>
            <span class="n">str_</span> <span class="o">=</span> <span class="s2">&quot;iter={:4} cost={:6.5e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">iter</span><span class="p">,</span><span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; nmf={:.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cost_nmf_list</span><span class="p">[</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; ls={:.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cost_ls_list</span><span class="p">[</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; diffcost={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">diffcost</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; res_W={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_W</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; res_P={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_P</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; res_H={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_H</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
<span class="c1">#            str_ += &quot; diffW={:3.2e}&quot;.format(diffW[iter])</span>
            <span class="k">print</span> <span class="n">str_</span> <span class="o">+</span> <span class="s2">&quot; ({:3.1f} sec)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>
    <span class="c1">#%%---- end of admm for loop ---------------------------------------------#</span>
<span class="c1">#    cost_list = np.array(cost_list)</span>

    <span class="c1"># convert residual in pandas dataframe</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">cost_list</span><span class="p">,</span> <span class="n">cost_nmf_list</span><span class="p">,</span> <span class="n">cost_ls_list</span><span class="p">],</span>
                        <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">,</span><span class="s1">&#39;nmf&#39;</span><span class="p">,</span><span class="s1">&#39;ls&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">res_W</span><span class="p">,</span><span class="n">res_P</span><span class="p">,</span><span class="n">res_H</span><span class="p">,</span><span class="n">diffcost</span><span class="p">],</span>
                       <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;res_W&#39;</span><span class="p">,</span><span class="s1">&#39;res_P&#39;</span><span class="p">,</span><span class="s1">&#39;res_H&#39;</span><span class="p">,</span><span class="s1">&#39;diffcost&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">silence</span><span class="p">:</span> <span class="n">print_time</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">W</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">Wtil</span><span class="p">,</span><span class="n">Ptil</span><span class="p">,</span><span class="n">cost</span><span class="p">,</span><span class="n">res</span>


<span class="k">def</span> <span class="nf">ls_spnmf_admm</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">r</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">gam</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">,</span><span class="n">rho</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
                  <span class="n">W_init</span><span class="o">=</span><span class="s1">&#39;nndsvd&#39;</span><span class="p">,</span><span class="n">disp_freq</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span><span class="n">silence</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                  <span class="n">constraint</span><span class="o">=</span><span class="s1">&#39;stiefel&#39;</span><span class="p">,</span><span class="n">gam2</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">add_intercept</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Projective NMF using ADMM.  gam2 = regularizer for classifier</span>

<span class="sd">    &gt;&gt;&gt; W,P,H,w,Wtil,Ptil,cost,res = pnmf_admm(X,r,rho=1e2)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : ndarray of shape (n_features, n_samples)=(p,n)</span>
<span class="sd">        Data matrix with columns as data points</span>
<span class="sd">    y : array-like of shape [n_samples,]</span>
<span class="sd">        Label vector</span>
<span class="sd">    r : int</span>
<span class="sd">        Dimension of the embedding space (n_components)</span>
<span class="sd">    rho : float</span>
<span class="sd">        Augmented Lagrangian parameter</span>
<span class="sd">    max_iter : int</span>
<span class="sd">        max number of iterations</span>
<span class="sd">    tol : float</span>
<span class="sd">        convergence tolerance (on relative change in objective value and</span>
<span class="sd">        all primal residuals)</span>
<span class="sd">    W_init : None, rng, or &#39;nndsvd&#39;</span>
<span class="sd">        Way to initialize W (and H).  If ``None`` or ``RandomState object``</span>
<span class="sd">        is supplied, both W and H will be initialized via non-negative</span>
<span class="sd">        random number.  If ``&#39;nndsvd&#39;``, will use deterministic initialization</span>
<span class="sd">        NNDSVD &quot;Non-Negative Double Singular Value Decomposition&quot;, proposed by</span>
<span class="sd">        Boutsidis2008.</span>
<span class="sd">    disp_freq : int</span>
<span class="sd">        Frequency of update display (in iterations)</span>
<span class="sd">    silence : bool</span>
<span class="sd">        If True, don&#39;t print-out convergence detail at the end.</span>
<span class="sd">    add_intercept : bool (default=False)</span>
<span class="sd">        Add intercept term to classifier (added 02/17/2016)</span>

<span class="sd">    Update history</span>
<span class="sd">    --------------</span>
<span class="sd">    **02/02/2016** - created but dirty code</span>

<span class="sd">    **02/03/2016** - Added regularizer    ``gam2``</span>

<span class="sd">    **02/17/2016** - added ``add_intercept`` option</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">rho</span> <span class="o">*=</span> <span class="mf">1.</span>
    <span class="n">gam</span> <span class="o">*=</span> <span class="mf">1.</span><span class="c1"># &lt;- ensure float</span>
    <span class="n">gam2</span> <span class="o">*=</span> <span class="mf">1.</span><span class="c1"># &lt;- ensure float</span>
    <span class="c1">#%%=== initialize variables =====</span>
    <span class="c1"># define main primal variable W (basis matrix)</span>
    <span class="k">if</span> <span class="n">W_init</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">W_init</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">):</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">W_init</span>

        <span class="n">W</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">W_init</span> <span class="o">==</span> <span class="s1">&#39;nndsvd&#39;</span><span class="p">:</span>
<span class="c1">#        W = nnd_svd(X,r)</span>
        <span class="n">W</span><span class="p">,</span><span class="n">H</span> <span class="o">=</span> <span class="n">nnd_svd</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">get_H</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid input for &quot;W_init&quot;&#39;</span><span class="p">)</span>

    <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">p</span><span class="p">))</span>
<span class="c1">#    P = np.random.rand(r,p)</span>

    <span class="k">if</span> <span class="n">add_intercept</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># &lt;- classification vector</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="c1"># &lt;- classification vector</span>

    <span class="c1"># aux. variables</span>
    <span class="n">Wtil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">W2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Ptil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="c1"># dual variables</span>
    <span class="n">Lam_W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_W2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>


    <span class="c1">#%%=== create empty lists for tracking updates ===</span>
    <span class="c1"># keep track of frobenius norm loss</span>
    <span class="n">cost_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cost_nmf_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cost_ls_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">PX</span> <span class="o">=</span> <span class="n">Ptil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">cost_nmf</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">Wtil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">PX</span><span class="p">)</span> <span class="o">-</span> <span class="n">X</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">if</span> <span class="n">add_intercept</span><span class="p">:</span>
        <span class="c1"># used for the least-squares term</span>
        <span class="n">one_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">PX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">PX</span><span class="p">,</span><span class="n">one_n</span><span class="p">))</span>
    <span class="n">cost_ls</span>  <span class="o">=</span> <span class="n">gam</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">PX</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">))</span> <span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">gam2</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="n">cost_nmf</span> <span class="o">+</span> <span class="n">cost_ls</span>

    <span class="n">cost_nmf_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_nmf</span><span class="p">)</span>
    <span class="n">cost_ls_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_ls</span><span class="p">)</span>
    <span class="n">cost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>

    <span class="c1"># relative change in cost</span>
    <span class="n">diffcost</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># keep track of relative primal residual</span>
    <span class="n">res_W</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_W2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_P</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_H</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># also keep track of diffW</span>
<span class="c1">#    diffW = []</span>
    <span class="c1">#%%=== run admm iterations ===</span>
    <span class="n">eye_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="c1"># precompute term needed for inversion lemma</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">X</span><span class="p">),</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="n">start</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iter</span><span class="p">):</span>
<span class="c1">#        W_old = W #&lt;- to keep track of diffW</span>

        <span class="c1">#================ primal updates (P, W, H, Ptil, Wtil) ===============#</span>
        <span class="c1"># update for P involves inversion lemma...</span>
        <span class="n">_R</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Lam_H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">/</span><span class="n">rho</span> <span class="o">-</span> <span class="n">Lam_P</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">rho</span> <span class="o">+</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">Ptil</span><span class="o">.</span><span class="n">T</span>
        <span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="n">_R</span> <span class="o">-</span> <span class="n">X</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">dot</span><span class="p">(</span><span class="n">K</span><span class="p">,</span><span class="n">_R</span><span class="p">)</span> <span class="p">))</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Ptil</span> <span class="o">=</span> <span class="p">(</span><span class="n">P</span><span class="o">+</span><span class="n">Lam_P</span><span class="o">/</span><span class="n">rho</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># (W,H) updates</span>
        <span class="k">if</span> <span class="n">add_intercept</span><span class="p">:</span>
            <span class="n">ytil</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">one_n</span><span class="o">*</span><span class="n">w</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">W</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">eye_r</span> <span class="o">+</span> <span class="n">gam</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">w</span><span class="p">[:</span><span class="n">r</span><span class="p">],</span><span class="n">w</span><span class="p">[:</span><span class="n">r</span><span class="p">]),</span>
                      <span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span><span class="o">+</span><span class="n">rho</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">X</span><span class="p">)</span><span class="o">-</span><span class="n">Lam_H</span> <span class="o">+</span> <span class="n">gam</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">w</span><span class="p">[:</span><span class="n">r</span><span class="p">],</span><span class="n">ytil</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">W</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">eye_r</span> <span class="o">+</span> <span class="n">gam</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">w</span><span class="p">),</span>
                      <span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span><span class="o">+</span><span class="n">rho</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">X</span><span class="p">)</span><span class="o">-</span><span class="n">Lam_H</span> <span class="o">+</span> <span class="n">gam</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">y</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">add_intercept</span><span class="p">:</span>
            <span class="c1"># H with intercept</span>
            <span class="n">H_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">H</span><span class="p">,</span><span class="n">one_n</span><span class="p">))</span>
            <span class="c1"># for now, ignore gam2 regularizer...i never use them</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span> <span class="n">H_</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">H_</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">H_</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span> <span class="n">H</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">gam2</span><span class="o">/</span><span class="n">gam</span><span class="p">)</span><span class="o">*</span><span class="n">eye_r</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>

        <span class="n">W</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="n">eye_r</span><span class="p">,</span>
                  <span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">Wtil</span><span class="o">+</span><span class="n">W2</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">Lam_W</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">Lam_W2</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="n">Wtil</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span><span class="o">+</span><span class="n">Lam_W</span><span class="o">/</span><span class="n">rho</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">W2</span> <span class="o">=</span> <span class="n">projection_spectral</span><span class="p">(</span><span class="n">W</span><span class="o">+</span><span class="n">Lam_W2</span><span class="o">/</span><span class="n">rho</span><span class="p">,</span><span class="n">constraint</span><span class="p">)</span>

        <span class="c1">#====================== dual updates =================================#</span>
        <span class="n">Lam_W</span> <span class="o">=</span> <span class="n">Lam_W</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">W</span> <span class="o">-</span> <span class="n">Wtil</span><span class="p">)</span>
        <span class="n">Lam_W2</span> <span class="o">=</span> <span class="n">Lam_W2</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">W</span> <span class="o">-</span> <span class="n">W2</span><span class="p">)</span>
        <span class="n">Lam_P</span> <span class="o">=</span> <span class="n">Lam_P</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">P</span> <span class="o">-</span> <span class="n">Ptil</span><span class="p">)</span>
        <span class="n">Lam_H</span> <span class="o">=</span> <span class="n">Lam_H</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">H</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">X</span><span class="p">))</span>

        <span class="c1">#============ comptute objective values ==============================#</span>
        <span class="c1"># main loss function</span>
        <span class="n">PX</span> <span class="o">=</span> <span class="n">Ptil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">cost_nmf</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">Wtil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">PX</span><span class="p">)</span> <span class="o">-</span> <span class="n">X</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
        <span class="k">if</span> <span class="n">add_intercept</span><span class="p">:</span> <span class="c1"># for computing LS loss term</span>
            <span class="n">PX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">PX</span><span class="p">,</span><span class="n">one_n</span><span class="p">))</span>
        <span class="n">cost_ls</span>  <span class="o">=</span> <span class="n">gam</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">PX</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">))</span> <span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">gam2</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="n">cost_nmf</span> <span class="o">+</span> <span class="n">cost_ls</span>

        <span class="n">cost_nmf_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_nmf</span><span class="p">)</span>
        <span class="n">cost_ls_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_ls</span><span class="p">)</span>
        <span class="n">cost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>

        <span class="c1"># relative change in cost</span>
        <span class="n">diffcost</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span><span class="o">/</span><span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>

        <span class="c1"># relative primal residuals</span>
        <span class="n">res_W</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="o">-</span><span class="n">Wtil</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="n">res_W2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="o">-</span><span class="n">W2</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="n">res_P</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">P</span><span class="o">-</span><span class="n">Ptil</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="n">res_H</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="o">-</span><span class="n">P</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">),</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>

        <span class="c1"># relative change in basis matrix</span>
<span class="c1">#        diffW.append( norm(W-W_old,&#39;fro&#39;)/ norm(W_old, &#39;fro&#39;) )</span>

        <span class="c1">#=== termination check ====#</span>
        <span class="n">check_exit</span>  <span class="o">=</span> <span class="p">(</span><span class="n">diffcost</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_W</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_W2</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_P</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_H</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">check_exit</span> <span class="ow">and</span> <span class="nb">iter</span> <span class="o">&gt;</span> <span class="mi">300</span><span class="p">:</span> <span class="c1"># allow 300 iterations of &quot;burn-in&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silence</span><span class="p">:</span>
                <span class="k">print</span> <span class="s2">&quot;    Termination condition met.  Exit at iter =&quot;</span><span class="p">,</span><span class="nb">iter</span><span class="p">,</span>
            <span class="k">break</span>
        <span class="c1">#=============== print current progress ==============================#</span>
<span class="c1">#        if iter % disp_freq == 0:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">iter</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">iter</span> <span class="o">%</span> <span class="n">disp_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="c1">#            str_ = &quot;iter={:4} cost={:3.3f}&quot;.format(iter,cost_list[iter+1])</span>
            <span class="n">str_</span> <span class="o">=</span> <span class="s2">&quot;iter={:4} cost={:6.5e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">iter</span><span class="p">,</span><span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; nmf={:.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cost_nmf_list</span><span class="p">[</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; ls={:.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cost_ls_list</span><span class="p">[</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; diffcost={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">diffcost</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; W={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_W</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; W2={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_W2</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; P={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_P</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; H={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_H</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
<span class="c1">#            str_ += &quot; diffW={:3.2e}&quot;.format(diffW[iter])</span>
            <span class="k">print</span> <span class="n">str_</span> <span class="o">+</span> <span class="s2">&quot; ({:3.1f} sec)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>
    <span class="c1">#%%---- end of admm for loop ---------------------------------------------#</span>
<span class="c1">#    cost_list = np.array(cost_list)</span>

    <span class="c1"># convert residual in pandas dataframe</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">cost_list</span><span class="p">,</span> <span class="n">cost_nmf_list</span><span class="p">,</span> <span class="n">cost_ls_list</span><span class="p">],</span>
                        <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">,</span><span class="s1">&#39;nmf&#39;</span><span class="p">,</span><span class="s1">&#39;ls&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">res_W</span><span class="p">,</span><span class="n">res_W2</span><span class="p">,</span><span class="n">res_P</span><span class="p">,</span><span class="n">res_H</span><span class="p">,</span><span class="n">diffcost</span><span class="p">],</span>
                       <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;res_W&#39;</span><span class="p">,</span><span class="s1">&#39;res_W2&#39;</span><span class="p">,</span><span class="s1">&#39;res_P&#39;</span><span class="p">,</span><span class="s1">&#39;res_H&#39;</span><span class="p">,</span><span class="s1">&#39;diffcost&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">silence</span><span class="p">:</span> <span class="n">print_time</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">W</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">Wtil</span><span class="p">,</span><span class="n">Ptil</span><span class="p">,</span><span class="n">cost</span><span class="p">,</span><span class="n">res</span>



<span class="k">def</span> <span class="nf">ls_spnmf_admm_bal</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">r</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">gam</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">,</span><span class="n">rho</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
                  <span class="n">W_init</span><span class="o">=</span><span class="s1">&#39;nndsvd&#39;</span><span class="p">,</span><span class="n">disp_freq</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span><span class="n">silence</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                  <span class="n">constraint</span><span class="o">=</span><span class="s1">&#39;stiefel&#39;</span><span class="p">,</span><span class="n">gam2</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">add_intercept</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; PSame as ``ls_spnmf_admm``, but with class-weighted loss</span>

<span class="sd">    &gt;&gt;&gt; W,P,H,w,Wtil,Ptil,cost,res = ls_spnmf_admm_bal(X,y,r,rho=1e2)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : ndarray of shape (n_features, n_samples)=(p,n)</span>
<span class="sd">        Data matrix with columns as data points</span>
<span class="sd">    y : array-like of shape [n_samples,]</span>
<span class="sd">        Label vector</span>
<span class="sd">    r : int</span>
<span class="sd">        Dimension of the embedding space (n_components)</span>
<span class="sd">    rho : float</span>
<span class="sd">        Augmented Lagrangian parameter</span>
<span class="sd">    max_iter : int</span>
<span class="sd">        max number of iterations</span>
<span class="sd">    tol : float</span>
<span class="sd">        convergence tolerance (on relative change in objective value and</span>
<span class="sd">        all primal residuals)</span>
<span class="sd">    W_init : None, rng, or &#39;nndsvd&#39;</span>
<span class="sd">        Way to initialize W (and H).  If ``None`` or ``RandomState object``</span>
<span class="sd">        is supplied, both W and H will be initialized via non-negative</span>
<span class="sd">        random number.  If ``&#39;nndsvd&#39;``, will use deterministic initialization</span>
<span class="sd">        NNDSVD &quot;Non-Negative Double Singular Value Decomposition&quot;, proposed by</span>
<span class="sd">        Boutsidis2008.</span>
<span class="sd">    disp_freq : int</span>
<span class="sd">        Frequency of update display (in iterations)</span>
<span class="sd">    silence : bool</span>
<span class="sd">        If True, don&#39;t print-out convergence detail at the end.</span>
<span class="sd">    add_intercept : bool (default=False)</span>
<span class="sd">        Add intercept term to classifier (added 02/17/2016)</span>

<span class="sd">    Update history</span>
<span class="sd">    --------------</span>
<span class="sd">    **02/17/2016** - function created</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">rho</span> <span class="o">*=</span> <span class="mf">1.</span>
    <span class="n">gam</span> <span class="o">*=</span> <span class="mf">1.</span><span class="c1"># &lt;- ensure float</span>
    <span class="n">gam2</span> <span class="o">*=</span> <span class="mf">1.</span><span class="c1"># &lt;- ensure float</span>
    <span class="c1">#%% get class balance info</span>
    <span class="n">weight_pos</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="o">==-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">n</span>
    <span class="n">weight_neg</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">weight_pos</span>
    <span class="n">weight_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">weight_vec</span><span class="p">[</span><span class="n">y</span><span class="o">==+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight_pos</span>
    <span class="n">weight_vec</span><span class="p">[</span><span class="n">y</span><span class="o">==-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight_neg</span>
    <span class="n">J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span> <span class="n">weight_vec</span> <span class="p">)</span>
    <span class="c1">#%%=== initialize variables =====</span>
    <span class="c1"># define main primal variable W (basis matrix)</span>
    <span class="k">if</span> <span class="n">W_init</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">W_init</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">):</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">W_init</span>

        <span class="n">W</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">W_init</span> <span class="o">==</span> <span class="s1">&#39;nndsvd&#39;</span><span class="p">:</span>
<span class="c1">#        W = nnd_svd(X,r)</span>
        <span class="n">W</span><span class="p">,</span><span class="n">H</span> <span class="o">=</span> <span class="n">nnd_svd</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">get_H</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid input for &quot;W_init&quot;&#39;</span><span class="p">)</span>

    <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">p</span><span class="p">))</span>
<span class="c1">#    P = np.random.rand(r,p)</span>

    <span class="k">if</span> <span class="n">add_intercept</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># &lt;- classification vector</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="c1"># &lt;- classification vector</span>

    <span class="c1"># aux. variables</span>
    <span class="n">Wtil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">W2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Ptil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="c1"># dual variables</span>
    <span class="n">Lam_W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_W2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>


    <span class="c1">#%%=== create empty lists for tracking updates ===</span>
    <span class="c1"># keep track of frobenius norm loss</span>
    <span class="n">cost_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cost_nmf_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cost_ls_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">PX</span> <span class="o">=</span> <span class="n">Ptil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">cost_nmf</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">Wtil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">PX</span><span class="p">)</span> <span class="o">-</span> <span class="n">X</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">if</span> <span class="n">add_intercept</span><span class="p">:</span>
        <span class="c1"># used for the least-squares term</span>
        <span class="n">one_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">PX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">PX</span><span class="p">,</span><span class="n">one_n</span><span class="p">))</span>
    <span class="c1"># compute weighted error</span>
    <span class="n">_err</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">PX</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
    <span class="n">_err</span> <span class="o">=</span> <span class="n">_err</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">J</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">_err</span><span class="p">))</span>
    <span class="n">cost_ls</span>  <span class="o">=</span> <span class="n">gam</span><span class="o">*</span><span class="n">_err</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">gam2</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
    <span class="c1">#cost_ls  = gam*norm(y - PX.T.dot(w)) **2/2 + gam2*norm(w)**2/2</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="n">cost_nmf</span> <span class="o">+</span> <span class="n">cost_ls</span>

    <span class="n">cost_nmf_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_nmf</span><span class="p">)</span>
    <span class="n">cost_ls_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_ls</span><span class="p">)</span>
    <span class="n">cost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>

    <span class="c1"># relative change in cost</span>
    <span class="n">diffcost</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># keep track of relative primal residual</span>
    <span class="n">res_W</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_W2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_P</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_H</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># also keep track of diffW</span>
<span class="c1">#    diffW = []</span>
    <span class="c1">#%%=== run admm iterations ===</span>
    <span class="n">eye_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="c1"># precompute term needed for inversion lemma</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">X</span><span class="p">),</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="n">start</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iter</span><span class="p">):</span>
<span class="c1">#        W_old = W #&lt;- to keep track of diffW</span>

        <span class="c1">#================ primal updates (P, W, H, Ptil, Wtil) ===============#</span>
        <span class="c1"># update for P involves inversion lemma...</span>
        <span class="n">_R</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Lam_H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">/</span><span class="n">rho</span> <span class="o">-</span> <span class="n">Lam_P</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">rho</span> <span class="o">+</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">Ptil</span><span class="o">.</span><span class="n">T</span>
        <span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="n">_R</span> <span class="o">-</span> <span class="n">X</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">dot</span><span class="p">(</span><span class="n">K</span><span class="p">,</span><span class="n">_R</span><span class="p">)</span> <span class="p">))</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Ptil</span> <span class="o">=</span> <span class="p">(</span><span class="n">P</span><span class="o">+</span><span class="n">Lam_P</span><span class="o">/</span><span class="n">rho</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># (W,H) updates</span>
        <span class="n">WtW</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">W</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">eye_r</span>
        <span class="k">if</span> <span class="n">add_intercept</span><span class="p">:</span>
            <span class="n">ytil</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">one_n</span><span class="o">*</span><span class="n">w</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">_S</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span><span class="o">+</span><span class="n">rho</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">X</span><span class="p">)</span><span class="o">-</span><span class="n">Lam_H</span> <span class="o">+</span> <span class="n">gam</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">w</span><span class="p">[:</span><span class="n">r</span><span class="p">],</span><span class="n">ytil</span><span class="p">)</span>
            <span class="n">wtw</span> <span class="o">=</span> <span class="n">gam</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">w</span><span class="p">[:</span><span class="n">r</span><span class="p">],</span><span class="n">w</span><span class="p">[:</span><span class="n">r</span><span class="p">])</span>
            <span class="c1">#H = solve(dot(W.T,W) + rho*eye_r + gam*np.outer(w[:r],w[:r]),</span>
            <span class="c1">#          dot(W.T, X)+rho*dot(P,X)-Lam_H + gam*np.outer(w[:r],ytil))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_S</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span><span class="o">+</span><span class="n">rho</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">X</span><span class="p">)</span><span class="o">-</span><span class="n">Lam_H</span> <span class="o">+</span> <span class="n">gam</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
            <span class="n">wtw</span> <span class="o">=</span> <span class="n">gam</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">w</span><span class="p">)</span>
            <span class="c1">#H = solve(dot(W.T,W) + rho*eye_r + gam*np.outer(w,w),</span>
            <span class="c1">#          dot(W.T, X)+rho*dot(P,X)-Lam_H + gam*np.outer(w,y))</span>
        <span class="n">H</span><span class="p">[:,</span><span class="n">y</span><span class="o">==+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">WtW</span> <span class="o">+</span> <span class="n">weight_pos</span><span class="o">*</span><span class="n">wtw</span><span class="p">,</span> <span class="n">_S</span><span class="p">[:,</span><span class="n">y</span><span class="o">==+</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">H</span><span class="p">[:,</span><span class="n">y</span><span class="o">==-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">WtW</span> <span class="o">+</span> <span class="n">weight_neg</span><span class="o">*</span><span class="n">wtw</span><span class="p">,</span> <span class="n">_S</span><span class="p">[:,</span><span class="n">y</span><span class="o">==-</span><span class="mi">1</span><span class="p">])</span>


        <span class="k">if</span> <span class="n">add_intercept</span><span class="p">:</span>
            <span class="c1"># H with intercept</span>
            <span class="n">H_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">H</span><span class="p">,</span><span class="n">one_n</span><span class="p">))</span>
            <span class="c1"># for now, ignore gam2 regularizer...i never use them</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span> <span class="n">H_</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">J</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">H_</span><span class="o">.</span><span class="n">T</span><span class="p">)),</span> <span class="n">H_</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">J</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span> <span class="n">H</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">J</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">gam2</span><span class="o">/</span><span class="n">gam</span><span class="p">)</span><span class="o">*</span><span class="n">eye_r</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">J</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">)))</span>

        <span class="n">W</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="n">eye_r</span><span class="p">,</span>
                  <span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">Wtil</span><span class="o">+</span><span class="n">W2</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">Lam_W</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">Lam_W2</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="n">Wtil</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span><span class="o">+</span><span class="n">Lam_W</span><span class="o">/</span><span class="n">rho</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">W2</span> <span class="o">=</span> <span class="n">projection_spectral</span><span class="p">(</span><span class="n">W</span><span class="o">+</span><span class="n">Lam_W2</span><span class="o">/</span><span class="n">rho</span><span class="p">,</span><span class="n">constraint</span><span class="p">)</span>

        <span class="c1">#====================== dual updates =================================#</span>
        <span class="n">Lam_W</span> <span class="o">=</span> <span class="n">Lam_W</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">W</span> <span class="o">-</span> <span class="n">Wtil</span><span class="p">)</span>
        <span class="n">Lam_W2</span> <span class="o">=</span> <span class="n">Lam_W2</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">W</span> <span class="o">-</span> <span class="n">W2</span><span class="p">)</span>
        <span class="n">Lam_P</span> <span class="o">=</span> <span class="n">Lam_P</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">P</span> <span class="o">-</span> <span class="n">Ptil</span><span class="p">)</span>
        <span class="n">Lam_H</span> <span class="o">=</span> <span class="n">Lam_H</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">H</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">X</span><span class="p">))</span>

        <span class="c1">#============ comptute objective values ==============================#</span>
        <span class="c1"># main loss function</span>
        <span class="n">PX</span> <span class="o">=</span> <span class="n">Ptil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">cost_nmf</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">Wtil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">PX</span><span class="p">)</span> <span class="o">-</span> <span class="n">X</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
        <span class="k">if</span> <span class="n">add_intercept</span><span class="p">:</span> <span class="c1"># for computing LS loss term</span>
            <span class="n">PX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">PX</span><span class="p">,</span><span class="n">one_n</span><span class="p">))</span>
        <span class="c1"># compute weighted error</span>
        <span class="n">_err</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">PX</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
        <span class="n">_err</span> <span class="o">=</span> <span class="n">_err</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">J</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">_err</span><span class="p">))</span>
        <span class="n">cost_ls</span>  <span class="o">=</span> <span class="n">gam</span><span class="o">*</span><span class="n">_err</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">gam2</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
        <span class="c1">#cost_ls  = gam*norm(y - PX.T.dot(w)) **2/2 + gam2*norm(w)**2/2</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="n">cost_nmf</span> <span class="o">+</span> <span class="n">cost_ls</span>

        <span class="n">cost_nmf_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_nmf</span><span class="p">)</span>
        <span class="n">cost_ls_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_ls</span><span class="p">)</span>
        <span class="n">cost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>

        <span class="c1"># relative change in cost</span>
        <span class="n">diffcost</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span><span class="o">/</span><span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>

        <span class="c1"># relative primal residuals</span>
        <span class="n">res_W</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="o">-</span><span class="n">Wtil</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="n">res_W2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="o">-</span><span class="n">W2</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="n">res_P</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">P</span><span class="o">-</span><span class="n">Ptil</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="n">res_H</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="o">-</span><span class="n">P</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">),</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>

        <span class="c1"># relative change in basis matrix</span>
<span class="c1">#        diffW.append( norm(W-W_old,&#39;fro&#39;)/ norm(W_old, &#39;fro&#39;) )</span>

        <span class="c1">#=== termination check ====#</span>
        <span class="n">check_exit</span>  <span class="o">=</span> <span class="p">(</span><span class="n">diffcost</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_W</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_W2</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_P</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_H</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">check_exit</span> <span class="ow">and</span> <span class="nb">iter</span> <span class="o">&gt;</span> <span class="mi">300</span><span class="p">:</span> <span class="c1"># allow 300 iterations of &quot;burn-in&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silence</span><span class="p">:</span>
                <span class="k">print</span> <span class="s2">&quot;    Termination condition met.  Exit at iter =&quot;</span><span class="p">,</span><span class="nb">iter</span><span class="p">,</span>
            <span class="k">break</span>
        <span class="c1">#=============== print current progress ==============================#</span>
<span class="c1">#        if iter % disp_freq == 0:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">iter</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">iter</span> <span class="o">%</span> <span class="n">disp_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="c1">#            str_ = &quot;iter={:4} cost={:3.3f}&quot;.format(iter,cost_list[iter+1])</span>
            <span class="n">str_</span> <span class="o">=</span> <span class="s2">&quot;iter={:4} cost={:6.5e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">iter</span><span class="p">,</span><span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; nmf={:.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cost_nmf_list</span><span class="p">[</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; ls={:.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cost_ls_list</span><span class="p">[</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; diffcost={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">diffcost</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; W={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_W</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; W2={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_W2</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; P={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_P</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; H={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_H</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
<span class="c1">#            str_ += &quot; diffW={:3.2e}&quot;.format(diffW[iter])</span>
            <span class="k">print</span> <span class="n">str_</span> <span class="o">+</span> <span class="s2">&quot; ({:3.1f} sec)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>
    <span class="c1">#%%---- end of admm for loop ---------------------------------------------#</span>
<span class="c1">#    cost_list = np.array(cost_list)</span>

    <span class="c1"># convert residual in pandas dataframe</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">cost_list</span><span class="p">,</span> <span class="n">cost_nmf_list</span><span class="p">,</span> <span class="n">cost_ls_list</span><span class="p">],</span>
                        <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">,</span><span class="s1">&#39;nmf&#39;</span><span class="p">,</span><span class="s1">&#39;ls&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">res_W</span><span class="p">,</span><span class="n">res_W2</span><span class="p">,</span><span class="n">res_P</span><span class="p">,</span><span class="n">res_H</span><span class="p">,</span><span class="n">diffcost</span><span class="p">],</span>
                       <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;res_W&#39;</span><span class="p">,</span><span class="s1">&#39;res_W2&#39;</span><span class="p">,</span><span class="s1">&#39;res_P&#39;</span><span class="p">,</span><span class="s1">&#39;res_H&#39;</span><span class="p">,</span><span class="s1">&#39;diffcost&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">silence</span><span class="p">:</span> <span class="n">print_time</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">W</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">Wtil</span><span class="p">,</span><span class="n">Ptil</span><span class="p">,</span><span class="n">cost</span><span class="p">,</span><span class="n">res</span>



<span class="c1">#%% === graph regularized methods</span>
<span class="k">def</span> <span class="nf">gpnmf_admm</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">tau</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">,</span><span class="n">rho</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span><span class="n">W_init</span><span class="o">=</span><span class="s1">&#39;nndsvd&#39;</span><span class="p">,</span>
               <span class="n">disp_freq</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">silence</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Graph regularized Projective NMF using ADMM.</span>

<span class="sd">    &gt;&gt;&gt; W,P,H,Wtil,Ptil,cost_list,res = gpnmf_admm(X,r,rho=5e2)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : ndarray of shape (n_features, n_samples)=(p,n)</span>
<span class="sd">        Data matrix with columns as data points</span>
<span class="sd">    r : int</span>
<span class="sd">        Dimension of the embedding space (n_components)</span>
<span class="sd">    L : ndarray of shape = [n_samples, n_samples]</span>
<span class="sd">        Laplacian matrix.</span>
<span class="sd">    tau : float</span>
<span class="sd">        Amount of graph regularization to apply</span>
<span class="sd">    rho : float</span>
<span class="sd">        Augmented Lagrangian parameter</span>
<span class="sd">    max_iter : int</span>
<span class="sd">        max number of iterations</span>
<span class="sd">    tol : float</span>
<span class="sd">        convergence tolerance (on relative change in objective value and</span>
<span class="sd">        all primal residuals)</span>
<span class="sd">    W_init : None (default), rng, or &#39;nndsvd&#39;</span>
<span class="sd">        Way to initialize W (and H).  If ``None`` or ``RandomState object``</span>
<span class="sd">        is supplied, both W and H will be initialized via non-negative</span>
<span class="sd">        random number.  If ``&#39;nndsvd&#39;``, will use deterministic initialization</span>
<span class="sd">        NNDSVD &quot;Non-Negative Double Singular Value Decomposition&quot;, proposed by</span>
<span class="sd">        Boutsidis2008.</span>
<span class="sd">    disp_freq : int</span>
<span class="sd">        Frequency of update display (in iterations)</span>
<span class="sd">    silence : bool</span>
<span class="sd">        If True, don&#39;t print-out convergence detail at the end.</span>

<span class="sd">    Update history</span>
<span class="sd">    --------------</span>
<span class="sd">    **02/03/2016** - function created</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rho</span> <span class="o">*=</span> <span class="mf">1.</span>
    <span class="n">tau</span> <span class="o">*=</span> <span class="mf">1.</span>
    <span class="n">p</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
    <span class="c1">#%%=== initialize variables =====</span>
    <span class="c1"># define main primal variable W (basis matrix)</span>
    <span class="k">if</span> <span class="n">W_init</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">W_init</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">):</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">W_init</span>

        <span class="n">W</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">W_init</span> <span class="o">==</span> <span class="s1">&#39;nndsvd&#39;</span><span class="p">:</span>
<span class="c1">#        W = nnd_svd(X,r)</span>
        <span class="n">W</span><span class="p">,</span><span class="n">H</span> <span class="o">=</span> <span class="n">nnd_svd</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">get_H</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid input for &quot;W_init&quot;&#39;</span><span class="p">)</span>

    <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">p</span><span class="p">))</span>
<span class="c1">#    P = np.random.rand(r,p)</span>

    <span class="c1"># aux. variables</span>
    <span class="n">Wtil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Ptil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Htil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="c1"># &lt;- for graph regularization</span>

    <span class="c1"># dual variables</span>
    <span class="n">Lam_W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_Htil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="c1"># &lt;- for graph regularization</span>
    <span class="c1">#%%=== create empty lists for tracking updates ===</span>
    <span class="c1"># keep track of frobenius norm loss</span>
    <span class="n">cost_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cost_nmf_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cost_graph_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">cost_nmf</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">Wtil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ptil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">))</span> <span class="o">-</span> <span class="n">X</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">cost_graph</span> <span class="o">=</span> <span class="n">tau</span><span class="o">*</span><span class="n">trace</span><span class="p">(</span> <span class="n">L</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">dot</span><span class="p">(</span><span class="n">Htil</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Htil</span><span class="p">)))</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="n">cost_nmf</span> <span class="o">+</span> <span class="n">cost_graph</span>

    <span class="n">cost_nmf_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_nmf</span><span class="p">)</span>
    <span class="n">cost_graph_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_graph</span><span class="p">)</span>
    <span class="n">cost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>

    <span class="c1"># relative change in cost</span>
    <span class="n">diffcost</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># keep track of relative primal residual</span>
    <span class="n">res_W</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_P</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_H</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_Htil</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># also keep track of diffW</span>
<span class="c1">#    diffW = []</span>
    <span class="c1">#%%=== run admm iterations ===</span>
    <span class="n">eye_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">eye_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

    <span class="c1"># precompute term needed for inversion lemma</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">X</span><span class="p">),</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="n">start</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iter</span><span class="p">):</span>
<span class="c1">#        W_old = W #&lt;- to keep track of diffW</span>

        <span class="c1">#================ primal updates (P, W, H, Ptil, Wtil) ===============#</span>
        <span class="c1"># update for P involves inversion lemma...</span>
        <span class="n">_R</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Lam_H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">/</span><span class="n">rho</span> <span class="o">-</span> <span class="n">Lam_P</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">rho</span> <span class="o">+</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">Ptil</span><span class="o">.</span><span class="n">T</span>
        <span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="n">_R</span> <span class="o">-</span> <span class="n">X</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">dot</span><span class="p">(</span><span class="n">K</span><span class="p">,</span><span class="n">_R</span><span class="p">)</span> <span class="p">))</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Ptil</span> <span class="o">=</span> <span class="p">(</span><span class="n">P</span><span class="o">+</span><span class="n">Lam_P</span><span class="o">/</span><span class="n">rho</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># (W,H) updates</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">W</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="n">eye_r</span><span class="p">,</span>
                  <span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">X</span><span class="p">)</span> <span class="o">-</span> <span class="n">Lam_H</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">Htil</span> <span class="o">-</span> <span class="n">Lam_Htil</span> <span class="p">)</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">+</span><span class="n">rho</span><span class="o">*</span><span class="n">eye_r</span><span class="p">,</span> <span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">Wtil</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">Lam_W</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Wtil</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span><span class="o">+</span><span class="n">Lam_W</span><span class="o">/</span><span class="n">rho</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">Htil</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">tau</span><span class="o">*</span><span class="n">L</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">eye_n</span><span class="p">,</span> <span class="n">rho</span><span class="o">*</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="o">+</span><span class="n">Lam_Htil</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="c1">#====================== dual updates =================================#</span>
        <span class="n">Lam_W</span> <span class="o">=</span> <span class="n">Lam_W</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">W</span> <span class="o">-</span> <span class="n">Wtil</span><span class="p">)</span>
        <span class="n">Lam_P</span> <span class="o">=</span> <span class="n">Lam_P</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">P</span> <span class="o">-</span> <span class="n">Ptil</span><span class="p">)</span>
        <span class="n">Lam_H</span> <span class="o">=</span> <span class="n">Lam_H</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">H</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">X</span><span class="p">))</span>
        <span class="n">Lam_Htil</span> <span class="o">=</span> <span class="n">Lam_Htil</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">H</span><span class="o">-</span><span class="n">Htil</span><span class="p">)</span>

        <span class="c1">#============ comptute objective values ==============================#</span>
        <span class="c1"># main loss function</span>
        <span class="n">cost_nmf</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">Wtil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ptil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">))</span> <span class="o">-</span> <span class="n">X</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">cost_graph</span> <span class="o">=</span> <span class="n">tau</span><span class="o">*</span><span class="n">trace</span><span class="p">(</span> <span class="n">L</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">dot</span><span class="p">(</span><span class="n">Htil</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Htil</span><span class="p">)))</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="n">cost_nmf</span> <span class="o">+</span> <span class="n">cost_graph</span>

        <span class="n">cost_nmf_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_nmf</span><span class="p">)</span>
        <span class="n">cost_graph_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_graph</span><span class="p">)</span>
        <span class="n">cost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>

        <span class="c1"># relative change in cost</span>
        <span class="n">diffcost</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span><span class="o">/</span><span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>

        <span class="c1"># relative primal residuals</span>
        <span class="n">res_W</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="o">-</span><span class="n">Wtil</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="n">res_P</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">P</span><span class="o">-</span><span class="n">Ptil</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="n">res_H</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="o">-</span><span class="n">P</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">),</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="n">res_Htil</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="o">-</span><span class="n">Htil</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>

        <span class="c1"># relative change in basis matrix</span>
<span class="c1">#        diffW.append( norm(W-W_old,&#39;fro&#39;)/ norm(W_old, &#39;fro&#39;) )</span>

        <span class="c1">#=== termination check ====#</span>
        <span class="n">check_exit</span>  <span class="o">=</span> <span class="p">(</span><span class="n">diffcost</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_W</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_P</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_H</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_Htil</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">check_exit</span> <span class="ow">and</span> <span class="nb">iter</span> <span class="o">&gt;</span> <span class="mi">300</span><span class="p">:</span> <span class="c1"># allow 300 iterations of &quot;burn-in&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silence</span><span class="p">:</span>
                <span class="k">print</span> <span class="s2">&quot;Termination condition met.  Exit at iter =&quot;</span><span class="p">,</span><span class="nb">iter</span><span class="p">,</span>
            <span class="k">break</span>
        <span class="c1">#=============== print current progress ==============================#</span>
<span class="c1">#        if iter % disp_freq == 0:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">iter</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">iter</span> <span class="o">%</span> <span class="n">disp_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="c1">#            str_ = &quot;iter={:4} cost={:3.3f}&quot;.format(iter,cost_list[iter+1])</span>
            <span class="n">str_</span> <span class="o">=</span> <span class="s2">&quot;iter={:4} cost={:6.5e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">iter</span><span class="p">,</span><span class="n">cost</span><span class="p">)</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; nmf={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cost_nmf</span><span class="p">)</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; graph={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cost_graph</span><span class="p">)</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; diffcost={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">diffcost</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; W={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_W</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; P={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_P</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; H={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_H</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; Htil={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_Htil</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
<span class="c1">#            str_ += &quot; diffW={:3.2e}&quot;.format(diffW[iter])</span>
            <span class="k">print</span> <span class="n">str_</span> <span class="o">+</span> <span class="s2">&quot; ({:3.1f} sec)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>
    <span class="c1">#%%---- end of admm for loop ---------------------------------------------#</span>
    <span class="n">cost_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cost_list</span><span class="p">)</span>

    <span class="c1"># convert to pandas dataframe</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">cost_list</span><span class="p">,</span> <span class="n">cost_nmf_list</span><span class="p">,</span> <span class="n">cost_graph_list</span><span class="p">],</span>
                        <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">,</span><span class="s1">&#39;nmf&#39;</span><span class="p">,</span><span class="s1">&#39;graph&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">res_W</span><span class="p">,</span><span class="n">res_P</span><span class="p">,</span><span class="n">res_H</span><span class="p">,</span><span class="n">diffcost</span><span class="p">],</span>
                       <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;res_W&#39;</span><span class="p">,</span><span class="s1">&#39;res_P&#39;</span><span class="p">,</span><span class="s1">&#39;res_H&#39;</span><span class="p">,</span><span class="s1">&#39;diffcost&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">silence</span><span class="p">:</span> <span class="n">print_time</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">W</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">Wtil</span><span class="p">,</span><span class="n">Ptil</span><span class="p">,</span><span class="n">cost</span><span class="p">,</span><span class="n">res</span>


<span class="k">def</span> <span class="nf">sgpnmf_admm</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">tau</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">,</span><span class="n">rho</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span><span class="n">W_init</span><span class="o">=</span><span class="s1">&#39;nndsvd&#39;</span><span class="p">,</span>
               <span class="n">disp_freq</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">silence</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Spectral Graph regularized Spectral Projective NMF using ADMM.</span>

<span class="sd">    &gt;&gt;&gt; W,P,H,Wtil,Ptil,cost_list,res = gpnmf_admm(X,r,rho=5e2)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : ndarray of shape (n_features, n_samples)=(p,n)</span>
<span class="sd">        Data matrix with columns as data points</span>
<span class="sd">    r : int</span>
<span class="sd">        Dimension of the embedding space (n_components)</span>
<span class="sd">    L : ndarray of shape = [n_samples, n_samples]</span>
<span class="sd">        Laplacian matrix.</span>
<span class="sd">    tau : float</span>
<span class="sd">        Amount of graph regularization to apply</span>
<span class="sd">    rho : float</span>
<span class="sd">        Augmented Lagrangian parameter</span>
<span class="sd">    max_iter : int</span>
<span class="sd">        max number of iterations</span>
<span class="sd">    tol : float</span>
<span class="sd">        convergence tolerance (on relative change in objective value and</span>
<span class="sd">        all primal residuals)</span>
<span class="sd">    W_init : None (default), rng, or &#39;nndsvd&#39;</span>
<span class="sd">        Way to initialize W (and H).  If ``None`` or ``RandomState object``</span>
<span class="sd">        is supplied, both W and H will be initialized via non-negative</span>
<span class="sd">        random number.  If ``&#39;nndsvd&#39;``, will use deterministic initialization</span>
<span class="sd">        NNDSVD &quot;Non-Negative Double Singular Value Decomposition&quot;, proposed by</span>
<span class="sd">        Boutsidis2008.</span>
<span class="sd">    disp_freq : int</span>
<span class="sd">        Frequency of update display (in iterations)</span>
<span class="sd">    silence : bool</span>
<span class="sd">        If True, don&#39;t print-out convergence detail at the end.</span>

<span class="sd">    Update history</span>
<span class="sd">    --------------</span>
<span class="sd">    **02/03/2016** - function created</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rho</span> <span class="o">*=</span> <span class="mf">1.</span>
    <span class="n">tau</span> <span class="o">*=</span> <span class="mf">1.</span>
    <span class="n">p</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
    <span class="c1">#%%=== initialize variables =====</span>
    <span class="c1"># define main primal variable W (basis matrix)</span>
    <span class="k">if</span> <span class="n">W_init</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">W_init</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">):</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">W_init</span>

        <span class="n">W</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">W_init</span> <span class="o">==</span> <span class="s1">&#39;nndsvd&#39;</span><span class="p">:</span>
<span class="c1">#        W = nnd_svd(X,r)</span>
        <span class="n">W</span><span class="p">,</span><span class="n">H</span> <span class="o">=</span> <span class="n">nnd_svd</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">get_H</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid input for &quot;W_init&quot;&#39;</span><span class="p">)</span>

    <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">p</span><span class="p">))</span>
<span class="c1">#    P = np.random.rand(r,p)</span>

    <span class="c1"># aux. variables</span>
    <span class="n">Wtil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">W2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>  <span class="c1"># &lt;- for spectral projection</span>
    <span class="n">Ptil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Htil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="c1"># &lt;- for graph regularization</span>

    <span class="c1"># dual variables</span>
    <span class="n">Lam_W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_W2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="c1"># &lt;- for spectral projection</span>
    <span class="n">Lam_P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_Htil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="c1"># &lt;- for graph regularization</span>
    <span class="c1">#%%=== create empty lists for tracking updates ===</span>
    <span class="c1"># keep track of frobenius norm loss</span>
    <span class="n">cost_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cost_nmf_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cost_graph_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">cost_nmf</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">Wtil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ptil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">))</span> <span class="o">-</span> <span class="n">X</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">cost_graph</span> <span class="o">=</span> <span class="n">tau</span><span class="o">*</span><span class="n">trace</span><span class="p">(</span> <span class="n">L</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">dot</span><span class="p">(</span><span class="n">Htil</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Htil</span><span class="p">)))</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="n">cost_nmf</span> <span class="o">+</span> <span class="n">cost_graph</span>

    <span class="n">cost_nmf_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_nmf</span><span class="p">)</span>
    <span class="n">cost_graph_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_graph</span><span class="p">)</span>
    <span class="n">cost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>

    <span class="c1"># relative change in cost</span>
    <span class="n">diffcost</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># keep track of relative primal residual</span>
    <span class="n">res_W</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_W2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_P</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_H</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_Htil</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># also keep track of diffW</span>
<span class="c1">#    diffW = []</span>
    <span class="c1">#%%=== run admm iterations ===</span>
    <span class="n">eye_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">eye_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

    <span class="c1"># precompute term needed for inversion lemma</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">X</span><span class="p">),</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="n">start</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iter</span><span class="p">):</span>
<span class="c1">#        W_old = W #&lt;- to keep track of diffW</span>

        <span class="c1">#================ primal updates (P, W, H, Ptil, Wtil) ===============#</span>
        <span class="c1"># update for P involves inversion lemma...</span>
        <span class="n">_R</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Lam_H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">/</span><span class="n">rho</span> <span class="o">-</span> <span class="n">Lam_P</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">rho</span> <span class="o">+</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">Ptil</span><span class="o">.</span><span class="n">T</span>
        <span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="n">_R</span> <span class="o">-</span> <span class="n">X</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">dot</span><span class="p">(</span><span class="n">K</span><span class="p">,</span><span class="n">_R</span><span class="p">)</span> <span class="p">))</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Ptil</span> <span class="o">=</span> <span class="p">(</span><span class="n">P</span><span class="o">+</span><span class="n">Lam_P</span><span class="o">/</span><span class="n">rho</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># (W,H) updates</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">W</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="n">eye_r</span><span class="p">,</span>
                  <span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">X</span><span class="p">)</span> <span class="o">-</span> <span class="n">Lam_H</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">Htil</span> <span class="o">-</span> <span class="n">Lam_Htil</span> <span class="p">)</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="n">eye_r</span><span class="p">,</span>
                  <span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">Wtil</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">Lam_W</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">W2</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">Lam_W2</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Wtil</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span><span class="o">+</span><span class="n">Lam_W</span><span class="o">/</span><span class="n">rho</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">W2</span> <span class="o">=</span> <span class="n">projection_spectral</span><span class="p">(</span><span class="n">W</span> <span class="o">+</span> <span class="n">Lam_W2</span><span class="o">/</span><span class="n">rho</span><span class="p">)</span>

        <span class="n">Htil</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">tau</span><span class="o">*</span><span class="n">L</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">eye_n</span><span class="p">,</span> <span class="n">rho</span><span class="o">*</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="o">+</span><span class="n">Lam_Htil</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="c1">#====================== dual updates =================================#</span>
        <span class="n">Lam_W</span> <span class="o">=</span> <span class="n">Lam_W</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">W</span> <span class="o">-</span> <span class="n">Wtil</span><span class="p">)</span>
        <span class="n">Lam_W2</span> <span class="o">=</span> <span class="n">Lam_W2</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">W</span> <span class="o">-</span> <span class="n">W2</span><span class="p">)</span>
        <span class="n">Lam_P</span> <span class="o">=</span> <span class="n">Lam_P</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">P</span> <span class="o">-</span> <span class="n">Ptil</span><span class="p">)</span>
        <span class="n">Lam_H</span> <span class="o">=</span> <span class="n">Lam_H</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">H</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">X</span><span class="p">))</span>
        <span class="n">Lam_Htil</span> <span class="o">=</span> <span class="n">Lam_Htil</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">H</span><span class="o">-</span><span class="n">Htil</span><span class="p">)</span>

        <span class="c1">#============ comptute objective values ==============================#</span>
        <span class="c1"># main loss function</span>
        <span class="n">cost_nmf</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">Wtil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ptil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">))</span> <span class="o">-</span> <span class="n">X</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">cost_graph</span> <span class="o">=</span> <span class="n">tau</span><span class="o">*</span><span class="n">trace</span><span class="p">(</span> <span class="n">L</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">dot</span><span class="p">(</span><span class="n">Htil</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Htil</span><span class="p">)))</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="n">cost_nmf</span> <span class="o">+</span> <span class="n">cost_graph</span>

        <span class="n">cost_nmf_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_nmf</span><span class="p">)</span>
        <span class="n">cost_graph_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_graph</span><span class="p">)</span>
        <span class="n">cost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>

        <span class="c1"># relative change in cost</span>
        <span class="n">diffcost</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span><span class="o">/</span><span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>

        <span class="c1"># relative primal residuals</span>
        <span class="n">res_W</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="o">-</span><span class="n">Wtil</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="n">res_W2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="o">-</span><span class="n">W2</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="n">res_P</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">P</span><span class="o">-</span><span class="n">Ptil</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="n">res_H</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="o">-</span><span class="n">P</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">),</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="n">res_Htil</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="o">-</span><span class="n">Htil</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>

        <span class="c1"># relative change in basis matrix</span>
<span class="c1">#        diffW.append( norm(W-W_old,&#39;fro&#39;)/ norm(W_old, &#39;fro&#39;) )</span>

        <span class="c1">#=== termination check ====#</span>
        <span class="n">check_exit</span>  <span class="o">=</span> <span class="p">(</span><span class="n">diffcost</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_W</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_W2</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_P</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_H</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_Htil</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">check_exit</span> <span class="ow">and</span> <span class="nb">iter</span> <span class="o">&gt;</span> <span class="mi">300</span><span class="p">:</span> <span class="c1"># allow 300 iterations of &quot;burn-in&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silence</span><span class="p">:</span>
                <span class="k">print</span> <span class="s2">&quot;Termination condition met.  Exit at iter =&quot;</span><span class="p">,</span><span class="nb">iter</span><span class="p">,</span>
            <span class="k">break</span>
        <span class="c1">#=============== print current progress ==============================#</span>
<span class="c1">#        if iter % disp_freq == 0:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">iter</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">iter</span> <span class="o">%</span> <span class="n">disp_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="c1">#            str_ = &quot;iter={:4} cost={:3.3f}&quot;.format(iter,cost_list[iter+1])</span>
            <span class="n">str_</span> <span class="o">=</span> <span class="s2">&quot;iter={:4} cost={:6.5e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">iter</span><span class="p">,</span><span class="n">cost</span><span class="p">)</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; nmf={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cost_nmf</span><span class="p">)</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; G={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cost_graph</span><span class="p">)</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; diffcost={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">diffcost</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; W={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_W</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; W2={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_W2</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; P={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_P</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; H={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_H</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; H2={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_Htil</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
<span class="c1">#            str_ += &quot; diffW={:3.2e}&quot;.format(diffW[iter])</span>
            <span class="k">print</span> <span class="n">str_</span> <span class="o">+</span> <span class="s2">&quot; ({:3.1f} sec)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>
    <span class="c1">#%%---- end of admm for loop ---------------------------------------------#</span>
    <span class="n">cost_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cost_list</span><span class="p">)</span>

    <span class="c1"># convert to pandas dataframe</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">cost_list</span><span class="p">,</span> <span class="n">cost_nmf_list</span><span class="p">,</span> <span class="n">cost_graph_list</span><span class="p">],</span>
                        <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">,</span><span class="s1">&#39;nmf&#39;</span><span class="p">,</span><span class="s1">&#39;graph&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">res_W</span><span class="p">,</span><span class="n">res_W2</span><span class="p">,</span><span class="n">res_P</span><span class="p">,</span><span class="n">res_H</span><span class="p">,</span><span class="n">diffcost</span><span class="p">],</span>
                       <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;res_W&#39;</span><span class="p">,</span><span class="s1">&#39;res_W2&#39;</span><span class="p">,</span><span class="s1">&#39;res_P&#39;</span><span class="p">,</span><span class="s1">&#39;res_H&#39;</span><span class="p">,</span><span class="s1">&#39;diffcost&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">silence</span><span class="p">:</span> <span class="n">print_time</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">W</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">Wtil</span><span class="p">,</span><span class="n">Ptil</span><span class="p">,</span><span class="n">cost</span><span class="p">,</span><span class="n">res</span>


<span class="k">def</span> <span class="nf">ls_sgpnmf_admm</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">tau</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">,</span><span class="n">gam</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">,</span><span class="n">gam2</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">rho</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
                   <span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span><span class="n">W_init</span><span class="o">=</span><span class="s1">&#39;nndsvd&#39;</span><span class="p">,</span><span class="n">disp_freq</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">silence</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                   <span class="n">add_intercept</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Graph regularized Spectral Projective NMF using ADMM.</span>

<span class="sd">    &gt;&gt;&gt; W,P,H,w,Wtil,Ptil,cost,res = ls_sgpnmf_admm(X,y,r,L,rho=5e2)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : ndarray of shape (n_features, n_samples)=(p,n)</span>
<span class="sd">        Data matrix with columns as data points</span>
<span class="sd">    y : array-like of shape [n_samples,]</span>
<span class="sd">        Label vector</span>
<span class="sd">    r : int</span>
<span class="sd">        Dimension of the embedding space (n_components)</span>
<span class="sd">    L : ndarray of shape = [n_samples, n_samples]</span>
<span class="sd">        Laplacian matrix.</span>
<span class="sd">    tau : float</span>
<span class="sd">        Amount of graph regularization to apply</span>
<span class="sd">    gam : float</span>
<span class="sd">        Amount of weight on the classification loss</span>
<span class="sd">    gam2 : float (default=0)</span>
<span class="sd">        Amount of regularization on the classifier (results in ridge regression</span>
<span class="sd">        update)</span>
<span class="sd">    rho : float</span>
<span class="sd">        Augmented Lagrangian parameter</span>
<span class="sd">    max_iter : int</span>
<span class="sd">        max number of iterations</span>
<span class="sd">    tol : float</span>
<span class="sd">        convergence tolerance (on relative change in objective value and</span>
<span class="sd">        all primal residuals)</span>
<span class="sd">    W_init : None, rng, or &#39;nndsvd&#39;</span>
<span class="sd">        Way to initialize W (and H).  If ``None`` or ``RandomState object``</span>
<span class="sd">        is supplied, both W and H will be initialized via non-negative</span>
<span class="sd">        random number.  If ``&#39;nndsvd&#39;``, will use deterministic initialization</span>
<span class="sd">        NNDSVD &quot;Non-Negative Double Singular Value Decomposition&quot;, proposed by</span>
<span class="sd">        Boutsidis2008.</span>
<span class="sd">    disp_freq : int</span>
<span class="sd">        Frequency of update display (in iterations)</span>
<span class="sd">    silence : bool</span>
<span class="sd">        If True, don&#39;t print-out convergence detail at the end</span>
<span class="sd">    add_intercept : bool (default=False)</span>
<span class="sd">        Add intercept term to classifier (added 02/16/2016)</span>

<span class="sd">    Update history</span>
<span class="sd">    --------------</span>
<span class="sd">    **02/04/2016** - function created</span>

<span class="sd">    **02/16/2016** - added ``add_intercept`` option</span>

<span class="sd">    **07/11/2016** - added keyboard interrupt</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rho</span> <span class="o">*=</span> <span class="mf">1.</span>
    <span class="n">tau</span> <span class="o">*=</span> <span class="mf">1.</span>
    <span class="n">gam</span> <span class="o">*=</span> <span class="mf">1.</span>
    <span class="n">gam2</span> <span class="o">*=</span> <span class="mf">1.</span>
    <span class="n">p</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
    <span class="c1">#%%=== initialize variables =====</span>
    <span class="c1"># define main primal variable W (basis matrix)</span>
    <span class="k">if</span> <span class="n">W_init</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">W_init</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">):</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">W_init</span>

        <span class="n">W</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">W_init</span> <span class="o">==</span> <span class="s1">&#39;nndsvd&#39;</span><span class="p">:</span>
<span class="c1">#        W = nnd_svd(X,r)</span>
        <span class="n">W</span><span class="p">,</span><span class="n">H</span> <span class="o">=</span> <span class="n">nnd_svd</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">get_H</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid input for &quot;W_init&quot;&#39;</span><span class="p">)</span>

    <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">p</span><span class="p">))</span>
<span class="c1">#    P = np.random.rand(r,p)</span>

    <span class="k">if</span> <span class="n">add_intercept</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># &lt;- classification vector</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="c1"># &lt;- classification vector</span>

    <span class="c1"># aux. variables</span>
    <span class="n">Wtil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">W2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>  <span class="c1"># &lt;- for spectral projection</span>
    <span class="n">Ptil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Htil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="c1"># &lt;- for graph regularization</span>

    <span class="c1"># dual variables</span>
    <span class="n">Lam_W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_W2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="c1"># &lt;- for spectral projection</span>
    <span class="n">Lam_P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_Htil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="c1"># &lt;- for graph regularization</span>
    <span class="c1">#%%=== create empty lists for tracking updates ===</span>
    <span class="c1"># keep track of frobenius norm loss</span>
    <span class="n">cost_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cost_ls_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cost_nmf_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cost_graph_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">PX</span> <span class="o">=</span> <span class="n">Ptil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">cost_nmf</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">Wtil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">PX</span><span class="p">)</span> <span class="o">-</span> <span class="n">X</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">if</span> <span class="n">add_intercept</span><span class="p">:</span>
        <span class="c1"># used for the least-squares term</span>
        <span class="n">one_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">PX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">PX</span><span class="p">,</span><span class="n">one_n</span><span class="p">))</span>
    <span class="n">cost_ls</span>  <span class="o">=</span> <span class="n">gam</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">PX</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">))</span> <span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">gam2</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">cost_graph</span> <span class="o">=</span> <span class="n">tau</span><span class="o">*</span><span class="n">trace</span><span class="p">(</span> <span class="n">L</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">dot</span><span class="p">(</span><span class="n">Htil</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Htil</span><span class="p">)))</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="n">cost_nmf</span> <span class="o">+</span> <span class="n">cost_graph</span> <span class="o">+</span> <span class="n">cost_ls</span>

    <span class="n">cost_nmf_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_nmf</span><span class="p">)</span>
    <span class="n">cost_ls_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_ls</span><span class="p">)</span>
    <span class="n">cost_graph_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_graph</span><span class="p">)</span>
    <span class="n">cost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>

    <span class="c1"># relative change in cost</span>
    <span class="n">diffcost</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># keep track of relative primal residual</span>
    <span class="n">res_W</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_W2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_P</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_H</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_Htil</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># also keep track of diffW</span>
<span class="c1">#    diffW = []</span>
    <span class="c1">#%%=== run admm iterations ===</span>
    <span class="n">eye_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">eye_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

    <span class="c1"># precompute term needed for inversion lemma</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">X</span><span class="p">),</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="n">start</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iter</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1">#W_old = W #&lt;- to keep track of diffW</span>
            <span class="c1">#================ primal updates (P, W, H, Ptil, Wtil) ===============#</span>
            <span class="c1"># update for P involves inversion lemma...</span>
            <span class="n">_R</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Lam_H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">/</span><span class="n">rho</span> <span class="o">-</span> <span class="n">Lam_P</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">rho</span> <span class="o">+</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">Ptil</span><span class="o">.</span><span class="n">T</span>
            <span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="n">_R</span> <span class="o">-</span> <span class="n">X</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">dot</span><span class="p">(</span><span class="n">K</span><span class="p">,</span><span class="n">_R</span><span class="p">)</span> <span class="p">))</span><span class="o">.</span><span class="n">T</span>
            <span class="n">Ptil</span> <span class="o">=</span> <span class="p">(</span><span class="n">P</span><span class="o">+</span><span class="n">Lam_P</span><span class="o">/</span><span class="n">rho</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
            <span class="c1"># (W,H) updates</span>
            <span class="k">if</span> <span class="n">add_intercept</span><span class="p">:</span>
                <span class="n">ytil</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">one_n</span><span class="o">*</span><span class="n">w</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">H</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">W</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="n">eye_r</span> <span class="o">+</span> <span class="n">gam</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">w</span><span class="p">[:</span><span class="n">r</span><span class="p">],</span><span class="n">w</span><span class="p">[:</span><span class="n">r</span><span class="p">]),</span>
                          <span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">X</span><span class="p">)</span> <span class="o">-</span> <span class="n">Lam_H</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">Htil</span> <span class="o">-</span>
                          <span class="n">Lam_Htil</span> <span class="o">+</span> <span class="n">gam</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">w</span><span class="p">[:</span><span class="n">r</span><span class="p">],</span><span class="n">ytil</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">H</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">W</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="n">eye_r</span> <span class="o">+</span> <span class="n">gam</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">w</span><span class="p">),</span>
                          <span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">X</span><span class="p">)</span> <span class="o">-</span> <span class="n">Lam_H</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">Htil</span> <span class="o">-</span>
                          <span class="n">Lam_Htil</span> <span class="o">+</span> <span class="n">gam</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">y</span><span class="p">))</span>
            <span class="n">W</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="n">eye_r</span><span class="p">,</span>
                      <span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">Wtil</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">Lam_W</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">W2</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">Lam_W2</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="n">Wtil</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span><span class="o">+</span><span class="n">Lam_W</span><span class="o">/</span><span class="n">rho</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
            <span class="n">W2</span> <span class="o">=</span> <span class="n">projection_spectral</span><span class="p">(</span><span class="n">W</span> <span class="o">+</span> <span class="n">Lam_W2</span><span class="o">/</span><span class="n">rho</span><span class="p">)</span>
    
            <span class="n">Htil</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">tau</span><span class="o">*</span><span class="n">L</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">eye_n</span><span class="p">,</span> <span class="n">rho</span><span class="o">*</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="o">+</span><span class="n">Lam_Htil</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    
            <span class="k">if</span> <span class="n">add_intercept</span><span class="p">:</span>
                <span class="c1"># H with intercept</span>
                <span class="n">H_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">H</span><span class="p">,</span><span class="n">one_n</span><span class="p">))</span>
                <span class="c1"># for now, ignore gam2 regularizer...i never use them</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span> <span class="n">H_</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">H_</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">H_</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span> <span class="n">H</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">gam2</span><span class="o">/</span><span class="n">gam</span><span class="p">)</span><span class="o">*</span><span class="n">eye_r</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
    
            <span class="c1">#====================== dual updates =================================#</span>
            <span class="n">Lam_W</span> <span class="o">=</span> <span class="n">Lam_W</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">W</span> <span class="o">-</span> <span class="n">Wtil</span><span class="p">)</span>
            <span class="n">Lam_W2</span> <span class="o">=</span> <span class="n">Lam_W2</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">W</span> <span class="o">-</span> <span class="n">W2</span><span class="p">)</span>
            <span class="n">Lam_P</span> <span class="o">=</span> <span class="n">Lam_P</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">P</span> <span class="o">-</span> <span class="n">Ptil</span><span class="p">)</span>
            <span class="n">Lam_H</span> <span class="o">=</span> <span class="n">Lam_H</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">H</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">X</span><span class="p">))</span>
            <span class="n">Lam_Htil</span> <span class="o">=</span> <span class="n">Lam_Htil</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">H</span><span class="o">-</span><span class="n">Htil</span><span class="p">)</span>
    
            <span class="c1">#============ comptute objective values ==============================#</span>
            <span class="c1"># main loss function</span>
            <span class="n">PX</span> <span class="o">=</span> <span class="n">Ptil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">cost_nmf</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">Wtil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">PX</span><span class="p">)</span> <span class="o">-</span> <span class="n">X</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
            <span class="k">if</span> <span class="n">add_intercept</span><span class="p">:</span> <span class="c1"># for computing LS loss term</span>
                <span class="n">PX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">PX</span><span class="p">,</span><span class="n">one_n</span><span class="p">))</span>
            <span class="n">cost_ls</span>  <span class="o">=</span> <span class="n">gam</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">PX</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">))</span> <span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">gam2</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">cost_graph</span> <span class="o">=</span> <span class="n">tau</span><span class="o">*</span><span class="n">trace</span><span class="p">(</span> <span class="n">L</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">dot</span><span class="p">(</span><span class="n">Htil</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Htil</span><span class="p">)))</span>
            <span class="n">cost</span> <span class="o">=</span> <span class="n">cost_nmf</span> <span class="o">+</span> <span class="n">cost_graph</span> <span class="o">+</span> <span class="n">cost_ls</span>
    
            <span class="n">cost_nmf_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_nmf</span><span class="p">)</span>
            <span class="n">cost_ls_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_ls</span><span class="p">)</span>
            <span class="n">cost_graph_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_graph</span><span class="p">)</span>
            <span class="n">cost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>
    
            <span class="c1"># relative change in cost</span>
            <span class="n">diffcost</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span><span class="o">/</span><span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
    
            <span class="c1"># relative primal residuals</span>
            <span class="n">res_W</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="o">-</span><span class="n">Wtil</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
            <span class="n">res_W2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="o">-</span><span class="n">W2</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
            <span class="n">res_P</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">P</span><span class="o">-</span><span class="n">Ptil</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
            <span class="n">res_H</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="o">-</span><span class="n">P</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">),</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
            <span class="n">res_Htil</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="o">-</span><span class="n">Htil</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
    
            <span class="c1"># relative change in basis matrix</span>
    <span class="c1">#        diffW.append( norm(W-W_old,&#39;fro&#39;)/ norm(W_old, &#39;fro&#39;) )</span>
    
            <span class="c1">#=== termination check ====#</span>
            <span class="n">check_exit</span>  <span class="o">=</span> <span class="p">(</span><span class="n">diffcost</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">)</span>
            <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_W</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
            <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_W2</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
            <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_P</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
            <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_H</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
            <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_Htil</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">check_exit</span> <span class="ow">and</span> <span class="nb">iter</span> <span class="o">&gt;</span> <span class="mi">300</span><span class="p">:</span> <span class="c1"># allow 300 iterations of &quot;burn-in&quot;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">silence</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s2">&quot;    Termination condition met.  Exit at iter =&quot;</span><span class="p">,</span><span class="nb">iter</span><span class="p">,</span>
                <span class="k">break</span>
            <span class="c1">#=============== print current progress ==============================#</span>
    <span class="c1">#        if iter % disp_freq == 0:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">iter</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">iter</span> <span class="o">%</span> <span class="n">disp_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
    <span class="c1">#            str_ = &quot;iter={:4} cost={:3.3f}&quot;.format(iter,cost_list[iter+1])</span>
                <span class="n">str_</span> <span class="o">=</span> <span class="s2">&quot;iter={:4} cost={:6.5e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">iter</span><span class="p">,</span><span class="n">cost</span><span class="p">)</span>
                <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; nmf={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cost_nmf</span><span class="p">)</span>
                <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; ls={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cost_ls</span><span class="p">)</span>
                <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; G={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cost_graph</span><span class="p">)</span>
                <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; diffcost={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">diffcost</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
                <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; W={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_W</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
                <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; W2={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_W2</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
                <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; P={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_P</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
                <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; H={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_H</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
                <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; H2={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_Htil</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
    <span class="c1">#            str_ += &quot; diffW={:3.2e}&quot;.format(diffW[iter])</span>
                <span class="k">print</span> <span class="n">str_</span> <span class="o">+</span> <span class="s2">&quot; ({:3.1f} sec)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="c1">#%%---- end of admm for loop ---------------------------------------------#</span>
    <span class="n">cost_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cost_list</span><span class="p">)</span>

    <span class="c1"># convert to pandas dataframe</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">cost_list</span><span class="p">,</span> <span class="n">cost_nmf_list</span><span class="p">,</span> <span class="n">cost_graph_list</span><span class="p">,</span><span class="n">cost_ls_list</span><span class="p">],</span>
                        <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">,</span><span class="s1">&#39;nmf&#39;</span><span class="p">,</span><span class="s1">&#39;graph&#39;</span><span class="p">,</span><span class="s1">&#39;ls&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">res_W</span><span class="p">,</span><span class="n">res_W2</span><span class="p">,</span><span class="n">res_P</span><span class="p">,</span><span class="n">res_H</span><span class="p">,</span><span class="n">diffcost</span><span class="p">],</span>
                       <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;res_W&#39;</span><span class="p">,</span><span class="s1">&#39;res_W2&#39;</span><span class="p">,</span><span class="s1">&#39;res_P&#39;</span><span class="p">,</span><span class="s1">&#39;res_H&#39;</span><span class="p">,</span><span class="s1">&#39;diffcost&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">silence</span><span class="p">:</span> <span class="n">print_time</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">W</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">Wtil</span><span class="p">,</span><span class="n">Ptil</span><span class="p">,</span><span class="n">cost</span><span class="p">,</span><span class="n">res</span>

<span class="k">def</span> <span class="nf">ls_sgpnmf_admm_bal</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">tau</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">,</span><span class="n">gam</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">,</span><span class="n">gam2</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">rho</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
                   <span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span><span class="n">W_init</span><span class="o">=</span><span class="s1">&#39;nndsvd&#39;</span><span class="p">,</span><span class="n">disp_freq</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">silence</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                   <span class="n">add_intercept</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Same as ``ls_sgpnmf_admm``, but with class-weighted loss</span>

<span class="sd">    &gt;&gt;&gt; W,P,H,w,Wtil,Ptil,cost,res = ls_sgpnmf_admm(X,y,r,L,rho=5e2)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : ndarray of shape (n_features, n_samples)=(p,n)</span>
<span class="sd">        Data matrix with columns as data points</span>
<span class="sd">    y : array-like of shape [n_samples,]</span>
<span class="sd">        Label vector</span>
<span class="sd">    r : int</span>
<span class="sd">        Dimension of the embedding space (n_components)</span>
<span class="sd">    L : ndarray of shape = [n_samples, n_samples]</span>
<span class="sd">        Laplacian matrix.</span>
<span class="sd">    tau : float</span>
<span class="sd">        Amount of graph regularization to apply</span>
<span class="sd">    gam : float</span>
<span class="sd">        Amount of weight on the classification loss</span>
<span class="sd">    gam2 : float (default=0)</span>
<span class="sd">        Amount of regularization on the classifier (results in ridge regression</span>
<span class="sd">        update)</span>
<span class="sd">    rho : float</span>
<span class="sd">        Augmented Lagrangian parameter</span>
<span class="sd">    max_iter : int</span>
<span class="sd">        max number of iterations</span>
<span class="sd">    tol : float</span>
<span class="sd">        convergence tolerance (on relative change in objective value and</span>
<span class="sd">        all primal residuals)</span>
<span class="sd">    W_init : None, rng, or &#39;nndsvd&#39;</span>
<span class="sd">        Way to initialize W (and H).  If ``None`` or ``RandomState object``</span>
<span class="sd">        is supplied, both W and H will be initialized via non-negative</span>
<span class="sd">        random number.  If ``&#39;nndsvd&#39;``, will use deterministic initialization</span>
<span class="sd">        NNDSVD &quot;Non-Negative Double Singular Value Decomposition&quot;, proposed by</span>
<span class="sd">        Boutsidis2008.</span>
<span class="sd">    disp_freq : int</span>
<span class="sd">        Frequency of update display (in iterations)</span>
<span class="sd">    silence : bool</span>
<span class="sd">        If True, don&#39;t print-out convergence detail at the end</span>
<span class="sd">    add_intercept : bool (default=False)</span>
<span class="sd">        Add intercept term to classifier (added 02/16/2016)</span>

<span class="sd">    Update history</span>
<span class="sd">    --------------</span>
<span class="sd">    **02/17/2016** - function created</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rho</span> <span class="o">*=</span> <span class="mf">1.</span>
    <span class="n">tau</span> <span class="o">*=</span> <span class="mf">1.</span>
    <span class="n">gam</span> <span class="o">*=</span> <span class="mf">1.</span>
    <span class="n">gam2</span> <span class="o">*=</span> <span class="mf">1.</span>
    <span class="n">p</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
    <span class="c1">#%% get class balance info</span>
    <span class="n">weight_pos</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="o">==-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">n</span>
    <span class="n">weight_neg</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">weight_pos</span>
    <span class="n">weight_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">weight_vec</span><span class="p">[</span><span class="n">y</span><span class="o">==+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight_pos</span>
    <span class="n">weight_vec</span><span class="p">[</span><span class="n">y</span><span class="o">==-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight_neg</span>
    <span class="n">J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span> <span class="n">weight_vec</span> <span class="p">)</span>
    <span class="c1">#%%=== initialize variables =====</span>
    <span class="c1"># define main primal variable W (basis matrix)</span>
    <span class="k">if</span> <span class="n">W_init</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">W_init</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">):</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">W_init</span>

        <span class="n">W</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">W_init</span> <span class="o">==</span> <span class="s1">&#39;nndsvd&#39;</span><span class="p">:</span>
<span class="c1">#        W = nnd_svd(X,r)</span>
        <span class="n">W</span><span class="p">,</span><span class="n">H</span> <span class="o">=</span> <span class="n">nnd_svd</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">get_H</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid input for &quot;W_init&quot;&#39;</span><span class="p">)</span>

    <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">p</span><span class="p">))</span>
<span class="c1">#    P = np.random.rand(r,p)</span>

    <span class="k">if</span> <span class="n">add_intercept</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># &lt;- classification vector</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="c1"># &lt;- classification vector</span>

    <span class="c1"># aux. variables</span>
    <span class="n">Wtil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">W2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>  <span class="c1"># &lt;- for spectral projection</span>
    <span class="n">Ptil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Htil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="c1"># &lt;- for graph regularization</span>

    <span class="c1"># dual variables</span>
    <span class="n">Lam_W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_W2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="c1"># &lt;- for spectral projection</span>
    <span class="n">Lam_P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_Htil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="c1"># &lt;- for graph regularization</span>
    <span class="c1">#%%=== create empty lists for tracking updates ===</span>
    <span class="c1"># keep track of frobenius norm loss</span>
    <span class="n">cost_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cost_ls_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cost_nmf_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cost_graph_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">PX</span> <span class="o">=</span> <span class="n">Ptil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">cost_nmf</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">Wtil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">PX</span><span class="p">)</span> <span class="o">-</span> <span class="n">X</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">if</span> <span class="n">add_intercept</span><span class="p">:</span>
        <span class="c1"># used for the least-squares term</span>
        <span class="n">one_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">PX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">PX</span><span class="p">,</span><span class="n">one_n</span><span class="p">))</span>
    <span class="c1"># compute weighted error</span>
    <span class="n">_err</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">PX</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
    <span class="n">_err</span> <span class="o">=</span> <span class="n">_err</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">J</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">_err</span><span class="p">))</span>
    <span class="n">cost_ls</span>  <span class="o">=</span> <span class="n">gam</span><span class="o">*</span><span class="n">_err</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">gam2</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
    <span class="c1">#cost_ls  = gam*norm(y - PX.T.dot(w)) **2/2 + gam2*norm(w)**2/2</span>
    <span class="n">cost_graph</span> <span class="o">=</span> <span class="n">tau</span><span class="o">*</span><span class="n">trace</span><span class="p">(</span> <span class="n">L</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">dot</span><span class="p">(</span><span class="n">Htil</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Htil</span><span class="p">)))</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="n">cost_nmf</span> <span class="o">+</span> <span class="n">cost_graph</span> <span class="o">+</span> <span class="n">cost_ls</span>

    <span class="n">cost_nmf_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_nmf</span><span class="p">)</span>
    <span class="n">cost_ls_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_ls</span><span class="p">)</span>
    <span class="n">cost_graph_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_graph</span><span class="p">)</span>
    <span class="n">cost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>

    <span class="c1"># relative change in cost</span>
    <span class="n">diffcost</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># keep track of relative primal residual</span>
    <span class="n">res_W</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_W2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_P</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_H</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_Htil</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># also keep track of diffW</span>
<span class="c1">#    diffW = []</span>
    <span class="c1">#%%=== run admm iterations ===</span>
    <span class="n">eye_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">eye_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

    <span class="c1"># precompute term needed for inversion lemma</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">X</span><span class="p">),</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="n">start</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iter</span><span class="p">):</span>
<span class="c1">#        W_old = W #&lt;- to keep track of diffW</span>

        <span class="c1">#================ primal updates (P, W, H, Ptil, Wtil) ===============#</span>
        <span class="c1"># update for P involves inversion lemma...</span>
        <span class="n">_R</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Lam_H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">/</span><span class="n">rho</span> <span class="o">-</span> <span class="n">Lam_P</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">rho</span> <span class="o">+</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">Ptil</span><span class="o">.</span><span class="n">T</span>
        <span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="n">_R</span> <span class="o">-</span> <span class="n">X</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">dot</span><span class="p">(</span><span class="n">K</span><span class="p">,</span><span class="n">_R</span><span class="p">)</span> <span class="p">))</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Ptil</span> <span class="o">=</span> <span class="p">(</span><span class="n">P</span><span class="o">+</span><span class="n">Lam_P</span><span class="o">/</span><span class="n">rho</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># (W,H) updates</span>
        <span class="n">WtW</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="n">eye_r</span>
        <span class="k">if</span> <span class="n">add_intercept</span><span class="p">:</span>
            <span class="n">ytil</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">one_n</span><span class="o">*</span><span class="n">w</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">_S</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">X</span><span class="p">)</span> <span class="o">-</span> <span class="n">Lam_H</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">Htil</span> <span class="o">-</span>\
                      <span class="n">Lam_Htil</span> <span class="o">+</span> <span class="n">gam</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">w</span><span class="p">[:</span><span class="n">r</span><span class="p">],</span><span class="n">ytil</span><span class="p">)</span>
            <span class="c1">#H = solve(dot(W.T,W)+(2*rho)*eye_r + gam*np.outer(w[:r],w[:r]),_S)</span>
            <span class="n">wtw</span> <span class="o">=</span> <span class="n">gam</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">w</span><span class="p">[:</span><span class="n">r</span><span class="p">],</span><span class="n">w</span><span class="p">[:</span><span class="n">r</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_S</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">X</span><span class="p">)</span> <span class="o">-</span> <span class="n">Lam_H</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">Htil</span> <span class="o">-</span>\
                      <span class="n">Lam_Htil</span> <span class="o">+</span> <span class="n">gam</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
            <span class="c1">#H = solve(dot(W.T,W)+(2*rho)*eye_r + gam*np.outer(w,w),_S)</span>
            <span class="n">wtw</span> <span class="o">=</span> <span class="n">gam</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">w</span><span class="p">)</span>
        <span class="n">H</span><span class="p">[:,</span><span class="n">y</span><span class="o">==+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">WtW</span> <span class="o">+</span> <span class="n">weight_pos</span><span class="o">*</span><span class="n">wtw</span><span class="p">,</span> <span class="n">_S</span><span class="p">[:,</span><span class="n">y</span><span class="o">==+</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">H</span><span class="p">[:,</span><span class="n">y</span><span class="o">==-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">WtW</span> <span class="o">+</span> <span class="n">weight_neg</span><span class="o">*</span><span class="n">wtw</span><span class="p">,</span> <span class="n">_S</span><span class="p">[:,</span><span class="n">y</span><span class="o">==-</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">W</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="n">eye_r</span><span class="p">,</span>
                  <span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">Wtil</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">Lam_W</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">W2</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">Lam_W2</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Wtil</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span><span class="o">+</span><span class="n">Lam_W</span><span class="o">/</span><span class="n">rho</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>


        <span class="n">W2</span> <span class="o">=</span> <span class="n">projection_spectral</span><span class="p">(</span><span class="n">W</span> <span class="o">+</span> <span class="n">Lam_W2</span><span class="o">/</span><span class="n">rho</span><span class="p">)</span>

        <span class="n">Htil</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">tau</span><span class="o">*</span><span class="n">L</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">eye_n</span><span class="p">,</span> <span class="n">rho</span><span class="o">*</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="o">+</span><span class="n">Lam_Htil</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="k">if</span> <span class="n">add_intercept</span><span class="p">:</span>
            <span class="c1"># H with intercept</span>
            <span class="n">H_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">H</span><span class="p">,</span><span class="n">one_n</span><span class="p">))</span>
            <span class="c1"># for now, ignore gam2 regularizer...i never use them</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span> <span class="n">H_</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">J</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">H_</span><span class="o">.</span><span class="n">T</span><span class="p">)),</span> <span class="n">H_</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">J</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span> <span class="n">H</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">J</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">gam2</span><span class="o">/</span><span class="n">gam</span><span class="p">)</span><span class="o">*</span><span class="n">eye_r</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">J</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">)))</span>

        <span class="c1">#====================== dual updates =================================#</span>
        <span class="n">Lam_W</span> <span class="o">=</span> <span class="n">Lam_W</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">W</span> <span class="o">-</span> <span class="n">Wtil</span><span class="p">)</span>
        <span class="n">Lam_W2</span> <span class="o">=</span> <span class="n">Lam_W2</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">W</span> <span class="o">-</span> <span class="n">W2</span><span class="p">)</span>
        <span class="n">Lam_P</span> <span class="o">=</span> <span class="n">Lam_P</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">P</span> <span class="o">-</span> <span class="n">Ptil</span><span class="p">)</span>
        <span class="n">Lam_H</span> <span class="o">=</span> <span class="n">Lam_H</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">H</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">X</span><span class="p">))</span>
        <span class="n">Lam_Htil</span> <span class="o">=</span> <span class="n">Lam_Htil</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">H</span><span class="o">-</span><span class="n">Htil</span><span class="p">)</span>

        <span class="c1">#============ comptute objective values ==============================#</span>
        <span class="c1"># main loss function</span>
        <span class="n">PX</span> <span class="o">=</span> <span class="n">Ptil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">cost_nmf</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">Wtil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">PX</span><span class="p">)</span> <span class="o">-</span> <span class="n">X</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
        <span class="k">if</span> <span class="n">add_intercept</span><span class="p">:</span> <span class="c1"># for computing LS loss term</span>
            <span class="n">PX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">PX</span><span class="p">,</span><span class="n">one_n</span><span class="p">))</span>
        <span class="c1"># compute weighted error</span>
        <span class="n">_err</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">PX</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
        <span class="n">_err</span> <span class="o">=</span> <span class="n">_err</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">J</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">_err</span><span class="p">))</span>
        <span class="n">cost_ls</span>  <span class="o">=</span> <span class="n">gam</span><span class="o">*</span><span class="n">_err</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">gam2</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
<span class="c1">#        cost_ls  = gam*norm(y - PX.T.dot(w)) **2/2 + gam2*norm(w)**2/2</span>
        <span class="n">cost_graph</span> <span class="o">=</span> <span class="n">tau</span><span class="o">*</span><span class="n">trace</span><span class="p">(</span> <span class="n">L</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">dot</span><span class="p">(</span><span class="n">Htil</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Htil</span><span class="p">)))</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="n">cost_nmf</span> <span class="o">+</span> <span class="n">cost_graph</span> <span class="o">+</span> <span class="n">cost_ls</span>

        <span class="n">cost_nmf_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_nmf</span><span class="p">)</span>
        <span class="n">cost_ls_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_ls</span><span class="p">)</span>
        <span class="n">cost_graph_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_graph</span><span class="p">)</span>
        <span class="n">cost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>

        <span class="c1"># relative change in cost</span>
        <span class="n">diffcost</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span><span class="o">/</span><span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>

        <span class="c1"># relative primal residuals</span>
        <span class="n">res_W</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="o">-</span><span class="n">Wtil</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="n">res_W2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="o">-</span><span class="n">W2</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="n">res_P</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">P</span><span class="o">-</span><span class="n">Ptil</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="n">res_H</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="o">-</span><span class="n">P</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">),</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="n">res_Htil</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="o">-</span><span class="n">Htil</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>

        <span class="c1"># relative change in basis matrix</span>
<span class="c1">#        diffW.append( norm(W-W_old,&#39;fro&#39;)/ norm(W_old, &#39;fro&#39;) )</span>

        <span class="c1">#=== termination check ====#</span>
        <span class="n">check_exit</span>  <span class="o">=</span> <span class="p">(</span><span class="n">diffcost</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_W</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_W2</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_P</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_H</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_Htil</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">check_exit</span> <span class="ow">and</span> <span class="nb">iter</span> <span class="o">&gt;</span> <span class="mi">300</span><span class="p">:</span> <span class="c1"># allow 300 iterations of &quot;burn-in&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silence</span><span class="p">:</span>
                <span class="k">print</span> <span class="s2">&quot;    Termination condition met.  Exit at iter =&quot;</span><span class="p">,</span><span class="nb">iter</span><span class="p">,</span>
            <span class="k">break</span>
        <span class="c1">#=============== print current progress ==============================#</span>
<span class="c1">#        if iter % disp_freq == 0:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">iter</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">iter</span> <span class="o">%</span> <span class="n">disp_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="c1">#            str_ = &quot;iter={:4} cost={:3.3f}&quot;.format(iter,cost_list[iter+1])</span>
            <span class="n">str_</span> <span class="o">=</span> <span class="s2">&quot;iter={:4} cost={:6.5e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">iter</span><span class="p">,</span><span class="n">cost</span><span class="p">)</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; nmf={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cost_nmf</span><span class="p">)</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; G={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cost_graph</span><span class="p">)</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; diffcost={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">diffcost</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; W={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_W</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; W2={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_W2</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; P={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_P</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; H={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_H</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; H2={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_Htil</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
<span class="c1">#            str_ += &quot; diffW={:3.2e}&quot;.format(diffW[iter])</span>
            <span class="k">print</span> <span class="n">str_</span> <span class="o">+</span> <span class="s2">&quot; ({:3.1f} sec)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>
    <span class="c1">#%%---- end of admm for loop ---------------------------------------------#</span>
    <span class="n">cost_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cost_list</span><span class="p">)</span>

    <span class="c1"># convert to pandas dataframe</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">cost_list</span><span class="p">,</span> <span class="n">cost_nmf_list</span><span class="p">,</span> <span class="n">cost_graph_list</span><span class="p">,</span><span class="n">cost_ls_list</span><span class="p">],</span>
                        <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">,</span><span class="s1">&#39;nmf&#39;</span><span class="p">,</span><span class="s1">&#39;graph&#39;</span><span class="p">,</span><span class="s1">&#39;ls&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">res_W</span><span class="p">,</span><span class="n">res_W2</span><span class="p">,</span><span class="n">res_P</span><span class="p">,</span><span class="n">res_H</span><span class="p">,</span><span class="n">diffcost</span><span class="p">],</span>
                       <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;res_W&#39;</span><span class="p">,</span><span class="s1">&#39;res_W2&#39;</span><span class="p">,</span><span class="s1">&#39;res_P&#39;</span><span class="p">,</span><span class="s1">&#39;res_H&#39;</span><span class="p">,</span><span class="s1">&#39;diffcost&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">silence</span><span class="p">:</span> <span class="n">print_time</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">W</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">Wtil</span><span class="p">,</span><span class="n">Ptil</span><span class="p">,</span><span class="n">cost</span><span class="p">,</span><span class="n">res</span>


<span class="k">def</span> <span class="nf">pnge_admm</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">r1</span><span class="p">,</span><span class="n">r2</span><span class="p">,</span><span class="n">L1</span><span class="p">,</span><span class="n">L2</span><span class="p">,</span><span class="n">tau</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">,</span><span class="n">rho</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
              <span class="n">W_init</span><span class="o">=</span><span class="s1">&#39;nndsvd&#39;</span><span class="p">,</span><span class="n">disp_freq</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">silence</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Projective non-negative graph embedding using ADMM.</span>

<span class="sd">    Note: in my Onenote, I used H_s, H_p...these are H_1 and H_2 in this code</span>
<span class="sd">    (basically, replace all (s,p) pairs with (1,2) pair)</span>

<span class="sd">    &gt;&gt;&gt; W,P,H,Wtil,Ptil,cost_list,res = gpnmf_admm(X,r,rho=5e2)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : ndarray of shape (n_features, n_samples)=(p,n)</span>
<span class="sd">        Data matrix with columns as data points</span>
<span class="sd">    r1 : int</span>
<span class="sd">        Dimension of the intrinsic embedding space (n_components)</span>
<span class="sd">    r2 : int</span>
<span class="sd">        Dimension of the complementary embedding space (n_components)</span>
<span class="sd">    L1 : ndarray of shape = [n_samples, n_samples]</span>
<span class="sd">        Laplacian matrix of intrinsic graph</span>
<span class="sd">    L2 : ndarray of shape = [n_samples, n_samples]</span>
<span class="sd">        Laplacian matrix of penalty graph.</span>
<span class="sd">    tau : float</span>
<span class="sd">        Amount of graph regularization to apply</span>
<span class="sd">    rho : float</span>
<span class="sd">        Augmented Lagrangian parameter</span>
<span class="sd">    max_iter : int</span>
<span class="sd">        max number of iterations</span>
<span class="sd">    tol : float</span>
<span class="sd">        convergence tolerance (on relative change in objective value and</span>
<span class="sd">        all primal residuals)</span>
<span class="sd">    W_init : None, rng, or &#39;nndsvd&#39;</span>
<span class="sd">        Way to initialize W (and H).  If ``None`` or ``RandomState object``</span>
<span class="sd">        is supplied, both W and H will be initialized via non-negative</span>
<span class="sd">        random number.  If ``&#39;nndsvd&#39;``, will use deterministic initialization</span>
<span class="sd">        NNDSVD &quot;Non-Negative Double Singular Value Decomposition&quot;, proposed by</span>
<span class="sd">        Boutsidis2008.</span>
<span class="sd">    disp_freq : int</span>
<span class="sd">        Frequency of update display (in iterations)</span>
<span class="sd">    silence : bool</span>
<span class="sd">        If True, don&#39;t print-out convergence detail at the end.</span>

<span class="sd">    Update history</span>
<span class="sd">    --------------</span>
<span class="sd">    **02/03/2016** - function created</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">r1</span><span class="o">+</span><span class="n">r2</span>
    <span class="n">rho</span> <span class="o">*=</span> <span class="mf">1.</span>
    <span class="n">tau</span> <span class="o">*=</span> <span class="mf">1.</span>
    <span class="n">p</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
    <span class="c1">#%%=== initialize variables =====</span>
    <span class="c1"># define main primal variable W (basis matrix)</span>
    <span class="k">if</span> <span class="n">W_init</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">W_init</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">):</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">W_init</span>

        <span class="n">W</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">W_init</span> <span class="o">==</span> <span class="s1">&#39;nndsvd&#39;</span><span class="p">:</span>
<span class="c1">#        W = nnd_svd(X,r)</span>
        <span class="n">W</span><span class="p">,</span><span class="n">H</span> <span class="o">=</span> <span class="n">nnd_svd</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">get_H</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid input for &quot;W_init&quot;&#39;</span><span class="p">)</span>

    <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">p</span><span class="p">))</span>
<span class="c1">#    P = np.random.rand(r,p)</span>

    <span class="c1"># aux. variables</span>
    <span class="n">Wtil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Ptil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Htil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="c1"># &lt;- for graph regularization</span>

    <span class="n">idx_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span>       <span class="c1"># &lt;- intrinsic graph indices (top half of H matrices)</span>
    <span class="n">idx_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">r1</span><span class="o">+</span><span class="n">r2</span><span class="p">)</span> <span class="c1"># &lt;- penalty   graph indices (bot half of H matrices)</span>
<span class="c1">#    Htil1 = np.zeros((r1,n)) # &lt;- the top half part of Htil (intrinsic part)</span>
<span class="c1">#    Htil2 = np.zeros((r2,n)) # &lt;- the bot half part of Htil (complementary part)</span>

    <span class="c1"># dual variables</span>
    <span class="n">Lam_W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_Htil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="c1"># &lt;- for graph regularization</span>
    <span class="c1">#%%=== create empty lists for tracking updates ===</span>
    <span class="c1"># keep track of frobenius norm loss</span>
    <span class="n">cost_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cost_nmf_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cost_graph_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">cost_nmf</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">Wtil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ptil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">))</span> <span class="o">-</span> <span class="n">X</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">_term1</span> <span class="o">=</span> <span class="n">trace</span><span class="p">(</span><span class="n">L1</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">dot</span><span class="p">(</span><span class="n">Htil</span><span class="p">[</span><span class="n">idx_i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">Htil</span><span class="p">[</span><span class="n">idx_i</span><span class="p">])))</span>
    <span class="n">_term2</span> <span class="o">=</span> <span class="n">trace</span><span class="p">(</span><span class="n">L2</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">dot</span><span class="p">(</span><span class="n">Htil</span><span class="p">[</span><span class="n">idx_p</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">Htil</span><span class="p">[</span><span class="n">idx_p</span><span class="p">])))</span>
    <span class="n">cost_graph</span> <span class="o">=</span> <span class="p">(</span><span class="n">tau</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">_term1</span> <span class="o">+</span> <span class="n">_term2</span><span class="p">)</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="n">cost_nmf</span> <span class="o">+</span> <span class="n">cost_graph</span>

    <span class="n">cost_nmf_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_nmf</span><span class="p">)</span>
    <span class="n">cost_graph_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_graph</span><span class="p">)</span>
    <span class="n">cost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>

    <span class="c1"># relative change in cost</span>
    <span class="n">diffcost</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># keep track of relative primal residual</span>
    <span class="n">res_W</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_P</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_H</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_Htil</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># also keep track of diffW</span>
<span class="c1">#    diffW = []</span>
    <span class="c1">#%%=== run admm iterations ===</span>
    <span class="n">eye_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">eye_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

    <span class="c1"># precompute term needed for inversion lemma</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">X</span><span class="p">),</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="n">start</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iter</span><span class="p">):</span>
<span class="c1">#        W_old = W #&lt;- to keep track of diffW</span>

        <span class="c1">#================ primal updates (P, W, H, Ptil, Wtil) ===============#</span>
        <span class="c1"># update for P involves inversion lemma...</span>
        <span class="n">_R</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Lam_H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">/</span><span class="n">rho</span> <span class="o">-</span> <span class="n">Lam_P</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">rho</span> <span class="o">+</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">Ptil</span><span class="o">.</span><span class="n">T</span>
        <span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="n">_R</span> <span class="o">-</span> <span class="n">X</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">dot</span><span class="p">(</span><span class="n">K</span><span class="p">,</span><span class="n">_R</span><span class="p">)</span> <span class="p">))</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Ptil</span> <span class="o">=</span> <span class="p">(</span><span class="n">P</span><span class="o">+</span><span class="n">Lam_P</span><span class="o">/</span><span class="n">rho</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># (W,H) updates</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">W</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="n">eye_r</span><span class="p">,</span>
                  <span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">X</span><span class="p">)</span> <span class="o">-</span> <span class="n">Lam_H</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">Htil</span> <span class="o">-</span> <span class="n">Lam_Htil</span> <span class="p">)</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">+</span><span class="n">rho</span><span class="o">*</span><span class="n">eye_r</span><span class="p">,</span> <span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">Wtil</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">Lam_W</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Wtil</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span><span class="o">+</span><span class="n">Lam_W</span><span class="o">/</span><span class="n">rho</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># --- Htil updates...broken down to two part: Htil1 and Htil2 ---</span>
        <span class="c1"># intrinsic graph update (top half of Htil matrix)</span>
        <span class="n">Htil</span><span class="p">[</span><span class="n">idx_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">tau</span><span class="o">*</span><span class="n">L1</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">eye_n</span><span class="p">,</span> <span class="n">rho</span><span class="o">*</span><span class="n">H</span><span class="p">[</span><span class="n">idx_i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">+</span><span class="n">Lam_Htil</span><span class="p">[</span><span class="n">idx_i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># penalty graph update (bottom half of Htil matrix)</span>
        <span class="n">Htil</span><span class="p">[</span><span class="n">idx_p</span><span class="p">]</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">tau</span><span class="o">*</span><span class="n">L2</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">eye_n</span><span class="p">,</span> <span class="n">rho</span><span class="o">*</span><span class="n">H</span><span class="p">[</span><span class="n">idx_p</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">+</span><span class="n">Lam_Htil</span><span class="p">[</span><span class="n">idx_p</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="c1">#====================== dual updates =================================#</span>
        <span class="n">Lam_W</span> <span class="o">=</span> <span class="n">Lam_W</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">W</span> <span class="o">-</span> <span class="n">Wtil</span><span class="p">)</span>
        <span class="n">Lam_P</span> <span class="o">=</span> <span class="n">Lam_P</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">P</span> <span class="o">-</span> <span class="n">Ptil</span><span class="p">)</span>
        <span class="n">Lam_H</span> <span class="o">=</span> <span class="n">Lam_H</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">H</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">X</span><span class="p">))</span>
        <span class="n">Lam_Htil</span> <span class="o">=</span> <span class="n">Lam_Htil</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">H</span><span class="o">-</span><span class="n">Htil</span><span class="p">)</span>

        <span class="c1">#============ comptute objective values ==============================#</span>
        <span class="c1"># main loss function</span>
        <span class="n">cost_nmf</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">Wtil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ptil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">))</span> <span class="o">-</span> <span class="n">X</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">_term1</span> <span class="o">=</span> <span class="n">trace</span><span class="p">(</span><span class="n">L1</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">dot</span><span class="p">(</span><span class="n">Htil</span><span class="p">[</span><span class="n">idx_i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">Htil</span><span class="p">[</span><span class="n">idx_i</span><span class="p">])))</span>
        <span class="n">_term2</span> <span class="o">=</span> <span class="n">trace</span><span class="p">(</span><span class="n">L2</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">dot</span><span class="p">(</span><span class="n">Htil</span><span class="p">[</span><span class="n">idx_p</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">Htil</span><span class="p">[</span><span class="n">idx_p</span><span class="p">])))</span>
        <span class="n">cost_graph</span> <span class="o">=</span> <span class="p">(</span><span class="n">tau</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">_term1</span> <span class="o">+</span> <span class="n">_term2</span><span class="p">)</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="n">cost_nmf</span> <span class="o">+</span> <span class="n">cost_graph</span>

        <span class="n">cost_nmf_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_nmf</span><span class="p">)</span>
        <span class="n">cost_graph_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_graph</span><span class="p">)</span>
        <span class="n">cost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>

        <span class="c1"># relative change in cost</span>
        <span class="n">diffcost</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span><span class="o">/</span><span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>

        <span class="c1"># relative primal residuals</span>
        <span class="n">res_W</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="o">-</span><span class="n">Wtil</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="n">res_P</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">P</span><span class="o">-</span><span class="n">Ptil</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="n">res_H</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="o">-</span><span class="n">P</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">),</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="n">res_Htil</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="o">-</span><span class="n">Htil</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>

        <span class="c1"># relative change in basis matrix</span>
<span class="c1">#        diffW.append( norm(W-W_old,&#39;fro&#39;)/ norm(W_old, &#39;fro&#39;) )</span>

        <span class="c1">#=== termination check ====#</span>
        <span class="n">check_exit</span>  <span class="o">=</span> <span class="p">(</span><span class="n">diffcost</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_W</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_P</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_H</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_Htil</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">check_exit</span> <span class="ow">and</span> <span class="nb">iter</span> <span class="o">&gt;</span> <span class="mi">300</span><span class="p">:</span> <span class="c1"># allow 300 iterations of &quot;burn-in&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silence</span><span class="p">:</span>
                <span class="k">print</span> <span class="s2">&quot;Termination condition met.  Exit at iter =&quot;</span><span class="p">,</span><span class="nb">iter</span><span class="p">,</span>
            <span class="k">break</span>
        <span class="c1">#=============== print current progress ==============================#</span>
<span class="c1">#        if iter % disp_freq == 0:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">iter</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">iter</span> <span class="o">%</span> <span class="n">disp_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="c1">#            str_ = &quot;iter={:4} cost={:3.3f}&quot;.format(iter,cost_list[iter+1])</span>
            <span class="n">str_</span> <span class="o">=</span> <span class="s2">&quot;iter={:4} cost={:6.5e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">iter</span><span class="p">,</span><span class="n">cost</span><span class="p">)</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; nmf={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cost_nmf</span><span class="p">)</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; graph={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cost_graph</span><span class="p">)</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; diffcost={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">diffcost</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; W={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_W</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; P={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_P</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; H={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_H</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; Htil={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_Htil</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
<span class="c1">#            str_ += &quot; diffW={:3.2e}&quot;.format(diffW[iter])</span>
            <span class="k">print</span> <span class="n">str_</span> <span class="o">+</span> <span class="s2">&quot; ({:3.1f} sec)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>
    <span class="c1">#%%---- end of admm for loop ---------------------------------------------#</span>
    <span class="n">cost_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cost_list</span><span class="p">)</span>

    <span class="c1"># convert to pandas dataframe</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">cost_list</span><span class="p">,</span> <span class="n">cost_nmf_list</span><span class="p">,</span> <span class="n">cost_graph_list</span><span class="p">],</span>
                        <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">,</span><span class="s1">&#39;nmf&#39;</span><span class="p">,</span><span class="s1">&#39;graph&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">res_W</span><span class="p">,</span><span class="n">res_P</span><span class="p">,</span><span class="n">res_H</span><span class="p">,</span><span class="n">diffcost</span><span class="p">],</span>
                       <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;res_W&#39;</span><span class="p">,</span><span class="s1">&#39;res_P&#39;</span><span class="p">,</span><span class="s1">&#39;res_H&#39;</span><span class="p">,</span><span class="s1">&#39;diffcost&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">silence</span><span class="p">:</span> <span class="n">print_time</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">W</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">Wtil</span><span class="p">,</span><span class="n">Ptil</span><span class="p">,</span><span class="n">cost</span><span class="p">,</span><span class="n">res</span>



<span class="k">def</span> <span class="nf">spnge_admm</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">r1</span><span class="p">,</span><span class="n">r2</span><span class="p">,</span><span class="n">L1</span><span class="p">,</span><span class="n">L2</span><span class="p">,</span><span class="n">tau</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">,</span><span class="n">rho</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
               <span class="n">W_init</span><span class="o">=</span><span class="s1">&#39;nndsvd&#39;</span><span class="p">,</span><span class="n">disp_freq</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">silence</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Projective non-negative graph embedding using ADMM.</span>

<span class="sd">    Note: in my Onenote, I used H_s, H_p...these are H_1 and H_2 in this code</span>
<span class="sd">    (basically, replace all (s,p) pairs with (1,2) pair)</span>

<span class="sd">    &gt;&gt;&gt; W,P,H,Wtil,Ptil,cost_list,res = gpnmf_admm(X,r,rho=5e2)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : ndarray of shape (n_features, n_samples)=(p,n)</span>
<span class="sd">        Data matrix with columns as data points</span>
<span class="sd">    r1 : int</span>
<span class="sd">        Dimension of the intrinsic embedding space (n_components)</span>
<span class="sd">    r2 : int</span>
<span class="sd">        Dimension of the complementary embedding space (n_components)</span>
<span class="sd">    L1 : ndarray of shape = [n_samples, n_samples]</span>
<span class="sd">        Laplacian matrix of intrinsic graph</span>
<span class="sd">    L2 : ndarray of shape = [n_samples, n_samples]</span>
<span class="sd">        Laplacian matrix of penalty graph.</span>
<span class="sd">    tau : float</span>
<span class="sd">        Amount of graph regularization to apply</span>
<span class="sd">    rho : float</span>
<span class="sd">        Augmented Lagrangian parameter</span>
<span class="sd">    max_iter : int</span>
<span class="sd">        max number of iterations</span>
<span class="sd">    tol : float</span>
<span class="sd">        convergence tolerance (on relative change in objective value and</span>
<span class="sd">        all primal residuals)</span>
<span class="sd">    W_init : None (default), rng, or &#39;nndsvd&#39;</span>
<span class="sd">        Way to initialize W (and H).  If ``None`` or ``RandomState object``</span>
<span class="sd">        is supplied, both W and H will be initialized via non-negative</span>
<span class="sd">        random number.  If ``&#39;nndsvd&#39;``, will use deterministic initialization</span>
<span class="sd">        NNDSVD &quot;Non-Negative Double Singular Value Decomposition&quot;, proposed by</span>
<span class="sd">        Boutsidis2008.</span>
<span class="sd">    disp_freq : int</span>
<span class="sd">        Frequency of update display (in iterations)</span>
<span class="sd">    silence : bool</span>
<span class="sd">        If True, don&#39;t print-out convergence detail at the end.</span>

<span class="sd">    Update history</span>
<span class="sd">    --------------</span>
<span class="sd">    **02/04/2016** - function created</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">r1</span><span class="o">+</span><span class="n">r2</span>
    <span class="n">rho</span> <span class="o">*=</span> <span class="mf">1.</span>
    <span class="n">tau</span> <span class="o">*=</span> <span class="mf">1.</span>
    <span class="n">p</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
    <span class="c1">#%%=== initialize variables =====</span>
    <span class="c1"># define main primal variable W (basis matrix)</span>
    <span class="k">if</span> <span class="n">W_init</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">W_init</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">):</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">W_init</span>

        <span class="n">W</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">W_init</span> <span class="o">==</span> <span class="s1">&#39;nndsvd&#39;</span><span class="p">:</span>
<span class="c1">#        W = nnd_svd(X,r)</span>
        <span class="n">W</span><span class="p">,</span><span class="n">H</span> <span class="o">=</span> <span class="n">nnd_svd</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">get_H</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid input for &quot;W_init&quot;&#39;</span><span class="p">)</span>

    <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">p</span><span class="p">))</span>
<span class="c1">#    P = np.random.rand(r,p)</span>

    <span class="c1"># aux. variables</span>
    <span class="n">Wtil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">W2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>   <span class="c1"># &lt;- for spectral projection</span>
    <span class="n">Ptil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Htil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="c1"># &lt;- for graph regularization</span>

    <span class="n">idx_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span>       <span class="c1"># &lt;- intrinsic graph indices (top half of H matrices)</span>
    <span class="n">idx_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">r1</span><span class="o">+</span><span class="n">r2</span><span class="p">)</span> <span class="c1"># &lt;- penalty   graph indices (bot half of H matrices)</span>
<span class="c1">#    Htil1 = np.zeros((r1,n)) # &lt;- the top half part of Htil (intrinsic part)</span>
<span class="c1">#    Htil2 = np.zeros((r2,n)) # &lt;- the bot half part of Htil (complementary part)</span>

    <span class="c1"># dual variables</span>
    <span class="n">Lam_W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_W2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>   <span class="c1"># &lt;- for spectral projection</span>
    <span class="n">Lam_P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_Htil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="c1"># &lt;- for graph regularization</span>
    <span class="c1">#%%=== create empty lists for tracking updates ===</span>
    <span class="c1"># keep track of frobenius norm loss</span>
    <span class="n">cost_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cost_nmf_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cost_graph_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">cost_nmf</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">Wtil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ptil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">))</span> <span class="o">-</span> <span class="n">X</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">_term1</span> <span class="o">=</span> <span class="n">trace</span><span class="p">(</span><span class="n">L1</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">dot</span><span class="p">(</span><span class="n">Htil</span><span class="p">[</span><span class="n">idx_i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">Htil</span><span class="p">[</span><span class="n">idx_i</span><span class="p">])))</span>
    <span class="n">_term2</span> <span class="o">=</span> <span class="n">trace</span><span class="p">(</span><span class="n">L2</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">dot</span><span class="p">(</span><span class="n">Htil</span><span class="p">[</span><span class="n">idx_p</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">Htil</span><span class="p">[</span><span class="n">idx_p</span><span class="p">])))</span>
    <span class="n">cost_graph</span> <span class="o">=</span> <span class="p">(</span><span class="n">tau</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">_term1</span> <span class="o">+</span> <span class="n">_term2</span><span class="p">)</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="n">cost_nmf</span> <span class="o">+</span> <span class="n">cost_graph</span>

    <span class="n">cost_nmf_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_nmf</span><span class="p">)</span>
    <span class="n">cost_graph_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_graph</span><span class="p">)</span>
    <span class="n">cost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>

    <span class="c1"># relative change in cost</span>
    <span class="n">diffcost</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># keep track of relative primal residual</span>
    <span class="n">res_W</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_W2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_P</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_H</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_Htil</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># also keep track of diffW</span>
<span class="c1">#    diffW = []</span>
    <span class="c1">#%%=== run admm iterations ===</span>
    <span class="n">eye_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">eye_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

    <span class="c1"># precompute term needed for inversion lemma</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">X</span><span class="p">),</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="n">start</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iter</span><span class="p">):</span>
<span class="c1">#        W_old = W #&lt;- to keep track of diffW</span>

        <span class="c1">#================ primal updates (P, W, H, Ptil, Wtil) ===============#</span>
        <span class="c1"># update for P involves inversion lemma...</span>
        <span class="n">_R</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Lam_H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">/</span><span class="n">rho</span> <span class="o">-</span> <span class="n">Lam_P</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">rho</span> <span class="o">+</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">Ptil</span><span class="o">.</span><span class="n">T</span>
        <span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="n">_R</span> <span class="o">-</span> <span class="n">X</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">dot</span><span class="p">(</span><span class="n">K</span><span class="p">,</span><span class="n">_R</span><span class="p">)</span> <span class="p">))</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Ptil</span> <span class="o">=</span> <span class="p">(</span><span class="n">P</span><span class="o">+</span><span class="n">Lam_P</span><span class="o">/</span><span class="n">rho</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># (W,H) updates</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">W</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="n">eye_r</span><span class="p">,</span>
                  <span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">X</span><span class="p">)</span> <span class="o">-</span> <span class="n">Lam_H</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">Htil</span> <span class="o">-</span> <span class="n">Lam_Htil</span> <span class="p">)</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="n">eye_r</span><span class="p">,</span>
                  <span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">Wtil</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">Lam_W</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">W2</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">Lam_W2</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Wtil</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span><span class="o">+</span><span class="n">Lam_W</span><span class="o">/</span><span class="n">rho</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># specral projection on two column blocks separately</span>
        <span class="n">_W</span> <span class="o">=</span> <span class="n">W</span> <span class="o">+</span> <span class="n">Lam_W2</span><span class="o">/</span><span class="n">rho</span>
        <span class="n">W2</span><span class="p">[:,</span><span class="n">idx_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">projection_spectral</span><span class="p">(</span><span class="n">_W</span><span class="p">[:,</span><span class="n">idx_i</span><span class="p">])</span>
        <span class="n">W2</span><span class="p">[:,</span><span class="n">idx_p</span><span class="p">]</span> <span class="o">=</span> <span class="n">projection_spectral</span><span class="p">(</span><span class="n">_W</span><span class="p">[:,</span><span class="n">idx_p</span><span class="p">])</span>

        <span class="c1"># --- Htil updates...broken down to two part: Htil1 and Htil2 ---</span>
        <span class="c1"># intrinsic graph update (top half of Htil matrix)</span>
        <span class="n">Htil</span><span class="p">[</span><span class="n">idx_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">tau</span><span class="o">*</span><span class="n">L1</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">eye_n</span><span class="p">,</span> <span class="n">rho</span><span class="o">*</span><span class="n">H</span><span class="p">[</span><span class="n">idx_i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">+</span><span class="n">Lam_Htil</span><span class="p">[</span><span class="n">idx_i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># penalty graph update (bottom half of Htil matrix)</span>
        <span class="n">Htil</span><span class="p">[</span><span class="n">idx_p</span><span class="p">]</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">tau</span><span class="o">*</span><span class="n">L2</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">eye_n</span><span class="p">,</span> <span class="n">rho</span><span class="o">*</span><span class="n">H</span><span class="p">[</span><span class="n">idx_p</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">+</span><span class="n">Lam_Htil</span><span class="p">[</span><span class="n">idx_p</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="c1">#====================== dual updates =================================#</span>
        <span class="n">Lam_W</span> <span class="o">=</span> <span class="n">Lam_W</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">W</span> <span class="o">-</span> <span class="n">Wtil</span><span class="p">)</span>
        <span class="n">Lam_W2</span> <span class="o">=</span> <span class="n">Lam_W2</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">W</span> <span class="o">-</span> <span class="n">W2</span><span class="p">)</span>
        <span class="n">Lam_P</span> <span class="o">=</span> <span class="n">Lam_P</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">P</span> <span class="o">-</span> <span class="n">Ptil</span><span class="p">)</span>
        <span class="n">Lam_H</span> <span class="o">=</span> <span class="n">Lam_H</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">H</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">X</span><span class="p">))</span>
        <span class="n">Lam_Htil</span> <span class="o">=</span> <span class="n">Lam_Htil</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">H</span><span class="o">-</span><span class="n">Htil</span><span class="p">)</span>

        <span class="c1">#============ comptute objective values ==============================#</span>
        <span class="c1"># main loss function</span>
        <span class="n">cost_nmf</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">Wtil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ptil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">))</span> <span class="o">-</span> <span class="n">X</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">_term1</span> <span class="o">=</span> <span class="n">trace</span><span class="p">(</span><span class="n">L1</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">dot</span><span class="p">(</span><span class="n">Htil</span><span class="p">[</span><span class="n">idx_i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">Htil</span><span class="p">[</span><span class="n">idx_i</span><span class="p">])))</span>
        <span class="n">_term2</span> <span class="o">=</span> <span class="n">trace</span><span class="p">(</span><span class="n">L2</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">dot</span><span class="p">(</span><span class="n">Htil</span><span class="p">[</span><span class="n">idx_p</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">Htil</span><span class="p">[</span><span class="n">idx_p</span><span class="p">])))</span>
        <span class="n">cost_graph</span> <span class="o">=</span> <span class="p">(</span><span class="n">tau</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">_term1</span> <span class="o">+</span> <span class="n">_term2</span><span class="p">)</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="n">cost_nmf</span> <span class="o">+</span> <span class="n">cost_graph</span>

        <span class="n">cost_nmf_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_nmf</span><span class="p">)</span>
        <span class="n">cost_graph_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_graph</span><span class="p">)</span>
        <span class="n">cost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>

        <span class="c1"># relative change in cost</span>
        <span class="n">diffcost</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span><span class="o">/</span><span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>

        <span class="c1"># relative primal residuals</span>
        <span class="n">res_W</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="o">-</span><span class="n">Wtil</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="n">res_W2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="o">-</span><span class="n">W2</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="n">res_P</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">P</span><span class="o">-</span><span class="n">Ptil</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="n">res_H</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="o">-</span><span class="n">P</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">),</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="n">res_Htil</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="o">-</span><span class="n">Htil</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>

        <span class="c1"># relative change in basis matrix</span>
<span class="c1">#        diffW.append( norm(W-W_old,&#39;fro&#39;)/ norm(W_old, &#39;fro&#39;) )</span>

        <span class="c1">#=== termination check ====#</span>
        <span class="n">check_exit</span>  <span class="o">=</span> <span class="p">(</span><span class="n">diffcost</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_W</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_P</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_H</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_Htil</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">check_exit</span> <span class="ow">and</span> <span class="nb">iter</span> <span class="o">&gt;</span> <span class="mi">300</span><span class="p">:</span> <span class="c1"># allow 300 iterations of &quot;burn-in&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silence</span><span class="p">:</span>
                <span class="k">print</span> <span class="s2">&quot;Termination condition met.  Exit at iter =&quot;</span><span class="p">,</span><span class="nb">iter</span><span class="p">,</span>
            <span class="k">break</span>
        <span class="c1">#=============== print current progress ==============================#</span>
<span class="c1">#        if iter % disp_freq == 0:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">iter</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">iter</span> <span class="o">%</span> <span class="n">disp_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="c1">#            str_ = &quot;iter={:4} cost={:3.3f}&quot;.format(iter,cost_list[iter+1])</span>
            <span class="n">str_</span> <span class="o">=</span> <span class="s2">&quot;iter={:4} cost={:6.5e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">iter</span><span class="p">,</span><span class="n">cost</span><span class="p">)</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; nmf={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cost_nmf</span><span class="p">)</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; graph={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cost_graph</span><span class="p">)</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; diffcost={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">diffcost</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; W={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_W</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; W2={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_W2</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; P={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_P</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; H={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_H</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; Htil={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_Htil</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
<span class="c1">#            str_ += &quot; diffW={:3.2e}&quot;.format(diffW[iter])</span>
            <span class="k">print</span> <span class="n">str_</span> <span class="o">+</span> <span class="s2">&quot; ({:3.1f} sec)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>
    <span class="c1">#%%---- end of admm for loop ---------------------------------------------#</span>
    <span class="n">cost_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cost_list</span><span class="p">)</span>

    <span class="c1"># convert to pandas dataframe</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">cost_list</span><span class="p">,</span> <span class="n">cost_nmf_list</span><span class="p">,</span> <span class="n">cost_graph_list</span><span class="p">],</span>
                        <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">,</span><span class="s1">&#39;nmf&#39;</span><span class="p">,</span><span class="s1">&#39;graph&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">res_W</span><span class="p">,</span><span class="n">res_W2</span><span class="p">,</span><span class="n">res_P</span><span class="p">,</span><span class="n">res_H</span><span class="p">,</span><span class="n">diffcost</span><span class="p">],</span>
                       <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;res_W&#39;</span><span class="p">,</span><span class="s1">&#39;res_W2&#39;</span><span class="p">,</span><span class="s1">&#39;res_P&#39;</span><span class="p">,</span><span class="s1">&#39;res_H&#39;</span><span class="p">,</span><span class="s1">&#39;diffcost&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">silence</span><span class="p">:</span> <span class="n">print_time</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">W</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">Wtil</span><span class="p">,</span><span class="n">Ptil</span><span class="p">,</span><span class="n">cost</span><span class="p">,</span><span class="n">res</span>


<span class="k">def</span> <span class="nf">ls_pnge_admm</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">r1</span><span class="p">,</span><span class="n">r2</span><span class="p">,</span><span class="n">L1</span><span class="p">,</span><span class="n">L2</span><span class="p">,</span><span class="n">tau</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">,</span><span class="n">gam</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span><span class="n">rho</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
                 <span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span><span class="n">W_init</span><span class="o">=</span><span class="s1">&#39;nndsvd&#39;</span><span class="p">,</span><span class="n">disp_freq</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">silence</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Projective non-negative graph embedding using ADMM.</span>

<span class="sd">    Note: in my Onenote, I used H_s, H_p...these are H_1 and H_2 in this code</span>
<span class="sd">    (basically, replace all (s,p) pairs with (1,2) pair)</span>

<span class="sd">    &gt;&gt;&gt; W,P,H,Wtil,Ptil,cost_list,res = gpnmf_admm(X,r,rho=5e2)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : ndarray of shape (n_features, n_samples)=(p,n)</span>
<span class="sd">        Data matrix with columns as data points</span>
<span class="sd">    y : array-like of shape [n_samples,]</span>
<span class="sd">        Label vector</span>
<span class="sd">    r1 : int</span>
<span class="sd">        Dimension of the intrinsic embedding space (n_components)</span>
<span class="sd">    r2 : int</span>
<span class="sd">        Dimension of the complementary embedding space (n_components)</span>
<span class="sd">    L1 : ndarray of shape = [n_samples, n_samples]</span>
<span class="sd">        Laplacian matrix of intrinsic graph</span>
<span class="sd">    L2 : ndarray of shape = [n_samples, n_samples]</span>
<span class="sd">        Laplacian matrix of penalty graph.</span>
<span class="sd">    tau : float</span>
<span class="sd">        Amount of graph regularization to apply</span>
<span class="sd">    gam : float</span>
<span class="sd">        Amount of weight on the classification loss</span>
<span class="sd">    rho : float</span>
<span class="sd">        Augmented Lagrangian parameter</span>
<span class="sd">    max_iter : int</span>
<span class="sd">        max number of iterations</span>
<span class="sd">    tol : float</span>
<span class="sd">        convergence tolerance (on relative change in objective value and</span>
<span class="sd">        all primal residuals)</span>
<span class="sd">    W_init : None (default), rng, or &#39;nndsvd&#39;</span>
<span class="sd">        Way to initialize W (and H).  If ``None`` or ``RandomState object``</span>
<span class="sd">        is supplied, both W and H will be initialized via non-negative</span>
<span class="sd">        random number.  If ``&#39;nndsvd&#39;``, will use deterministic initialization</span>
<span class="sd">        NNDSVD &quot;Non-Negative Double Singular Value Decomposition&quot;, proposed by</span>
<span class="sd">        Boutsidis2008.</span>
<span class="sd">    disp_freq : int</span>
<span class="sd">        Frequency of update display (in iterations)</span>
<span class="sd">    silence : bool</span>
<span class="sd">        If True, don&#39;t print-out convergence detail at the end.</span>

<span class="sd">    Update history</span>
<span class="sd">    --------------</span>
<span class="sd">    **02/03/2016** - function created</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">r1</span><span class="o">+</span><span class="n">r2</span>
    <span class="n">rho</span> <span class="o">*=</span> <span class="mf">1.</span>
    <span class="n">tau</span> <span class="o">*=</span> <span class="mf">1.</span>
    <span class="n">gam</span> <span class="o">*=</span> <span class="mf">1.</span>
    <span class="n">p</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
    <span class="c1">#%%=== initialize variables =====</span>
    <span class="c1"># define main primal variable W (basis matrix)</span>
    <span class="k">if</span> <span class="n">W_init</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">W_init</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">):</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">W_init</span>

        <span class="n">W</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">W_init</span> <span class="o">==</span> <span class="s1">&#39;nndsvd&#39;</span><span class="p">:</span>
<span class="c1">#        W = nnd_svd(X,r)</span>
        <span class="n">W</span><span class="p">,</span><span class="n">H</span> <span class="o">=</span> <span class="n">nnd_svd</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">get_H</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid input for &quot;W_init&quot;&#39;</span><span class="p">)</span>

    <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">p</span><span class="p">))</span>
<span class="c1">#    P = np.random.rand(r,p)</span>

    <span class="c1"># aux. variables</span>
    <span class="n">Wtil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Ptil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Htil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="c1"># &lt;- for graph regularization</span>

    <span class="n">idx_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span>       <span class="c1"># &lt;- intrinsic graph indices (top half of H matrices)</span>
    <span class="n">idx_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">r1</span><span class="o">+</span><span class="n">r2</span><span class="p">)</span> <span class="c1"># &lt;- penalty   graph indices (bot half of H matrices)</span>
<span class="c1">#    Htil1 = np.zeros((r1,n)) # &lt;- the top half part of Htil (intrinsic part)</span>
<span class="c1">#    Htil2 = np.zeros((r2,n)) # &lt;- the bot half part of Htil (complementary part)</span>

    <span class="c1"># classifier</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span>

    <span class="c1"># dual variables</span>
    <span class="n">Lam_W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_Htil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="c1"># &lt;- for graph regularization</span>
    <span class="c1">#%%=== create empty lists for tracking updates ===</span>
    <span class="c1"># keep track of frobenius norm loss</span>
    <span class="n">cost_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cost_nmf_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cost_ls_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cost_graph_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">cost_nmf</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">Wtil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ptil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">))</span> <span class="o">-</span> <span class="n">X</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">cost_ls</span>  <span class="o">=</span> <span class="n">gam</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">H</span><span class="p">[</span><span class="n">idx_i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">))</span> <span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">_term1</span> <span class="o">=</span> <span class="n">trace</span><span class="p">(</span><span class="n">L1</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">dot</span><span class="p">(</span><span class="n">Htil</span><span class="p">[</span><span class="n">idx_i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">Htil</span><span class="p">[</span><span class="n">idx_i</span><span class="p">])))</span>
    <span class="n">_term2</span> <span class="o">=</span> <span class="n">trace</span><span class="p">(</span><span class="n">L2</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">dot</span><span class="p">(</span><span class="n">Htil</span><span class="p">[</span><span class="n">idx_p</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">Htil</span><span class="p">[</span><span class="n">idx_p</span><span class="p">])))</span>
    <span class="n">cost_graph</span> <span class="o">=</span> <span class="p">(</span><span class="n">tau</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">_term1</span> <span class="o">+</span> <span class="n">_term2</span><span class="p">)</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="n">cost_nmf</span> <span class="o">+</span> <span class="n">cost_graph</span> <span class="o">+</span> <span class="n">cost_ls</span>

    <span class="n">cost_nmf_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_nmf</span><span class="p">)</span>
    <span class="n">cost_graph_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_graph</span><span class="p">)</span>
    <span class="n">cost_ls_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_ls</span><span class="p">)</span>
    <span class="n">cost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>

    <span class="c1"># relative change in cost</span>
    <span class="n">diffcost</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># keep track of relative primal residual</span>
    <span class="n">res_W</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_P</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_H</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_Htil</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># also keep track of diffW</span>
<span class="c1">#    diffW = []</span>
    <span class="c1">#%%=== run admm iterations ===</span>
    <span class="n">eye_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">eye_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

    <span class="c1"># precompute term needed for inversion lemma</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">X</span><span class="p">),</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="n">start</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iter</span><span class="p">):</span>
<span class="c1">#        W_old = W #&lt;- to keep track of diffW</span>

        <span class="c1">#================ primal updates (P, W, H, Ptil, Wtil) ===============#</span>
        <span class="c1"># update for P involves inversion lemma...</span>
        <span class="n">_R</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Lam_H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">/</span><span class="n">rho</span> <span class="o">-</span> <span class="n">Lam_P</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">rho</span> <span class="o">+</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">Ptil</span><span class="o">.</span><span class="n">T</span>
        <span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="n">_R</span> <span class="o">-</span> <span class="n">X</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">dot</span><span class="p">(</span><span class="n">K</span><span class="p">,</span><span class="n">_R</span><span class="p">)</span> <span class="p">))</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Ptil</span> <span class="o">=</span> <span class="p">(</span><span class="n">P</span><span class="o">+</span><span class="n">Lam_P</span><span class="o">/</span><span class="n">rho</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># intrinsic H update</span>
        <span class="n">Wi</span> <span class="o">=</span> <span class="n">W</span><span class="p">[:,</span><span class="n">idx_i</span><span class="p">]</span>
        <span class="n">Wp</span> <span class="o">=</span> <span class="n">W</span><span class="p">[:,</span><span class="n">idx_p</span><span class="p">]</span>
        <span class="n">H</span><span class="p">[</span><span class="n">idx_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">Wi</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">Wi</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span> <span class="o">+</span> <span class="n">gam</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">w</span><span class="p">),</span>
                  <span class="n">dot</span><span class="p">(</span><span class="n">Wi</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="n">idx_i</span><span class="p">],</span><span class="n">X</span><span class="p">)</span> <span class="o">-</span> <span class="n">Lam_H</span><span class="p">[</span><span class="n">idx_i</span><span class="p">]</span> <span class="o">+</span>
                  <span class="n">rho</span><span class="o">*</span><span class="n">Htil</span><span class="p">[</span><span class="n">idx_i</span><span class="p">]</span> <span class="o">-</span> <span class="n">Lam_Htil</span><span class="p">[</span><span class="n">idx_i</span><span class="p">]</span> <span class="o">+</span> <span class="n">gam</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">y</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">H</span><span class="p">[</span><span class="n">idx_p</span><span class="p">]</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">Wp</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">Wp</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">r2</span><span class="p">),</span>
                  <span class="n">dot</span><span class="p">(</span><span class="n">Wp</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="n">idx_p</span><span class="p">],</span><span class="n">X</span><span class="p">)</span> <span class="o">-</span> <span class="n">Lam_H</span><span class="p">[</span><span class="n">idx_p</span><span class="p">]</span> <span class="o">+</span>
                  <span class="n">rho</span><span class="o">*</span><span class="n">Htil</span><span class="p">[</span><span class="n">idx_p</span><span class="p">]</span> <span class="o">-</span> <span class="n">Lam_Htil</span><span class="p">[</span><span class="n">idx_p</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span> <span class="n">H</span><span class="p">[</span><span class="n">idx_i</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="n">idx_i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">H</span><span class="p">[</span><span class="n">idx_i</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>

        <span class="n">W</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">+</span><span class="n">rho</span><span class="o">*</span><span class="n">eye_r</span><span class="p">,</span> <span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">Wtil</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">Lam_W</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Wtil</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span><span class="o">+</span><span class="n">Lam_W</span><span class="o">/</span><span class="n">rho</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># --- Htil updates...broken down to two part: Htil1 and Htil2 ---</span>
        <span class="c1"># intrinsic graph update (top half of Htil matrix)</span>
        <span class="n">Htil</span><span class="p">[</span><span class="n">idx_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">tau</span><span class="o">*</span><span class="n">L1</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">eye_n</span><span class="p">,</span> <span class="n">rho</span><span class="o">*</span><span class="n">H</span><span class="p">[</span><span class="n">idx_i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">+</span><span class="n">Lam_Htil</span><span class="p">[</span><span class="n">idx_i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># penalty graph update (bottom half of Htil matrix)</span>
        <span class="n">Htil</span><span class="p">[</span><span class="n">idx_p</span><span class="p">]</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">tau</span><span class="o">*</span><span class="n">L2</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">eye_n</span><span class="p">,</span> <span class="n">rho</span><span class="o">*</span><span class="n">H</span><span class="p">[</span><span class="n">idx_p</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">+</span><span class="n">Lam_Htil</span><span class="p">[</span><span class="n">idx_p</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="c1">#====================== dual updates =================================#</span>
        <span class="n">Lam_W</span> <span class="o">=</span> <span class="n">Lam_W</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">W</span> <span class="o">-</span> <span class="n">Wtil</span><span class="p">)</span>
        <span class="n">Lam_P</span> <span class="o">=</span> <span class="n">Lam_P</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">P</span> <span class="o">-</span> <span class="n">Ptil</span><span class="p">)</span>
        <span class="n">Lam_H</span> <span class="o">=</span> <span class="n">Lam_H</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">H</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">X</span><span class="p">))</span>
        <span class="n">Lam_Htil</span> <span class="o">=</span> <span class="n">Lam_Htil</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">H</span><span class="o">-</span><span class="n">Htil</span><span class="p">)</span>

        <span class="c1">#============ comptute objective values ==============================#</span>
        <span class="c1"># main loss function</span>
        <span class="n">cost_nmf</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">Wtil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ptil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">))</span> <span class="o">-</span> <span class="n">X</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">cost_ls</span>  <span class="o">=</span> <span class="n">gam</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">H</span><span class="p">[</span><span class="n">idx_i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">))</span> <span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">_term1</span> <span class="o">=</span> <span class="n">trace</span><span class="p">(</span><span class="n">L1</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">dot</span><span class="p">(</span><span class="n">Htil</span><span class="p">[</span><span class="n">idx_i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">Htil</span><span class="p">[</span><span class="n">idx_i</span><span class="p">])))</span>
        <span class="n">_term2</span> <span class="o">=</span> <span class="n">trace</span><span class="p">(</span><span class="n">L2</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">dot</span><span class="p">(</span><span class="n">Htil</span><span class="p">[</span><span class="n">idx_p</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">Htil</span><span class="p">[</span><span class="n">idx_p</span><span class="p">])))</span>
        <span class="n">cost_graph</span> <span class="o">=</span> <span class="p">(</span><span class="n">tau</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">_term1</span> <span class="o">+</span> <span class="n">_term2</span><span class="p">)</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="n">cost_nmf</span> <span class="o">+</span> <span class="n">cost_graph</span> <span class="o">+</span> <span class="n">cost_ls</span>

        <span class="n">cost_nmf_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_nmf</span><span class="p">)</span>
        <span class="n">cost_graph_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_graph</span><span class="p">)</span>
        <span class="n">cost_ls_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_ls</span><span class="p">)</span>
        <span class="n">cost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>

        <span class="c1"># relative change in cost</span>
        <span class="n">diffcost</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span><span class="o">/</span><span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>

        <span class="c1"># relative primal residuals</span>
        <span class="n">res_W</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="o">-</span><span class="n">Wtil</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="n">res_P</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">P</span><span class="o">-</span><span class="n">Ptil</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="n">res_H</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="o">-</span><span class="n">P</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">),</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="n">res_Htil</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="o">-</span><span class="n">Htil</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>

        <span class="c1"># relative change in basis matrix</span>
<span class="c1">#        diffW.append( norm(W-W_old,&#39;fro&#39;)/ norm(W_old, &#39;fro&#39;) )</span>

        <span class="c1">#=== termination check ====#</span>
        <span class="n">check_exit</span>  <span class="o">=</span> <span class="p">(</span><span class="n">diffcost</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_W</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_P</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_H</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_Htil</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">check_exit</span> <span class="ow">and</span> <span class="nb">iter</span> <span class="o">&gt;</span> <span class="mi">300</span><span class="p">:</span> <span class="c1"># allow 300 iterations of &quot;burn-in&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silence</span><span class="p">:</span>
                <span class="k">print</span> <span class="s2">&quot;Termination condition met.  Exit at iter =&quot;</span><span class="p">,</span><span class="nb">iter</span><span class="p">,</span>
            <span class="k">break</span>
        <span class="c1">#=============== print current progress ==============================#</span>
<span class="c1">#        if iter % disp_freq == 0:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">iter</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">iter</span> <span class="o">%</span> <span class="n">disp_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="c1">#            str_ = &quot;iter={:4} cost={:3.3f}&quot;.format(iter,cost_list[iter+1])</span>
            <span class="n">str_</span> <span class="o">=</span> <span class="s2">&quot;iter={:4} cost={:6.5e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">iter</span><span class="p">,</span><span class="n">cost</span><span class="p">)</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; nmf={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cost_nmf</span><span class="p">)</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; graph={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cost_graph</span><span class="p">)</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; ls={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cost_ls</span><span class="p">)</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; diffcost={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">diffcost</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; W={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_W</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; P={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_P</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; H={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_H</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; Htil={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_Htil</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
<span class="c1">#            str_ += &quot; diffW={:3.2e}&quot;.format(diffW[iter])</span>
            <span class="k">print</span> <span class="n">str_</span> <span class="o">+</span> <span class="s2">&quot; ({:3.1f} sec)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>
    <span class="c1">#%%---- end of admm for loop ---------------------------------------------#</span>
    <span class="n">cost_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cost_list</span><span class="p">)</span>

    <span class="c1"># convert to pandas dataframe</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">cost_list</span><span class="p">,</span> <span class="n">cost_nmf_list</span><span class="p">,</span> <span class="n">cost_graph_list</span><span class="p">,</span><span class="n">cost_ls_list</span><span class="p">],</span>
                        <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">,</span><span class="s1">&#39;nmf&#39;</span><span class="p">,</span><span class="s1">&#39;graph&#39;</span><span class="p">,</span><span class="s1">&#39;ls&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">res_W</span><span class="p">,</span><span class="n">res_P</span><span class="p">,</span><span class="n">res_H</span><span class="p">,</span><span class="n">diffcost</span><span class="p">],</span>
                       <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;res_W&#39;</span><span class="p">,</span><span class="s1">&#39;res_P&#39;</span><span class="p">,</span><span class="s1">&#39;res_H&#39;</span><span class="p">,</span><span class="s1">&#39;diffcost&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">silence</span><span class="p">:</span> <span class="n">print_time</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">W</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">Wtil</span><span class="p">,</span><span class="n">Ptil</span><span class="p">,</span><span class="n">cost</span><span class="p">,</span><span class="n">res</span>
<span class="c1">#%% === class ====</span>
<span class="k">class</span> <span class="nc">PNMF_ADMM</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span><span class="n">TransformerMixin</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">r</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">rho</span><span class="o">=</span><span class="mf">5e2</span><span class="p">,</span><span class="n">W_init</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
                 <span class="n">disp_freq</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span><span class="n">silence</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">r</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rho</span> <span class="o">=</span> <span class="n">rho</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_init</span> <span class="o">=</span> <span class="n">W_init</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span> <span class="o">=</span> <span class="n">max_iter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="o">=</span> <span class="n">tol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disp_freq</span> <span class="o">=</span> <span class="n">disp_freq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">silence</span> <span class="o">=</span> <span class="n">silence</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;WARNING: Here, to conform with scikit&#39;s convention, X is [n,p] shaped&quot;&quot;&quot;</span>
        <span class="n">W</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">Wtil</span><span class="p">,</span><span class="n">Ptil</span><span class="p">,</span><span class="n">cost_list</span><span class="p">,</span><span class="n">res</span> <span class="o">=</span> <span class="n">pnmf_admm</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">r</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">rho</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span>
            <span class="n">W_init</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">W_init</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">,</span>
            <span class="n">disp_freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">disp_freq</span><span class="p">,</span> <span class="n">silence</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">silence</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_</span> <span class="o">=</span> <span class="n">Wtil</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P_</span> <span class="o">=</span> <span class="n">Ptil</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">H_</span> <span class="o">=</span> <span class="n">H</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cost_</span> <span class="o">=</span> <span class="n">cost_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resid_</span> <span class="o">=</span> <span class="n">res</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;WARNING: Here, to conform with scikit&#39;s convention, X is [n,p] shaped&quot;&quot;&quot;</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;P_&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">P_</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SPNMF_ADMM</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span><span class="n">TransformerMixin</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">r</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">rho</span><span class="o">=</span><span class="mf">5e2</span><span class="p">,</span><span class="n">constraint</span><span class="o">=</span><span class="s1">&#39;stiefel&#39;</span><span class="p">,</span><span class="n">W_init</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">max_iter</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span><span class="n">disp_freq</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span><span class="n">silence</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">r</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rho</span> <span class="o">=</span> <span class="n">rho</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraint</span> <span class="o">=</span> <span class="n">constraint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_init</span> <span class="o">=</span> <span class="n">W_init</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span> <span class="o">=</span> <span class="n">max_iter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="o">=</span> <span class="n">tol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disp_freq</span> <span class="o">=</span> <span class="n">disp_freq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">silence</span> <span class="o">=</span> <span class="n">silence</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;WARNING: Here, to conform with scikit&#39;s convention, X is [n,p]</span>
<span class="sd">        shaped, so need to apply transpose before inputting to function&quot;&quot;&quot;</span>
        <span class="n">W</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">W1</span><span class="p">,</span><span class="n">Ptil</span><span class="p">,</span><span class="n">cost_list</span><span class="p">,</span><span class="n">res</span> <span class="o">=</span> <span class="n">spnmf_admm</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">r</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span>
            <span class="n">constraint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">constraint</span><span class="p">,</span> <span class="n">rho</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span><span class="p">,</span>
            <span class="n">tol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">,</span> <span class="n">W_init</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">W_init</span><span class="p">,</span> <span class="n">disp_freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">disp_freq</span><span class="p">,</span>
            <span class="n">silence</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">silence</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">W_</span> <span class="o">=</span> <span class="n">W1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P_</span> <span class="o">=</span> <span class="n">Ptil</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">H_</span> <span class="o">=</span> <span class="n">H</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cost_</span> <span class="o">=</span> <span class="n">cost_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resid_</span> <span class="o">=</span> <span class="n">res</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;WARNING: Here, to conform with scikit&#39;s convention, X is [n,p] shaped&quot;&quot;&quot;</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;P_&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">P_</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PNGE_ADMM</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span><span class="n">TransformerMixin</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">knn_i</span><span class="p">,</span><span class="n">knn_p</span><span class="p">,</span><span class="n">r1</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">r2</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">rho</span><span class="o">=</span><span class="mf">5e2</span><span class="p">,</span><span class="n">tau</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">,</span><span class="n">W_init</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">max_iter</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span><span class="n">disp_freq</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span><span class="n">silence</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        knn_i = # within-class kNN neighbors</span>
<span class="sd">        knn_p = # betwen-class kNN neighbors</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r1</span> <span class="o">=</span> <span class="n">r1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r2</span> <span class="o">=</span> <span class="n">r2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">knn_i</span> <span class="o">=</span> <span class="n">knn_i</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">knn_p</span> <span class="o">=</span> <span class="n">knn_p</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span>  <span class="o">=</span> <span class="n">r1</span><span class="o">+</span><span class="n">r2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">=</span> <span class="n">tau</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rho</span> <span class="o">=</span> <span class="n">rho</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_init</span> <span class="o">=</span> <span class="n">W_init</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span> <span class="o">=</span> <span class="n">max_iter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="o">=</span> <span class="n">tol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disp_freq</span> <span class="o">=</span> <span class="n">disp_freq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">silence</span> <span class="o">=</span> <span class="n">silence</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;WARNING: Here, to conform with scikit&#39;s convention, X is [n,p]</span>
<span class="sd">        shaped, so need to apply transpose before inputting to function&quot;&quot;&quot;</span>
        <span class="c1"># construct intrinsic and penalty graph</span>
        <span class="n">Li</span> <span class="o">=</span> <span class="n">get_knn_within_class</span><span class="p">(</span> <span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">n_neighbors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">knn_i</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">Lp</span> <span class="o">=</span> <span class="n">get_knn_between_class</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">n_neighbors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">knn_p</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">W</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">Wtil</span><span class="p">,</span><span class="n">Ptil</span><span class="p">,</span><span class="n">cost</span><span class="p">,</span><span class="n">res</span> <span class="o">=</span> <span class="n">pnge_admm</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">r1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="p">,</span><span class="n">r2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="p">,</span>
            <span class="n">L1</span><span class="o">=</span><span class="n">Li</span><span class="p">,</span><span class="n">L2</span><span class="o">=</span><span class="n">Lp</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">,</span> <span class="n">rho</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span><span class="p">,</span>
            <span class="n">tol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">,</span> <span class="n">W_init</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">W_init</span><span class="p">,</span> <span class="n">disp_freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">disp_freq</span><span class="p">,</span>
            <span class="n">silence</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">silence</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">W_</span> <span class="o">=</span> <span class="n">Wtil</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P_</span> <span class="o">=</span> <span class="n">Ptil</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">H_</span> <span class="o">=</span> <span class="n">H</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cost_</span> <span class="o">=</span> <span class="n">cost</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resid_</span> <span class="o">=</span> <span class="n">res</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;WARNING: Here, to conform with scikit&#39;s convention, X is [n,p] shaped&quot;&quot;&quot;</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;P_&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">P_</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">LS_PNGE_ADMM</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span><span class="n">TransformerMixin</span><span class="p">,</span><span class="n">ClassifierMixin</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">knn_i</span><span class="p">,</span><span class="n">knn_p</span><span class="p">,</span><span class="n">r1</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">r2</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">rho</span><span class="o">=</span><span class="mf">5e2</span><span class="p">,</span><span class="n">tau</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">,</span><span class="n">gam</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">,</span><span class="n">W_init</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">max_iter</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span><span class="n">disp_freq</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span><span class="n">silence</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        knn_i = # within-class kNN neighbors</span>
<span class="sd">        knn_p = # betwen-class kNN neighbors</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r1</span> <span class="o">=</span> <span class="n">r1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r2</span> <span class="o">=</span> <span class="n">r2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">knn_i</span> <span class="o">=</span> <span class="n">knn_i</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">knn_p</span> <span class="o">=</span> <span class="n">knn_p</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span>  <span class="o">=</span> <span class="n">r1</span><span class="o">+</span><span class="n">r2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">=</span> <span class="n">tau</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gam</span> <span class="o">=</span> <span class="n">gam</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rho</span> <span class="o">=</span> <span class="n">rho</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_init</span> <span class="o">=</span> <span class="n">W_init</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span> <span class="o">=</span> <span class="n">max_iter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="o">=</span> <span class="n">tol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disp_freq</span> <span class="o">=</span> <span class="n">disp_freq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">silence</span> <span class="o">=</span> <span class="n">silence</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;WARNING: Here, to conform with scikit&#39;s convention, X is [n,p]</span>
<span class="sd">        shaped, so need to apply transpose before inputting to function&quot;&quot;&quot;</span>
        <span class="c1"># construct intrinsic and penalty graph</span>
        <span class="n">Li</span> <span class="o">=</span> <span class="n">get_knn_within_class</span><span class="p">(</span> <span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">n_neighbors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">knn_i</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">Lp</span> <span class="o">=</span> <span class="n">get_knn_between_class</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">n_neighbors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">knn_p</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">W</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">Wtil</span><span class="p">,</span><span class="n">Ptil</span><span class="p">,</span><span class="n">cost</span><span class="p">,</span><span class="n">res</span> <span class="o">=</span> <span class="n">ls_pnge_admm</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">r1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="p">,</span><span class="n">r2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="p">,</span>
            <span class="n">L1</span><span class="o">=</span><span class="n">Li</span><span class="p">,</span><span class="n">L2</span><span class="o">=</span><span class="n">Lp</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">,</span> <span class="n">gam</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gam</span><span class="p">,</span>
            <span class="n">rho</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span><span class="p">,</span>
            <span class="n">tol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">,</span> <span class="n">W_init</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">W_init</span><span class="p">,</span> <span class="n">disp_freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">disp_freq</span><span class="p">,</span>
            <span class="n">silence</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">silence</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">W_</span> <span class="o">=</span> <span class="n">Wtil</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P_</span> <span class="o">=</span> <span class="n">Ptil</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">H_</span> <span class="o">=</span> <span class="n">H</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_</span> <span class="o">=</span> <span class="n">w</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cost_</span> <span class="o">=</span> <span class="n">cost</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resid_</span> <span class="o">=</span> <span class="n">res</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;WARNING: Here, to conform with scikit&#39;s convention, X is [n,p] shaped&quot;&quot;&quot;</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;P_&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">P_</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">decision_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">):</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;P_&#39;</span><span class="p">)</span>

        <span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="c1"># apply classifier</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">score</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">):</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;P_&#39;</span><span class="p">)</span>

        <span class="c1"># project data to low dimensional space</span>
        <span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="c1"># apply classifier</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_</span><span class="p">)</span>
        <span class="n">ypr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ypr</span>


<span class="k">class</span> <span class="nc">LS_SPNMF_ADMM</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span><span class="n">ClassifierMixin</span><span class="p">,</span><span class="n">TransformerMixin</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">gam</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">,</span><span class="n">gam2</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">r</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">rho</span><span class="o">=</span><span class="mf">5e2</span><span class="p">,</span><span class="n">constraint</span><span class="o">=</span><span class="s1">&#39;stiefel&#39;</span><span class="p">,</span><span class="n">W_init</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">max_iter</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span><span class="n">disp_freq</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span><span class="n">silence</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">r</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gam</span> <span class="o">=</span> <span class="n">gam</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gam2</span> <span class="o">=</span> <span class="n">gam2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rho</span> <span class="o">=</span> <span class="n">rho</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraint</span> <span class="o">=</span> <span class="n">constraint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_init</span> <span class="o">=</span> <span class="n">W_init</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span> <span class="o">=</span> <span class="n">max_iter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="o">=</span> <span class="n">tol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disp_freq</span> <span class="o">=</span> <span class="n">disp_freq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">silence</span> <span class="o">=</span> <span class="n">silence</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;WARNING: Here, to conform with scikit&#39;s convention, X is [n,p]</span>
<span class="sd">        shaped, so need to apply transpose before inputting to function&quot;&quot;&quot;</span>
        <span class="n">W</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">Wtil</span><span class="p">,</span><span class="n">Ptil</span><span class="p">,</span><span class="n">cost</span><span class="p">,</span><span class="n">res</span> <span class="o">=</span> <span class="n">ls_spnmf_admm</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span>
            <span class="n">gam</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gam</span><span class="p">,</span> <span class="n">gam2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gam2</span><span class="p">,</span>
            <span class="n">constraint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">constraint</span><span class="p">,</span> <span class="n">rho</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span><span class="p">,</span>
            <span class="n">tol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">,</span> <span class="n">W_init</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">W_init</span><span class="p">,</span> <span class="n">disp_freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">disp_freq</span><span class="p">,</span>
            <span class="n">silence</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">silence</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">W_</span> <span class="o">=</span> <span class="n">Wtil</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_</span> <span class="o">=</span> <span class="n">w</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P_</span> <span class="o">=</span> <span class="n">Ptil</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">H_</span> <span class="o">=</span> <span class="n">H</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cost_</span> <span class="o">=</span> <span class="n">cost</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resid_</span> <span class="o">=</span> <span class="n">res</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;WARNING: Here, to conform with scikit&#39;s convention, X is [n,p] shaped&quot;&quot;&quot;</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;P_&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">P_</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">decision_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">):</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;P_&#39;</span><span class="p">)</span>
        <span class="c1"># project data to low dimensional space</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">P_</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="c1"># apply classifier</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">score</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">):</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;P_&#39;</span><span class="p">)</span>

        <span class="c1"># project data to low dimensional space</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">P_</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="c1"># apply classifier</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_</span><span class="p">)</span>
        <span class="n">ypr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ypr</span>


<div class="viewcode-block" id="LS_SGPNMF_ADMM"><a class="viewcode-back" href="../../../supervised_nmf.html#tak.ml.LS_SGPNMF_ADMM">[docs]</a><span class="k">class</span> <span class="nc">LS_SGPNMF_ADMM</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span><span class="n">ClassifierMixin</span><span class="p">,</span><span class="n">TransformerMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Created 02/04/2016&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">r</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">tau</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">,</span><span class="n">gam</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">,</span><span class="n">gam2</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">rho</span><span class="o">=</span><span class="mf">5e2</span><span class="p">,</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
                 <span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span><span class="n">W_init</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">disp_freq</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span><span class="n">silence</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">graph_type</span><span class="o">=</span><span class="s1">&#39;knn_within_class&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        graph_type : {&#39;knn&#39; or &#39;knn_within_class&#39;}</span>
<span class="sd">            (X,y) driven graph construction method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">r</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">=</span> <span class="n">tau</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gam</span> <span class="o">=</span> <span class="n">gam</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gam2</span> <span class="o">=</span> <span class="n">gam2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rho</span> <span class="o">=</span> <span class="n">rho</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span> <span class="o">=</span> <span class="n">max_iter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="o">=</span> <span class="n">tol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_init</span> <span class="o">=</span> <span class="n">W_init</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disp_freq</span> <span class="o">=</span> <span class="n">disp_freq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">silence</span> <span class="o">=</span> <span class="n">silence</span>

        <span class="c1"># feature driven graph construction method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_neighbors</span> <span class="o">=</span> <span class="n">n_neighbors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph_type</span> <span class="o">=</span> <span class="n">graph_type</span>

<div class="viewcode-block" id="LS_SGPNMF_ADMM.fit"><a class="viewcode-back" href="../../../supervised_nmf.html#tak.ml.LS_SGPNMF_ADMM.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;WARNING: Here, to conform with scikit&#39;s convention, X is [n,p]</span>
<span class="sd">        shaped, so need to apply transpose before inputting to function&quot;&quot;&quot;</span>
        <span class="c1"># create within-class KNN graph</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_type</span> <span class="o">==</span> <span class="s1">&#39;knn_within_class&#39;</span><span class="p">:</span>
            <span class="n">L</span> <span class="o">=</span> <span class="n">get_knn_within_class</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">n_neighbors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_neighbors</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_type</span> <span class="o">==</span> <span class="s1">&#39;knn&#39;</span><span class="p">:</span>
            <span class="n">L</span> <span class="o">=</span> <span class="n">get_knn_graph</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">n_neighbors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_neighbors</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<span class="c1">#        # if L is a tuple or list with two integers, create supervised</span>
<span class="c1">#        # MFA graph (knn_withinclass and knn_betweenclass graph)</span>
<span class="c1">#        if isinstance(self.L,list) or isinstance(self.L,tuple):</span>
<span class="c1">#            # within class intrinsic graph</span>
<span class="c1">#            Ls = get_knn_within_class(X,y,n_neighbors=self.L[0])[1]</span>
<span class="c1">#</span>
<span class="c1">#            # between class penalty graph</span>
<span class="c1">#            Lp = get_knn_between_class(X,y,n_neighbors=self.L[1])[1]</span>
<span class="c1">#</span>
<span class="c1">#            # final laplacian matrix of interest</span>
<span class="c1">#            L = Ls - Lp</span>
<span class="c1">#        elif self.L.shape[1] == len(y):</span>
<span class="c1">#            # else (nxn) laplacian matrix is assumed to be given</span>
<span class="c1">#            # (add exception statement later)</span>
<span class="c1">#            L = self.L</span>


        <span class="n">W</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">Wtil</span><span class="p">,</span><span class="n">Ptil</span><span class="p">,</span><span class="n">cost</span><span class="p">,</span><span class="n">res</span> <span class="o">=</span> <span class="n">ls_sgpnmf_admm</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="n">L</span><span class="p">,</span>
            <span class="n">tau</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">,</span> <span class="n">gam</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gam</span><span class="p">,</span> <span class="n">gam2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gam2</span><span class="p">,</span> <span class="n">rho</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span>
            <span class="n">max_iter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">,</span> <span class="n">W_init</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">W_init</span><span class="p">,</span>
            <span class="n">disp_freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">disp_freq</span><span class="p">,</span> <span class="n">silence</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">silence</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">W_</span> <span class="o">=</span> <span class="n">Wtil</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_</span> <span class="o">=</span> <span class="n">w</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P_</span> <span class="o">=</span> <span class="n">Ptil</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">H_</span> <span class="o">=</span> <span class="n">H</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cost_</span> <span class="o">=</span> <span class="n">cost</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resid_</span> <span class="o">=</span> <span class="n">res</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="LS_SGPNMF_ADMM.transform"><a class="viewcode-back" href="../../../supervised_nmf.html#tak.ml.LS_SGPNMF_ADMM.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;WARNING: Here, to conform with scikit&#39;s convention, X is [n,p] shaped&quot;&quot;&quot;</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;P_&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">P_</span><span class="o">.</span><span class="n">T</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">decision_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">):</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;P_&#39;</span><span class="p">)</span>
        <span class="c1"># project data to low dimensional space</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">P_</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="c1"># apply classifier</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">score</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">):</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;P_&#39;</span><span class="p">)</span>

        <span class="c1"># project data to low dimensional space</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">P_</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="c1"># apply classifier</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_</span><span class="p">)</span>
        <span class="n">ypr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ypr</span></div>




<span class="c1">#%%==== helper functions =====</span>
<span class="k">def</span> <span class="nf">nnd_svd</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">get_H</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; My wrapper to NND-SVD from nimfa module</span>

<span class="sd">    NND-SVD = &quot;Non-Negative Double Singular Value Decomposition&quot;, proposed by</span>
<span class="sd">    Boutsidis2008.  Since my focus is on PNMF, just return matrix W.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : ndarray of shape [p,n]</span>
<span class="sd">        Data matrix with columns as data points</span>
<span class="sd">    r : int</span>
<span class="sd">        Dimension of the embedding space</span>
<span class="sd">    get_H : bool (default = False)</span>
<span class="sd">        Return coefficient matrix too (not needed when using projective NMF)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    W : ndarray of shape [p,r]</span>
<span class="sd">        Initialization of basis &amp; projection matrix</span>
<span class="sd">    H : (optional) ndarray of shape [r,n]</span>
<span class="sd">        Initialization of coefficient matrix.  Returned if ``get_H=True``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">nimfa.methods.seeding.nndsvd</span> <span class="kn">import</span> <span class="n">Nndsvd</span>

    <span class="k">if</span> <span class="n">get_H</span><span class="p">:</span>
        <span class="n">Winit</span><span class="p">,</span><span class="n">Hinit</span> <span class="o">=</span> <span class="n">Nndsvd</span><span class="p">()</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">rank</span><span class="o">=</span><span class="n">r</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">flag</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Winit</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Hinit</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Winit</span> <span class="o">=</span> <span class="n">Nndsvd</span><span class="p">()</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">rank</span><span class="o">=</span><span class="n">r</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">flag</span><span class="o">=</span><span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># convert to ndarray (instead of matrix form)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Winit</span><span class="p">)</span>



<span class="k">def</span> <span class="nf">prox_hinge</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">tau</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Proximal operator of the hinge loss</span>

<span class="sd">    Return the prox operator of the hinge loss, given by:</span>

<span class="sd">    .. math::</span>

<span class="sd">        \\text{prox}(x,\\tau) =</span>
<span class="sd">            \\begin{cases}</span>
<span class="sd">                t       &amp; \\text{if}\\quad t &gt; 1 \\\\</span>
<span class="sd">                1       &amp; \\text{if}\\quad 1-\\tau \\le t \\le 1 \\\\</span>
<span class="sd">                t+\\tau &amp; \\text{if}\\quad t &lt; 1-\\tau</span>
<span class="sd">            \\end{cases}</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : array_like</span>
<span class="sd">        Input values</span>

<span class="sd">    tau : float</span>
<span class="sd">        Prox-operator value</span>

<span class="sd">    Returns</span>
<span class="sd">    ------</span>
<span class="sd">    y : ndarray</span>
<span class="sd">        The prox-operator of the hinge loss</span>

<span class="sd">    Plot</span>
<span class="sd">    ----</span>
<span class="sd">    &gt;&gt;&gt; x = np.linspace(-4,4,501)</span>
<span class="sd">    &gt;&gt;&gt; plt.plot(x, prox(x,tau=2))</span>
<span class="sd">    &gt;&gt;&gt; plt.grid(&#39;on&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">tau</span><span class="p">)</span><span class="o">&lt;=</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="o">&lt;=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">tau</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">tau</span><span class="p">))</span>

<span class="c1">#%% --- graph related ---</span>
<span class="k">def</span> <span class="nf">get_subject_graph</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">return_as_df</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Get &quot;subject-graph&quot;, where S_ij = 1 if (i,j) represents the same subject</span>

<span class="sd">    Returns the similarity matrix S and Laplacian matrix L of shape [n,n].</span>
<span class="sd">    Usecase for TBI, where we have scans from same subjects.</span>

<span class="sd">    Usage</span>
<span class="sd">    -----</span>
<span class="sd">    &gt;&gt;&gt; X,y,df = twio.get_tbi_connectomes(return_all_scores=True)</span>
<span class="sd">    &gt;&gt;&gt; S,L = get_subject_graph(df)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    S, L : ndarray of shape = [n,n]</span>
<span class="sd">        Similarity and Laplacian matrix, respectively.</span>

<span class="sd">    History</span>
<span class="sd">    -------</span>
<span class="sd">    Created 02/03/2016</span>

<span class="sd">    See ``dev_0203_created_subject_graph.py``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1">#from scipy import sparse</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Subject_ID&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Subject_ID&#39;</span><span class="p">]</span>

    <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span> <span class="n">S</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">D</span> <span class="o">-</span> <span class="n">S</span>

    <span class="k">if</span> <span class="n">return_as_df</span><span class="p">:</span>
        <span class="n">S</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Subject_ID&#39;</span><span class="p">],</span><span class="n">columns</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Subject_ID&#39;</span><span class="p">])</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Subject_ID&#39;</span><span class="p">],</span><span class="n">columns</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Subject_ID&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">S</span><span class="p">,</span><span class="n">L</span>


<span class="k">def</span> <span class="nf">get_knn_kfn</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">n_neighbors</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Get k-nearest and k-farthest neighbors (in Euclidean distance)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : ndarray of shape [n,p]</span>
<span class="sd">        Design matrix</span>
<span class="sd">    n_neighbors : int</span>
<span class="sd">        Number of neighbors</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    knn : ndarray of shape [n,n_neighbors]</span>
<span class="sd">        K-nearest-neighbors</span>
<span class="sd">    kfn : ndarray of shape [n,n_neighbors,]</span>
<span class="sd">        K-farthest-neighbors</span>

<span class="sd">    Snippets</span>
<span class="sd">    --------</span>
<span class="sd">    I used this as a sanity check for this function (use Spyder variable</span>
<span class="sd">    explorer to compare EDM_sorted and EDM_knn, EDM_kfn below)</span>

<span class="sd">    &gt;&gt;&gt; knn,kfn = tw_nmf.get_knn_kfn(X,n_neighbors=5)</span>
<span class="sd">    &gt;&gt;&gt; EDM = tw.get_EDM(X)</span>
<span class="sd">    &gt;&gt;&gt; EDM_sorted = np.sort(EDM, axis=1)</span>
<span class="sd">    &gt;&gt;&gt; EDM_knn = np.zeros(knn.shape)</span>
<span class="sd">    &gt;&gt;&gt; EDM_kfn = np.zeros(knn.shape)</span>
<span class="sd">    &gt;&gt;&gt; for i in range( EDM_knn.shape[0]):</span>
<span class="sd">    &gt;&gt;&gt;     EDM_knn[i] = EDM[i, knn[i]]</span>
<span class="sd">    &gt;&gt;&gt;     EDM_kfn[i] = EDM[i, kfn[i]]</span>

<span class="sd">    **Created 01/24/2016**</span>
<span class="sd">    ----------------------</span>
<span class="sd">    See ``0124_knn_and_kfarthest_b.py``</span>

<span class="sd">    Updates 02/11/2016</span>

<span class="sd">    - replaced np.argsort with tw.argsort to handle &quot;ties&quot;</span>
<span class="sd">    - add huge diagonal item to EDM</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">sklearn.metrics.pairwise</span> <span class="kn">import</span> <span class="n">pairwise_distances</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># add huge item to diagonal to ensure &quot;self&quot; will be farthest</span>
    <span class="n">EDM</span> <span class="o">=</span> <span class="n">pairwise_distances</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">metric</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mf">10e10</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

    <span class="c1">#idx_rank  = np.argsort(EDM,axis=1)</span>
    <span class="n">idx_rank</span> <span class="o">=</span> <span class="n">tw</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">EDM</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># here ok to start from beginning - i avoided self-similarity above</span>
    <span class="n">knn</span> <span class="o">=</span> <span class="n">idx_rank</span><span class="p">[:,:</span><span class="n">n_neighbors</span><span class="p">]</span>

    <span class="c1"># -1 shift since the &quot;farthest&quot; guy is the huge diagonal EDM element</span>
    <span class="c1"># I added above</span>
    <span class="n">kfn</span> <span class="o">=</span> <span class="n">idx_rank</span><span class="p">[:,</span><span class="o">-</span><span class="n">n_neighbors</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">knn</span><span class="p">,</span><span class="n">kfn</span>



<span class="k">def</span> <span class="nf">get_knn</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">n_neighbors</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Get k-nearest neighbors (in Euclidean distance)</span>

<span class="sd">    This function is a simple wrapper to ``get_knn_kfn``, which i created first.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : ndarray of shape [n,p]</span>
<span class="sd">        Design matrix</span>
<span class="sd">    n_neighbors : int</span>
<span class="sd">        Number of neighbors</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    knn : ndarray of shape [n,n_neighbors]</span>
<span class="sd">        K-nearest-neighbors for each samples (each row contains indices of kNN)</span>

<span class="sd">    Snippets</span>
<span class="sd">    --------</span>
<span class="sd">    I used this as a sanity check for this function (use Spyder variable</span>
<span class="sd">    explorer to compare EDM_sorted and EDM_knn, EDM_kfn below)</span>

<span class="sd">    &gt;&gt;&gt; knn,kfn = tw_nmf.get_knn_kfn(X,n_neighbors=5)</span>
<span class="sd">    &gt;&gt;&gt; EDM = tw.get_EDM(X)</span>
<span class="sd">    &gt;&gt;&gt; EDM_sorted = np.sort(EDM, axis=1)</span>
<span class="sd">    &gt;&gt;&gt; EDM_knn = np.zeros(knn.shape)</span>
<span class="sd">    &gt;&gt;&gt; for i in range( EDM_knn.shape[0]):</span>
<span class="sd">    &gt;&gt;&gt;     EDM_knn[i] = EDM[i, knn[i]]</span>

<span class="sd">    **Created 02/11/2016**</span>
<span class="sd">    ----------------------</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">knn</span> <span class="o">=</span> <span class="n">get_knn_kfn</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">n_neighbors</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">knn</span>


<span class="k">def</span> <span class="nf">get_kfn</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">n_neighbors</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Get k-farthest neighbors (in Euclidean distance)</span>

<span class="sd">    This function is a simple wrapper to ``get_knn_kfn``, which i created first.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : ndarray of shape [n,p]</span>
<span class="sd">        Design matrix</span>
<span class="sd">    n_neighbors : int</span>
<span class="sd">        Number of neighbors</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    kfn : ndarray of shape [n,n_neighbors]</span>
<span class="sd">        K-farthest-neighbors for each samples (each row contains indices of kFN)</span>

<span class="sd">    Snippets</span>
<span class="sd">    --------</span>
<span class="sd">    I used this as a sanity check for this function (use Spyder variable</span>
<span class="sd">    explorer to compare EDM_sorted and EDM_knn, EDM_kfn below)</span>

<span class="sd">    &gt;&gt;&gt; knn,kfn = tw_nmf.get_knn_kfn(X,n_neighbors=5)</span>
<span class="sd">    &gt;&gt;&gt; EDM = tw.get_EDM(X)</span>
<span class="sd">    &gt;&gt;&gt; EDM_sorted = np.sort(EDM, axis=1)</span>
<span class="sd">    &gt;&gt;&gt; EDM_knn = np.zeros(knn.shape)</span>
<span class="sd">    &gt;&gt;&gt; for i in range( EDM_knn.shape[0]):</span>
<span class="sd">    &gt;&gt;&gt;     EDM_knn[i] = EDM[i, knn[i]]</span>

<span class="sd">    **Created 02/11/2016**</span>
<span class="sd">    ----------------------</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kfn</span> <span class="o">=</span> <span class="n">get_knn_kfn</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">n_neighbors</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">kfn</span>


<span class="k">def</span> <span class="nf">make_graph_from_knn</span><span class="p">(</span><span class="n">knn</span><span class="p">,</span><span class="n">symm_method</span><span class="o">=</span><span class="s1">&#39;OR&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Given knn index info, create similarity and adjacency graph</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    knn : ndarray of shape [n,n_neighbors]</span>
<span class="sd">        K-nearest-neighbors indices (can also be k-FARTHEST)</span>
<span class="sd">    symm_method : {&#39;OR&#39;, &#39;AND&#39;} (default=&quot;OR&quot;)</span>
<span class="sd">        Symmetrization method (since kNN is not a symmetric relation).</span>
<span class="sd">        Logical &quot;AND&quot; or &quot;OR&quot;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    S, L : ndarray of shape = [n,n]</span>
<span class="sd">        Similarity and Laplacian matrix, respectively.  For now, binary only.</span>

<span class="sd">    Usage</span>
<span class="sd">    -----</span>
<span class="sd">    &gt;&gt;&gt; knn = tw_nmf.get_knn(scores_exec,n_neighbors=3)</span>
<span class="sd">    &gt;&gt;&gt; S,L = tw.make_graph_from_knn(knn)</span>

<span class="sd">    History</span>
<span class="sd">    --------</span>
<span class="sd">    Created 02/11/2016</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">knn</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">=</span><span class="mi">1</span>

    <span class="c1"># symmetrize</span>
    <span class="k">if</span> <span class="n">symm_method</span> <span class="o">==</span> <span class="s1">&#39;OR&#39;</span><span class="p">:</span>
        <span class="n">S</span> <span class="o">=</span> <span class="p">((</span><span class="n">S</span> <span class="o">+</span> <span class="n">S</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">symm_method</span> <span class="o">==</span> <span class="s1">&#39;AND&#39;</span><span class="p">:</span>
        <span class="n">S</span> <span class="o">=</span> <span class="p">((</span><span class="n">S</span> <span class="o">+</span> <span class="n">S</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="c1"># create laplacian matrix</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span> <span class="n">S</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">D</span> <span class="o">-</span> <span class="n">S</span>

    <span class="k">return</span> <span class="n">S</span><span class="p">,</span><span class="n">L</span>




<span class="k">def</span> <span class="nf">get_knn_kfn_graph</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">n_neighbors</span><span class="p">):</span>
    <span class="n">knn</span><span class="p">,</span><span class="n">kfn</span> <span class="o">=</span> <span class="n">get_knn_kfn</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">n_neighbors</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">A_knn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
    <span class="n">A_kfn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">A_knn</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">knn</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">=</span><span class="mi">1</span>
        <span class="n">A_kfn</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">kfn</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">=</span><span class="mi">1</span>

    <span class="c1"># symmetrize</span>
    <span class="n">A_knn</span> <span class="o">=</span> <span class="p">((</span><span class="n">A_knn</span> <span class="o">+</span> <span class="n">A_knn</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">A_kfn</span> <span class="o">=</span> <span class="p">((</span><span class="n">A_kfn</span> <span class="o">+</span> <span class="n">A_kfn</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">A_knn</span><span class="p">,</span> <span class="n">A_kfn</span>


<span class="k">def</span> <span class="nf">get_knn_graph</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">symm_method</span> <span class="o">=</span> <span class="s1">&#39;OR&#39;</span><span class="p">,</span> <span class="n">get_kfn</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Given [n,p] data matrix, return kNN graph (or kFN graph)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : ndarray of shape [n,p]</span>
<span class="sd">        Design matrix</span>
<span class="sd">    n_neighbors : int</span>
<span class="sd">        Number of neighbors</span>
<span class="sd">    symm_method : {&#39;OR&#39;, &#39;AND&#39;} (default=&quot;OR&quot;)</span>
<span class="sd">        Symmetrization method (since kNN is not a symmetric relation).</span>
<span class="sd">        Logical &quot;AND&quot; or &quot;OR&quot;</span>
<span class="sd">    get_kfn : bool (default=False)</span>
<span class="sd">        Get k-&quot;farthest&quot;-neighbor graph (**added 02/11/2016**)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    S, L : ndarray of shape = [n,n]</span>
<span class="sd">        Similarity and Laplacian matrix, respectively.  For now, binary only.</span>

<span class="sd">    History</span>
<span class="sd">    -------</span>
<span class="sd">    Created 02/03/2016</span>

<span class="sd">    02/11/2016 - Added new argument ``get_kfn`` for k-farthest option.</span>
<span class="sd">    Also decided to use new function i created, ``make_graph_from_knn`` to</span>
<span class="sd">    construct S,L from knn index info (helps code modularity)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>

    <span class="c1">#--- get neighbor indices ----#</span>
    <span class="k">if</span> <span class="n">get_kfn</span><span class="p">:</span>
        <span class="c1"># note: abusive variable name</span>
        <span class="n">_</span><span class="p">,</span><span class="n">nbr_idx</span> <span class="o">=</span> <span class="n">get_knn_kfn</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">n_neighbors</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nbr_idx</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">get_knn_kfn</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">n_neighbors</span><span class="p">)</span>

    <span class="c1">#--- create binary similarity graph ----#</span>
    <span class="n">S</span><span class="p">,</span><span class="n">L</span> <span class="o">=</span> <span class="n">make_graph_from_knn</span><span class="p">(</span><span class="n">nbr_idx</span><span class="p">,</span><span class="n">symm_method</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">S</span><span class="p">,</span><span class="n">L</span>


<span class="k">def</span> <span class="nf">edm_checker</span><span class="p">(</span><span class="n">Xfeatures</span><span class="p">,</span><span class="n">S</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Can be handy for checking is kNN structure makes sense</span>

<span class="sd">    Created 02/03/2016.  See ``t_0203_gpnmf_trial1.py``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">rankdata</span>

    <span class="c1"># EDM vectorized</span>
    <span class="n">edm</span> <span class="o">=</span> <span class="n">tw</span><span class="o">.</span><span class="n">dvec</span><span class="p">(</span><span class="n">tw</span><span class="o">.</span><span class="n">get_EDM</span><span class="p">(</span><span class="n">Xfeatures</span><span class="p">))</span>

    <span class="c1"># study df_edm inside spyder&#39;s variable explorer.</span>
    <span class="c1"># (you&#39;ll see the &quot;top rank&quot; distances are usually &quot;is_neighbor&quot;)</span>
    <span class="n">df_edm_checker</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">edm</span><span class="p">,</span><span class="n">rankdata</span><span class="p">(</span><span class="n">edm</span><span class="p">),</span><span class="n">tw</span><span class="o">.</span><span class="n">dvec</span><span class="p">(</span><span class="n">S</span><span class="p">)],</span>
                           <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;dist&#39;</span><span class="p">,</span><span class="s1">&#39;rank&#39;</span><span class="p">,</span><span class="s1">&#39;is_neighbor&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="k">return</span> <span class="n">df_edm_checker</span>


<span class="k">def</span> <span class="nf">edm_checker_embedding</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">S</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Checker to see if &quot;similar&quot; sample nearby in embedded space</span>

<span class="sd">    X : ndarray of shape = [n_samples,n_features]</span>
<span class="sd">        Original feature</span>
<span class="sd">    H : ndarray of shape = [n_samples,n_reduced_features]</span>
<span class="sd">        Features embedded in lower dimensional space</span>
<span class="sd">    S : ndarray of shape = [n_samples,n_samples]</span>
<span class="sd">        Similarity matrix.  The nonzero locations indicates pairs where</span>
<span class="sd">        EDM values should be small in the embedded space.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    df_edm : dataframe with nchoosek(n_samples,2) rows (all possible pairs)</span>
<span class="sd">        Contains ranking info of EDM in original and embedded feature space.</span>
<span class="sd">        I used this to view in spyder&#39;s explorer as a check to see my</span>
<span class="sd">        graph regularizer is working.</span>

<span class="sd">    History</span>
<span class="sd">    -------</span>
<span class="sd">    Created 02/03/2016.  See ``t_0203_gpnmf_trial1.py``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">##%% ensure subjects that are indicated &quot;similar&quot; by S are indeed nearby in H</span>
    <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">rankdata</span>

    <span class="c1"># EDM in original space</span>
    <span class="n">edm_raw</span> <span class="o">=</span> <span class="n">tw</span><span class="o">.</span><span class="n">dvec</span><span class="p">(</span><span class="n">tw</span><span class="o">.</span><span class="n">get_EDM</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>

    <span class="c1"># EDM in new space</span>
    <span class="n">edm</span> <span class="o">=</span> <span class="n">tw</span><span class="o">.</span><span class="n">dvec</span><span class="p">(</span><span class="n">tw</span><span class="o">.</span><span class="n">get_EDM</span><span class="p">(</span><span class="n">H</span><span class="p">))</span>

    <span class="c1"># study df_edm inside spyder&#39;s variable explorer.</span>
    <span class="c1"># (you&#39;ll see the &quot;top rank&quot; distances are usually &quot;is_neighbor&quot;</span>
    <span class="n">df_edm</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">edm_raw</span><span class="p">,</span><span class="n">rankdata</span><span class="p">(</span><span class="n">edm_raw</span><span class="p">),</span><span class="n">edm</span><span class="p">,</span><span class="n">rankdata</span><span class="p">(</span><span class="n">edm</span><span class="p">),</span><span class="n">tw</span><span class="o">.</span><span class="n">dvec</span><span class="p">(</span><span class="n">S</span><span class="p">)],</span>
                           <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;dist_X&#39;</span><span class="p">,</span><span class="s1">&#39;rank_X&#39;</span><span class="p">,</span><span class="s1">&#39;dist_H&#39;</span><span class="p">,</span><span class="s1">&#39;rank_H&#39;</span><span class="p">,</span><span class="s1">&#39;is_neighbor&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="k">return</span> <span class="n">df_edm</span>


<span class="k">def</span> <span class="nf">get_knn_within_class</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">symm_method</span><span class="o">=</span><span class="s1">&#39;OR&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Get within-class k-nearest-neighbor.</span>

<span class="sd">    KNN structure with the restriction that the label of the data pair agree.</span>

<span class="sd">    X : ndarray of shape [n_samples,n_feaures]</span>
<span class="sd">        Data matrix</span>
<span class="sd">    y : label vector of shape [n_samples]</span>
<span class="sd">        Binary label vector</span>

<span class="sd">    History</span>
<span class="sd">    -------</span>
<span class="sd">    Created 02/03/2016 - see ``dev_0203_get_within_betweenclass_knn.py``</span>

<span class="sd">    Update 02/11/2016</span>

<span class="sd">    - replaced np.argsort with tw.argsort to handle &quot;ties&quot;</span>
<span class="sd">    - decided to use new function i created, ``make_graph_from_knn`` to</span>
<span class="sd">      construct S,L from knn index info (helps code modularity)</span>
<span class="sd">    - removed variable ``ranking`` inside code...it doesn&#39;t seem to do anything</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="c1"># set diagonal to large value to avoid self similarity (helps the sorting and ranking)</span>
    <span class="n">EDM</span> <span class="o">=</span> <span class="n">tw</span><span class="o">.</span><span class="n">get_EDM</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e10</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

    <span class="c1">#idx_rank = np.argsort(EDM,axis=1)</span>
    <span class="n">idx_rank</span> <span class="o">=</span> <span class="n">tw</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">EDM</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">knn_within</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">kth_nearest</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="c1"># candidate subject to compare</span>
            <span class="n">isub</span> <span class="o">=</span> <span class="n">idx_rank</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>

            <span class="c1"># if candidate subject label agrees, than add to knn</span>
            <span class="k">if</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">y</span><span class="p">[</span><span class="n">isub</span><span class="p">]:</span>
                <span class="n">knn_within</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">kth_nearest</span><span class="p">]</span> <span class="o">=</span> <span class="n">isub</span>

                <span class="c1"># now look for the &quot;next&quot; nearest neighbor</span>
                <span class="n">kth_nearest</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">kth_nearest</span> <span class="o">==</span> <span class="n">n_neighbors</span><span class="p">:</span> <span class="k">break</span>

    <span class="c1"># now we&#39;re ready to make knn graph matrices</span>
    <span class="n">S</span><span class="p">,</span><span class="n">L</span> <span class="o">=</span> <span class="n">make_graph_from_knn</span><span class="p">(</span><span class="n">knn_within</span><span class="p">,</span><span class="n">symm_method</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">S</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">knn_within</span>




<span class="k">def</span> <span class="nf">get_knn_between_class</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">symm_method</span><span class="o">=</span><span class="s1">&#39;OR&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Get between-class k-nearest-neighbor.</span>

<span class="sd">    KNN structure with the restriction that the label of the data pair disagree</span>

<span class="sd">    History</span>
<span class="sd">    -------</span>
<span class="sd">    Created 02/03/2016 - see ``dev_0203_get_within_betweenclass_knn.py``</span>

<span class="sd">    Update 02/11/2016</span>

<span class="sd">    - replaced np.argsort with tw.argsort to handle &quot;ties&quot;</span>
<span class="sd">    - decided to use new function i created, ``make_graph_from_knn`` to</span>
<span class="sd">      construct S,L from knn index info (helps code modularity)</span>
<span class="sd">    - removed variable ``ranking`` inside code...it doesn&#39;t seem to do anything</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="c1"># set diagonal to large value to avoid self similarity (helps the sorting and ranking)</span>
    <span class="n">EDM</span> <span class="o">=</span> <span class="n">tw</span><span class="o">.</span><span class="n">get_EDM</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e10</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

    <span class="c1">#idx_rank = np.argsort(EDM,axis=1)</span>
    <span class="n">idx_rank</span> <span class="o">=</span> <span class="n">tw</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">EDM</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">knn_between</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">kth_nearest</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="c1"># candidate subject to compare</span>
            <span class="n">isub</span> <span class="o">=</span> <span class="n">idx_rank</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>

            <span class="c1"># if candidate subject label disagrees, than add to knn</span>
            <span class="k">if</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">y</span><span class="p">[</span><span class="n">isub</span><span class="p">]:</span>
                <span class="n">knn_between</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">kth_nearest</span><span class="p">]</span> <span class="o">=</span> <span class="n">isub</span>

                <span class="c1"># now look for the &quot;next&quot; nearest neighbor</span>
                <span class="n">kth_nearest</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">kth_nearest</span> <span class="o">==</span> <span class="n">n_neighbors</span><span class="p">:</span> <span class="k">break</span>

    <span class="c1"># now we&#39;re ready to make knn graph matrices</span>
    <span class="n">S</span><span class="p">,</span><span class="n">L</span> <span class="o">=</span> <span class="n">make_graph_from_knn</span><span class="p">(</span><span class="n">knn_between</span><span class="p">,</span><span class="n">symm_method</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">S</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">knn_between</span>


<span class="k">def</span> <span class="nf">get_gose_graph_sorted_y</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">y</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Get GOSE/DRS knn-graph.</span>

<span class="sd">    For control subjects, all similarity will have zero values.</span>

<span class="sd">    Here assume y is sorted into blocks of TBI and HC.  This way it is easy</span>
<span class="sd">    to assign similarity matrix, as it&#39;ll have block diagonal structure.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : dataframe</span>
<span class="sd">        &gt;&gt;&gt; X,y,df = twio.get_tbi_connectomes(return_all_scores=True)</span>
<span class="sd">    y : array-like of shape = (n_subjects,)</span>
<span class="sd">        Vector of binary labels.  Must be sorted in blocks of +1 and -1</span>
<span class="sd">    n_neighbors : int</span>
<span class="sd">        Number of neighbors to select in kNN (ie, value of k)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    S, L : ndarray of shape = [n,n]</span>
<span class="sd">        Similarity and Laplacian matrix, respectively.  For now, binary only.</span>
<span class="sd">        S_{i,j} will be 1 if subjects i and j are both TBI, and the</span>
<span class="sd">        Euclidean distance in [GOSE,DRS] are among kNN.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="n">df_tbi</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;y_dx == +1&#39;</span><span class="p">)[[</span><span class="s1">&#39;GOSE&#39;</span><span class="p">,</span><span class="s1">&#39;DRS&#39;</span><span class="p">]]</span>
    <span class="n">S_tbi</span> <span class="o">=</span> <span class="n">get_knn_graph</span><span class="p">(</span><span class="n">df_tbi</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">n_neighbors</span><span class="o">=</span><span class="n">n_neighbors</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
    <span class="n">S</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span> <span class="n">df_tbi</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_tbi</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span> <span class="o">=</span> <span class="n">S_tbi</span>

    <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">-</span> <span class="n">S</span>
    <span class="k">return</span> <span class="n">S</span><span class="p">,</span> <span class="n">L</span>

<span class="k">def</span> <span class="nf">get_gose_graph</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Get GOSE/DRS knn-graph, where y can be shuffled in any arbitrary order.</span>

<span class="sd">    For control subjects, all similarity will have zero values.</span>

<span class="sd">    Here assume y is sorted into blocks of TBI and HC.  This way it is easy</span>
<span class="sd">    to assign similarity matrix, as it&#39;ll have block diagonal structure.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : dataframe</span>
<span class="sd">        &gt;&gt;&gt; X,y,df = twio.get_tbi_connectomes(return_all_scores=True)</span>
<span class="sd">    y : array-like of shape = (n_subjects,)</span>
<span class="sd">        Vector of binary labels</span>
<span class="sd">    n_neighbors : int</span>
<span class="sd">        Number of neighbors to select in kNN (ie, value of k)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    S, L : ndarray of shape = [n,n]</span>
<span class="sd">        Similarity and Laplacian matrix, respectively.  For now, binary only.</span>
<span class="sd">        S_{i,j} will be 1 if subjects i and j are both TBI, and the</span>
<span class="sd">        Euclidean distance in [GOSE,DRS] are among kNN.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#--- first sort TBI/HC subjects ---#</span>
    <span class="sd">&quot;&quot;&quot;numpy argsort will return index-order of &quot;ties&quot; in seemingly arbitrary</span>
<span class="sd">       order....i want the &quot;ties&quot; to be returned in the order of the original</span>
<span class="sd">       occurence (for example, if y[10],y[15],y[21] are tied, i want the</span>
<span class="sd">       idx_sort to give me (10,15,21), not random permutation of it.</span>
<span class="sd">       Use rankdata for this.</span>
<span class="sd">       http://stackoverflow.com/questions/14671013/</span>
<span class="sd">       ranking-of-numpy-array-with-possible-duplicates</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#idx_sort = np.argsort(y) #&lt;== don&#39;t do this!</span>
    <span class="n">idx_sort</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">rankdata</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="s1">&#39;ordinal&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
    <span class="n">rev_sort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">idx_sort</span><span class="p">)</span> <span class="c1"># &lt;- to &quot;undo&quot; sorting</span>
    <span class="c1">#http://stackoverflow.com/questions/2483696/undo-or-reverse-argsort-python</span>

    <span class="n">df_sort</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">idx_sort</span><span class="p">,:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">y_sort</span>  <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">idx_sort</span><span class="p">]</span>

    <span class="c1">#--- now we can use the &quot;sorted&quot; gose/drs graph construction ---#</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">get_gose_graph_sorted_y</span><span class="p">(</span><span class="n">df_sort</span><span class="p">,</span><span class="n">y_sort</span><span class="p">,</span><span class="n">n_neighbors</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># undo the sorting</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">rev_sort</span><span class="p">,</span><span class="n">rev_sort</span><span class="p">)]</span>

    <span class="c1"># Laplacian graph</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">-</span> <span class="n">S</span>
    <span class="k">return</span> <span class="n">S</span><span class="p">,</span><span class="n">L</span>



<span class="k">def</span> <span class="nf">get_subject_constrained_gose_knn</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">sanity_check</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Get gose/drs knn graph, with the constraint that if S_ij cannot be</span>
<span class="sd">    the same subject</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : dataframe</span>
<span class="sd">        &gt;&gt;&gt; X,y,df = twio.get_tbi_connectomes(return_all_scores=True)</span>
<span class="sd">    y : array-like of shape = (n_subjects,)</span>
<span class="sd">        Vector of binary labels</span>
<span class="sd">    n_neighbors : int</span>
<span class="sd">        Number of neighbors to select in kNN (ie, value of k)</span>
<span class="sd">    sanity_check : bool (default=False)</span>
<span class="sd">        Return extra &quot;sanity-check&quot; items</span>

<span class="sd">        &gt;&gt;&gt; # sanity_check = False</span>
<span class="sd">        &gt;&gt;&gt; knn_gose, knn_gose_subj = get_subject_constrained_gose_knn(df,y)</span>
<span class="sd">        &gt;&gt;&gt; # sanity_check = True</span>
<span class="sd">        &gt;&gt;&gt; knn_gose, knn_gose_subj,df_EDM,df_EDM_sorted,df_EDM_knn = ...</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    knn_gose : pd.DataFrame of of shape=(n_tbi,n_neibors)</span>
<span class="sd">        knn structure, where each row indicates a subject, and col-values</span>
<span class="sd">        contains integer indices of kNN for that subject.</span>
<span class="sd">    knn_gose_subj : pd.DataFrame of of shape=(n_tbi,n_neibors)</span>
<span class="sd">        Contains string of Subject_ID (good sanity check for myself that</span>
<span class="sd">        the same subject is not connected via knn)</span>

<span class="sd">    Extra returns if sanity_check is on</span>
<span class="sd">    -----------------------------------</span>
<span class="sd">    Bit tedious to explain in words....</span>
<span class="sd">    Run the snippet code above, and explore them in spyder variable explorer,</span>
<span class="sd">    and you&#39;ll get what i mean...</span>

<span class="sd">    History</span>
<span class="sd">    -------</span>
<span class="sd">    Created 02/11/2016 - see ``dev_0211_create_constrained_gose_graph.py``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">n_tbi</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="o">==+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">df_tbi</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;y_dx==1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">id_list</span> <span class="o">=</span> <span class="n">df_tbi</span><span class="p">[</span><span class="s1">&#39;Subject_ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="c1"># set diagonal to large value to avoid self similarity (helps the sorting and ranking)</span>
    <span class="n">EDM</span> <span class="o">=</span> <span class="n">tw</span><span class="o">.</span><span class="n">get_EDM</span><span class="p">(</span><span class="n">df_tbi</span><span class="p">[[</span><span class="s1">&#39;GOSE&#39;</span><span class="p">,</span><span class="s1">&#39;DRS&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e10</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n_tbi</span><span class="p">)</span>

    <span class="c1">#--- create subject constrained gose knn graph ---#</span>
    <span class="n">knn_gose</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_tbi</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">knn_gose_subj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_tbi</span><span class="p">,</span><span class="n">n_neighbors</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
    <span class="n">idx_rank</span> <span class="o">=</span> <span class="n">tw</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">EDM</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_tbi</span><span class="p">):</span>
        <span class="n">kth_nearest</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">id_i</span> <span class="o">=</span> <span class="n">id_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="c1"># candidate subject to compare</span>
            <span class="n">isub</span> <span class="o">=</span> <span class="n">idx_rank</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>

            <span class="c1"># if indices (i,j) are NOT the same subject, than add to knn</span>
            <span class="k">if</span> <span class="n">id_i</span> <span class="o">!=</span> <span class="n">id_list</span><span class="p">[</span><span class="n">isub</span><span class="p">]:</span>
                <span class="n">knn_gose</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">kth_nearest</span><span class="p">]</span> <span class="o">=</span> <span class="n">isub</span>
                <span class="c1">#knn_gose_subj[i,kth_nearest] = id_list[isub]</span>
                <span class="n">knn_gose_subj</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">kth_nearest</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_tbi</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="n">isub</span><span class="p">]</span>

                <span class="c1"># now look for the &quot;next&quot; nearest neighbor</span>
                <span class="n">kth_nearest</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">kth_nearest</span> <span class="o">==</span> <span class="n">n_neighbors</span><span class="p">:</span>
                    <span class="k">break</span>

    <span class="c1"># convert to dataframe so i can view in spyder variable explorer</span>
    <span class="n">knn_gose</span>      <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">knn_gose</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df_tbi</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">])</span>
    <span class="n">knn_gose_subj</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">knn_gose_subj</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df_tbi</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">sanity_check</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">knn_gose</span><span class="p">,</span> <span class="n">knn_gose_subj</span>

    <span class="c1">#---- for sanity check, get sorted EDM with distance and subject-id -----#</span>
    <span class="n">idx_sort</span> <span class="o">=</span> <span class="n">tw</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">EDM</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df_EDM_sorted</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">df_tbi</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">],</span><span class="n">columns</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">n_tbi</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_tbi</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_tbi</span><span class="p">):</span>
            <span class="n">_dist</span> <span class="o">=</span> <span class="n">EDM</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">idx_sort</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]]</span>
            <span class="n">_id</span>   <span class="o">=</span> <span class="n">df_tbi</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="n">idx_sort</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]]</span>
            <span class="n">df_EDM_sorted</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">_id</span><span class="p">,</span><span class="n">_dist</span><span class="p">)</span>

    <span class="c1">#--- now get constrained knn info, of distance and subject-id ---#</span>
    <span class="c1">#--- make sure no same-subject are not connected              ---#</span>
    <span class="n">df_EDM_knn</span><span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">df_tbi</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">n_neighbors</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_tbi</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_neighbors</span><span class="p">):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">knn_gose</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
            <span class="n">_dist</span> <span class="o">=</span> <span class="n">EDM</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">_id</span>   <span class="o">=</span> <span class="n">df_tbi</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">df_EDM_knn</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">_id</span><span class="p">,</span> <span class="n">_dist</span><span class="p">)</span>

    <span class="n">df_EDM</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">EDM</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">df_tbi</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">],</span><span class="n">columns</span><span class="o">=</span><span class="n">df_tbi</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">])</span>

    <span class="c1"># Tranpose makes it easier to view in spyder variable explorer</span>
    <span class="n">df_EDM_sorted</span> <span class="o">=</span> <span class="n">df_EDM_sorted</span><span class="o">.</span><span class="n">T</span>
    <span class="n">df_EDM_knn</span>    <span class="o">=</span> <span class="n">df_EDM_knn</span><span class="o">.</span><span class="n">T</span>

    <span class="k">return</span> <span class="n">knn_gose</span><span class="p">,</span> <span class="n">knn_gose_subj</span><span class="p">,</span><span class="n">df_EDM</span><span class="p">,</span><span class="n">df_EDM_sorted</span><span class="p">,</span><span class="n">df_EDM_knn</span>


<span class="k">def</span> <span class="nf">get_subject_constrained_gose_graph</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Get gose/drs knn graph, with the constraint that if S_ij cannot be</span>
<span class="sd">    the same subject</span>

<span class="sd">    Note that df and y can be permuted in any order, which is important</span>
<span class="sd">    when running cross-validation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : dataframe</span>
<span class="sd">        &gt;&gt;&gt; X,y,df = twio.get_tbi_connectomes(return_all_scores=True)</span>
<span class="sd">    y : array-like of shape = (n_subjects,)</span>
<span class="sd">        Vector of binary labels</span>
<span class="sd">    n_neighbors : int</span>
<span class="sd">        Number of neighbors to select in kNN (ie, value of k)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    S, L : ndarray of shape = [n,n]</span>
<span class="sd">        Similarity and Laplacian matrix, respectively.  For now, binary only.</span>
<span class="sd">        S_{i,j} will be 1 if subjects i and j are both TBI, and the</span>
<span class="sd">        Euclidean distance in [GOSE,DRS] are among kNN.</span>

<span class="sd">    History</span>
<span class="sd">    -------</span>
<span class="sd">    Created 02/11/2016 - see ``dev_0211_create_constrained_gose_graph.py``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="c1">#| note that since i&#39;m using rankdata.argsort(), all these sorting and</span>
    <span class="c1">#| revsorting will not do anything  if y are already sorted, which is</span>
    <span class="c1">#| nice since i don&#39;t have to create and maintain a separate function</span>
    <span class="n">idx_sort</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">rankdata</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="s1">&#39;ordinal&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
    <span class="n">rev_sort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">idx_sort</span><span class="p">)</span> <span class="c1"># &lt;- to &quot;undo&quot; sorting</span>
    <span class="c1">#http://stackoverflow.com/questions/2483696/undo-or-reverse-argsort-python</span>

    <span class="n">df_sort</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">idx_sort</span><span class="p">,:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">y_sort</span>  <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">idx_sort</span><span class="p">]</span>

    <span class="c1">#--- now we can use the &quot;sorted&quot; gose/drs graph construction ---#</span>
    <span class="n">knn_gose</span> <span class="o">=</span> <span class="n">get_subject_constrained_gose_knn</span><span class="p">(</span><span class="n">df_sort</span><span class="p">,</span><span class="n">y_sort</span><span class="p">,</span><span class="n">n_neighbors</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">S_tbi</span> <span class="o">=</span> <span class="n">make_graph_from_knn</span><span class="p">(</span><span class="n">knn_gose</span><span class="o">.</span><span class="n">values</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>

    <span class="c1"># thanks to the sorting, this S will have block diagonal structure</span>
    <span class="n">S</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span> <span class="n">y_sort</span><span class="o">==+</span><span class="mi">1</span><span class="p">,</span><span class="n">y_sort</span><span class="o">==+</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">S_tbi</span>

    <span class="c1">#==== undo the sorting ====#</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">rev_sort</span><span class="p">,</span><span class="n">rev_sort</span><span class="p">)]</span>

    <span class="c1"># Laplacian graph</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">-</span> <span class="n">S</span>
    <span class="k">return</span> <span class="n">S</span><span class="p">,</span><span class="n">L</span>


<span class="k">def</span> <span class="nf">get_gose_kfn</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Get gose/drs kfn graph.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : dataframe</span>
<span class="sd">        &gt;&gt;&gt; X,y,df = twio.get_tbi_connectomes(return_all_scores=True)</span>
<span class="sd">    y : array-like of shape = (n_subjects,)</span>
<span class="sd">        Vector of binary labels</span>
<span class="sd">    n_neighbors : int</span>
<span class="sd">        Number of neighbors to select in kFN (ie, value of k)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    kfn_gose : pd.DataFrame of of shape=(n_tbi,n_neibors)</span>
<span class="sd">        kfn structure, where each row indicates a subject, and col-values</span>
<span class="sd">        contains integer indices of kNN for that subject.</span>
<span class="sd">    kfn_gose_subj : pd.DataFrame of of shape=(n_tbi,n_neibors)</span>
<span class="sd">        Contains string of Subject_ID (good for sanity check with ``df_EDM``)</span>
<span class="sd">    df_EDM : pd.DataFrame of of shape=(n_neighbors,n_neighbors)</span>
<span class="sd">        Col/Index = subject id</span>

<span class="sd">    History</span>
<span class="sd">    -------</span>
<span class="sd">    Created 02/11/2016 - see ``dev_0211_create_kfn_gose_graph.py``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df_tbi</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;y_dx==1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">n_tbi</span> <span class="o">=</span> <span class="n">df_tbi</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1">##### set diagonal to large value to avoid self similarity (helps the sorting and ranking)</span>
    <span class="c1"># no, don&#39;t do this....i want the last n_neighbor columns to be the &quot;farthest&quot;</span>
    <span class="n">EDM</span> <span class="o">=</span> <span class="n">tw</span><span class="o">.</span><span class="n">get_EDM</span><span class="p">(</span><span class="n">df_tbi</span><span class="p">[[</span><span class="s1">&#39;GOSE&#39;</span><span class="p">,</span><span class="s1">&#39;DRS&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="c1"># + 1e10*np.eye(n_tbi)</span>

    <span class="c1">#--- create subject constrained gose knn graph ---#</span>
    <span class="n">kfn_gose</span> <span class="o">=</span> <span class="n">get_kfn</span><span class="p">(</span><span class="n">df_tbi</span><span class="p">[[</span><span class="s1">&#39;GOSE&#39;</span><span class="p">,</span><span class="s1">&#39;DRS&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">n_neighbors</span><span class="p">)</span>
    <span class="n">kfn_gose</span> <span class="o">=</span> <span class="n">kfn_gose</span><span class="p">[:,::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># reverse sort so &quot;farthest&quot; appears in the first column</span>
    <span class="n">kfn_gose_subj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_tbi</span><span class="p">,</span><span class="n">n_neighbors</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_tbi</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_neighbors</span><span class="p">):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">kfn_gose</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
            <span class="n">kfn_gose_subj</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_tbi</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="n">idx</span><span class="p">]</span>

    <span class="c1"># convert to dataframe so i can view in spyder variable explorer</span>
    <span class="n">kfn_gose</span>      <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">kfn_gose</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df_tbi</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">])</span>
    <span class="n">kfn_gose_subj</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">kfn_gose_subj</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df_tbi</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="n">df_EDM</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">EDM</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">df_tbi</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">],</span><span class="n">columns</span><span class="o">=</span><span class="n">df_tbi</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">])</span>
    <span class="n">EDM</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">EDM</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">kfn_gose</span><span class="p">,</span><span class="n">kfn_gose_subj</span><span class="p">,</span><span class="n">df_EDM</span><span class="p">,</span> <span class="n">EDM</span>


<span class="k">def</span> <span class="nf">get_gose_graph_kfn</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Get gose/drs kfn graph</span>

<span class="sd">    Note that df and y can be permuted in any order, which is important</span>
<span class="sd">    when running cross-validation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : dataframe</span>
<span class="sd">        &gt;&gt;&gt; X,y,df = twio.get_tbi_connectomes(return_all_scores=True)</span>
<span class="sd">    y : array-like of shape = (n_subjects,)</span>
<span class="sd">        Vector of binary labels</span>
<span class="sd">    n_neighbors : int</span>
<span class="sd">        Number of neighbors to select in kFN (ie, value of k)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    S, L : ndarray of shape = [n,n]</span>
<span class="sd">        Similarity and Laplacian matrix, respectively.  For now, binary only.</span>
<span class="sd">        S_{i,j} will be 1 if subjects i and j are both TBI, and the</span>
<span class="sd">        Euclidean distance in [GOSE,DRS] are among kFN.</span>

<span class="sd">    TODO</span>
<span class="sd">    -----</span>
<span class="sd">    HUGE overlap with ``get_subject_constrained_gose_graph``....the crux is</span>
<span class="sd">    sorting tbi subjects into cluster, than inverse sorting.  Try to merge</span>
<span class="sd">    two functions together if I find i may need to create another variant</span>
<span class="sd">    of this idea.</span>

<span class="sd">    History</span>
<span class="sd">    -------</span>
<span class="sd">    Created 02/11/2016 - see ``dev_0211_create_kfn_gose_graph.py``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="c1">#| note that since i&#39;m using rankdata.argsort(), all these sorting and</span>
    <span class="c1">#| revsorting will not do anything  if y are already sorted, which is</span>
    <span class="c1">#| nice since i don&#39;t have to create and maintain a separate function</span>
    <span class="n">idx_sort</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">rankdata</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="s1">&#39;ordinal&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
    <span class="n">rev_sort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">idx_sort</span><span class="p">)</span> <span class="c1"># &lt;- to &quot;undo&quot; sorting</span>
    <span class="c1">#http://stackoverflow.com/questions/2483696/undo-or-reverse-argsort-python</span>

    <span class="n">df_sort</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">idx_sort</span><span class="p">,:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">y_sort</span>  <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">idx_sort</span><span class="p">]</span>

    <span class="c1">#--- now we can use the &quot;sorted&quot; gose/drs graph construction ---#</span>
    <span class="n">kfn_gose</span> <span class="o">=</span> <span class="n">get_gose_kfn</span><span class="p">(</span><span class="n">df_sort</span><span class="p">,</span><span class="n">n_neighbors</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">S_tbi</span> <span class="o">=</span> <span class="n">make_graph_from_knn</span><span class="p">(</span><span class="n">kfn_gose</span><span class="o">.</span><span class="n">values</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>

    <span class="c1"># thanks to the sorting, this S will have block diagonal structure</span>
    <span class="n">S</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span> <span class="n">y_sort</span><span class="o">==+</span><span class="mi">1</span><span class="p">,</span><span class="n">y_sort</span><span class="o">==+</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">S_tbi</span>

    <span class="c1">#==== undo the sorting ====#</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">rev_sort</span><span class="p">,</span><span class="n">rev_sort</span><span class="p">)]</span>

    <span class="c1"># Laplacian graph</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">-</span> <span class="n">S</span>
    <span class="k">return</span> <span class="n">S</span><span class="p">,</span><span class="n">L</span>
<span class="c1">#%%----</span>

<span class="k">def</span> <span class="nf">normalize_W</span><span class="p">(</span><span class="n">W</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Normalize the columns of W to unit norm</span>

<span class="sd">    W : ndarray of shape [p,r]</span>
<span class="sd">        Typically the basis matrix returned from NMF</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Wnorm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">scipy.linalg</span> <span class="kn">import</span> <span class="n">norm</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">Wnorm</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">W</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">[:,</span><span class="n">i</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">Wnorm</span>


<span class="k">def</span> <span class="nf">disp_corrW</span><span class="p">(</span><span class="n">W</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Display correlation matrix of basis matrix W returned from NMF</span>

<span class="sd">    Useful to see how &quot;orthogonal&quot; the learnt basis are.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Wnorm</span> <span class="o">=</span> <span class="n">normalize_W</span><span class="p">(</span><span class="n">W</span><span class="p">)</span>

    <span class="n">tw</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">131</span><span class="p">),</span><span class="n">tw</span><span class="o">.</span><span class="n">imtak</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="p">)),</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">132</span><span class="p">),</span><span class="n">tw</span><span class="o">.</span><span class="n">imtak</span><span class="p">(</span><span class="n">Wnorm</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Wnorm</span><span class="p">)),</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gci</span><span class="p">()</span><span class="o">.</span><span class="n">set_clim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">133</span><span class="p">),</span><span class="n">tw</span><span class="o">.</span><span class="n">imtak</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">)),</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gci</span><span class="p">()</span><span class="o">.</span><span class="n">set_clim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="c1">#    plt.colorbar()</span>


<span class="c1">#%% **** FAILURES ****</span>
<span class="k">def</span> <span class="nf">hinge_pnmf_admm</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">rho</span><span class="o">=</span><span class="mf">1e2</span><span class="p">,</span><span class="n">lam</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">,</span><span class="n">gam</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">,</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
                    <span class="n">W_init</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">disp_freq</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span><span class="n">silence</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Supervised Projective NMF with hinge-loss (solved via ADMM)</span>

<span class="sd">    &gt;&gt;&gt; W,P,H,w,Wtil,Ptil,wtil,cost,res = pnmf_admm(X,y,r=10,rho=1e2)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : ndarray of shape =[n_features, n_samples]=[p,n]</span>
<span class="sd">        Data matrix with columns as data points</span>
<span class="sd">    y : array-like, shape = [n_samples]</span>
<span class="sd">        Binary Target vector relative to X (must be +/- 1)</span>
<span class="sd">    r : int</span>
<span class="sd">        Dimension of the embedding space (n_components)</span>
<span class="sd">    lam : float</span>
<span class="sd">        Regularization parameter (amount of emphasis on hinge-loss)</span>
<span class="sd">    gam : float</span>
<span class="sd">        Regularization parameter (classification regularizer)</span>
<span class="sd">    rho : float</span>
<span class="sd">        Augmented Lagrangian parameter</span>
<span class="sd">    max_iter : int</span>
<span class="sd">        max number of iterations</span>
<span class="sd">    tol : float</span>
<span class="sd">        convergence tolerance (on relative change in objective value and</span>
<span class="sd">        all primal residuals)</span>
<span class="sd">    W_init : None (default), rng, or &#39;nndsvd&#39;</span>
<span class="sd">        Way to initialize W (and H).  If ``None`` or ``RandomState object``</span>
<span class="sd">        is supplied, both W and H will be initialized via non-negative</span>
<span class="sd">        random number.  If ``&#39;nndsvd&#39;``, will use deterministic initialization</span>
<span class="sd">        NNDSVD &quot;Non-Negative Double Singular Value Decomposition&quot;, proposed by</span>
<span class="sd">        Boutsidis2008.</span>
<span class="sd">    disp_freq : int</span>
<span class="sd">        Frequency of update display (in iterations)</span>
<span class="sd">    silence : bool</span>
<span class="sd">        If True, don&#39;t print-out convergence detail at the end.</span>

<span class="sd">    Update history</span>
<span class="sd">    --------------</span>
<span class="sd">    **Created 02/02/2016**</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">lam</span> <span class="o">*=</span> <span class="mf">1.</span> <span class="c1"># ensure float</span>
    <span class="n">gam</span> <span class="o">*=</span> <span class="mf">1.</span> <span class="c1"># ensure float</span>
    <span class="c1">#%%=== initialize variables =====</span>
    <span class="c1"># define main primal variable W (basis matrix)</span>
    <span class="k">if</span> <span class="n">W_init</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">W_init</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">):</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">W_init</span>

        <span class="n">W</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">W_init</span> <span class="o">==</span> <span class="s1">&#39;nndsvd&#39;</span><span class="p">:</span>
<span class="c1">#        W = nnd_svd(X,r)</span>
        <span class="n">W</span><span class="p">,</span><span class="n">H</span> <span class="o">=</span> <span class="n">nnd_svd</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">get_H</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid input for &quot;W_init&quot;&#39;</span><span class="p">)</span>

    <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">p</span><span class="p">))</span>
<span class="c1">#    P = np.random.rand(r,p)</span>

    <span class="c1"># classification weight vector</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="c1"># aux. variables</span>
    <span class="n">Wtil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Ptil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">wtil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

    <span class="c1"># dual variables</span>
    <span class="n">Lam_W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">d_w</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

<span class="c1">#    Y = np.diag(y)</span>
    <span class="c1">#%%=== create empty lists for tracking updates ===</span>
    <span class="c1"># keep track of frobenius norm loss</span>
    <span class="n">cost_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cost_recon_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cost_supervised_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1">#    cost = norm(Wtil.dot(Ptil.dot(X)) - X,&#39;fro&#39;)**2/2 + \</span>
<span class="c1">#           lam*np.maximum(0, 1-y*dot(H.T,w)).sum() + norm(gam)**2/2</span>
<span class="c1">#    cost = norm( X - dot(W,P.dot(X)), &#39;fro&#39;)**2/2</span>

    <span class="n">cost_recon</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">Wtil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ptil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">))</span> <span class="o">-</span> <span class="n">X</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">cost_recon_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_recon</span><span class="p">)</span>

    <span class="n">cost_supervised</span> <span class="o">=</span> <span class="n">lam</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">y</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">w</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="n">norm</span><span class="p">(</span><span class="n">gam</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">cost_supervised_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_supervised</span><span class="p">)</span>

    <span class="n">cost</span> <span class="o">=</span> <span class="n">cost_recon</span> <span class="o">+</span> <span class="n">cost_supervised</span>
    <span class="n">cost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>

    <span class="c1"># relative change in cost</span>
    <span class="n">diffcost</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># precompute term needed for inversion lemma</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">X</span><span class="p">),</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="c1"># keep track of relative primal residual</span>
    <span class="n">res_W</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_P</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_H</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_w</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># also keep track of diffW</span>
<span class="c1">#    diffW = []</span>
    <span class="c1">#%%=== run admm iterations ===</span>
    <span class="n">eye_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="c1"># precompute term needed for inversion lemma</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">X</span><span class="p">),</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="n">rho_W</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="mi">50000000</span>

    <span class="n">start</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iter</span><span class="p">):</span>
<span class="c1">#        rho = min(1e6, rho*1.0001)</span>
<span class="c1">#        W_old = W #&lt;- to keep track of diffW</span>

        <span class="c1">#================ primal updates (P, W, H, Ptil, Wtil) ===============#</span>
        <span class="c1"># update for P involves inversion lemma...</span>


        <span class="c1"># (W,H) updates</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">+</span><span class="n">rho_W</span><span class="o">*</span><span class="n">eye_r</span><span class="p">,</span> <span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho_W</span><span class="o">*</span><span class="n">Wtil</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">Lam_W</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Wtil</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span><span class="o">+</span><span class="n">Lam_W</span><span class="o">/</span><span class="n">rho_W</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">W</span><span class="p">)</span><span class="o">+</span><span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">eye_r</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">w</span><span class="p">)),</span>
                  <span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span> <span class="o">-</span> <span class="n">Lam_H</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">(</span><span class="n">d_w</span><span class="o">*</span><span class="n">y</span><span class="p">))</span> <span class="o">+</span>
                  <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">X</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">(</span><span class="n">wtil</span><span class="o">*</span><span class="n">y</span><span class="p">)))</span> <span class="p">)</span>

        <span class="n">_R</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Lam_H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">/</span><span class="n">rho</span> <span class="o">-</span> <span class="n">Lam_P</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">rho</span> <span class="o">+</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">Ptil</span><span class="o">.</span><span class="n">T</span>
        <span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="n">_R</span> <span class="o">-</span> <span class="n">X</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">dot</span><span class="p">(</span><span class="n">K</span><span class="p">,</span><span class="n">_R</span><span class="p">)</span> <span class="p">))</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Ptil</span> <span class="o">=</span> <span class="p">(</span><span class="n">P</span><span class="o">+</span><span class="n">Lam_P</span><span class="o">/</span><span class="n">rho</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># (w,wtil) updates</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span> <span class="n">H</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">gam</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="n">H</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="o">-</span><span class="n">y</span><span class="o">*</span><span class="n">d_w</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">wtil</span><span class="p">)</span> <span class="p">)</span> <span class="o">/</span> <span class="n">rho</span>
        <span class="n">wtil</span> <span class="o">=</span> <span class="n">prox_hinge</span><span class="p">(</span> <span class="n">y</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> <span class="o">+</span> <span class="n">d_w</span><span class="o">/</span><span class="n">rho</span><span class="p">,</span> <span class="n">lam</span><span class="o">/</span><span class="n">rho</span> <span class="p">)</span>

        <span class="c1">#====================== dual updates =================================#</span>
        <span class="n">Lam_W</span> <span class="o">=</span> <span class="n">Lam_W</span> <span class="o">+</span> <span class="n">rho_W</span><span class="o">*</span><span class="p">(</span><span class="n">W</span> <span class="o">-</span> <span class="n">Wtil</span><span class="p">)</span>
        <span class="n">Lam_P</span> <span class="o">=</span> <span class="n">Lam_P</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">P</span> <span class="o">-</span> <span class="n">Ptil</span><span class="p">)</span>
        <span class="n">Lam_H</span> <span class="o">=</span> <span class="n">Lam_H</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">H</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">X</span><span class="p">))</span>
        <span class="n">d_w</span> <span class="o">=</span> <span class="n">d_w</span> <span class="o">-</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">wtil</span> <span class="o">-</span> <span class="n">y</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">w</span><span class="p">))</span>

        <span class="c1">#============ comptute objective values ==============================#</span>
        <span class="c1"># main loss function</span>
        <span class="n">cost_recon</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">Wtil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ptil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">))</span> <span class="o">-</span> <span class="n">X</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">cost_recon_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_recon</span><span class="p">)</span>

        <span class="n">cost_supervised</span> <span class="o">=</span> <span class="n">lam</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">y</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="o">-</span><span class="n">w</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="n">norm</span><span class="p">(</span><span class="n">gam</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">cost_supervised_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_supervised</span><span class="p">)</span>

        <span class="n">cost</span> <span class="o">=</span> <span class="n">cost_recon</span> <span class="o">+</span> <span class="n">cost_supervised</span>
        <span class="n">cost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>

        <span class="c1"># relative change in cost</span>
        <span class="n">diffcost</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span><span class="o">/</span><span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>

        <span class="c1"># relative primal residuals</span>
        <span class="n">res_W</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="o">-</span><span class="n">Wtil</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="n">res_P</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">P</span><span class="o">-</span><span class="n">Ptil</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="n">res_H</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="o">-</span><span class="n">P</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">),</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
<span class="c1">#        res_w.append(norm(wtil - y*dot(H.T,w))/norm(wtil))</span>
        <span class="n">res_w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># relative change in basis matrix</span>
<span class="c1">#        diffW.append( norm(W-W_old,&#39;fro&#39;)/ norm(W_old, &#39;fro&#39;) )</span>

        <span class="c1">#=== termination check ====#</span>
        <span class="n">check_exit</span>  <span class="o">=</span> <span class="p">(</span><span class="n">diffcost</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_W</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_P</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_H</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_w</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">check_exit</span> <span class="ow">and</span> <span class="nb">iter</span> <span class="o">&gt;</span> <span class="mi">300</span><span class="p">:</span> <span class="c1"># allow 300 iterations of &quot;burn-in&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silence</span><span class="p">:</span>
                <span class="k">print</span> <span class="s2">&quot;Termination condition met.  Exit at iter =&quot;</span><span class="p">,</span><span class="nb">iter</span><span class="p">,</span>
            <span class="k">break</span>
        <span class="c1">#=============== print current progress ==============================#</span>
<span class="c1">#        if iter % disp_freq == 0:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">iter</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">iter</span> <span class="o">%</span> <span class="n">disp_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="c1">#            print rho,</span>
<span class="c1">#            rho = min(1e6, rho*1.05)</span>
<span class="c1">#            str_ = &quot;iter={:4} cost={:3.3f}&quot;.format(iter,cost_list[iter+1])</span>
            <span class="n">str_</span> <span class="o">=</span> <span class="s2">&quot;iter={:4} cost={:6.5e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">iter</span><span class="p">,</span><span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; costU={:6.5e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cost_recon_list</span><span class="p">[</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; costS={:6.5e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cost_supervised_list</span><span class="p">[</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; diffcost={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">diffcost</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; W={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_W</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; P={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_P</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; H={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_H</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; w={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_w</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
<span class="c1">#            str_ += &quot; diffW={:3.2e}&quot;.format(diffW[iter])</span>
            <span class="k">print</span> <span class="n">str_</span> <span class="o">+</span> <span class="s2">&quot; ({:3.1f} sec)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>
    <span class="c1">#%%---- end of admm for loop ---------------------------------------------#</span>
    <span class="n">cost_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cost_list</span><span class="p">)</span>

    <span class="c1"># convert residual in pandas dataframe</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">res_W</span><span class="p">,</span><span class="n">res_P</span><span class="p">,</span><span class="n">res_H</span><span class="p">,</span><span class="n">res_w</span><span class="p">,</span><span class="n">diffcost</span><span class="p">],</span>
                       <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;res_W&#39;</span><span class="p">,</span><span class="s1">&#39;res_P&#39;</span><span class="p">,</span><span class="s1">&#39;res_H&#39;</span><span class="p">,</span><span class="s1">&#39;res_w&#39;</span><span class="p">,</span><span class="s1">&#39;diffcost&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">silence</span><span class="p">:</span> <span class="n">print_time</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">W</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">Wtil</span><span class="p">,</span><span class="n">Ptil</span><span class="p">,</span><span class="n">cost_list</span><span class="p">,</span><span class="n">res</span>


<span class="k">def</span> <span class="nf">hinge_spnmf_admm</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">rho</span><span class="o">=</span><span class="mf">1e2</span><span class="p">,</span><span class="n">lam</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">,</span><span class="n">gam</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">,</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
                    <span class="n">W_init</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">disp_freq</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span><span class="n">silence</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Supervised Projective NMF with hinge-loss (solved via ADMM)</span>

<span class="sd">    &gt;&gt;&gt; W,P,H,w,Wtil,Ptil,wtil,cost,res = pnmf_admm(X,y,r=10,rho=1e2)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : ndarray of shape =[n_features, n_samples]=[p,n]</span>
<span class="sd">        Data matrix with columns as data points</span>
<span class="sd">    y : array-like, shape = [n_samples]</span>
<span class="sd">        Binary Target vector relative to X (must be +/- 1)</span>
<span class="sd">    r : int</span>
<span class="sd">        Dimension of the embedding space (n_components)</span>
<span class="sd">    lam : float</span>
<span class="sd">        Regularization parameter (amount of emphasis on hinge-loss)</span>
<span class="sd">    gam : float</span>
<span class="sd">        Regularization parameter (classification regularizer)</span>
<span class="sd">    rho : float</span>
<span class="sd">        Augmented Lagrangian parameter</span>
<span class="sd">    max_iter : int</span>
<span class="sd">        max number of iterations</span>
<span class="sd">    tol : float</span>
<span class="sd">        convergence tolerance (on relative change in objective value and</span>
<span class="sd">        all primal residuals)</span>
<span class="sd">    W_init : None (default), rng, or &#39;nndsvd&#39;</span>
<span class="sd">        Way to initialize W (and H).  If ``None`` or ``RandomState object``</span>
<span class="sd">        is supplied, both W and H will be initialized via non-negative</span>
<span class="sd">        random number.  If ``&#39;nndsvd&#39;``, will use deterministic initialization</span>
<span class="sd">        NNDSVD &quot;Non-Negative Double Singular Value Decomposition&quot;, proposed by</span>
<span class="sd">        Boutsidis2008.</span>
<span class="sd">    disp_freq : int</span>
<span class="sd">        Frequency of update display (in iterations)</span>
<span class="sd">    silence : bool</span>
<span class="sd">        If True, don&#39;t print-out convergence detail at the end.</span>

<span class="sd">    Update history</span>
<span class="sd">    --------------</span>
<span class="sd">    **Created 02/02/2016**</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">lam</span> <span class="o">*=</span> <span class="mf">1.</span> <span class="c1"># ensure float</span>
    <span class="n">gam</span> <span class="o">*=</span> <span class="mf">1.</span> <span class="c1"># ensure float</span>
    <span class="c1">#%%=== initialize variables =====</span>
    <span class="c1"># define main primal variable W (basis matrix)</span>
    <span class="k">if</span> <span class="n">W_init</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">W_init</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">):</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">W_init</span>

        <span class="n">W</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">W_init</span> <span class="o">==</span> <span class="s1">&#39;nndsvd&#39;</span><span class="p">:</span>
<span class="c1">#        W = nnd_svd(X,r)</span>
        <span class="n">W</span><span class="p">,</span><span class="n">H</span> <span class="o">=</span> <span class="n">nnd_svd</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">get_H</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid input for &quot;W_init&quot;&#39;</span><span class="p">)</span>

<span class="c1">#    P = np.zeros((r,p))</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>

    <span class="c1"># classification weight vector</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="c1"># aux. variables</span>
    <span class="n">Wtil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">W2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Ptil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">wtil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">wtil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

    <span class="c1"># dual variables</span>
    <span class="n">Lam_W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_W2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">d_w</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

<span class="c1">#    Y = np.diag(y)</span>
    <span class="c1">#%%=== create empty lists for tracking updates ===</span>
    <span class="c1"># keep track of frobenius norm loss</span>
    <span class="n">cost_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cost_recon_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cost_supervised_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1">#    cost = norm(Wtil.dot(Ptil.dot(X)) - X,&#39;fro&#39;)**2/2 + \</span>
<span class="c1">#           lam*np.maximum(0, 1-y*dot(H.T,w)).sum() + norm(gam)**2/2</span>
<span class="c1">#    cost = norm( X - dot(W,P.dot(X)), &#39;fro&#39;)**2/2</span>

    <span class="n">cost_recon</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">Wtil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ptil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">))</span> <span class="o">-</span> <span class="n">X</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">cost_recon_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_recon</span><span class="p">)</span>

    <span class="n">cost_supervised</span> <span class="o">=</span> <span class="n">lam</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">y</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">w</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="n">norm</span><span class="p">(</span><span class="n">gam</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">cost_supervised_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_supervised</span><span class="p">)</span>

    <span class="n">cost</span> <span class="o">=</span> <span class="n">cost_recon</span> <span class="o">+</span> <span class="n">cost_supervised</span>
    <span class="n">cost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>

    <span class="c1"># relative change in cost</span>
    <span class="n">diffcost</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># keep track of relative primal residual</span>
    <span class="n">res_W</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_W2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_P</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_H</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_w</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># also keep track of diffW</span>
<span class="c1">#    diffW = []</span>
    <span class="c1">#%%=== run admm iterations ===</span>
    <span class="n">eye_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="c1"># precompute term needed for inversion lemma</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">X</span><span class="p">),</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">rho_W</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="mf">5e5</span>
    <span class="n">rho_W2</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="mf">5e5</span>
    <span class="n">start</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iter</span><span class="p">):</span>
<span class="c1">#        rho = min(1e6, rho*1.0001)</span>
<span class="c1">#        W_old = W #&lt;- to keep track of diffW</span>
        <span class="c1"># (W,H) updates</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">rho_W</span><span class="o">+</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="n">eye_r</span><span class="p">,</span>
                  <span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho_W</span><span class="o">*</span><span class="n">Wtil</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">Lam_W</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">Lam_W2</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">W2</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Wtil</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span><span class="o">+</span><span class="n">Lam_W</span><span class="o">/</span><span class="n">rho_W</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1">#================ primal updates (P, W, H, Ptil, Wtil) ===============#</span>
        <span class="c1"># update for P involves inversion lemma...</span>
        <span class="n">_R</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Lam_H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">/</span><span class="n">rho</span> <span class="o">-</span> <span class="n">Lam_P</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">rho</span> <span class="o">+</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">Ptil</span><span class="o">.</span><span class="n">T</span>
        <span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="n">_R</span> <span class="o">-</span> <span class="n">X</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">dot</span><span class="p">(</span><span class="n">K</span><span class="p">,</span><span class="n">_R</span><span class="p">)</span> <span class="p">))</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Ptil</span> <span class="o">=</span> <span class="p">(</span><span class="n">P</span><span class="o">+</span><span class="n">Lam_P</span><span class="o">/</span><span class="n">rho</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>


        <span class="n">W2</span> <span class="o">=</span> <span class="n">projection_spectral</span><span class="p">(</span><span class="n">W</span><span class="o">+</span><span class="n">Lam_W2</span><span class="o">/</span><span class="n">rho</span><span class="p">)</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">W</span><span class="p">)</span><span class="o">+</span><span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">eye_r</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">w</span><span class="p">)),</span>
                  <span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span> <span class="o">-</span> <span class="n">Lam_H</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">(</span><span class="n">d_w</span><span class="o">*</span><span class="n">y</span><span class="p">))</span> <span class="o">+</span>
                  <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">X</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">(</span><span class="n">wtil</span><span class="o">*</span><span class="n">y</span><span class="p">)))</span> <span class="p">)</span>

        <span class="c1"># (w,wtil) updates</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span> <span class="n">H</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">gam</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="n">H</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="o">-</span><span class="n">y</span><span class="o">*</span><span class="n">d_w</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">wtil</span><span class="p">)</span> <span class="p">)</span> <span class="o">/</span> <span class="n">rho</span>
        <span class="n">wtil</span> <span class="o">=</span> <span class="n">prox_hinge</span><span class="p">(</span> <span class="n">y</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> <span class="o">+</span> <span class="n">d_w</span><span class="o">/</span><span class="n">rho</span><span class="p">,</span> <span class="n">lam</span><span class="o">/</span><span class="n">rho</span> <span class="p">)</span>

        <span class="c1">#====================== dual updates =================================#</span>
        <span class="n">Lam_W</span> <span class="o">=</span> <span class="n">Lam_W</span> <span class="o">+</span> <span class="n">rho_W</span><span class="o">*</span><span class="p">(</span><span class="n">W</span> <span class="o">-</span> <span class="n">Wtil</span><span class="p">)</span>
        <span class="n">Lam_W2</span> <span class="o">=</span> <span class="n">Lam_W2</span> <span class="o">-</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">W</span> <span class="o">-</span> <span class="n">W2</span><span class="p">)</span>
        <span class="n">Lam_P</span> <span class="o">=</span> <span class="n">Lam_P</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">P</span> <span class="o">-</span> <span class="n">Ptil</span><span class="p">)</span>
        <span class="n">Lam_H</span> <span class="o">=</span> <span class="n">Lam_H</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">H</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">X</span><span class="p">))</span>
        <span class="n">d_w</span> <span class="o">=</span> <span class="n">d_w</span> <span class="o">-</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">wtil</span> <span class="o">-</span> <span class="n">y</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">w</span><span class="p">))</span>

        <span class="c1">#============ comptute objective values ==============================#</span>
        <span class="c1"># main loss function</span>
        <span class="n">cost_recon</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">Wtil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ptil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">))</span> <span class="o">-</span> <span class="n">X</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">cost_recon_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_recon</span><span class="p">)</span>

        <span class="n">cost_supervised</span> <span class="o">=</span> <span class="n">lam</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">y</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="o">-</span><span class="n">w</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="n">norm</span><span class="p">(</span><span class="n">gam</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">cost_supervised_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_supervised</span><span class="p">)</span>

        <span class="n">cost</span> <span class="o">=</span> <span class="n">cost_recon</span> <span class="o">+</span> <span class="n">cost_supervised</span>
        <span class="n">cost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>

        <span class="c1"># relative change in cost</span>
        <span class="n">diffcost</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span><span class="o">/</span><span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>

        <span class="c1"># relative primal residuals</span>
        <span class="n">res_W</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="o">-</span><span class="n">Wtil</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="n">res_W2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">W2</span><span class="o">-</span><span class="n">Wtil</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="n">res_P</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">P</span><span class="o">-</span><span class="n">Ptil</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="n">res_H</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="o">-</span><span class="n">P</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">),</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="n">res_w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">wtil</span> <span class="o">-</span> <span class="n">y</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">w</span><span class="p">))</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">wtil</span><span class="p">))</span>
<span class="c1">#        res_w.append(0)</span>

        <span class="c1"># relative change in basis matrix</span>
<span class="c1">#        diffW.append( norm(W-W_old,&#39;fro&#39;)/ norm(W_old, &#39;fro&#39;) )</span>

        <span class="c1">#=== termination check ====#</span>
        <span class="n">check_exit</span>  <span class="o">=</span> <span class="p">(</span><span class="n">diffcost</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_W</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_P</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_H</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">res_w</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">tol</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">check_exit</span> <span class="ow">and</span> <span class="nb">iter</span> <span class="o">&gt;</span> <span class="mi">300</span><span class="p">:</span> <span class="c1"># allow 300 iterations of &quot;burn-in&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silence</span><span class="p">:</span>
                <span class="k">print</span> <span class="s2">&quot;Termination condition met.  Exit at iter =&quot;</span><span class="p">,</span><span class="nb">iter</span><span class="p">,</span>
            <span class="k">break</span>
        <span class="c1">#=============== print current progress ==============================#</span>
<span class="c1">#        if iter % disp_freq == 0:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">iter</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">iter</span> <span class="o">%</span> <span class="n">disp_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="c1">#            print rho,</span>
<span class="c1">#            rho = min(1e6, rho*1.05)</span>
<span class="c1">#            str_ = &quot;iter={:4} cost={:3.3f}&quot;.format(iter,cost_list[iter+1])</span>
            <span class="n">str_</span> <span class="o">=</span> <span class="s2">&quot;iter={:4} cost={:6.5e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">iter</span><span class="p">,</span><span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; costU={:6.5e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cost_recon_list</span><span class="p">[</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; costS={:6.5e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cost_supervised_list</span><span class="p">[</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; diffcost={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">diffcost</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; W={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_W</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; W2={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_W2</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; P={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_P</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; H={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_H</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; w={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_w</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
<span class="c1">#            str_ += &quot; diffW={:3.2e}&quot;.format(diffW[iter])</span>
            <span class="k">print</span> <span class="n">str_</span> <span class="o">+</span> <span class="s2">&quot; ({:3.1f} sec)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>
    <span class="c1">#%%---- end of admm for loop ---------------------------------------------#</span>
    <span class="n">cost_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cost_list</span><span class="p">)</span>

    <span class="c1"># convert residual in pandas dataframe</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">res_W</span><span class="p">,</span><span class="n">res_P</span><span class="p">,</span><span class="n">res_H</span><span class="p">,</span><span class="n">res_w</span><span class="p">,</span><span class="n">diffcost</span><span class="p">],</span>
                       <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;res_W&#39;</span><span class="p">,</span><span class="s1">&#39;res_P&#39;</span><span class="p">,</span><span class="s1">&#39;res_H&#39;</span><span class="p">,</span><span class="s1">&#39;res_w&#39;</span><span class="p">,</span><span class="s1">&#39;diffcost&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">silence</span><span class="p">:</span> <span class="n">print_time</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">W</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">Wtil</span><span class="p">,</span><span class="n">Ptil</span><span class="p">,</span><span class="n">cost_list</span><span class="p">,</span><span class="n">res</span>


<span class="c1">#%%=== label constraint method that didn&#39;t turnout so useful ====</span>
<span class="k">def</span> <span class="nf">lc_spnmf_admm</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">r</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">,</span><span class="n">constraint</span><span class="o">=</span><span class="s1">&#39;stiefel&#39;</span><span class="p">,</span><span class="n">rho</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
                  <span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span><span class="n">W_init</span><span class="o">=</span><span class="s1">&#39;nndsvd&#39;</span><span class="p">,</span><span class="n">disp_freq</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">silence</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Label constrained Spectral Projective NMF using ADMM.</span>

<span class="sd">    **LC** Idea from 2011 Z. Jiang (CVPR) - Learning a discriminative</span>
<span class="sd">    dictionary for sparse coding via label constrained k-svd</span>

<span class="sd">    Usage</span>
<span class="sd">    -----</span>
<span class="sd">    &gt;&gt;&gt; W,P,H,Wtil,Ptil,A,cost,res = lc_spnmf_admm(....)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : ndarray of shape (n_features, n_samples)=(p,n)</span>
<span class="sd">        Data matrix with columns as data points</span>
<span class="sd">    y : array-like of shape [n_samples,]</span>
<span class="sd">        Label vector</span>
<span class="sd">    r : int (must be even for this LC-approach)</span>
<span class="sd">        Dimension of the embedding space (n_components)</span>
<span class="sd">    alpha : float</span>
<span class="sd">        Regularization for discriminative code</span>
<span class="sd">    constraint : ``&#39;stiefel&#39;`` or ``&#39;convex&#39;``</span>
<span class="sd">        The type of spectral constraint (default: ``&#39;stiefel&#39;``).  This</span>
<span class="sd">        determines the type of spectral projection applied.</span>
<span class="sd">    rho : float</span>
<span class="sd">        Augmented Lagrangian parameter</span>
<span class="sd">    max_iter : int</span>
<span class="sd">        max number of iterations</span>
<span class="sd">    tol : float</span>
<span class="sd">        convergence tolerance (on relative change in objective value and</span>
<span class="sd">        all primal residuals)</span>
<span class="sd">    W_init : None, rng, or &#39;nndsvd&#39; (default)</span>
<span class="sd">        Way to initialize W (and H).  If ``None`` or ``RandomState object``</span>
<span class="sd">        is supplied, both W and H will be initialized via non-negative</span>
<span class="sd">        random number.  If ``&#39;nndsvd&#39;``, will use deterministic initialization</span>
<span class="sd">        NNDSVD &quot;Non-Negative Double Singular Value Decomposition&quot;, proposed by</span>
<span class="sd">        Boutsidis2008.</span>
<span class="sd">    disp_freq : int</span>
<span class="sd">        Frequency of update display (in iterations)</span>
<span class="sd">    silence : bool</span>
<span class="sd">        If True, don&#39;t print-out convergence detail at the end.</span>

<span class="sd">    History</span>
<span class="sd">    --------------</span>
<span class="sd">    **02/08/2016** - function created (forked from ``spnmf_admm``)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">alpha</span> <span class="o">*=</span> <span class="mf">1.0</span>
    <span class="n">rho</span> <span class="o">*=</span> <span class="mf">1.0</span>
    <span class="k">if</span> <span class="n">r</span><span class="o">%</span><span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;r must be an even integer&quot;</span><span class="p">)</span>
    <span class="c1">#%%=== initialize variables =====</span>
    <span class="k">if</span> <span class="n">W_init</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">W_init</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">):</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">W_init</span>

        <span class="n">W</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">W_init</span> <span class="o">==</span> <span class="s1">&#39;nndsvd&#39;</span><span class="p">:</span>
<span class="c1">#        W = nnd_svd(X,r)</span>
        <span class="n">W</span><span class="p">,</span><span class="n">H</span> <span class="o">=</span> <span class="n">nnd_svd</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">get_H</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid input for &quot;W_init&quot;&#39;</span><span class="p">)</span>

    <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">p</span><span class="p">))</span>
<span class="c1">#    P = np.random.rand(r,p)</span>

    <span class="c1"># aux. variables</span>
    <span class="n">W1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">W2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Ptil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="c1"># dual variables</span>
    <span class="n">Lam_W1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_W2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="c1">#--- variables for LC approach ---#</span>
    <span class="c1"># linear transformation matrix that parametrizes LC</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">r</span><span class="p">))</span>

    <span class="c1"># get discriminative codes</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="n">get_discriminative_codes</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
    <span class="c1">#%%=== create empty lists for tracking updates ===</span>
    <span class="c1"># keep track of frobenius norm loss</span>
    <span class="n">cost_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cost_nmf_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cost_LC_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">cost_nmf</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W1</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ptil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">))</span> <span class="o">-</span> <span class="n">X</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">cost_LC</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span> <span class="n">Q</span> <span class="o">-</span> <span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">),</span> <span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="n">cost_nmf</span> <span class="o">+</span> <span class="n">cost_LC</span>

    <span class="n">cost_nmf_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_nmf</span><span class="p">)</span>
    <span class="n">cost_LC_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_LC</span><span class="p">)</span>
    <span class="n">cost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>

    <span class="c1"># relative change in cost</span>
    <span class="n">diffcost</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># keep track of relative primal residual</span>
    <span class="n">res_W1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_W2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_P</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_H</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># also keep track of diffW</span>
<span class="c1">#    diffW = []</span>
    <span class="c1">#%%=== run admm iterations ===</span>
    <span class="n">eye_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="c1"># precompute term needed for inversion lemma</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">X</span><span class="p">),</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>



    <span class="n">start</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iter</span><span class="p">):</span>
<span class="c1">#        W_old = W #&lt;- to keep track of diffW</span>

        <span class="c1">#================ primal updates (P, W, H, Ptil, Wtil) ===============#</span>
        <span class="c1"># update for P involves inversion lemma...</span>
        <span class="n">_R</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Lam_H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">/</span><span class="n">rho</span> <span class="o">-</span> <span class="n">Lam_P</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">rho</span> <span class="o">+</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">Ptil</span><span class="o">.</span><span class="n">T</span>
        <span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="n">_R</span> <span class="o">-</span> <span class="n">X</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">dot</span><span class="p">(</span><span class="n">K</span><span class="p">,</span><span class="n">_R</span><span class="p">)</span> <span class="p">))</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Ptil</span> <span class="o">=</span> <span class="p">(</span><span class="n">P</span><span class="o">+</span><span class="n">Lam_P</span><span class="o">/</span><span class="n">rho</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># (W,H) updates</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">W</span><span class="p">)</span><span class="o">+</span><span class="n">rho</span><span class="o">*</span><span class="n">eye_r</span> <span class="o">+</span> <span class="n">alpha</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">A</span><span class="p">),</span>
                  <span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">X</span><span class="p">)</span> <span class="o">-</span> <span class="n">Lam_H</span> <span class="o">+</span> <span class="n">alpha</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">Q</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span> <span class="n">H</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">H</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Q</span><span class="o">.</span><span class="n">T</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="n">eye_r</span><span class="p">,</span>
                  <span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">W1</span><span class="o">+</span><span class="n">W2</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">Lam_W1</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">Lam_W2</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># projections</span>
        <span class="n">W1</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span><span class="o">+</span><span class="n">Lam_W1</span><span class="o">/</span><span class="n">rho</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">W2</span> <span class="o">=</span> <span class="n">projection_spectral</span><span class="p">(</span><span class="n">W</span><span class="o">+</span><span class="n">Lam_W2</span><span class="o">/</span><span class="n">rho</span><span class="p">,</span><span class="n">projection_type</span><span class="o">=</span><span class="n">constraint</span><span class="p">)</span>

        <span class="c1">#====================== dual updates =================================#</span>
        <span class="n">Lam_W1</span> <span class="o">=</span> <span class="n">Lam_W1</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">W</span> <span class="o">-</span> <span class="n">W1</span><span class="p">)</span>
        <span class="n">Lam_W2</span> <span class="o">=</span> <span class="n">Lam_W2</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">W</span> <span class="o">-</span> <span class="n">W2</span><span class="p">)</span>
        <span class="n">Lam_P</span> <span class="o">=</span> <span class="n">Lam_P</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">P</span> <span class="o">-</span> <span class="n">Ptil</span><span class="p">)</span>
        <span class="n">Lam_H</span> <span class="o">=</span> <span class="n">Lam_H</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">H</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">X</span><span class="p">))</span>

        <span class="c1">#============ comptute objective values ==============================#</span>
        <span class="c1"># main loss function</span>
        <span class="n">cost_nmf</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W1</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ptil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">))</span> <span class="o">-</span> <span class="n">X</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">cost_LC</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span> <span class="n">Q</span> <span class="o">-</span> <span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">),</span> <span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="n">cost_nmf</span> <span class="o">+</span> <span class="n">cost_LC</span>

        <span class="n">cost_nmf_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_nmf</span><span class="p">)</span>
        <span class="n">cost_LC_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_LC</span><span class="p">)</span>
        <span class="n">cost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>

        <span class="c1"># relative change in cost</span>
        <span class="n">diffcost</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span><span class="o">/</span><span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>

        <span class="c1"># relative primal residuals</span>
        <span class="n">res_W1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="o">-</span><span class="n">W1</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="n">res_W2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="o">-</span><span class="n">W2</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="n">res_P</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">P</span><span class="o">-</span><span class="n">Ptil</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="n">res_H</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="o">-</span><span class="n">P</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">),</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>

        <span class="c1"># relative change in basis matrix</span>
<span class="c1">#        diffW.append( norm(W-W_old,&#39;fro&#39;)/ norm(W_old, &#39;fro&#39;) )</span>

        <span class="c1">#=== termination check =============#</span>
        <span class="n">check_exit</span> <span class="o">=</span>  <span class="p">(</span><span class="n">diffcost</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span>  <span class="n">res_W1</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span>  <span class="n">res_W2</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span>   <span class="n">res_P</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span>   <span class="n">res_H</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">check_exit</span> <span class="ow">and</span> <span class="nb">iter</span> <span class="o">&gt;</span> <span class="mi">300</span><span class="p">:</span> <span class="c1"># allow 300 iterations of &quot;burn-in&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silence</span><span class="p">:</span>
                <span class="k">print</span> <span class="s2">&quot;Termination condition met.  Exit at iter =&quot;</span><span class="p">,</span><span class="nb">iter</span><span class="p">,</span>
            <span class="k">break</span>
        <span class="c1">#=============== print current progress ==============================#</span>
<span class="c1">#        if iter % disp_freq == 0:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">iter</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">iter</span> <span class="o">%</span> <span class="n">disp_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">str_</span> <span class="o">=</span> <span class="s2">&quot;iter={:4} cost={:6.5e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">iter</span><span class="p">,</span><span class="n">cost</span><span class="p">)</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; nmf={:.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cost_nmf</span><span class="p">)</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; LC={:.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cost_LC</span><span class="p">)</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; diffcost={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">diffcost</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; W1={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_W1</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; W2={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_W2</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; P={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_P</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; H={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_H</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
<span class="c1">#            str_ += &quot; diffW={:3.2e}&quot;.format(diffW[iter])</span>
            <span class="k">print</span> <span class="n">str_</span> <span class="o">+</span> <span class="s2">&quot; ({:3.1f} sec)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>
    <span class="c1">#%%---- end of admm for loop ---------------------------------------------#</span>
<span class="c1">#    cost_list = np.array(cost_list)</span>

    <span class="c1"># convert residual in pandas dataframe</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">cost_list</span><span class="p">,</span> <span class="n">cost_nmf_list</span><span class="p">,</span> <span class="n">cost_LC_list</span><span class="p">],</span>
                        <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">,</span><span class="s1">&#39;nmf&#39;</span><span class="p">,</span><span class="s1">&#39;LC&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">res_W1</span><span class="p">,</span><span class="n">res_W2</span><span class="p">,</span><span class="n">res_P</span><span class="p">,</span><span class="n">res_H</span><span class="p">,</span><span class="n">diffcost</span><span class="p">],</span>
                       <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;res_W1&#39;</span><span class="p">,</span><span class="s1">&#39;res_W2&#39;</span><span class="p">,</span><span class="s1">&#39;res_P&#39;</span><span class="p">,</span><span class="s1">&#39;res_H&#39;</span><span class="p">,</span><span class="s1">&#39;diffcost&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">silence</span><span class="p">:</span> <span class="n">print_time</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">W</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">W1</span><span class="p">,</span><span class="n">Ptil</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">cost</span><span class="p">,</span><span class="n">res</span>





<span class="k">def</span> <span class="nf">lslc_spnmf_admm</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">r</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">,</span><span class="n">gam</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">,</span><span class="n">constraint</span><span class="o">=</span><span class="s1">&#39;stiefel&#39;</span><span class="p">,</span><span class="n">rho</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span>
                    <span class="n">max_iter</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
                  <span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span><span class="n">W_init</span><span class="o">=</span><span class="s1">&#39;nndsvd&#39;</span><span class="p">,</span><span class="n">disp_freq</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">silence</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Least-squares Label constrained Spectral Projective NMF using ADMM.</span>

<span class="sd">    **LC** Idea from 2011 Z. Jiang (CVPR) - Learning a discriminative</span>
<span class="sd">    dictionary for sparse coding via label constrained k-svd</span>

<span class="sd">    Usage</span>
<span class="sd">    -----</span>
<span class="sd">    &gt;&gt;&gt; W,P,H,Wtil,Ptil,A,w,cost,res = lslc_spnmf_admm(....)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : ndarray of shape (n_features, n_samples)=(p,n)</span>
<span class="sd">        Data matrix with columns as data points</span>
<span class="sd">    y : array-like of shape [n_samples,]</span>
<span class="sd">        Label vector</span>
<span class="sd">    r : int (must be even for this LC-approach)</span>
<span class="sd">        Dimension of the embedding space (n_components)</span>
<span class="sd">    alpha : float</span>
<span class="sd">        Regularization for discriminative code</span>
<span class="sd">    gam : float</span>
<span class="sd">        Regularization on the least-squares fit</span>
<span class="sd">    constraint : ``&#39;stiefel&#39;`` or ``&#39;convex&#39;``</span>
<span class="sd">        The type of spectral constraint (default: ``&#39;stiefel&#39;``).  This</span>
<span class="sd">        determines the type of spectral projection applied.</span>
<span class="sd">    rho : float</span>
<span class="sd">        Augmented Lagrangian parameter</span>
<span class="sd">    max_iter : int</span>
<span class="sd">        max number of iterations</span>
<span class="sd">    tol : float</span>
<span class="sd">        convergence tolerance (on relative change in objective value and</span>
<span class="sd">        all primal residuals)</span>
<span class="sd">    W_init : None, rng, or &#39;nndsvd&#39;</span>
<span class="sd">        Way to initialize W (and H).  If ``None`` or ``RandomState object``</span>
<span class="sd">        is supplied, both W and H will be initialized via non-negative</span>
<span class="sd">        random number.  If ``&#39;nndsvd&#39;``, will use deterministic initialization</span>
<span class="sd">        NNDSVD &quot;Non-Negative Double Singular Value Decomposition&quot;, proposed by</span>
<span class="sd">        Boutsidis2008.</span>
<span class="sd">    disp_freq : int</span>
<span class="sd">        Frequency of update display (in iterations)</span>
<span class="sd">    silence : bool</span>
<span class="sd">        If True, don&#39;t print-out convergence detail at the end.</span>

<span class="sd">    History</span>
<span class="sd">    --------------</span>
<span class="sd">    **02/08/2016** - function created (forked from ``lc_spnmf_admm``)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">alpha</span> <span class="o">*=</span> <span class="mf">1.0</span>
    <span class="n">rho</span> <span class="o">*=</span> <span class="mf">1.0</span>
    <span class="k">if</span> <span class="n">r</span><span class="o">%</span><span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;r must be an even integer&quot;</span><span class="p">)</span>
    <span class="c1">#%%=== initialize variables =====</span>
    <span class="k">if</span> <span class="n">W_init</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">W_init</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">):</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">W_init</span>

        <span class="n">W</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">/=</span> <span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">W_init</span> <span class="o">==</span> <span class="s1">&#39;nndsvd&#39;</span><span class="p">:</span>
<span class="c1">#        W = nnd_svd(X,r)</span>
        <span class="n">W</span><span class="p">,</span><span class="n">H</span> <span class="o">=</span> <span class="n">nnd_svd</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">get_H</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid input for &quot;W_init&quot;&#39;</span><span class="p">)</span>

    <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">p</span><span class="p">))</span>
<span class="c1">#    P = np.random.rand(r,p)</span>

    <span class="c1"># aux. variables</span>
    <span class="n">W1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">W2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Ptil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="c1"># dual variables</span>
    <span class="n">Lam_W1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_W2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lam_H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="c1">#--- variables for LC approach ---#</span>
    <span class="c1"># linear transformation matrix that parametrizes LC</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">r</span><span class="p">))</span>

    <span class="c1"># get discriminative codes</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="n">get_discriminative_codes</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>

    <span class="c1"># classifier</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="c1">#%%=== create empty lists for tracking updates ===</span>
    <span class="c1"># keep track of frobenius norm loss</span>
    <span class="n">cost_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cost_nmf_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cost_LC_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cost_ls_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">PX</span> <span class="o">=</span> <span class="n">Ptil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">cost_nmf</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W1</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">PX</span><span class="p">)</span> <span class="o">-</span> <span class="n">X</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">cost_LC</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span> <span class="n">Q</span> <span class="o">-</span> <span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">),</span> <span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">cost_ls</span>  <span class="o">=</span> <span class="n">gam</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">PX</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">))</span> <span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="n">cost_nmf</span> <span class="o">+</span> <span class="n">cost_LC</span> <span class="o">+</span> <span class="n">cost_ls</span>

    <span class="n">cost_nmf_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_nmf</span><span class="p">)</span>
    <span class="n">cost_LC_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_LC</span><span class="p">)</span>
    <span class="n">cost_ls_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_ls</span><span class="p">)</span>
    <span class="n">cost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>

    <span class="c1"># relative change in cost</span>
    <span class="n">diffcost</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># keep track of relative primal residual</span>
    <span class="n">res_W1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_W2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_P</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_H</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># also keep track of diffW</span>
<span class="c1">#    diffW = []</span>
    <span class="c1">#%%=== run admm iterations ===</span>
    <span class="n">eye_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="c1"># precompute term needed for inversion lemma</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">X</span><span class="p">),</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>



    <span class="n">start</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iter</span><span class="p">):</span>
<span class="c1">#        W_old = W #&lt;- to keep track of diffW</span>

        <span class="c1">#================ primal updates (P, W, H, Ptil, Wtil) ===============#</span>
        <span class="c1"># update for P involves inversion lemma...</span>
        <span class="n">_R</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Lam_H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">/</span><span class="n">rho</span> <span class="o">-</span> <span class="n">Lam_P</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">rho</span> <span class="o">+</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">Ptil</span><span class="o">.</span><span class="n">T</span>
        <span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="n">_R</span> <span class="o">-</span> <span class="n">X</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">dot</span><span class="p">(</span><span class="n">K</span><span class="p">,</span><span class="n">_R</span><span class="p">)</span> <span class="p">))</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Ptil</span> <span class="o">=</span> <span class="p">(</span><span class="n">P</span><span class="o">+</span><span class="n">Lam_P</span><span class="o">/</span><span class="n">rho</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># (W,H) updates</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">W</span><span class="p">)</span><span class="o">+</span><span class="n">rho</span><span class="o">*</span><span class="n">eye_r</span> <span class="o">+</span> <span class="n">alpha</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">A</span><span class="p">),</span>
                  <span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">X</span><span class="p">)</span> <span class="o">-</span> <span class="n">Lam_H</span> <span class="o">+</span> <span class="n">alpha</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">Q</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span> <span class="n">H</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">H</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Q</span><span class="o">.</span><span class="n">T</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span> <span class="n">H</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">H</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="n">eye_r</span><span class="p">,</span>
                  <span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">W1</span><span class="o">+</span><span class="n">W2</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">Lam_W1</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">Lam_W2</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># projections</span>
        <span class="n">W1</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span><span class="o">+</span><span class="n">Lam_W1</span><span class="o">/</span><span class="n">rho</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">W2</span> <span class="o">=</span> <span class="n">projection_spectral</span><span class="p">(</span><span class="n">W</span><span class="o">+</span><span class="n">Lam_W2</span><span class="o">/</span><span class="n">rho</span><span class="p">,</span><span class="n">projection_type</span><span class="o">=</span><span class="n">constraint</span><span class="p">)</span>

        <span class="c1">#====================== dual updates =================================#</span>
        <span class="n">Lam_W1</span> <span class="o">=</span> <span class="n">Lam_W1</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">W</span> <span class="o">-</span> <span class="n">W1</span><span class="p">)</span>
        <span class="n">Lam_W2</span> <span class="o">=</span> <span class="n">Lam_W2</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">W</span> <span class="o">-</span> <span class="n">W2</span><span class="p">)</span>
        <span class="n">Lam_P</span> <span class="o">=</span> <span class="n">Lam_P</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">P</span> <span class="o">-</span> <span class="n">Ptil</span><span class="p">)</span>
        <span class="n">Lam_H</span> <span class="o">=</span> <span class="n">Lam_H</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">H</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">X</span><span class="p">))</span>

        <span class="c1">#============ comptute objective values ==============================#</span>
        <span class="c1"># main loss function</span>
        <span class="n">PX</span> <span class="o">=</span> <span class="n">Ptil</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">cost_nmf</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">W1</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">PX</span><span class="p">)</span> <span class="o">-</span> <span class="n">X</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">cost_LC</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span> <span class="n">Q</span> <span class="o">-</span> <span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">),</span> <span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">cost_ls</span>  <span class="o">=</span> <span class="n">gam</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">PX</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">))</span> <span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="n">cost_nmf</span> <span class="o">+</span> <span class="n">cost_LC</span> <span class="o">+</span> <span class="n">cost_ls</span>

        <span class="n">cost_nmf_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_nmf</span><span class="p">)</span>
        <span class="n">cost_LC_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_LC</span><span class="p">)</span>
        <span class="n">cost_ls_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_ls</span><span class="p">)</span>
        <span class="n">cost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>

        <span class="c1"># relative change in cost</span>
        <span class="n">diffcost</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span><span class="o">/</span><span class="n">cost_list</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>

        <span class="c1"># relative primal residuals</span>
        <span class="n">res_W1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="o">-</span><span class="n">W1</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="n">res_W2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="o">-</span><span class="n">W2</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="n">res_P</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">P</span><span class="o">-</span><span class="n">Ptil</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>
        <span class="n">res_H</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="o">-</span><span class="n">P</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">),</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="s1">&#39;fro&#39;</span><span class="p">))</span>

        <span class="c1"># relative change in basis matrix</span>
<span class="c1">#        diffW.append( norm(W-W_old,&#39;fro&#39;)/ norm(W_old, &#39;fro&#39;) )</span>

        <span class="c1">#=== termination check =============#</span>
        <span class="n">check_exit</span> <span class="o">=</span>  <span class="p">(</span><span class="n">diffcost</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span>  <span class="n">res_W1</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span>  <span class="n">res_W2</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span>   <span class="n">res_P</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">)</span>
        <span class="n">check_exit</span> <span class="o">&amp;=</span> <span class="p">(</span>   <span class="n">res_H</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">check_exit</span> <span class="ow">and</span> <span class="nb">iter</span> <span class="o">&gt;</span> <span class="mi">300</span><span class="p">:</span> <span class="c1"># allow 300 iterations of &quot;burn-in&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silence</span><span class="p">:</span>
                <span class="k">print</span> <span class="s2">&quot;Termination condition met.  Exit at iter =&quot;</span><span class="p">,</span><span class="nb">iter</span><span class="p">,</span>
            <span class="k">break</span>
        <span class="c1">#=============== print current progress ==============================#</span>
<span class="c1">#        if iter % disp_freq == 0:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">iter</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">iter</span> <span class="o">%</span> <span class="n">disp_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">str_</span> <span class="o">=</span> <span class="s2">&quot;iter={:4} cost={:6.5e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">iter</span><span class="p">,</span><span class="n">cost</span><span class="p">)</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; nmf={:.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cost_nmf</span><span class="p">)</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; LC={:.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cost_LC</span><span class="p">)</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; LS={:.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cost_ls</span><span class="p">)</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; diffcost={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">diffcost</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; W1={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_W1</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; W2={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_W2</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; P={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_P</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
            <span class="n">str_</span> <span class="o">+=</span> <span class="s2">&quot; H={:3.2e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_H</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
<span class="c1">#            str_ += &quot; diffW={:3.2e}&quot;.format(diffW[iter])</span>
            <span class="k">print</span> <span class="n">str_</span> <span class="o">+</span> <span class="s2">&quot; ({:3.1f} sec)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>
    <span class="c1">#%%---- end of admm for loop ---------------------------------------------#</span>
<span class="c1">#    cost_list = np.array(cost_list)</span>

    <span class="c1"># convert residual in pandas dataframe</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">cost_list</span><span class="p">,</span> <span class="n">cost_nmf_list</span><span class="p">,</span> <span class="n">cost_LC_list</span><span class="p">,</span><span class="n">cost_ls_list</span><span class="p">],</span>
                        <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">,</span><span class="s1">&#39;nmf&#39;</span><span class="p">,</span><span class="s1">&#39;LC&#39;</span><span class="p">,</span><span class="s1">&#39;cost_ls&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">res_W1</span><span class="p">,</span><span class="n">res_W2</span><span class="p">,</span><span class="n">res_P</span><span class="p">,</span><span class="n">res_H</span><span class="p">,</span><span class="n">diffcost</span><span class="p">],</span>
                       <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;res_W1&#39;</span><span class="p">,</span><span class="s1">&#39;res_W2&#39;</span><span class="p">,</span><span class="s1">&#39;res_P&#39;</span><span class="p">,</span><span class="s1">&#39;res_H&#39;</span><span class="p">,</span><span class="s1">&#39;diffcost&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">silence</span><span class="p">:</span> <span class="n">print_time</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">W</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">W1</span><span class="p">,</span><span class="n">Ptil</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">cost</span><span class="p">,</span><span class="n">res</span>

<span class="k">class</span> <span class="nc">LC_SPNMF_ADMM</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span><span class="n">TransformerMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Label constrained Spectral Projective NMF using ADMM.</span>

<span class="sd">    History</span>
<span class="sd">    --------------</span>
<span class="sd">    **02/08/2016** - function created (forked from ``spnmf_admm``)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">r</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">,</span><span class="n">constraint</span><span class="o">=</span><span class="s1">&#39;stiefel&#39;</span><span class="p">,</span><span class="n">rho</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span>
                 <span class="n">max_iter</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span><span class="n">W_init</span><span class="o">=</span><span class="s1">&#39;nndsvd&#39;</span><span class="p">,</span>
                 <span class="n">disp_freq</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span><span class="n">silence</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">%</span><span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;r must be an even integer&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">r</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraint</span> <span class="o">=</span> <span class="n">constraint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rho</span> <span class="o">=</span> <span class="n">rho</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span> <span class="o">=</span> <span class="n">max_iter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="o">=</span> <span class="n">tol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_init</span> <span class="o">=</span> <span class="n">W_init</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disp_freq</span> <span class="o">=</span> <span class="n">disp_freq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">silence</span> <span class="o">=</span> <span class="n">silence</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;WARNING: Here, to conform with scikit&#39;s convention, X is [n,p]</span>
<span class="sd">        shaped, so need to apply transpose before inputting to function&quot;&quot;&quot;</span>
        <span class="n">W</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">Wtil</span><span class="p">,</span><span class="n">Ptil</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">cost</span><span class="p">,</span><span class="n">res</span> <span class="o">=</span> <span class="n">lc_spnmf_admm</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span>
            <span class="n">constraint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">constraint</span><span class="p">,</span> <span class="n">rho</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span><span class="p">,</span>
            <span class="n">tol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">,</span> <span class="n">W_init</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">W_init</span><span class="p">,</span> <span class="n">disp_freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">disp_freq</span><span class="p">,</span>
            <span class="n">silence</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">silence</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">W_</span> <span class="o">=</span> <span class="n">Wtil</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P_</span> <span class="o">=</span> <span class="n">Ptil</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">H_</span> <span class="o">=</span> <span class="n">H</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">A_</span> <span class="o">=</span> <span class="n">A</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cost_</span> <span class="o">=</span> <span class="n">cost</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resid_</span> <span class="o">=</span> <span class="n">res</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;WARNING: Here, to conform with scikit&#39;s convention, X is [n,p] shaped&quot;&quot;&quot;</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;P_&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">P_</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">LSLC_SPNMF_ADMM</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span><span class="n">TransformerMixin</span><span class="p">,</span><span class="n">ClassifierMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Least squares Label constrained Spectral Projective NMF using ADMM.</span>

<span class="sd">    History</span>
<span class="sd">    --------------</span>
<span class="sd">    **02/08/2016** - function created (forked from ``LC_SPNMF_ADMM``)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">r</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">,</span><span class="n">gam</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">,</span><span class="n">constraint</span><span class="o">=</span><span class="s1">&#39;stiefel&#39;</span><span class="p">,</span><span class="n">rho</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span>
                 <span class="n">max_iter</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span><span class="n">W_init</span><span class="o">=</span><span class="s1">&#39;nndsvd&#39;</span><span class="p">,</span>
                 <span class="n">disp_freq</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span><span class="n">silence</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">%</span><span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;r must be an even integer&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">r</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gam</span> <span class="o">=</span> <span class="n">gam</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraint</span> <span class="o">=</span> <span class="n">constraint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rho</span> <span class="o">=</span> <span class="n">rho</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span> <span class="o">=</span> <span class="n">max_iter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="o">=</span> <span class="n">tol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_init</span> <span class="o">=</span> <span class="n">W_init</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disp_freq</span> <span class="o">=</span> <span class="n">disp_freq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">silence</span> <span class="o">=</span> <span class="n">silence</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;WARNING: Here, to conform with scikit&#39;s convention, X is [n,p]</span>
<span class="sd">        shaped, so need to apply transpose before inputting to function&quot;&quot;&quot;</span>
        <span class="n">W</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">Wtil</span><span class="p">,</span><span class="n">Ptil</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">cost</span><span class="p">,</span><span class="n">res</span> <span class="o">=</span> <span class="n">lslc_spnmf_admm</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="n">gam</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gam</span><span class="p">,</span>
            <span class="n">constraint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">constraint</span><span class="p">,</span> <span class="n">rho</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span><span class="p">,</span>
            <span class="n">tol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">,</span> <span class="n">W_init</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">W_init</span><span class="p">,</span> <span class="n">disp_freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">disp_freq</span><span class="p">,</span>
            <span class="n">silence</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">silence</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">W_</span> <span class="o">=</span> <span class="n">Wtil</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P_</span> <span class="o">=</span> <span class="n">Ptil</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">H_</span> <span class="o">=</span> <span class="n">H</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">A_</span> <span class="o">=</span> <span class="n">A</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_</span> <span class="o">=</span> <span class="n">w</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cost_</span> <span class="o">=</span> <span class="n">cost</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resid_</span> <span class="o">=</span> <span class="n">res</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;WARNING: Here, to conform with scikit&#39;s convention, X is [n,p] shaped&quot;&quot;&quot;</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;P_&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">P_</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">decision_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">):</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;P_&#39;</span><span class="p">)</span>
        <span class="c1"># project data to low dimensional space</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">P_</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="c1"># apply classifier</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">score</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">):</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;P_&#39;</span><span class="p">)</span>

        <span class="c1"># project data to low dimensional space</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">P_</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="c1"># apply classifier</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_</span><span class="p">)</span>
        <span class="n">ypr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ypr</span>


<span class="k">def</span> <span class="nf">get_discriminative_codes</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">r</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Get codes for **Label-constraint**</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    y : array-like of shape [n_samples,]</span>
<span class="sd">        label vector</span>
<span class="sd">    r : int divisible by 2</span>
<span class="sd">        Embedding space. For simplicity, I&#39;m going to let the number of</span>
<span class="sd">        dimension for +1 and -1 both be the same at r/2</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Q : array-like of shape</span>

<span class="sd">    Idea from 2011 Z. Jiang (CVPR) - Learning a discriminative dictionary</span>
<span class="sd">    for sparse coding via label constrained k-svd</span>

<span class="sd">    Created 02/08/2016</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">r</span><span class="o">%</span><span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;r must be an even integer&quot;</span><span class="p">)</span>

    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">qp</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">qm</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">qp</span><span class="p">[:</span><span class="n">r</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">qm</span><span class="p">[</span><span class="n">r</span><span class="o">/</span><span class="mi">2</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==+</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">Q</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">qp</span>
        <span class="k">elif</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">Q</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">qm</span>
    <span class="k">return</span> <span class="n">Q</span>

</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
      
    </p>
    <p>
      Last updated on Nov 05, 2016.<br/>
    </p>
  </div>
</footer>
  </body>
</html>